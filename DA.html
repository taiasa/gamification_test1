<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ãƒ¼ã‚¿æ•´ç†ãƒ»åˆ†æã‚¢ãƒ—ãƒª v2</title>
    <!-- ã‚°ãƒ©ãƒ•æç”»ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4A90E2;
            --accent-color: #F5A623;
            --bg-color: #F0F4F8;
            --card-bg: #FFFFFF;
            --text-color: #333333;
            --font-main: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 20px;
            box-sizing: border-box;
        }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .input-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        input[type="number"] {
            padding: 10px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 150px;
            outline: none;
        }

        input[type="number"]:focus {
            border-color: var(--primary-color);
        }

        button {
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
        }

        button:active {
            transform: scale(0.95);
        }

        .btn-add { background-color: var(--primary-color); color: white; }
        .btn-clear { background-color: #E74C3C; color: white; }
        .btn-sort { background-color: #2ECC71; color: white; margin: 0 5px; }
        
        /* ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .btn-download {
            background-color: #607D8B;
            color: white;
            margin-left: 10px;
            font-size: 14px;
            padding: 8px 15px;
        }

        .btn-analyze { 
            background-color: var(--accent-color); 
            color: white; 
            font-size: 20px; 
            padding: 15px 40px; 
            display: block; 
            margin: 20px auto;
            width: 100%;
            max-width: 300px;
            box-shadow: 0 4px 0 #d38d1b;
        }
        .btn-analyze:active { box-shadow: 0 2px 0 #d38d1b; transform: translateY(2px); }

        /* ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .data-display {
            background-color: #f9f9f9;
            border: 2px dashed #ccc;
            border-radius: 15px;
            padding: 15px;
            min-height: 80px;
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-start;
            align-items: center;
        }

        .data-chip {
            background-color: white;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: popIn 0.3s ease;
        }

        /* ãƒ‡ãƒ¼ã‚¿ã®ç•ªå·è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */
        .data-index {
            background-color: var(--primary-color);
            color: white;
            font-size: 12px;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px;
        }

        .delete-chip {
            background: #eee;
            color: #666;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            margin-left: 5px;
        }
        .delete-chip:hover {
            background: #ffcccc;
            color: red;
        }

        .empty-msg {
            color: #999;
            width: 100%;
            text-align: center;
        }

        /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        /* åˆ†æçµæœã‚¨ãƒªã‚¢ */
        #result-section {
            display: none; /* æœ€åˆã¯éš ã™ */
            border-top: 3px solid #eee;
            margin-top: 30px;
            padding-top: 30px;
            animation: slideDown 0.5s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #EAF4FF;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-label { font-size: 14px; color: #666; margin-bottom: 5px; }
        .stat-value { font-size: 28px; font-weight: bold; color: var(--primary-color); }

        /* ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ è¨­å®š */
        .histogram-controls {
            background: #fff8e1;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .histogram-controls label {
            font-weight: bold;
        }

        .chart-wrapper {
            background: white; /* ä¿å­˜æ™‚ã«èƒŒæ™¯ãŒé»’ããªã‚‰ãªã„ã‚ˆã†ã«ç™½ã‚’æŒ‡å®š */
            padding: 10px;
            border-radius: 10px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        @keyframes popIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

    </style>
</head>
<body>

    <h1>ğŸ“Š ãƒ‡ãƒ¼ã‚¿æ•´ç†ãƒ»åˆ†æã‚¢ãƒ—ãƒª</h1>

    <div class="container">
        <!-- å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="input-section">
            <input type="number" id="dataInput" placeholder="æ•°å­—ã‚’å…¥åŠ›" onkeydown="if(event.key==='Enter') addData()">
            <button class="btn-add" onclick="addData()">è¿½åŠ </button>
            <button class="btn-clear" onclick="clearData()">ã™ã¹ã¦æ¶ˆã™</button>
        </div>

        <div class="toolbar">
            <span>ãƒ‡ãƒ¼ã‚¿æ•°: <b id="count">0</b> å€‹</span>
            <div>
                <button class="btn-sort" onclick="sortData('asc')">å°ã•ã„é †</button>
                <button class="btn-sort" onclick="sortData('desc')">å¤§ãã„é †</button>
            </div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="data-display" id="dataDisplay">
            <div class="empty-msg">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œè¿½åŠ ã€ãƒœã‚¿ãƒ³ã§æ•°å­—ã‚’ã„ã‚Œã¦ã­ï¼</div>
        </div>

        <button class="btn-analyze" onclick="analyzeData()">åˆ†æã™ã‚‹ï¼</button>

        <!-- åˆ†æçµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="result-section">
            <h2>çµæœã¯ã£ã´ã‚‡ã†</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡å€¤ (ã¸ã„ãã‚“)</div>
                    <div class="stat-value" id="res-mean">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ä¸­å¤®å€¤ (çœŸã‚“ä¸­ã®å€¤)</div>
                    <div class="stat-value" id="res-median">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœ€é »å€¤ (ä¸€ç•ªå¤šã„å€¤)</div>
                    <div class="stat-value" id="res-mode">-</div>
                </div>
            </div>

            <div class="histogram-controls">
                <div>
                    <label for="binWidth">éšç´šã®å¹…ï¼ˆã‚°ãƒ©ãƒ•ã®åŒºåˆ‡ã‚Šï¼‰:</label>
                    <input type="number" id="binWidth" value="10" min="1" style="width: 80px;" onchange="updateHistogram()">
                    <span>ãšã¤åŒºåˆ‡ã‚‹</span>
                </div>
                <button class="btn-download" onclick="downloadChart()">ğŸ“· ã‚°ãƒ©ãƒ•ã‚’ç”»åƒã§ä¿å­˜</button>
            </div>

            <div class="chart-wrapper">
                <div class="chart-container">
                    <canvas id="histogramChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜å ´æ‰€
        let dataList = [];
        let myChart = null;

        // ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
        function addData() {
            const input = document.getElementById('dataInput');
            const value = parseFloat(input.value);

            if (isNaN(value)) {
                alert("æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
                return;
            }

            dataList.push(value);
            input.value = ""; // å…¥åŠ›æ¬„ã‚’ç©ºã«ã™ã‚‹
            input.focus(); // ç¶šã‘ã¦å…¥åŠ›ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            renderData();
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°ï¼ˆç•ªå·è¡¨ç¤ºã‚’è¿½åŠ ï¼‰
        function renderData() {
            const display = document.getElementById('dataDisplay');
            const countSpan = document.getElementById('count');
            
            display.innerHTML = "";
            countSpan.innerText = dataList.length;

            if (dataList.length === 0) {
                display.innerHTML = '<div class="empty-msg">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œè¿½åŠ ã€ãƒœã‚¿ãƒ³ã§æ•°å­—ã‚’ã„ã‚Œã¦ã­ï¼</div>';
                document.getElementById('result-section').style.display = 'none';
                return;
            }

            // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒãƒ—ã¨ã—ã¦è¡¨ç¤º
            dataList.forEach((num, index) => {
                const chip = document.createElement('div');
                chip.className = 'data-chip';
                // ç•ªå· + ãƒ‡ãƒ¼ã‚¿ + å‰Šé™¤ãƒœã‚¿ãƒ³
                chip.innerHTML = `
                    <span class="data-index">${index + 1}</span>
                    <span>${num}</span>
                    <div class="delete-chip" onclick="removeData(${index})">Ã—</div>
                `;
                display.appendChild(chip);
            });
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
        function removeData(index) {
            dataList.splice(index, 1);
            renderData();
        }

        // ã™ã¹ã¦å‰Šé™¤
        function clearData() {
            if(confirm("æœ¬å½“ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) {
                dataList = [];
                renderData();
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’ä¸¦ã³æ›¿ãˆã‚‹é–¢æ•°
        function sortData(order) {
            if (dataList.length === 0) return;

            if (order === 'asc') {
                dataList.sort((a, b) => a - b);
            } else {
                dataList.sort((a, b) => b - a);
            }
            renderData();
        }

        // ãƒ¡ã‚¤ãƒ³ã®åˆ†æé–¢æ•°
        function analyzeData() {
            if (dataList.length === 0) {
                alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼æ•°å­—ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            document.getElementById('result-section').style.display = 'block';
            
            // ç”»é¢ã®ä¸‹ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            setTimeout(() => {
                document.getElementById('result-section').scrollIntoView({ behavior: 'smooth' });
            }, 100);

            // 1. å¹³å‡å€¤
            const sum = dataList.reduce((a, b) => a + b, 0);
            const mean = sum / dataList.length;
            document.getElementById('res-mean').innerText = Math.round(mean * 10) / 10;

            // 2. ä¸­å¤®å€¤
            const sorted = [...dataList].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            let median;
            if (sorted.length % 2 === 0) {
                median = (sorted[mid - 1] + sorted[mid]) / 2;
            } else {
                median = sorted[mid];
            }
            document.getElementById('res-median').innerText = median;

            // 3. æœ€é »å€¤
            const frequency = {};
            let maxFreq = 0;
            sorted.forEach(val => {
                frequency[val] = (frequency[val] || 0) + 1;
                if (frequency[val] > maxFreq) maxFreq = frequency[val];
            });

            let modes = [];
            for (const key in frequency) {
                if (frequency[key] === maxFreq) {
                    modes.push(key);
                }
            }

            if (maxFreq === 1 && dataList.length > 1) {
                document.getElementById('res-mode').innerText = "ãªã—";
            } else {
                document.getElementById('res-mode').innerText = modes.join(', ');
            }

            // 4. ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã®æç”»ï¼ˆåˆæœŸè¨­å®šï¼‰
            const maxVal = Math.max(...dataList);
            const minVal = Math.min(...dataList);
            let suggestedWidth = Math.ceil((maxVal - minVal) / 5);
            if (suggestedWidth === 0) suggestedWidth = 10;
            if (suggestedWidth > 5 && suggestedWidth < 10) suggestedWidth = 5;
            
            const widthInput = document.getElementById('binWidth');
            if (!myChart) { 
                widthInput.value = suggestedWidth;
            }
            
            updateHistogram();
        }

        // ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ æ›´æ–°ãƒ»æç”»é–¢æ•°
        function updateHistogram() {
            const width = parseFloat(document.getElementById('binWidth').value);
            if (!width || width <= 0) return;

            const minData = Math.min(...dataList);
            const maxData = Math.max(...dataList);

            let start = Math.floor(minData / width) * width;
            let end = Math.ceil((maxData + 0.1) / width) * width; 
            
            const labels = [];
            const dataCounts = [];

            for (let i = start; i < end; i += width) {
                let currentStart = Math.round(i * 100) / 100;
                let currentEnd = Math.round((i + width) * 100) / 100;
                
                labels.push(`${currentStart} ã€œ ${currentEnd}`);
                
                let count = dataList.filter(d => d >= currentStart && d < currentEnd).length;
                dataCounts.push(count);
            }

            drawChart(labels, dataCounts, "åº¦æ•°ï¼ˆå€‹æ•°ï¼‰");
        }

        function drawChart(labels, data, labelName) {
            const ctx = document.getElementById('histogramChart').getContext('2d');

            if (myChart) {
                myChart.destroy();
            }

            // ç™½èƒŒæ™¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ï¼ˆä¿å­˜æ™‚ã«èƒŒæ™¯ãŒé€éã—ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
            const whiteBackgroundPlugin = {
                id: 'customCanvasBackgroundColor',
                beforeDraw: (chart) => {
                    const ctx = chart.canvas.getContext('2d');
                    ctx.save();
                    ctx.globalCompositeOperation = 'destination-over';
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, chart.width, chart.height);
                    ctx.restore();
                }
            };

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: labelName,
                        data: data,
                        backgroundColor: 'rgba(74, 144, 226, 0.6)',
                        borderColor: 'rgba(74, 144, 226, 1)',
                        borderWidth: 1,
                        barPercentage: 1.0,
                        categoryPercentage: 1.0
                    }]
                },
                plugins: [whiteBackgroundPlugin], // ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’é©ç”¨
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 },
                            title: { display: true, text: 'åº¦æ•°ï¼ˆäººæ•°ã‚„å€‹æ•°ï¼‰' }
                        },
                        x: {
                            title: { display: true, text: 'éšç´šï¼ˆç¯„å›²ï¼‰' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (tooltipItems) => tooltipItems[0].label + ' ã®ç¯„å›²'
                            }
                        }
                    }
                }
            });
        }

        // ã‚°ãƒ©ãƒ•ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°
        function downloadChart() {
            if (!myChart) {
                alert("ã¾ãšã¯ã€Œåˆ†æã™ã‚‹ï¼ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚°ãƒ©ãƒ•ã‚’ä½œã£ã¦ã­ã€‚");
                return;
            }
            const link = document.createElement('a');
            link.download = 'ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ .png';
            link.href = document.getElementById('histogramChart').toDataURL('image/png');
            link.click();
        }

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sky Adventure English - Deluxe Edition</title>
    <style>
        /* --- Âü∫Êú¨Ë®≠ÂÆö --- */
        :root {
            --cell-w: 120px;
            --cell-h: 90px;
            --primary-color: #0277bd;
            --accent-color: #ff9800;
        }

        body {
            margin: 0; padding: 0;
            background: linear-gradient(to bottom, #4fc3f7, #e1f5fe);
            font-family: "Varela Round", "Arial Rounded MT Bold", sans-serif;
            overflow: hidden;
            width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            touch-action: manipulation;
        }

        /* --- ËÉåÊôØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ --- */
        .sky-decoration { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: 0; }
        .cloud {
            position: absolute; background: rgba(255,255,255,0.8);
            border-radius: 50%; animation: floatCloud linear infinite;
        }
        .cloud::after, .cloud::before { content:''; position: absolute; background: inherit; border-radius: 50%; }
        .c1 { width: 100px; height: 40px; top: 10%; left: -20%; animation-duration: 25s; }
        .c1::after { width: 50px; height: 50px; top: -25px; left: 15px; }
        .c2 { width: 140px; height: 60px; top: 30%; left: -20%; animation-duration: 35s; animation-delay: 5s; }
        .c2::after { width: 70px; height: 70px; top: -35px; left: 25px; }
        @keyframes floatCloud { 0% { transform: translateX(0); } 100% { transform: translateX(120vw); } }

        /* --- „Ç≤„Éº„É†ÁîªÈù¢„Ç≥„É≥„ÉÜ„Éä --- */
        #game-viewport {
            position: relative;
            width: 1200px; height: 800px;
            transform-origin: center center;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10;
            visibility: hidden; opacity: 0; transition: opacity 0.5s;
        }

        /* --- UI„Éë„Éº„ÉÑ --- */
        header {
            width: 90%; display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.9); padding: 10px 30px; border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px;
        }
        .logo { font-size: 2rem; color: var(--primary-color); font-weight: 800; text-shadow: 2px 2px 0 #fff; }
        .turn-panel { font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .current-p-badge { padding: 5px 20px; border-radius: 20px; color: white; text-shadow: 1px 1px 0 rgba(0,0,0,0.3); }

        /* --- Áõ§Èù¢ --- */
        #board-area {
            position: relative;
            background: rgba(255,255,255,0.5);
            padding: 20px; border-radius: 30px;
            border: 4px solid #fff;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        #grid-container {
            display: grid;
            grid-template-columns: repeat(6, var(--cell-w));
            grid-template-rows: repeat(5, var(--cell-h));
            gap: 15px;
            position: relative;
        }

        .cell {
            background: white; border-radius: 15px;
            border-bottom: 6px solid #ddd;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; font-weight: bold; color: #aaa;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .cell.start { background: #b2dfdb; border-color: #009688; color: #00796b; }
        .cell.goal { background: #ffcdd2; border-color: #e57373; color: #c62828; }
        .cell.special { border-color: #ffd54f; background: #fffde7; color: #ff6f00; animation: pulse 2s infinite; }
        .gimmick-icon { font-size: 2.5rem; position: absolute; pointer-events: none; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- „Ç≥„Éû --- */
        .token {
            width: 60px; height: 60px;
            position: absolute; top:0; left:0;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3));
            z-index: 20; display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem;
            transform: scale(0);
        }

        /* --- Êìç‰Ωú„Ç®„É™„Ç¢ & Âπ≥Èù¢„Çµ„Ç§„Ç≥„É≠ --- */
        #controls {
            margin-top: 25px;
            display: flex; align-items: center; gap: 40px;
            background: rgba(255,255,255,0.7);
            padding: 15px 40px; border-radius: 30px;
        }

        .dice-flat {
            width: 90px; height: 90px;
            background: white; border-radius: 18px; border: 4px solid #333;
            box-shadow: 0 8px 0 rgba(0,0,0,0.2);
            display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr);
            padding: 6px; box-sizing: border-box;
        }
        .pip { background-color: #333; border-radius: 50%; margin: 4px; visibility: hidden; }
        
        .dice-face-1 .p5 { visibility: visible; background-color: #f44336; width: 18px; height: 18px; margin: 1px; justify-self: center; align-self: center;}
        .dice-face-2 .p1, .dice-face-2 .p9 { visibility: visible; }
        .dice-face-3 .p1, .dice-face-3 .p5, .dice-face-3 .p9 { visibility: visible; }
        .dice-face-4 .p1, .dice-face-4 .p3, .dice-face-4 .p7, .dice-face-4 .p9 { visibility: visible; }
        .dice-face-5 .p1, .dice-face-5 .p3, .dice-face-5 .p5, .dice-face-5 .p7, .dice-face-5 .p9 { visibility: visible; }
        .dice-face-6 .p1, .dice-face-6 .p3, .dice-face-6 .p4, .dice-face-6 .p6, .dice-face-6 .p7, .dice-face-6 .p9 { visibility: visible; }

        .btn-action {
            width: 220px; padding: 15px 0; font-size: 2rem; border-radius: 50px;
            border: none; color: white; font-family: inherit; font-weight: bold;
            box-shadow: 0 8px 0 rgba(0,0,0,0.2); cursor: pointer; transition: 0.1s;
        }
        .btn-roll { background: var(--accent-color); box-shadow: 0 8px 0 #e65100; }
        .btn-roll:active { transform: translateY(8px); box-shadow: none; }
        .btn-stop { background: #f44336; box-shadow: 0 8px 0 #c62828; animation: pulseBtn 0.5s infinite alternate; }
        @keyframes pulseBtn { from{transform:scale(1);} to{transform:scale(1.05);} }
        .btn-action:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; animation: none; }

        #msg-box { font-size: 1.8rem; font-weight: bold; color: var(--primary-color); min-width: 200px; text-align: center; }

        /* --- „É¢„Éº„ÉÄ„É´ÂÖ±ÈÄö --- */
        .modal-overlay {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.6); z-index: 100;
            justify-content: center; align-items: center;
        }
        .modal-card {
            background: white; width: 500px; padding: 30px;
            border-radius: 30px; text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 8px solid var(--primary-color);
        }
        @keyframes popIn { from{transform:scale(0.5);opacity:0;} to{transform:scale(1);opacity:1;} }

        /* „ÇØ„Ç§„Ç∫„Éª„ÇÆ„Éü„ÉÉ„ÇØ */
        .quiz-img { font-size: 5rem; display: block; margin: 10px 0; }
        .options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .opt-btn {
            background: #f0f4c3; border: 3px solid #dce775; padding: 15px;
            font-size: 1.2rem; border-radius: 15px; cursor: pointer; font-weight: bold; color: #555;
        }
        .opt-btn:hover { background: #dce775; color: white; }

        /* „Ç®„Éï„Çß„ÇØ„Éà */
        #effect-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; pointer-events: none;
            z-index: 200; display: flex; justify-content: center; align-items: center;
        }
        .flash-msg { font-size: 5rem; color: #fff; font-weight: 900; -webkit-text-stroke: 3px #000; opacity: 0; }
        
        #start-screen { z-index: 300; background: linear-gradient(135deg, #81d4fa, #29b6f6); }
        
        /* ÂÑ™ÂãùÁîªÈù¢ */
        #win-modal { z-index: 500; }
        .winner-crown { font-size: 8rem; margin: 0; animation: floatCrown 2s infinite ease-in-out; }
        .winner-name { font-size: 3rem; color: #e65100; margin: 10px 0; font-weight: 900; }
        @keyframes floatCrown { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-20px);} }
        
        /* Á¥ôÂêπÈõ™Áî®„Ç≠„É£„É≥„Éê„Çπ */
        #confetti-canvas {
            position: fixed; top:0; left:0; width:100%; height:100%;
            pointer-events: none; z-index: 400; display: none;
        }
    </style>
</head>
<body>

    <div class="sky-decoration">
        <div class="cloud c1"></div>
        <div class="cloud c2"></div>
    </div>

    <!-- Á¥ôÂêπÈõ™„Ç≠„É£„É≥„Éê„Çπ -->
    <canvas id="confetti-canvas"></canvas>

    <!-- „Çπ„Çø„Éº„ÉàÁîªÈù¢ -->
    <div id="start-screen" class="modal-overlay" style="display:flex;">
        <div class="modal-card" style="border-color: #fff;">
            <div style="font-size: 4rem;">üå§Ô∏è‚úàÔ∏è</div>
            <h1 style="color:#01579b; font-size: 2.5rem; margin:10px 0;">Sky Adventure<br>English</h1>
            <p>Select Players:</p>
            <div style="display:flex; justify-content:center; gap:10px;">
                <button class="btn-action btn-roll" onclick="initGame(1)" style="font-size:1.2rem; padding:10px; width:60px;">1</button>
                <button class="btn-action btn-roll" onclick="initGame(2)" style="font-size:1.2rem; padding:10px; width:60px;">2</button>
                <button class="btn-action btn-roll" onclick="initGame(3)" style="font-size:1.2rem; padding:10px; width:60px;">3</button>
                <button class="btn-action btn-roll" onclick="initGame(4)" style="font-size:1.2rem; padding:10px; width:60px;">4</button>
            </div>
            <p style="font-size:0.8rem; margin-top:20px;">üîä Sound ON</p>
        </div>
    </div>

    <!-- ÂÑ™ÂãùÁîªÈù¢ -->
    <div id="win-modal" class="modal-overlay">
        <div class="modal-card" style="border-color: gold; background: #fffde7; transform:scale(1.2);">
            <div class="winner-crown">üëë</div>
            <h2 style="color:#fbc02d; font-size:2.5rem; margin:0; text-shadow: 2px 2px 0 white;">CONGRATULATIONS!</h2>
            <div id="winner-display" class="winner-name">Player 1 Wins!</div>
            <p style="font-size:1.5rem;">You are the English Master! üèÜ</p>
            <button class="btn-action btn-roll" onclick="location.reload()" style="background: linear-gradient(#ffeb3b, #fbc02d); color: #333;">Play Again</button>
        </div>
    </div>

    <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
    <div id="game-viewport">
        <header>
            <div class="logo">SKY SUGOROKU</div>
            <div class="turn-panel">
                Turn: <span id="turn-badge" class="current-p-badge" style="background:gray;">Player 1</span>
            </div>
        </header>

        <div id="board-area">
            <div id="grid-container"></div>
        </div>

        <div id="controls">
            <div id="flat-dice" class="dice-flat dice-face-1">
                <div class="pip p1"></div><div class="pip p2"></div><div class="pip p3"></div>
                <div class="pip p4"></div><div class="pip p5"></div><div class="pip p6"></div>
                <div class="pip p7"></div><div class="pip p8"></div><div class="pip p9"></div>
            </div>
            <button id="action-btn" class="btn-action btn-roll" onclick="handleDiceAction()">ROLL START</button>
            <div id="msg-box">Let's Play!</div>
        </div>
    </div>

    <!-- „ÇØ„Ç§„Ç∫„Éª„ÇÆ„Éü„ÉÉ„ÇØÁî®„É¢„Éº„ÉÄ„É´ -->
    <div id="game-modal" class="modal-overlay">
        <div class="modal-card">
            <div id="modal-content"></div>
        </div>
    </div>

    <div id="effect-overlay">
        <div id="flash-text" class="flash-msg"></div>
    </div>

    <script>
        // === ÂÆöÊï∞„Éª„Éá„Éº„ÇøÂÆöÁæ© ===
        const COLS = 6;
        const ROWS = 5;
        const TOTAL_CELLS = 30;

        const GIMMICKS = {
            BOOST:  { id: 'boost',  icon: 'üöÄ', name: 'Rocket Boost!', desc: 'Go forward 3 spaces!', color: '#e3f2fd' },
            BACK:   { id: 'back',   icon: '‚õàÔ∏è', name: 'Thunder!',      desc: 'Go back 3 spaces...',   color: '#eceff1' },
            STAR:   { id: 'star',   icon: '‚≠ê', name: 'Lucky Star!',   desc: 'Roll Dice Again!',      color: '#fff9c4' },
            SLEEP:  { id: 'sleep',  icon: 'üí§', name: 'Nap Time...',   desc: 'Skip next turn.',       color: '#d1c4e9' },
            SWAP:   { id: 'swap',   icon: 'üîÑ', name: 'Switch!',       desc: 'Swap places!',          color: '#b2dfdb' }
        };

        // --- „ÇØ„Ç§„Ç∫„Éá„Éº„Çø (40Âïè„Å´Â¢óÈáè) ---
        const QUIZ_DATA = [
            // Fruits & Food
            { q: "What is this?", img: "üçé", a: "Apple", opts: ["Apple", "Banana", "Cherry", "Melon"] },
            { q: "What is this?", img: "üçå", a: "Banana", opts: ["Lemon", "Banana", "Peach", "Grape"] },
            { q: "What is this?", img: "üçá", a: "Grape", opts: ["Grape", "Apple", "Orange", "Berry"] },
            { q: "What is this?", img: "üçï", a: "Pizza", opts: ["Bread", "Pizza", "Cake", "Rice"] },
            { q: "What is this?", img: "üçî", a: "Hamburger", opts: ["Sandwich", "Hamburger", "Hot dog", "Fries"] },
            { q: "It is sweet.", img: "üç∞", a: "Cake", opts: ["Bread", "Fish", "Cake", "Salad"] },
            // Animals
            { q: "What animal?", img: "üê∂", a: "Dog", opts: ["Dog", "Cat", "Mouse", "Fox"] },
            { q: "What animal?", img: "üê±", a: "Cat", opts: ["Dog", "Cat", "Tiger", "Lion"] },
            { q: "Which is big?", img: "üêò", a: "Elephant", opts: ["Ant", "Mouse", "Cat", "Elephant"] },
            { q: "King of animals.", img: "ü¶Å", a: "Lion", opts: ["Lion", "Tiger", "Bear", "Wolf"] },
            { q: "It has long ears.", img: "üê∞", a: "Rabbit", opts: ["Dog", "Rabbit", "Mouse", "Pig"] },
            { q: "It can swim.", img: "üêü", a: "Fish", opts: ["Bird", "Fish", "Cat", "Rabbit"] },
            { q: "It can fly.", img: "üê¶", a: "Bird", opts: ["Dog", "Fish", "Bird", "Pig"] },
            // Colors
            { q: "What color?", img: "üü•", a: "Red", opts: ["Red", "Blue", "Green", "Yellow"] },
            { q: "What color?", img: "üü¶", a: "Blue", opts: ["Red", "Blue", "Green", "Black"] },
            { q: "What color?", img: "üü®", a: "Yellow", opts: ["White", "Blue", "Yellow", "Purple"] },
            { q: "What color?", img: "üü©", a: "Green", opts: ["Red", "Green", "Pink", "Orange"] },
            { q: "What color?", img: "‚¨õ", a: "Black", opts: ["White", "Black", "Blue", "Red"] },
            // Numbers
            { q: "1 + 1 = ?", img: "2Ô∏è‚É£", a: "Two", opts: ["One", "Two", "Three", "Four"] },
            { q: "Five + Five = ?", img: "üîü", a: "Ten", opts: ["Eight", "Nine", "Ten", "Eleven"] },
            { q: "Count: One, Two, ...", img: "3Ô∏è‚É£", a: "Three", opts: ["Three", "Four", "Five", "Six"] },
            { q: "Seven is...?", img: "7Ô∏è‚É£", a: "7", opts: ["5", "6", "7", "8"] },
            // Objects & Vehicles
            { q: "You read this.", img: "üìñ", a: "Book", opts: ["Pen", "Book", "Desk", "Bag"] },
            { q: "You write with this.", img: "‚úèÔ∏è", a: "Pencil", opts: ["Eraser", "Pencil", "Box", "Cup"] },
            { q: "What is this?", img: "üöó", a: "Car", opts: ["Bus", "Train", "Car", "Bike"] },
            { q: "It goes to school.", img: "üöå", a: "Bus", opts: ["Car", "Bus", "Plane", "Ship"] },
            { q: "It flies.", img: "‚úàÔ∏è", a: "Plane", opts: ["Car", "Boat", "Plane", "Train"] },
            { q: "What is this?", img: "‚öΩ", a: "Ball", opts: ["Ball", "Bat", "Box", "Doll"] },
            // Nature & Weather
            { q: "It is hot.", img: "üåû", a: "Sun", opts: ["Moon", "Sun", "Star", "Cloud"] },
            { q: "At night.", img: "üåô", a: "Moon", opts: ["Sun", "Moon", "Rain", "Snow"] },
            { q: "Wet weather.", img: "‚òî", a: "Rain", opts: ["Sun", "Rain", "Snow", "Wind"] },
            { q: "Beautiful flower.", img: "üåª", a: "Flower", opts: ["Tree", "Grass", "Flower", "Leaf"] },
            // Greetings & Verbs
            { q: "Say Hello!", img: "üëã", a: "Hello", opts: ["Hello", "Goodbye", "Good Night", "Sorry"] },
            { q: "Before you sleep.", img: "üõå", a: "Good Night", opts: ["Hello", "Good Morning", "Good Night", "Thank you"] },
            { q: "Action?", img: "üèÉ", a: "Run", opts: ["Run", "Sit", "Sleep", "Eat"] },
            { q: "Action?", img: "üèä", a: "Swim", opts: ["Run", "Swim", "Fly", "Walk"] },
            { q: "Action?", img: "üçΩÔ∏è", a: "Eat", opts: ["Drink", "Eat", "Read", "Play"] },
            // Body parts
            { q: "You see with...", img: "üëÄ", a: "Eyes", opts: ["Ears", "Eyes", "Nose", "Mouth"] },
            { q: "You hear with...", img: "üëÇ", a: "Ears", opts: ["Eyes", "Ears", "Hands", "Legs"] },
            { q: "This is a...", img: "‚úã", a: "Hand", opts: ["Foot", "Head", "Hand", "Back"] }
        ];

        const PLAYER_COLORS = [
            { c: '#ff1744', i: 'üêµ', n: 'Player 1' },
            { c: '#2979ff', i: 'üêß', n: 'Player 2' },
            { c: '#00e676', i: 'üê∏', n: 'Player 3' },
            { c: '#ffea00', i: 'üêØ', n: 'Player 4' }
        ];

        // === „Ç≤„Éº„É†Áä∂ÊÖãÂ§âÊï∞ ===
        let players = [];
        let turn = 0;
        let isMoving = false;
        let isRolling = false;
        let rollInterval = null;
        let cellData = [];
        let audioCtx = null;

        // === ÂàùÊúüÂåñ„Å®ÁîªÈù¢Ë™øÊï¥ ===
        function fitScreen() {
            const viewport = document.getElementById('game-viewport');
            const scale = Math.min(window.innerWidth / 1200, window.innerHeight / 800) * 0.95;
            viewport.style.transform = `scale(${Math.max(0.1, scale)})`;
        }
        window.addEventListener('resize', fitScreen);
        
        // Èü≥Â£∞Ê©üËÉΩ
        function initAudio() {
            if (!audioCtx) {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (AudioContext) audioCtx = new AudioContext();
                } catch(e) {}
            }
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playSound(type) {
            if(!audioCtx) return;
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                const now = audioCtx.currentTime;

                if(type === 'tick') {
                    osc.type = 'square'; osc.frequency.setValueAtTime(800, now);
                    gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                    osc.start(now); osc.stop(now + 0.05);
                } else if(type === 'stop') {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(600, now);
                    osc.frequency.exponentialRampToValueAtTime(300, now + 0.2);
                    gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2);
                } else if(type === 'move') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(400, now);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1);
                } else if(type === 'correct') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(880, now); osc.frequency.setValueAtTime(1760, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.4);
                    osc.start(now); osc.stop(now + 0.4);
                } else if(type === 'wrong') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now); osc.stop(now + 0.3);
                } else if(type === 'win') {
                    // „Éï„Ç°„É≥„Éï„Ç°„Éº„É¨ (Major chord arpeggio)
                    const notes = [523.25, 659.25, 783.99, 1046.50, 783.99, 1046.50]; // C E G C G C
                    notes.forEach((freq, i) => {
                        const o = audioCtx.createOscillator();
                        const g = audioCtx.createGain();
                        o.connect(g); g.connect(audioCtx.destination);
                        o.type = 'square';
                        o.frequency.setValueAtTime(freq, now + i*0.15);
                        g.gain.setValueAtTime(0.1, now + i*0.15);
                        g.gain.exponentialRampToValueAtTime(0.01, now + i*0.15 + 0.3);
                        o.start(now + i*0.15); o.stop(now + i*0.15 + 0.3);
                    });
                }
            } catch(e) {}
        }

        // === „Ç≤„Éº„É†ÈñãÂßãÂá¶ÁêÜ ===
        window.initGame = function(num) {
            initAudio();
            document.getElementById('start-screen').style.display = 'none';
            const viewport = document.getElementById('game-viewport');
            viewport.style.visibility = 'visible';
            viewport.style.opacity = '1';
            fitScreen();
            createBoard();
            createPlayers(num);
            updateHUD();
        };

        function createBoard() {
            const grid = document.getElementById('grid-container');
            grid.innerHTML = "";
            cellData = new Array(TOTAL_CELLS).fill(null);
            
            for(let i=0; i<TOTAL_CELLS; i++) {
                const row = Math.floor(i / COLS);
                const col = (row % 2 === 0) ? (i % COLS) : (COLS - 1 - (i % COLS));
                const div = document.createElement('div');
                div.className = 'cell';
                div.style.gridRow = ROWS - row;
                div.style.gridColumn = col + 1;
                div.id = `cell-${i}`;
                div.innerText = i;
                if(i===0) { div.classList.add('start'); div.innerText="Start"; }
                if(i===TOTAL_CELLS-1) { div.classList.add('goal'); div.innerText="Goal"; }
                grid.appendChild(div);
            }
            // „ÇÆ„Éü„ÉÉ„ÇØÈÖçÁΩÆ
            const available = [];
            for(let i=1; i<TOTAL_CELLS-1; i++) available.push(i);
            available.sort(() => Math.random() - 0.5);
            const types = Object.keys(GIMMICKS);
            for(let i=0; i<7; i++) {
                if(available.length === 0) break;
                const idx = available.pop();
                const g = GIMMICKS[types[i % types.length]];
                cellData[idx] = { type: 'gimmick', data: g };
                const cellEl = document.getElementById(`cell-${idx}`);
                cellEl.classList.add('special');
                const icon = document.createElement('div');
                icon.className = 'gimmick-icon';
                icon.innerText = g.icon;
                cellEl.appendChild(icon);
            }
        }

        function createPlayers(num) {
            const boardArea = document.getElementById('board-area');
            players = [];
            for(let i=0; i<num; i++) {
                const p = PLAYER_COLORS[i];
                const token = document.createElement('div');
                token.className = 'token';
                token.innerText = p.i;
                token.style.backgroundColor = p.c;
                token.style.border = "3px solid white";
                token.style.borderRadius = "50%";
                boardArea.appendChild(token);
                players.push({ id: i, name: p.n, color: p.c, pos: 0, el: token, skipTurn: false });
            }
            setTimeout(() => { players.forEach(p => moveTokenTo(p.id, 0)); }, 50);
        }

        function moveTokenTo(playerId, cellIndex) {
            const p = players[playerId];
            const targetCell = document.getElementById(`cell-${cellIndex}`);
            const grid = document.getElementById('grid-container');
            if(!targetCell || !grid) return;

            const cellLeft = targetCell.offsetLeft + grid.offsetLeft;
            const cellTop = targetCell.offsetTop + grid.offsetTop;
            const offsetX = (targetCell.offsetWidth - 60) / 2;
            const offsetY = (targetCell.offsetHeight - 60) / 2;
            const shift = (playerId * 5) - (players.length * 2);

            p.el.style.transform = `translate(${cellLeft + offsetX + shift}px, ${cellTop + offsetY + shift}px) scale(1)`;
        }

        function updateHUD() {
            const p = players[turn];
            const badge = document.getElementById('turn-badge');
            badge.innerText = p.name;
            badge.style.backgroundColor = p.color;
            
            const btn = document.getElementById('action-btn');
            const msg = document.getElementById('msg-box');
            if(p.skipTurn) {
                msg.innerText = "Skip Turn...";
                btn.disabled = true;
                setTimeout(() => { p.skipTurn = false; nextTurn(); }, 1500);
            } else {
                msg.innerText = "It's your turn!";
                btn.disabled = false;
                btn.className = "btn-action btn-roll";
                btn.innerText = "ROLL START";
            }
        }

        // === „Çµ„Ç§„Ç≥„É≠ & ÁßªÂãï ===
        window.handleDiceAction = function() {
            if(isMoving) return;
            const btn = document.getElementById('action-btn');
            const msg = document.getElementById('msg-box');

            if(!isRolling) {
                initAudio();
                isRolling = true;
                btn.className = "btn-action btn-stop";
                btn.innerText = "STOP!";
                msg.innerText = "Rolling...";
                rollInterval = setInterval(() => {
                    updateDiceFace(Math.floor(Math.random() * 6) + 1);
                    playSound('tick');
                }, 80);
            } else {
                isRolling = false;
                clearInterval(rollInterval);
                playSound('stop');
                const roll = Math.floor(Math.random() * 6) + 1;
                updateDiceFace(roll);
                btn.disabled = true;
                btn.className = "btn-action btn-roll";
                msg.innerText = `Rolled ${roll}!`;
                setTimeout(() => { processMove(roll); }, 800);
            }
        };

        function updateDiceFace(num) {
            document.getElementById('flat-dice').className = `dice-flat dice-face-${num}`;
        }

        function processMove(steps) {
            isMoving = true;
            const p = players[turn];
            let remaining = steps;
            const timer = setInterval(() => {
                if(remaining > 0) {
                    p.pos++;
                    if(p.pos >= TOTAL_CELLS - 1) { p.pos = TOTAL_CELLS - 1; remaining = 0; }
                    moveTokenTo(p.id, p.pos);
                    playSound('move');
                    remaining--;
                } else {
                    clearInterval(timer);
                    checkLandEvent();
                }
            }, 400);
        }

        function checkLandEvent() {
            const p = players[turn];
            if(p.pos === TOTAL_CELLS - 1) {
                handleWin(p);
                return;
            }
            const cellInfo = cellData[p.pos];
            if(cellInfo && cellInfo.type === 'gimmick') {
                setTimeout(() => { triggerGimmick(cellInfo.data); }, 500);
            } else {
                setTimeout(showQuiz, 500);
            }
        }

        // === ÂÑ™ÂãùÂá¶ÁêÜ ===
        function handleWin(winner) {
            playSound('win');
            startConfetti();
            
            const modal = document.getElementById('win-modal');
            const display = document.getElementById('winner-display');
            
            display.innerHTML = `<span style="font-size:4rem">${winner.name}</span><br><span style="font-size:3rem">${winner.color === '#ff1744' ? 'üêµ' : winner.color === '#2979ff' ? 'üêß' : winner.color === '#00e676' ? 'üê∏' : 'üêØ'}</span>`;
            display.style.color = winner.color;
            
            modal.style.display = 'flex';
        }

        // === Á¥ôÂêπÈõ™„Ç®„Éï„Çß„ÇØ„Éà ===
        function startConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.style.display = 'block';
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const particles = [];
            for(let i=0; i<200; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    vx: Math.random() * 4 - 2,
                    vy: Math.random() * 3 + 2,
                    c: `hsl(${Math.random()*360}, 100%, 50%)`,
                    s: Math.random() * 10 + 5
                });
            }

            function loop() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                let active = false;
                particles.forEach(p => {
                    p.x += p.vx; p.y += p.vy;
                    if(p.y < canvas.height) {
                        active = true;
                        ctx.fillStyle = p.c;
                        ctx.fillRect(p.x, p.y, p.s, p.s);
                    } else {
                        // Reset to keep falling
                        p.y = -20; p.x = Math.random() * canvas.width; active = true;
                    }
                });
                if(active) requestAnimationFrame(loop);
            }
            loop();
        }

        // === „ÇÆ„Éü„ÉÉ„ÇØ & „ÇØ„Ç§„Ç∫ ===
        function triggerGimmick(g) {
            const modal = document.getElementById('game-modal');
            const content = document.getElementById('modal-content');
            modal.style.display = 'flex';
            content.innerHTML = `
                <div style="font-size:4rem;">${g.icon}</div>
                <h2 style="margin:0; color:#ff6f00;">${g.name}</h2>
                <p style="font-size:1.2rem; color:#555;">${g.desc}</p>
                <button class="btn-action btn-roll" onclick="applyGimmick('${g.id}')">OK</button>
            `;
            playSound('correct');
        }

        window.applyGimmick = function(id) {
            document.getElementById('game-modal').style.display = 'none';
            const p = players[turn];
            if(id === 'boost') { showFlash("BOOST!!", "#2196f3"); processMove(3); return; }
            if(id === 'back') { showFlash("BACK...", "#607d8b"); p.pos = Math.max(0, p.pos - 3); moveTokenTo(p.id, p.pos); setTimeout(showQuiz, 1000); return; }
            if(id === 'star') { showFlash("AGAIN!", "#ffeb3b"); isMoving = false; updateHUD(); return; }
            if(id === 'sleep') { showFlash("Zzz...", "#9c27b0"); p.skipTurn = true; setTimeout(nextTurn, 1000); return; }
            if(id === 'swap') {
                showFlash("SWAP!", "#009688");
                if(players.length > 1) {
                    let targets = players.filter(pl => pl.id !== p.id);
                    let target = targets[Math.floor(Math.random()*targets.length)];
                    let temp = p.pos; p.pos = target.pos; target.pos = temp;
                    moveTokenTo(p.id, p.pos); moveTokenTo(target.id, target.pos);
                }
                setTimeout(showQuiz, 1000); return;
            }
            setTimeout(nextTurn, 500);
        };

        function showQuiz() {
            const q = QUIZ_DATA[Math.floor(Math.random()*QUIZ_DATA.length)];
            const modal = document.getElementById('game-modal');
            const content = document.getElementById('modal-content');
            const opts = [...q.opts].sort(()=>Math.random()-0.5);
            let btnHtml = "";
            opts.forEach(o => {
                const safeO = o.replace(/'/g, "\\'");
                const safeA = q.a.replace(/'/g, "\\'");
                btnHtml += `<button class="opt-btn" onclick="checkAnswer('${safeO}', '${safeA}')">${o}</button>`;
            });
            content.innerHTML = `
                <span style="background:var(--primary-color); color:white; padding:5px 10px; border-radius:10px;">Quiz</span>
                <div class="quiz-img">${q.img}</div>
                <h2 style="margin:10px 0;">${q.q}</h2>
                <div class="options">${btnHtml}</div>
            `;
            modal.style.display = 'flex';
        }

        window.checkAnswer = function(selected, correct) {
            document.getElementById('game-modal').style.display = 'none';
            if(selected === correct) {
                showFlash("Great! ‚≠ï", "#4caf50"); playSound('correct');
            } else {
                showFlash("Try Again ‚ùå", "#f44336"); playSound('wrong');
            }
            setTimeout(nextTurn, 1500);
        };

        function nextTurn() {
            turn = (turn + 1) % players.length;
            isMoving = false;
            updateHUD();
        }

        function showFlash(text, color) {
            const el = document.getElementById('flash-text');
            el.innerText = text; el.style.color = color;
            el.style.opacity = 1; el.style.transform = "scale(1.5)";
            el.style.transition = "all 0.5s ease-out";
            setTimeout(() => { el.style.opacity = 0; el.style.transform = "scale(0.5)"; }, 1000);
        }
    </script>
</body>
</html>
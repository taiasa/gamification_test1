<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GALAXY GEM HUNTER 6.2: Indian Math Gate</title>
    <style>
        /* --- å¤‰æ•°å®šç¾© --- */
        :root {
            --bg-dark: #050510;
            --bg-mid: #1a1a40;
            --bg-light: #2a2a60;
            --accent-cyan: #00f2ff;
            --accent-magenta: #ff0055;
            --accent-gold: #ffd700;
            --accent-green: #00ff88;
            --glass-bg: rgba(20, 20, 40, 0.9);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text-main: #ffffff;
            --font-main: 'Helvetica Neue', Arial, sans-serif;
            --app-margin: 15px;
            --app-radius: 20px;
        }

        /* --- åŸºæœ¬è¨­å®š --- */
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
            background: #000;
        }
        body {
            font-family: var(--font-main); color: var(--text-main);
            display: flex; justify-content: center; align-items: center;
            touch-action: manipulation;
        }

        /* ã‚¢ãƒ—ãƒªãƒ©ãƒƒãƒ‘ãƒ¼ */
        #app-wrapper {
            width: calc(100% - var(--app-margin) * 2);
            height: calc(100% - var(--app-margin) * 2);
            max-width: 600px; max-height: 900px;
            position: relative;
            background: radial-gradient(circle at center, var(--bg-mid), var(--bg-dark));
            border: 1px solid var(--glass-border);
            border-radius: var(--app-radius);
            box-shadow: 0 0 40px rgba(0, 242, 255, 0.1);
            overflow: hidden; display: flex; flex-direction: column;
        }

        /* èƒŒæ™¯è¦ç´  */
        .stars-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 3s infinite ease-in-out; }
        @keyframes twinkle { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; } }
        #particle-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 90; }

        /* =========================================
           ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚²ãƒ¼ãƒˆ (ã‚¤ãƒ³ãƒ‰å¼ç®—æ•°)
           ========================================= */
        #gate-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.98); z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px;
        }
        .gate-title {
            color: var(--accent-magenta); font-size: 1.5rem; font-weight: 900;
            margin-bottom: 20px; letter-spacing: 2px; text-transform: uppercase;
            border: 2px solid var(--accent-magenta); padding: 10px 20px; border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 0, 85, 0.3);
            background: rgba(255, 0, 85, 0.1);
        }
        .gate-msg { font-size: 0.9rem; color: #ccc; margin-bottom: 30px; line-height: 1.6; max-width: 80%; }
        
        /* ã‚²ãƒ¼ãƒˆå†…ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        #gate-content { display: none; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .gate-progress { font-size: 0.8rem; color: var(--accent-cyan); margin-bottom: 10px; letter-spacing: 2px;}
        
        .timer-bar-bg {
            width: 80%; height: 10px; background: #333; border-radius: 5px; margin-bottom: 20px; overflow: hidden;
        }
        .timer-bar-fill {
            width: 100%; height: 100%; background: var(--accent-green);
            transition: width 0.1s linear, background 0.3s;
        }
        .timer-bar-fill.danger { background: var(--accent-magenta); }

        .gate-q-box {
            font-size: 3.5rem; font-weight: 900; margin: 20px 0;
            font-family: 'Courier New', monospace; text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        .gate-input {
            background: transparent; border: none; border-bottom: 3px solid var(--accent-cyan);
            color: #fff; font-size: 2.5rem; width: 150px; text-align: center; font-weight: bold;
            margin-bottom: 20px; border-radius: 0;
        }
        .gate-input::placeholder { color: #333; }
        
        .btn-gate {
            padding: 15px 40px; font-size: 1.2rem; font-weight: bold;
            background: var(--accent-cyan); color: #000; border: none; border-radius: 50px;
            cursor: pointer; box-shadow: 0 0 20px rgba(0,242,255,0.4);
            margin-top: 10px;
        }
        .gate-alert {
            color: var(--accent-magenta); font-weight: bold; margin-top: 20px; min-height: 1.5em;
            animation: shake 0.4s;
        }
        @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-10px);} 75%{transform:translateX(10px);} }


        /* --- ã‚²ãƒ¼ãƒ æœ¬ç·¨ (ä»¥å‰ã¨åŒæ§˜) --- */
        #game-shaker {
            flex: 1; width: 100%; height: 100%; display: flex; flex-direction: column;
            align-items: center; transition: transform 0.05s; position: relative; z-index: 1;
        }
        
        /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 20, 0.95); z-index: 9999;
            display: none; /* åˆæœŸã¯éè¡¨ç¤º(ã‚²ãƒ¼ãƒˆã‚¯ãƒªã‚¢å¾Œè¡¨ç¤º) */
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px; transition: opacity 0.8s;
            border-radius: var(--app-radius);
        }
        .title-logo {
            font-size: 2rem; font-weight: 900;
            background: linear-gradient(to right, var(--accent-cyan), var(--accent-gold));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px;
            filter: drop-shadow(0 0 15px rgba(0,242,255,0.3));
        }
        .start-btn {
            padding: 15px 60px; font-size: 1.4rem; font-weight: bold;
            color: #fff; background: linear-gradient(45deg, var(--accent-cyan), #00aaff);
            border: none; border-radius: 50px; cursor: pointer;
            box-shadow: 0 0 25px rgba(0, 242, 255, 0.4);
            transition: transform 0.1s; margin-top: 30px;
        }
        .start-btn:active { transform: scale(0.95); }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒ¡ã‚¤ãƒ³ãƒ»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« (å‰å›ã®CSSã‚’æµç”¨) */
        header { width: 100%; padding: 15px 20px; z-index: 10; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--glass-border); }
        .game-title-sm { font-size: 0.9rem; color: var(--accent-cyan); font-weight: bold; }
        .coin-display { font-size: 1.6rem; font-weight: 800; color: var(--accent-gold); text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        .sps-display { font-size: 0.8rem; color: #aaa; margin-top: -3px; text-align: right;}
        
        .main-stage { flex: 1; width: 100%; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; }
        .gem-wrapper { position: relative; z-index: 10; cursor: pointer; width: 200px; height: 200px; display: flex; align-items: center; justify-content: center; -webkit-tap-highlight-color: transparent; }
        .main-gem { font-size: 140px; filter: drop-shadow(0 0 30px rgba(0, 242, 255, 0.4)); animation: float 4s ease-in-out infinite; pointer-events: none; }
        .main-gem.clicked { transform: scale(0.9) rotate(3deg); }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-15px); } }

        .fever-container { width: 80%; max-width: 300px; height: 10px; background: rgba(0,0,0,0.6); border-radius: 6px; margin-top: 40px; position: relative; border: 1px solid #555; overflow: hidden; z-index: 10; }
        .fever-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #ff00cc, #333399, #00f2ff); background-size: 200% 100%; animation: gradientMove 1s linear infinite; }
        .fever-label { position: absolute; top: -20px; left: 0; width: 100%; text-align: center; font-size: 0.65rem; color: var(--accent-magenta); font-weight: bold; letter-spacing: 2px; }
        @keyframes gradientMove { 0% { background-position: 100% 0; } 100% { background-position: -100% 0; } }

        .control-area { width: 100%; height: 45%; background: var(--glass-bg); border-top: 1px solid var(--glass-border); backdrop-filter: blur(20px); display: flex; flex-direction: column; z-index: 80; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
        .tabs { display: flex; width: 100%; border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; background: rgba(255,255,255,0.02); color: #888; font-weight: bold; font-size: 0.9rem; }
        .tab.active { background: rgba(255,255,255,0.1); color: var(--accent-cyan); border-bottom: 3px solid var(--accent-cyan); }
        .panel-content { flex: 1; overflow-y: auto; padding: 15px; display: none; -webkit-overflow-scrolling: touch; }
        .panel-content.active { display: block; }
        
        .shop-item { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); margin-bottom: 8px; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }
        .shop-item.disabled { opacity: 0.5; pointer-events: none; }
        .item-info { display: flex; align-items: center; gap: 12px; }
        .item-icon { font-size: 1.8rem; width: 40px; text-align: center; }
        .item-details h4 { margin: 0; font-size: 0.95rem; color: #fff; }
        .item-details p { margin: 2px 0 0; font-size: 0.75rem; color: #aaa; }
        .buy-btn { background: transparent; border: 1px solid var(--accent-cyan); color: var(--accent-cyan); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; min-width: 90px; font-size: 0.85rem; }
        .buy-btn:hover { background: var(--accent-cyan); color: #000; }

        .gacha-panel { text-align: center; padding: 20px 0; }
        .btn-gacha-lg { width: 100%; max-width: 350px; padding: 25px; background: linear-gradient(45deg, #6a11cb, #2575fc); border: none; border-radius: 15px; color: white; font-size: 1.2rem; font-weight: bold; box-shadow: 0 0 25px rgba(37, 117, 252, 0.4); cursor: pointer; position: relative; overflow: hidden; }
        .collection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(55px, 1fr)); gap: 6px; padding-bottom: 40px; }
        .col-slot { aspect-ratio: 1; background: rgba(0,0,0,0.3); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; border: 1px solid rgba(255,255,255,0.1); }
        .col-slot.locked { font-size: 1rem; opacity: 0.2; filter: grayscale(1); }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(5px); border-radius: var(--app-radius); }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: rgba(15, 15, 30, 0.95); border: 2px solid var(--accent-cyan); border-radius: 16px; padding: 30px; width: 90%; max-width: 450px; text-align: center; transform: scale(0.9); transition: transform 0.3s; }
        .modal.active .modal-content { transform: scale(1); }
        
        /* ãƒ­ãƒœãƒƒãƒˆèƒŒæ™¯ */
        .robots-visual { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 1; overflow: hidden; }
        .robot-sprite { position: absolute; font-size: 24px; transition: all 0.5s; filter: drop-shadow(0 0 5px var(--accent-cyan)); animation: hoverRobot 3s infinite alternate; }
        @keyframes hoverRobot { from { transform: translateY(0); } to { transform: translateY(-10px); } }

        /* ãƒ©ãƒ³ã‚¯è‰² */
        .rank-C { color: #b0c4de; } .rank-B { color: #00bfff; } .rank-A { color: #da70d6; text-shadow: 0 0 10px #da70d6; }
        .rank-S { color: #ff4500; text-shadow: 0 0 15px #ff4500; } .rank-SS { color: #ffd700; text-shadow: 0 0 20px #ffd700; }
        .rank-SSS { background: linear-gradient(to right, #ff00cc, #333399, #00f2ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 25px rgba(255,255,255,0.8); }

    </style>
</head>
<body>
    <div id="app-wrapper">
        <div class="stars-container" id="stars-bg"></div>
        <canvas id="particle-canvas"></canvas>

        <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚²ãƒ¼ãƒˆ (ã‚¤ãƒ³ãƒ‰å¼ç®—æ•°) -->
        <div id="gate-screen">
            <div id="gate-intro">
                <div class="gate-title">SECURITY CHECK</div>
                <div class="gate-msg">
                    <p>è­¦å‘Š: ã‚²ãƒ¼ãƒ ä¸­æ¯’é˜²æ­¢ã‚·ã‚¹ãƒ†ãƒ ä½œå‹•ä¸­</p>
                    <p style="color:#fff; font-weight:bold;">ã“ã®ã‚²ãƒ¼ãƒ ã‚’éŠã¶è³‡æ ¼ãŒã‚ã‚‹ã®ã¯ã€<br>ã€Œã‚¤ãƒ³ãƒ‰å¼ç®—æ•°(19Ã—19)ã€<br>ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ãŸè€…ã ã‘ã§ã™ã€‚</p>
                    <p style="font-size:0.8rem;">11Ã—11ã‹ã‚‰19Ã—19ã®ã‹ã‘ç®—ãŒ<br>5å•å‡ºé¡Œã•ã‚Œã¾ã™ã€‚<br><span style="color:var(--accent-magenta);">1å•ã‚ãŸã‚Š10ç§’ä»¥å†…</span>ã«ç­”ãˆã¦ãã ã•ã„ã€‚<br>1åº¦ã§ã‚‚å¤±æ•—ã™ã‚‹ã¨æœ€åˆã‹ã‚‰ã§ã™ã€‚</p>
                </div>
                <button id="btn-gate-start" class="btn-gate">è©¦é¨“ã‚’é–‹å§‹ã™ã‚‹</button>
            </div>
            
            <div id="gate-content">
                <div class="gate-progress">SECURITY LEVEL <span id="gate-step">1</span>/5</div>
                <div class="timer-bar-bg">
                    <div class="timer-bar-fill" id="gate-timer-bar"></div>
                </div>
                <div class="gate-q-box" id="gate-question">11 Ã— 11</div>
                <input type="number" id="gate-input" class="gate-input" placeholder="?" inputmode="decimal">
                <div class="gate-alert" id="gate-alert"></div>
                <div style="font-size:0.8rem; color:#666; margin-top:20px;">Enterã‚­ãƒ¼ã§é€ä¿¡</div>
            </div>
        </div>

        <!-- æœ¬ç·¨ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
        <div id="start-screen">
            <div class="title-logo">GALAXY GEM HUNTER<br>FINAL COLLECTION</div>
            <div style="color:#aaa; font-size:0.9rem; margin:20px 0;">èªè¨¼æˆåŠŸ: ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯</div>
            <button id="btn-start" class="start-btn">å†’é™ºã‚’å§‹ã‚ã‚‹</button>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ -->
        <div id="game-shaker">
            <header>
                <div class="header-left">
                    <div class="game-title-sm">GGH 6.2</div>
                    <div style="font-size:0.7rem; color:#888;">Indian Math Gate</div>
                </div>
                <div class="score-board">
                    <div class="coin-display">
                        <span style="font-size:1rem; vertical-align:middle;">ğŸª™</span>
                        <span id="coin-val">0</span>
                    </div>
                    <div class="sps-display" id="sps-val">0 /sec</div>
                </div>
            </header>

            <div class="main-stage">
                <div class="robots-visual" id="robots-container"></div>
                
                <div class="gem-wrapper" id="main-gem-wrapper">
                    <div class="main-gem" id="main-gem">ğŸ’</div>
                </div>

                <div class="fever-container">
                    <div class="fever-label">FEVER GAUGE</div>
                    <div class="fever-bar" id="fever-bar"></div>
                </div>
            </div>
        </div>

        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
        <div class="control-area">
            <div class="tabs">
                <div class="tab active" data-target="shop">å·¥å ´</div>
                <div class="tab" data-target="gacha">å¬å–š</div>
                <div class="tab" data-target="collection">å›³é‘‘ <span id="col-count">(0/100)</span></div>
            </div>

            <div id="tab-shop" class="panel-content active">
                <div class="shop-item" id="item-click-upgrade">
                    <div class="item-info">
                        <div class="item-icon">âš¡</div>
                        <div class="item-details">
                            <h4>ãƒ‘ãƒ¯ãƒ¼ãƒ‰ãƒªãƒ«</h4>
                            <p>ã‚¿ãƒƒãƒ—åŠ¹ç‡UP (+1)</p>
                        </div>
                    </div>
                    <button class="buy-btn" id="btn-buy-click"><span id="cost-click">20</span></button>
                </div>
                <div id="robot-list"></div>
            </div>

            <div id="tab-gacha" class="panel-content">
                <div class="gacha-panel">
                    <button class="btn-gacha-lg" id="btn-gacha">å®ç®±ã‚’è§£æã™ã‚‹<br><span style="font-size:0.9rem; color:var(--accent-gold);" id="gacha-cost-disp">Cost: 500</span></button>
                </div>
            </div>

            <div id="tab-collection" class="panel-content">
                <div class="collection-grid" id="collection-grid"></div>
            </div>
        </div>

        <!-- å„ç¨®ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div class="modal" id="math-modal">
            <div class="modal-content">
                <div id="math-rank-badge" style="padding:5px 10px; border-radius:10px; display:inline-block; margin-bottom:10px; font-weight:bold;">RANK A</div>
                <div id="math-q-text" style="font-size:1.4rem; font-weight:bold; margin-bottom:20px;">Question</div>
                <input type="number" id="math-input" style="font-size:1.5rem; padding:10px; width:200px; text-align:center;">
                <button id="btn-math-submit" class="buy-btn" style="margin-top:20px; width:100%; padding:15px; font-size:1.1rem;">è§£é™¤</button>
            </div>
        </div>

        <div class="modal" id="gacha-modal">
            <div class="modal-content" style="background:transparent; border:none; box-shadow:none;">
                <div id="scene-chest" style="text-align:center;">
                    <div style="font-size:8rem; cursor:pointer;" id="chest-obj">ğŸ</div>
                </div>
                <div id="scene-result" style="display:none; text-align:center; background:rgba(0,0,0,0.9); padding:30px; border-radius:20px; border:2px solid var(--accent-cyan);">
                    <div id="res-rank" style="font-size:2rem; font-weight:900;">RANK</div>
                    <div id="res-img" style="font-size:6rem; margin:10px 0;">ğŸ’</div>
                    <div id="res-name" style="font-size:1.2rem; margin-bottom:20px;">Name</div>
                    <button class="buy-btn" id="btn-close-result">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

<script>
(function() {
    'use strict';

    /* =========================================
       AUDIO SYSTEM (éŸ³éŸ¿)
       ========================================= */
    const AudioSys = {
        ctx: null,
        init: function() {
            if (!this.ctx) {
                const AC = window.AudioContext || window.webkitAudioContext;
                if (AC) this.ctx = new AC();
            }
        },
        playTone: function(freq, type, duration, vol=0.1) {
            if (!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            gain.gain.setValueAtTime(0, this.ctx.currentTime);
            gain.gain.linearRampToValueAtTime(vol, this.ctx.currentTime + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
            osc.connect(gain); gain.connect(this.ctx.destination);
            osc.start(); osc.stop(this.ctx.currentTime + duration);
        },
        sfxCorrect: function() { this.playTone(880, 'sine', 0.1, 0.2); setTimeout(()=>this.playTone(1760, 'sine', 0.3, 0.2), 100); },
        sfxWrong: function() { this.playTone(150, 'sawtooth', 0.4, 0.3); },
        sfxTick: function() { this.playTone(1000, 'square', 0.05, 0.05); }
    };

    /* =========================================
       GATE LOGIC (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚²ãƒ¼ãƒˆ)
       ========================================= */
    const Gate = {
        active: true,
        currentStep: 0,
        totalSteps: 5,
        timer: null,
        timeLeft: 10,
        maxTime: 10,
        answer: 0,
        
        init: function() {
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            document.getElementById('btn-gate-start').addEventListener('click', () => {
                AudioSys.init(); // AudioContextæœ‰åŠ¹åŒ–
                document.getElementById('gate-intro').style.display = 'none';
                document.getElementById('gate-content').style.display = 'flex';
                this.nextQuestion();
            });

            const input = document.getElementById('gate-input');
            input.addEventListener('keydown', (e) => {
                if(e.key === 'Enter') this.checkAnswer();
            });
        },

        nextQuestion: function() {
            if(this.currentStep >= this.totalSteps) {
                this.pass();
                return;
            }

            this.currentStep++;
            document.getElementById('gate-step').textContent = this.currentStep;
            
            // ã‚¤ãƒ³ãƒ‰å¼ç®—æ•°: 11~19 Ã— 11~19
            const n1 = Math.floor(Math.random() * 9) + 11;
            const n2 = Math.floor(Math.random() * 9) + 11;
            this.answer = n1 * n2;
            
            document.getElementById('gate-question').textContent = `${n1} Ã— ${n2}`;
            
            const input = document.getElementById('gate-input');
            input.value = '';
            input.focus();

            this.startTimer();
        },

        startTimer: function() {
            if(this.timer) clearInterval(this.timer);
            this.timeLeft = this.maxTime;
            this.updateBar();

            this.timer = setInterval(() => {
                this.timeLeft -= 0.1;
                this.updateBar();

                if(this.timeLeft <= 3 && this.timeLeft > 0) {
                    if(Math.floor(this.timeLeft * 10) % 10 === 0) AudioSys.sfxTick();
                }

                if(this.timeLeft <= 0) {
                    this.fail("æ™‚é–“åˆ‡ã‚Œï¼");
                }
            }, 100);
        },

        updateBar: function() {
            const bar = document.getElementById('gate-timer-bar');
            const pct = (this.timeLeft / this.maxTime) * 100;
            bar.style.width = Math.max(0, pct) + '%';
            if(pct < 30) bar.classList.add('danger');
            else bar.classList.remove('danger');
        },

        checkAnswer: function() {
            const input = document.getElementById('gate-input');
            const val = parseInt(input.value);
            if(isNaN(val)) return;

            if(val === this.answer) {
                AudioSys.sfxCorrect();
                clearInterval(this.timer);
                this.nextQuestion();
            } else {
                this.fail("ä¸æ­£è§£ï¼");
            }
        },

        fail: function(reason) {
            clearInterval(this.timer);
            AudioSys.sfxWrong();
            const alert = document.getElementById('gate-alert');
            alert.textContent = `${reason} æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã§ã™ã€‚`;
            
            // ãƒªã‚»ãƒƒãƒˆæ¼”å‡º
            setTimeout(() => {
                alert.textContent = "";
                this.currentStep = 0;
                document.getElementById('gate-content').style.display = 'none';
                document.getElementById('gate-intro').style.display = 'block';
            }, 2000);
        },

        pass: function() {
            clearInterval(this.timer);
            AudioSys.sfxCorrect();
            // ã‚²ãƒ¼ãƒˆéè¡¨ç¤º -> ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢è¡¨ç¤º
            const gate = document.getElementById('gate-screen');
            gate.style.transition = 'opacity 1s';
            gate.style.opacity = 0;
            setTimeout(() => {
                gate.style.display = 'none';
                const start = document.getElementById('start-screen');
                start.style.display = 'flex';
                // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«åˆæœŸåŒ–ãªã©
                Particles.init(); 
            }, 1000);
        }
    };

    /* =========================================
       GAME CORE (æœ¬ç·¨)
       ========================================= */
    // ä»¥ä¸‹ã€å‰å›ã®ãƒ­ã‚¸ãƒƒã‚¯ã¨ã»ã¼åŒã˜ã§ã™ãŒã€ã‚²ãƒ¼ãƒˆé€šéå¾Œã«å‹•ä½œã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™
    
    const ROBOTS = [
        { name: 'è‡ªå‹•ãƒ‰ãƒ­ãƒ¼ãƒ³', icon: 'ğŸš', sps: 1, cost: 50 },
        { name: 'æ¡æ˜ãƒ­ãƒœãƒƒãƒˆ', icon: 'ğŸ¤–', sps: 5, cost: 300 },
        { name: 'é‡æ©Ÿãƒ‰ãƒªãƒ«', icon: 'ğŸšœ', sps: 20, cost: 1500 },
        { name: 'ãƒ¬ãƒ¼ã‚¶ãƒ¼ç™ºæ˜æ©Ÿ', icon: 'ğŸ”«', sps: 80, cost: 6000 },
        { name: 'ãƒ—ãƒ©ã‚ºãƒæŠ½å‡ºæ©Ÿ', icon: 'âš—ï¸', sps: 250, cost: 20000 },
        { name: 'é‡å­PC', icon: 'ğŸ’»', sps: 800, cost: 80000 },
        { name: 'è»Œé“ã‚¿ãƒ¯ãƒ¼', icon: 'ğŸ—¼', sps: 2500, cost: 300000 },
        { name: 'æœˆé¢åŸºåœ°', icon: 'ğŸŒ‘', sps: 8000, cost: 1200000 }
    ];

    const RANKS = ['C', 'B', 'A', 'S', 'SS', 'SSS'];
    const RANK_PROBS = [40, 25, 15, 10, 7, 3];
    const ITEMS = []; 
    // ã‚¢ã‚¤ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ(ç°¡æ˜“ç‰ˆ)
    for(let i=0; i<100; i++) {
        let r = 'C';
        if(i>30) r='B'; if(i>50) r='A'; if(i>70) r='S'; if(i>85) r='SS'; if(i>95) r='SSS';
        ITEMS.push({ id:i, rank:r, name:`Gem #${i+1}`, icon:['ğŸ’','ğŸ”®','ğŸ’','ğŸ‘‘'][i%4] });
    }

    const State = {
        coins: 0, clickPower: 1, clickCost: 20,
        robots: ROBOTS.map(r=>({...r, count:0, currentCost:r.cost})),
        inventory: new Array(100).fill(0),
        gachaCost: 500, fever: 0, isFever: false,
        pendingItem: null, pendingAns: 0
    };

    function initGame() {
        // æ˜ŸèƒŒæ™¯ç”Ÿæˆ
        const bg = document.getElementById('stars-bg');
        for(let i=0; i<50; i++) {
            const s = document.createElement('div');
            s.className='star'; s.style.left=Math.random()*100+'%'; s.style.top=Math.random()*100+'%';
            s.style.width=Math.random()*3+'px'; s.style.height=s.style.width;
            s.style.animationDelay=Math.random()*5+'s';
            bg.appendChild(s);
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‰
        document.getElementById('btn-start').addEventListener('click', () => {
            document.getElementById('start-screen').style.opacity = 0;
            setTimeout(() => document.getElementById('start-screen').style.display='none', 800);
            setInterval(gameLoop, 100);
        });

        document.getElementById('main-gem-wrapper').addEventListener('mousedown', clickGem);
        document.getElementById('main-gem-wrapper').addEventListener('touchstart', (e)=>{ e.preventDefault(); clickGem(e.touches[0]); });

        document.getElementById('btn-buy-click').addEventListener('click', buyClick);
        document.getElementById('btn-gacha').addEventListener('click', tryGacha);
        document.getElementById('btn-math-submit').addEventListener('click', submitMath);
        document.getElementById('chest-obj').addEventListener('click', openChest);
        document.getElementById('btn-close-result').addEventListener('click', ()=>document.getElementById('gacha-modal').classList.remove('active'));

        // ã‚¿ãƒ–åˆ¶å¾¡
        document.querySelectorAll('.tab').forEach(t => {
            t.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
                t.classList.add('active');
                document.querySelectorAll('.panel-content').forEach(x=>x.classList.remove('active'));
                document.getElementById('tab-'+t.dataset.target).classList.add('active');
            });
        });

        // ã‚·ãƒ§ãƒƒãƒ—åˆæœŸåŒ–
        renderShop();
        renderCollection();
        updateUI();
    }

    /* ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ç³» */
    function gameLoop() {
        let sps = 0;
        State.robots.forEach(r => sps += r.count * r.sps);
        if(State.isFever) sps *= 5;
        if(sps > 0) {
            State.coins += sps / 10;
            updateUI();
        }
        document.getElementById('sps-val').textContent = Math.floor(sps) + "/sec";
        
        if(State.isFever) {
            State.fever -= 0.5;
            document.getElementById('fever-bar').style.width = State.fever + '%';
            if(State.fever <= 0) {
                State.isFever = false;
                document.body.classList.remove('fever-mode');
            }
        }
    }

    function clickGem(e) {
        let p = State.clickPower * (State.isFever ? 5 : 1);
        State.coins += p;
        AudioSys.playTone(800, 'sine', 0.1);
        Particles.spawn(e.clientX||window.innerWidth/2, e.clientY||window.innerHeight/2);
        
        const gem = document.getElementById('main-gem');
        gem.classList.remove('clicked');
        void gem.offsetWidth; gem.classList.add('clicked');
        
        if(!State.isFever) {
            State.fever += 0.5;
            document.getElementById('fever-bar').style.width = State.fever + '%';
            if(State.fever >= 100) {
                State.isFever = true;
                State.fever = 100;
            }
        }
        updateUI();
    }

    function updateUI() {
        document.getElementById('coin-val').textContent = Math.floor(State.coins).toLocaleString();
        document.getElementById('cost-click').textContent = State.clickCost;
        
        const gBtn = document.getElementById('btn-gacha');
        if(State.coins < State.gachaCost) { gBtn.style.opacity=0.5; gBtn.disabled=true; }
        else { gBtn.style.opacity=1; gBtn.disabled=false; }
        document.getElementById('gacha-cost-disp').textContent = "Cost: " + State.gachaCost;
    }

    function renderShop() {
        const list = document.getElementById('robot-list');
        list.innerHTML = '';
        State.robots.forEach((r, i) => {
            const div = document.createElement('div');
            div.className = 'shop-item';
            div.innerHTML = `
                <div class="item-info"><div class="item-icon">${r.icon}</div>
                <div class="item-details"><h4>${r.name}</h4><p>+${r.sps}/s <span style="margin-left:5px">æ‰€æŒ:${r.count}</span></p></div></div>
                <button class="buy-btn" onclick="buyRobot(${i})">${r.currentCost}</button>
            `;
            list.appendChild(div);
        });
    }

    window.buyRobot = function(i) {
        const r = State.robots[i];
        if(State.coins >= r.currentCost) {
            State.coins -= r.currentCost;
            r.count++;
            r.currentCost = Math.floor(r.currentCost * 1.25);
            AudioSys.playTone(400, 'square', 0.1);
            renderShop(); updateUI();
            
            const v = document.createElement('div');
            v.className='robot-sprite'; v.textContent=r.icon;
            v.style.left=Math.random()*90+'%'; v.style.top=Math.random()*90+'%';
            document.getElementById('robots-container').appendChild(v);
        }
    };

    function buyClick() {
        if(State.coins >= State.clickCost) {
            State.coins -= State.clickCost;
            State.clickPower++;
            State.clickCost = Math.floor(State.clickCost * 1.6);
            AudioSys.playTone(600, 'square', 0.1);
            updateUI();
        }
    }

    /* ã‚¬ãƒãƒ£ãƒ»ç®—æ•° (æœ¬ç·¨ã¯ç°¡æ˜“åŒ–: 2æ¡è¶³ã—ç®—) */
    function tryGacha() {
        if(State.coins < State.gachaCost) return;
        State.coins -= State.gachaCost;
        State.gachaCost = Math.floor(State.gachaCost * 1.1);
        updateUI();

        // ãƒ©ãƒ³ã‚¯æŠ½é¸
        let r = Math.random()*100, sum=0, rank='C';
        for(let i=0; i<RANK_PROBS.length; i++) {
            sum += RANK_PROBS[i]; if(r<sum) { rank=RANKS[i]; break; }
        }
        
        const pool = ITEMS.filter(x=>x.rank===rank);
        State.pendingItem = pool[Math.floor(Math.random()*pool.length)];
        
        // æœ¬ç·¨ã®ç®—æ•°å•é¡Œ (ã‚¤ãƒ³ãƒ‰å¼ã§ã¯ãªãé©åº¦ãªé›£æ˜“åº¦)
        const n1 = Math.floor(Math.random()*80)+10;
        const n2 = Math.floor(Math.random()*9)+2;
        State.pendingAns = n1 * n2;
        
        document.getElementById('math-modal').classList.add('active');
        document.getElementById('math-rank-badge').textContent = rank;
        document.getElementById('math-q-text').textContent = `${n1} Ã— ${n2} = ?`;
        document.getElementById('math-input').value = '';
        document.getElementById('math-input').focus();
    }

    function submitMath() {
        const val = parseInt(document.getElementById('math-input').value);
        if(val === State.pendingAns) {
            AudioSys.sfxCorrect();
            document.getElementById('math-modal').classList.remove('active');
            document.getElementById('gacha-modal').classList.add('active');
            document.getElementById('scene-chest').style.display='block';
            document.getElementById('scene-result').style.display='none';
        } else {
            AudioSys.sfxWrong();
            document.getElementById('math-input').value = '';
            document.getElementById('math-input').placeholder = 'Miss!';
        }
    }

    function openChest() {
        document.getElementById('scene-chest').style.display='none';
        document.getElementById('scene-result').style.display='block';
        const it = State.pendingItem;
        State.inventory[it.id]++;
        
        document.getElementById('res-rank').textContent = it.rank;
        document.getElementById('res-img').textContent = it.icon;
        document.getElementById('res-name').textContent = it.name;
        
        // ãƒ©ãƒ³ã‚¯è‰²ã‚¯ãƒ©ã‚¹é©ç”¨
        const re = document.getElementById('res-rank'); re.className=''; re.classList.add('rank-'+it.rank);
        const ri = document.getElementById('res-img'); ri.className=''; ri.classList.add('rank-'+it.rank);
        
        renderCollection();
    }

    function renderCollection() {
        const g = document.getElementById('collection-grid'); g.innerHTML='';
        let c=0;
        ITEMS.forEach((it,i) => {
            const has = State.inventory[i]>0;
            if(has) c++;
            const d = document.createElement('div');
            d.className = 'col-slot ' + (has?'':'locked');
            d.textContent = has ? it.icon : '?';
            g.appendChild(d);
        });
        document.getElementById('col-count').textContent = `(${c}/100)`;
    }

    /* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« (Canvas) */
    const Particles = {
        ctx: null, items: [],
        init: function() {
            const c = document.getElementById('particle-canvas');
            c.width = c.parentElement.offsetWidth; c.height = c.parentElement.offsetHeight;
            this.ctx = c.getContext('2d');
            this.loop();
        },
        spawn: function(x, y) {
            const rect = document.getElementById('app-wrapper').getBoundingClientRect();
            for(let i=0; i<8; i++) {
                this.items.push({
                    x: x - rect.left, y: y - rect.top,
                    vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                    life: 1.0, color: `hsl(${Math.random()*360},100%,70%)`
                });
            }
        },
        loop: function() {
            const {ctx} = this;
            if(!ctx) return;
            ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height);
            for(let i=this.items.length-1; i>=0; i--) {
                const p = this.items[i];
                p.x+=p.vx; p.y+=p.vy; p.vy+=0.5; p.life-=0.05;
                if(p.life<=0) this.items.splice(i,1);
                else {
                    ctx.globalAlpha=p.life; ctx.fillStyle=p.color;
                    ctx.beginPath(); ctx.arc(p.x,p.y,5,0,Math.PI*2); ctx.fill();
                }
            }
            requestAnimationFrame(()=>this.loop());
        }
    };

    // åˆæœŸåŒ–å®Ÿè¡Œ (ã¾ãšã¯ã‚²ãƒ¼ãƒˆã‚’åˆæœŸåŒ–)
    Gate.init();
    initGame(); // ã‚²ãƒ¼ãƒ æœ¬ç·¨ã®æº–å‚™ï¼ˆç”»é¢ã¯éš ã—ã¦ãŠãï¼‰

})();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹ä¹ã‹ã‚‰ã‚ã‚Šç®—ã‚²ãƒ¼ãƒ </title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js CDN for simple sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* æ—¥æœ¬èªè¡¨ç¤ºã«é©ã—ãŸãƒ•ã‚©ãƒ³ãƒˆã‚’è¨­å®š */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #e0f2fe; /* Light Blue Background */
            min-height: 100vh;
        }
        /* å•é¡Œã®æ•°å­—ã‚’èª¿æ•´ã—ã¦ã‚ˆã‚Šç›®ç«‹ã¤ã‚ˆã†ã« */
        #problem-display {
            font-size: 2.5rem; /* 3.5rem ã‹ã‚‰ 2.5rem ã«å¤‰æ›´ã—ã€ä½™ã‚Šã‚ã‚Šã§ã‚‚ä¸€è¡Œã«åã¾ã‚Šã‚„ã™ãã™ã‚‹ */
            font-weight: 800;
            color: #4f46e5; /* Indigo-600 */
            line-height: 1.2;
            transition: transform 0.1s ease-out;
        }
        /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .input-field:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.5);
        }
        /* ãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .btn-primary {
            transition: all 0.15s ease-in-out;
        }
        .btn-primary:hover {
            transform: translateY(-2px); /* ã‚ˆã‚Šç›®ç«‹ã¤ãƒ›ãƒãƒ¼åŠ¹æœ */
            box-shadow: 0 6px 10px -2px rgba(0, 0, 0, 0.2);
        }
        /* ã‚¨ãƒ©ãƒ¼æ™‚ã®æºã‚Œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .shake-error {
            animation: shake 0.3s ease-in-out;
        }
        /* ã‚¹ã‚³ã‚¢ã®æˆåŠŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes score-pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } /* green-500 */
            50% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        .score-animation {
            animation: score-pulse 0.4s ease-out;
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-lg bg-white p-6 md:p-10 rounded-3xl shadow-2xl border-4 border-blue-200 space-y-6">
        <h1 class="text-4xl font-extrabold text-center text-gray-800">ä¹ä¹ã‹ã‚‰ã‚ã‚Šç®—ã‚²ãƒ¼ãƒ </h1>

        <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚¨ãƒªã‚¢ -->
        <div class="flex flex-wrap justify-center gap-3 p-3 bg-blue-50 rounded-xl shadow-inner">
            <label class="flex items-center space-x-2 cursor-pointer">
                <input type="radio" name="game-mode" id="kuku-mode" value="kuku" checked class="form-radio text-blue-600 h-5 w-5">
                <span class="text-gray-700 font-bold">ä¹ä¹ãƒ¢ãƒ¼ãƒ‰</span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
                <input type="radio" name="game-mode" id="warizan-mode" value="warizan" class="form-radio text-blue-600 h-5 w-5">
                <span class="text-gray-700 font-bold">ã‚ã‚Šç®—ãƒ¢ãƒ¼ãƒ‰</span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
                <input type="radio" name="game-mode" id="amari-mode" value="amari" class="form-radio text-blue-600 h-5 w-5">
                <span class="text-gray-700 font-bold">ã‚ã‚Šç®—ï¼ˆä½™ã‚Šã‚ã‚Šï¼‰ãƒ¢ãƒ¼ãƒ‰</span>
            </label>
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¨ãƒªã‚¢ -->
        <div class="flex justify-between items-center text-xl font-extrabold border-b-4 border-gray-100 pb-3">
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-gray-600">æ®‹ã‚Šæ™‚é–“:</span>
                <span id="timer" class="text-red-600 text-2xl font-black">--</span>
            </div>
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-gray-600">ã‚¹ã‚³ã‚¢:</span>
                <span id="score" class="text-green-600 text-2xl font-black">0</span>
            </div>
        </div>

        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
        <div id="message-area" class="text-center p-4 rounded-xl bg-yellow-100 text-yellow-800 font-bold border-2 border-yellow-300">
            ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€â–¡ã‚’ã†ã‚ã‚ˆã†ï¼
        </div>

        <!-- å•é¡Œè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="text-center py-12 bg-indigo-50 rounded-xl shadow-inner">
            <div id="problem-display" class="select-none">
                â–¡ Ã— â–¡ = â–¡
            </div>
        </div>

        <!-- å…¥åŠ›ã¨ãƒœã‚¿ãƒ³ -->
        <div class="flex flex-col space-y-4">
            <!-- å˜ä¸€å›ç­”ç”¨ï¼ˆä¹ä¹/ã‚ã‚Šç®—ãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
            <input type="number" id="single-answer-input" placeholder="ç­”ãˆã‚’å…¥åŠ› (1-9)"
                   class="input-field w-full px-4 py-4 border-4 border-gray-300 rounded-xl text-3xl text-center focus:outline-none focus:border-blue-500"
                   min="1" max="9" disabled>

            <!-- è¤‡æ•°å›ç­”ç”¨ï¼ˆä½™ã‚Šã‚ã‚Šã‚ã‚Šç®—ãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
            <div id="amari-inputs-container" class="flex space-x-4 hidden">
                <div class="flex-1">
                    <label for="quotient-input" class="block text-sm font-bold text-gray-700 text-center mb-1">å•†</label>
                    <input type="number" id="quotient-input" placeholder="å•†" 
                           class="input-field w-full px-4 py-4 border-4 border-gray-300 rounded-xl text-3xl text-center focus:outline-none focus:border-blue-500"
                           min="0" max="9" disabled>
                </div>
                <div class="flex-1">
                    <label for="remainder-input" class="block text-sm font-bold text-gray-700 text-center mb-1">ä½™ã‚Š</label>
                    <input type="number" id="remainder-input" placeholder="ä½™ã‚Š" 
                           class="input-field w-full px-4 py-4 border-4 border-gray-300 rounded-xl text-3xl text-center focus:outline-none focus:border-blue-500"
                           min="0" max="8" disabled>
                </div>
            </div>

            <button id="start-button" class="btn-primary w-full bg-blue-600 text-white font-black py-4 rounded-xl text-2xl shadow-xl hover:bg-blue-700">
                ğŸš€ ã‚¹ã‚¿ãƒ¼ãƒˆ
            </button>

            <button id="submit-button" class="btn-primary w-full bg-green-600 text-white font-black py-4 rounded-xl text-2xl shadow-xl hover:bg-green-700 hidden" disabled>
                âœ… è§£ç­”ã™ã‚‹
            </button>
            
            <!-- è¿½åŠ : ã‚¹ãƒˆãƒƒãƒ—/ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
            <div id="control-buttons" class="flex space-x-4">
                <button id="stop-button" class="btn-primary flex-1 bg-yellow-500 text-white font-bold py-3 rounded-xl text-xl shadow-lg hover:bg-yellow-600" disabled>
                    â¸ï¸ ã‚¹ãƒˆãƒƒãƒ—
                </button>
                <button id="retry-button" class="btn-primary flex-1 bg-red-500 text-white font-bold py-3 rounded-xl text-xl shadow-lg hover:bg-red-600" disabled>
                    ğŸ”„ ãƒªãƒˆãƒ©ã‚¤
                </button>
            </div>
        </div>

    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let score = 0;
        let timeRemaining = 60; // 60ç§’
        let timerInterval;
        let gameRunning = false;
        let gamePaused = false;
        let correctFactor;
        let gameMode = 'kuku';

        // DOMè¦ç´ 
        const timerEl = document.getElementById('timer');
        const scoreEl = document.getElementById('score');
        const problemEl = document.getElementById('problem-display');
        const messageArea = document.getElementById('message-area');
        const startButton = document.getElementById('start-button');
        const submitButton = document.getElementById('submit-button');
        const stopButton = document.getElementById('stop-button');
        const retryButton = document.getElementById('retry-button');

        // å…¥åŠ›è¦ç´ 
        const singleAnswerInput = document.getElementById('single-answer-input');
        const amariInputsContainer = document.getElementById('amari-inputs-container');
        const quotientInput = document.getElementById('quotient-input');
        const remainderInput = document.getElementById('remainder-input');

        // ãƒ¢ãƒ¼ãƒ‰é¸æŠè¦ç´ 
        const kukuModeRadio = document.getElementById('kuku-mode');
        const warizanModeRadio = document.getElementById('warizan-mode');
        const amariModeRadio = document.getElementById('amari-mode');

        // Tone.jsã‚’ä½¿ã£ãŸåŠ¹æœéŸ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        let correctSynth, incorrectSynth, gameStartSynth, gameEndSynth;
        
        try {
            if (Tone) {
                // æ­£è§£éŸ³: Playful chime using a PolySynth for multiple notes
                correctSynth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.3 }
                }).toDestination();

                // ä¸æ­£è§£éŸ³: Low, sharp, percussive sound
                incorrectSynth = new Tone.MembraneSynth({
                    pitchDecay: 0.01,
                    octaves: 1,
                    envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 0.1 },
                    volume: -10
                }).toDestination();

                // ã‚²ãƒ¼ãƒ é–‹å§‹éŸ³
                gameStartSynth = new Tone.Synth({
                    oscillator: { type: "triangle" },
                    envelope: { attack: 0.05, decay: 0.2, sustain: 0.1, release: 0.4 }
                }).toDestination();
                
                // ã‚²ãƒ¼ãƒ çµ‚äº†éŸ³
                gameEndSynth = new Tone.FMSynth({
                    envelope: { attack: 0.01, decay: 0.5, sustain: 0.01, release: 1 },
                    volume: -8
                }).toDestination();
                
            }
        } catch(e) {
            console.warn("Tone.js could not initialize immediately.");
        }


        /**
         * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
         * @param {string} text - è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
         * @param {string} type - 'success', 'error', 'info' ã®ã„ãšã‚Œã‹
         */
        function showMessage(text, type = 'info') {
            let bgColor, textColor, borderColor;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100';
                    textColor = 'text-green-800';
                    borderColor = 'border-green-300';
                    break;
                case 'error':
                    bgColor = 'bg-red-100';
                    textColor = 'text-red-800';
                    borderColor = 'border-red-300';
                    break;
                case 'info':
                default:
                    bgColor = 'bg-yellow-100';
                    textColor = 'text-yellow-800';
                    borderColor = 'border-yellow-300';
                    break;
            }
            messageArea.className = `text-center p-4 rounded-xl font-bold transition-all duration-300 border-2 ${bgColor} ${textColor} ${borderColor}`;
            messageArea.textContent = text;
        }

        /**
         * 1ã€œ9ã®ãƒ©ãƒ³ãƒ€ãƒ ãªæ•´æ•°ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
         * @returns {number} 1ã‹ã‚‰9ã¾ã§ã®æ•´æ•°
         */
        function getRandomKukuNumber() {
            return Math.floor(Math.random() * 9) + 1;
        }

        /**
         * ãƒ¢ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚
         * @param {string} mode - 'kuku', 'warizan', 'amari'
         * @param {boolean} disabled - å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹ã«ã™ã‚‹ã‹ã©ã†ã‹
         */
        function switchInputMode(mode, disabled) {
            if (mode === 'amari') {
                singleAnswerInput.classList.add('hidden');
                amariInputsContainer.classList.remove('hidden');
                quotientInput.disabled = disabled;
                remainderInput.disabled = disabled;
                if (!disabled) quotientInput.focus();
            } else {
                singleAnswerInput.classList.remove('hidden');
                amariInputsContainer.classList.add('hidden');
                singleAnswerInput.disabled = disabled;
                if (!disabled) singleAnswerInput.focus();
            }
            // ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œä½™ã‚Šã€ã«æ›´æ–°ã™ã‚‹
            if (mode === 'amari') {
                remainderInput.placeholder = "ä½™ã‚Š";
            } else {
                remainderInput.placeholder = "ã‚ã¾ã‚Š"; 
            }
        }


        /**
         * æ–°ã—ã„å•é¡Œï¼ˆA Ã— â–¡ = Cã€C Ã· A = â–¡ã€ã¾ãŸã¯ A Ã· B = â–¡ ä½™ã‚Š â–³ï¼‰ã‚’ç”Ÿæˆã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚
         */
        function generateProblem() {
            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
            singleAnswerInput.value = '';
            quotientInput.value = '';
            remainderInput.value = '';

            if (gameMode === 'amari') {
                // A Ã· B = Q ä½™ã‚Š R
                const divisorB = Math.floor(Math.random() * 8) + 2; // å‰²ã‚‹æ•° B (2-9)
                const quotientQ = getRandomKukuNumber(); // å•† Q (1-9)
                const remainderR = Math.floor(Math.random() * (divisorB - 1)) + 1; // ä½™ã‚Š R (1 to B-1)

                const dividendA = divisorB * quotientQ + remainderR; // å‰²ã‚‰ã‚Œã‚‹æ•° A

                correctFactor = { quotient: quotientQ, remainder: remainderR };

                problemEl.innerHTML = `<span>${dividendA}</span> <span class="mx-2">Ã·</span> <span>${divisorB}</span> <span class="mx-2">=</span> <span class="text-red-500">â–¡</span> <span class="text-lg mx-1">ä½™ã‚Š</span> <span class="text-red-500">â–³</span>`;
                
                quotientInput.focus();

            } else {
                // ä¹ä¹/ã‚ã‚Šç®—ãƒ¢ãƒ¼ãƒ‰
                const factorA = getRandomKukuNumber();
                const factorB = getRandomKukuNumber(); // ã“ã‚ŒãŒå¸¸ã«ç­”ãˆ
                const productC = factorA * factorB;

                correctFactor = factorB;

                if (gameMode === 'kuku') {
                    // ä¹ä¹ãƒ¢ãƒ¼ãƒ‰: A Ã— â–¡ = C
                    problemEl.innerHTML = `<span>${factorA}</span> <span class="mx-2">Ã—</span> <span class="text-red-500">â–¡</span> <span class="mx-2">=</span> <span>${productC}</span>`;
                } else {
                    // ã‚ã‚Šç®—ãƒ¢ãƒ¼ãƒ‰: C Ã· A = â–¡
                    problemEl.innerHTML = `<span>${productC}</span> <span class="mx-2">Ã·</span> <span>${factorA}</span> <span class="mx-2">=</span> <span class="text-red-500">â–¡</span>`;
                }

                singleAnswerInput.focus();
            }
        }

        /**
         * åˆ¶é™æ™‚é–“ã‚’æ›´æ–°ã—ã€0ã«ãªã£ãŸã‚‰ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚
         */
        function updateTimer() {
            if (gamePaused) return;

            timeRemaining--;
            timerEl.textContent = timeRemaining;

            if (timeRemaining <= 0) {
                endGame();
            }
        }

        /**
         * ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ã€‚
         */
        function startGame() {
            if (gameRunning) return;

            score = 0;
            timeRemaining = 60;
            gameRunning = true;
            gamePaused = false;
            scoreEl.textContent = score;
            timerEl.textContent = timeRemaining;
            scoreEl.classList.remove('score-animation'); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ

            // åŠ¹æœéŸ³: ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ
            if (gameStartSynth) {
                gameStartSynth.triggerAttackRelease("G4", "8n", "+0", 0.3);
                gameStartSynth.triggerAttackRelease("C5", "8n", "+0.1", 0.3);
            }

            // ã‚¿ã‚¤ãƒãƒ¼ã®é–‹å§‹
            clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);

            // UIã®åˆ‡ã‚Šæ›¿ãˆ
            startButton.classList.add('hidden');
            submitButton.classList.remove('hidden');
            
            stopButton.disabled = false;
            retryButton.disabled = false;
            stopButton.textContent = 'â¸ï¸ ã‚¹ãƒˆãƒƒãƒ—';
            
            switchInputMode(gameMode, false); // å…¥åŠ›ã‚’æœ‰åŠ¹åŒ–

            showMessage(`ã‚ˆãƒ¼ã„ã€ã‚¹ã‚¿ãƒ¼ãƒˆï¼${gameMode === 'kuku' ? 'ä¹ä¹' : gameMode === 'warizan' ? 'ã‚ã‚Šç®—' : 'ä½™ã‚Šã‚ã‚Šã‚ã‚Šç®—'}ãƒ¢ãƒ¼ãƒ‰ã§é ‘å¼µã‚ã†ï¼`, 'info');
            generateProblem();
        }

        /**
         * ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã€çµæœã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
         */
        function endGame() {
            gameRunning = false;
            clearInterval(timerInterval);

            // åŠ¹æœéŸ³: ã‚²ãƒ¼ãƒ çµ‚äº†
            if (gameEndSynth) {
                gameEndSynth.triggerAttackRelease("F3", "4n", "+0", 0.5);
                gameEndSynth.triggerAttackRelease("C3", "4n", "+0.2", 0.5);
            }

            // UIã®åˆ‡ã‚Šæ›¿ãˆ
            startButton.classList.remove('hidden');
            submitButton.classList.add('hidden');
            
            stopButton.disabled = true;
            retryButton.disabled = true;
            stopButton.textContent = 'â¸ï¸ ã‚¹ãƒˆãƒƒãƒ—';

            switchInputMode(gameMode, true);
            
            problemEl.innerHTML = 'â–¡ Ã— â–¡ = â–¡'; 

            // çµ‚äº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            let finalMessage;
            if (score >= 30) {
                finalMessage = `ğŸ† çµ‚äº†ï¼ã‚¹ã‚³ã‚¢ã¯${score}ç‚¹ã§ã—ãŸï¼é©šç•°çš„ãªã‚¹ãƒ”ãƒ¼ãƒ‰ã§ã™ï¼`;
            } else if (score >= 15) {
                finalMessage = `ğŸ˜„ çµ‚äº†ï¼ã‚¹ã‚³ã‚¢ã¯${score}ç‚¹ã§ã—ãŸã€‚ç´ æ™´ã‚‰ã—ã„å‡ºæ¥ã§ã™ï¼`;
            } else {
                finalMessage = `ğŸ’ª çµ‚äº†ï¼ã‚¹ã‚³ã‚¢ã¯${score}ç‚¹ã§ã™ã€‚æ¬¡ã¯ã‚‚ã£ã¨é›†ä¸­ã—ã¦é ‘å¼µã‚ã†ï¼`;
            }
            showMessage(finalMessage, 'info');
        }

        /**
         * ã‚²ãƒ¼ãƒ ã®ä¸€æ™‚åœæ­¢/å†é–‹ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚
         */
        function togglePause() {
            if (!gameRunning) return;

            gamePaused = !gamePaused;

            if (gamePaused) {
                // ä¸€æ™‚åœæ­¢
                stopButton.textContent = 'â–¶ï¸ å†é–‹';
                switchInputMode(gameMode, true); // å…¥åŠ›ã‚’ç„¡åŠ¹åŒ–
                submitButton.disabled = true;
                showMessage('â¸ï¸ ã‚²ãƒ¼ãƒ ä¸€æ™‚åœæ­¢ä¸­ã€‚å†é–‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­ï¼', 'info');
                clearInterval(timerInterval); // ã‚¿ã‚¤ãƒãƒ¼ã‚’æ­¢ã‚ã‚‹
            } else {
                // å†é–‹
                stopButton.textContent = 'â¸ï¸ ã‚¹ãƒˆãƒƒãƒ—';
                switchInputMode(gameMode, false); // å…¥åŠ›ã‚’æœ‰åŠ¹åŒ–
                submitButton.disabled = false;
                showMessage('â–¶ï¸ å†é–‹ï¼æ™‚é–“ã‚’ç„¡é§„ã«ã—ãªã„ã§ï¼', 'success');
                timerInterval = setInterval(updateTimer, 1000); // ã‚¿ã‚¤ãƒãƒ¼ã‚’å†é–‹
            }
        }
        
        /**
         * ã‚²ãƒ¼ãƒ ã‚’ãƒªãƒˆãƒ©ã‚¤ã—ã€åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã€‚
         */
        function resetGame() {
            // å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆ
            gameRunning = false;
            gamePaused = false;
            clearInterval(timerInterval);
            
            // UIã®ãƒªã‚»ãƒƒãƒˆ
            score = 0;
            timeRemaining = 60;
            scoreEl.textContent = score;
            timerEl.textContent = '--';
            problemEl.innerHTML = 'â–¡ Ã— â–¡ = â–¡';
            scoreEl.classList.remove('score-animation');
            
            // ãƒœã‚¿ãƒ³ã¨å…¥åŠ›ã®åˆ‡ã‚Šæ›¿ãˆ
            startButton.classList.remove('hidden');
            submitButton.classList.add('hidden');
            
            stopButton.textContent = 'â¸ï¸ ã‚¹ãƒˆãƒƒãƒ—';
            stopButton.disabled = true;
            retryButton.disabled = true;
            
            switchInputMode(gameMode, true); // å…¥åŠ›ã‚’ç„¡åŠ¹åŒ–
            
            showMessage('â†©ï¸ ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦å†é–‹ï¼', 'info');
        }

        /**
         * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã¿ã¾ã™ã€‚
         */
        function checkAnswer() {
            if (!gameRunning || gamePaused) return;

            let isCorrect = false;
            let focusEl;

            if (gameMode === 'amari') {
                // ã‚ã‚Šç®—ï¼ˆä½™ã‚Šã‚ã‚Šï¼‰ãƒ¢ãƒ¼ãƒ‰ã®åˆ¤å®š
                const userQuotient = parseInt(quotientInput.value, 10);
                const userRemainder = parseInt(remainderInput.value, 10);
                const correctQuotient = correctFactor.quotient;
                const correctRemainder = correctFactor.remainder;

                if (isNaN(userQuotient)) {
                    showMessage('å•†ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼', 'error');
                    quotientInput.focus();
                    return;
                }
                if (isNaN(userRemainder)) {
                    showMessage('ä½™ã‚Šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼', 'error');
                    remainderInput.focus();
                    return;
                }

                isCorrect = (userQuotient === correctQuotient) && (userRemainder === correctRemainder);
                focusEl = quotientInput;

            } else {
                // ä¹ä¹/ã‚ã‚Šç®—ãƒ¢ãƒ¼ãƒ‰ã®åˆ¤å®š
                const userAnswer = parseInt(singleAnswerInput.value, 10);
                
                // 1. å›ç­”ãŒ1ã€œ9ã®ç¯„å›²å†…ã‹ã€ã¾ãŸã¯æ•°å­—ã‹ãƒã‚§ãƒƒã‚¯
                if (isNaN(userAnswer) || userAnswer < 1 || userAnswer > 9) {
                    showMessage('ç­”ãˆã¯1ã‹ã‚‰9ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼', 'error');
                    singleAnswerInput.value = '';
                    singleAnswerInput.focus();
                    return;
                }
                isCorrect = userAnswer === correctFactor;
                focusEl = singleAnswerInput;
            }

            // 2. æ­£èª¤åˆ¤å®šå¾Œã®å‡¦ç†
            if (isCorrect) {
                score++;
                scoreEl.textContent = score;

                // ã‚¹ã‚³ã‚¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é©ç”¨
                scoreEl.classList.remove('score-animation');
                // DOMã®å†æç”»ã‚’å¼·åˆ¶ã™ã‚‹ãŸã‚ã®setTimeout
                setTimeout(() => scoreEl.classList.add('score-animation'), 10);

                // åŠ¹æœéŸ³: æ­£è§£
                if(correctSynth) {
                    correctSynth.triggerAttackRelease(["C6", "E6"], "8n");
                }

                showMessage('ğŸ˜Š æ­£è§£ï¼æ¬¡ã¸é€²ã‚‚ã†ï¼', 'success');

                setTimeout(generateProblem, 500);
            } else {
                // åŠ¹æœéŸ³: ä¸æ­£è§£
                if(incorrectSynth) incorrectSynth.triggerAttackRelease("C2", "8n");

                showMessage('âŒ æ®‹å¿µï¼é•ã†ã‚ˆã€‚å†ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼', 'error');
                
                messageArea.classList.add('shake-error');
                setTimeout(() => {
                    messageArea.classList.remove('shake-error');
                }, 300);

                focusEl.focus(); 
            }
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. ã‚²ãƒ¼ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            startButton.addEventListener('click', startGame);
            submitButton.addEventListener('click', checkAnswer);
            
            // 2. ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            stopButton.addEventListener('click', togglePause);
            retryButton.addEventListener('click', resetGame);
            
            // å˜ä¸€å›ç­”ç”¨Enterã‚­ãƒ¼
            singleAnswerInput.addEventListener('keydown', (e) => {
                if (gameRunning && !gamePaused && e.key === 'Enter') {
                    e.preventDefault();
                    checkAnswer();
                }
            });

            // è¤‡æ•°å›ç­”ç”¨Enterã‚­ãƒ¼
            const handleAmariKeydown = (e) => {
                 if (gameRunning && !gamePaused && e.key === 'Enter') {
                    e.preventDefault();
                    checkAnswer();
                }
            };
            quotientInput.addEventListener('keydown', handleAmariKeydown);
            remainderInput.addEventListener('keydown', handleAmariKeydown);


            // 3. ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒªã‚¹ãƒŠãƒ¼
            [kukuModeRadio, warizanModeRadio, amariModeRadio].forEach(radio => {
                radio.addEventListener('change', () => {
                    gameMode = radio.value;
                    // ã‚²ãƒ¼ãƒ å®Ÿè¡Œä¸­ã¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ™‚ã«å•é¡Œã‚’å†ç”Ÿæˆ
                    if (gameRunning) { 
                        switchInputMode(gameMode, false);
                        generateProblem(); 
                        showMessage(`ã‚ˆãƒ¼ã„ã€ã‚¹ã‚¿ãƒ¼ãƒˆï¼${gameMode === 'kuku' ? 'ä¹ä¹' : gameMode === 'warizan' ? 'ã‚ã‚Šç®—' : 'ä½™ã‚Šã‚ã‚Šã‚ã‚Šç®—'}ãƒ¢ãƒ¼ãƒ‰ã§é ‘å¼µã‚ã†ï¼`, 'info'); 
                    } else {
                        // ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã¯UIã®ã¿åˆ‡ã‚Šæ›¿ãˆã‚‹
                        switchInputMode(gameMode, true);
                    }
                });
            });
            
            // åˆæœŸçŠ¶æ…‹ã®UIã‚’æ­£ã—ãè¨­å®š
            switchInputMode(gameMode, true);
        });

    </script>
</body>
</html>

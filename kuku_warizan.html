<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‹ã‘ç®—ã‹ã‚‰ã‚ã‚Šç®—ã¸ï¼ç©´åŸ‹ã‚è¨ˆç®—ã‚²ãƒ¼ãƒ </title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js CDN for simple sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* æ—¥æœ¬èªè¡¨ç¤ºã«é©ã—ãŸãƒ•ã‚©ãƒ³ãƒˆã‚’è¨­å®š */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f0f4f8;
            min-height: 100vh;
        }
        /* å•é¡Œã®æ•°å­—ã‚’å¤§ããã€è¦‹ã‚„ã™ã */
        #problem-display {
            font-size: 4rem;
            font-weight: 700;
            color: #1e3a8a; /* Blue-900 */
        }
        /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #answer-input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.5);
        }
        /* ãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .btn-primary {
            transition: all 0.15s ease-in-out;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* ã‚¨ãƒ©ãƒ¼æ™‚ã®æºã‚Œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .shake-error {
            animation: shake 0.3s ease-in-out;
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-lg bg-white p-6 md:p-10 rounded-2xl shadow-2xl space-y-6">
        <h1 class="text-3xl font-bold text-center text-gray-800">ä¹ä¹ â†’ ã‚ã‚Šç®— ã‚²ãƒ¼ãƒ </h1>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¨ãƒªã‚¢ -->
        <div class="flex justify-between items-center text-lg font-semibold border-b pb-3">
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-gray-600">æ®‹ã‚Šæ™‚é–“:</span>
                <span id="timer" class="text-red-600">--</span>
            </div>
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-gray-600">ã‚¹ã‚³ã‚¢:</span>
                <span id="score" class="text-green-600">0</span>
            </div>
        </div>

        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
        <div id="message-area" class="text-center p-4 rounded-lg bg-yellow-100 text-yellow-800 font-medium">
            ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€ä¹ä¹ã‚’ä½¿ã£ãŸè¨ˆç®—ã«æŒ‘æˆ¦ã—ã‚ˆã†ï¼
        </div>

        <!-- å•é¡Œè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="text-center py-8">
            <div id="problem-display" class="select-none">
                â–¡ Ã— â–¡ = â–¡
            </div>
        </div>

        <!-- å…¥åŠ›ã¨ãƒœã‚¿ãƒ³ -->
        <div class="flex flex-col space-y-4">
            <input type="number" id="answer-input" placeholder="ã“ã“ã«ç­”ãˆã‚’å…¥åŠ›"
                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-2xl text-center focus:outline-none"
                   min="1" max="9" disabled>

            <button id="start-button" class="btn-primary w-full bg-blue-600 text-white font-bold py-3 rounded-xl text-xl shadow-lg hover:bg-blue-700">
                ã‚¹ã‚¿ãƒ¼ãƒˆ
            </button>

            <button id="submit-button" class="btn-primary w-full bg-green-600 text-white font-bold py-3 rounded-xl text-xl shadow-lg hover:bg-green-700 hidden" disabled>
                è§£ç­”ã™ã‚‹
            </button>
        </div>

    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let score = 0;
        let timeRemaining = 60; // 60ç§’
        let timerInterval;
        let gameRunning = false;
        let correctFactor; // æ­£ã—ã„ç­”ãˆï¼ˆâ–¡ã«å…¥ã‚‹æ•°ï¼‰

        // DOMè¦ç´ 
        const timerEl = document.getElementById('timer');
        const scoreEl = document.getElementById('score');
        const problemEl = document.getElementById('problem-display');
        const answerInput = document.getElementById('answer-input');
        const messageArea = document.getElementById('message-area');
        const startButton = document.getElementById('start-button');
        const submitButton = document.getElementById('submit-button');

        // Tone.jsã‚’ä½¿ã£ãŸåŠ¹æœéŸ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        let correctSynth, incorrectSynth;

        if (Tone) {
            // æ­£è§£éŸ³: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ™ãƒ«
            correctSynth = new Tone.MembraneSynth().toDestination();
            // ä¸æ­£è§£éŸ³: ä½ã„ãƒã‚¤ã‚º
            incorrectSynth = new Tone.NoiseSynth({
                noise: { type: 'white' },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }
            }).toDestination();
        } else {
            console.error("Tone.jsãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚éŸ³å£°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚");
        }

        /**
         * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
         * @param {string} text - è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
         * @param {string} type - 'success', 'error', 'info' ã®ã„ãšã‚Œã‹
         */
        function showMessage(text, type = 'info') {
            let bgColor, textColor;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100';
                    textColor = 'text-green-800';
                    break;
                case 'error':
                    bgColor = 'bg-red-100';
                    textColor = 'text-red-800';
                    break;
                case 'info':
                default:
                    bgColor = 'bg-yellow-100';
                    textColor = 'text-yellow-800';
                    break;
            }
            messageArea.className = `text-center p-4 rounded-lg font-medium transition-all duration-300 ${bgColor} ${textColor}`;
            messageArea.textContent = text;
        }

        /**
         * 1ã€œ9ã®ãƒ©ãƒ³ãƒ€ãƒ ãªæ•´æ•°ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
         * @returns {number} 1ã‹ã‚‰9ã¾ã§ã®æ•´æ•°
         */
        function getRandomKukuNumber() {
            return Math.floor(Math.random() * 9) + 1;
        }

        /**
         * æ–°ã—ã„å•é¡Œï¼ˆA Ã— â–¡ = Cï¼‰ã‚’ç”Ÿæˆã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚
         */
        function generateProblem() {
            // A (æœ€åˆã®å› æ•°) ã¨ B (ç©´åŸ‹ã‚ã®å› æ•°) ã‚’1ã€œ9ã§ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆ
            const factorA = getRandomKukuNumber();
            const factorB = getRandomKukuNumber();
            const productC = factorA * factorB;

            // æ­£ã—ã„ç­”ãˆã‚’ä¿å­˜
            correctFactor = factorB;

            // å•é¡Œã‚’ 'A Ã— â–¡ = C' ã®å½¢å¼ã§è¡¨ç¤º
            problemEl.innerHTML = `<span>${factorA}</span> <span class="mx-4">Ã—</span> <span class="text-red-500">â–¡</span> <span class="mx-4">=</span> <span>${productC}</span>`;

            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            answerInput.value = '';
            answerInput.focus();
        }

        /**
         * åˆ¶é™æ™‚é–“ã‚’æ›´æ–°ã—ã€0ã«ãªã£ãŸã‚‰ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚
         */
        function updateTimer() {
            timeRemaining--;
            timerEl.textContent = timeRemaining;

            if (timeRemaining <= 0) {
                endGame();
            }
        }

        /**
         * ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ã€‚
         */
        function startGame() {
            if (gameRunning) return;

            score = 0;
            timeRemaining = 60;
            gameRunning = true;
            scoreEl.textContent = score;
            timerEl.textContent = timeRemaining;

            // ã‚¿ã‚¤ãƒãƒ¼ã®é–‹å§‹
            clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);

            // UIã®åˆ‡ã‚Šæ›¿ãˆ
            startButton.classList.add('hidden');
            submitButton.classList.remove('hidden');
            answerInput.disabled = false;
            submitButton.disabled = false;

            showMessage('ã‚ˆãƒ¼ã„ã€ã‚¹ã‚¿ãƒ¼ãƒˆï¼åˆ¶é™æ™‚é–“å†…ã«ãŸãã•ã‚“è§£ã“ã†ï¼', 'info');
            generateProblem();
        }

        /**
         * ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã€çµæœã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
         */
        function endGame() {
            gameRunning = false;
            clearInterval(timerInterval);

            // UIã®åˆ‡ã‚Šæ›¿ãˆ
            startButton.classList.remove('hidden');
            submitButton.classList.add('hidden');
            answerInput.disabled = true;
            submitButton.disabled = true;
            // å•é¡Œè¡¨ç¤ºã‚’ã€Œâ–¡ Ã— â–¡ = â–¡ã€ã«ãƒªã‚»ãƒƒãƒˆ
            problemEl.innerHTML = 'â–¡ Ã— â–¡ = â–¡'; 

            // çµ‚äº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            let finalMessage;
            if (score >= 30) {
                finalMessage = `ğŸ† çµ‚äº†ï¼ã‚¹ã‚³ã‚¢ã¯${score}ç‚¹ã§ã—ãŸï¼é©šç•°çš„ãªã‚¹ãƒ”ãƒ¼ãƒ‰ã§ã™ï¼`;
            } else if (score >= 15) {
                finalMessage = `ğŸ˜„ çµ‚äº†ï¼ã‚¹ã‚³ã‚¢ã¯${score}ç‚¹ã§ã—ãŸã€‚ç´ æ™´ã‚‰ã—ã„å‡ºæ¥ã§ã™ï¼`;
            } else {
                finalMessage = `ğŸ’ª çµ‚äº†ï¼ã‚¹ã‚³ã‚¢ã¯${score}ç‚¹ã§ã™ã€‚æ¬¡ã¯ã‚‚ã£ã¨é›†ä¸­ã—ã¦é ‘å¼µã‚ã†ï¼`;
            }
            showMessage(finalMessage, 'info');
        }

        /**
         * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã¿ã¾ã™ã€‚
         */
        function checkAnswer() {
            if (!gameRunning) return;

            const userAnswer = parseInt(answerInput.value, 10);
            
            // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
            console.log(`[checkAnswer] User Input: ${answerInput.value}, Parsed: ${userAnswer}, Correct Answer: ${correctFactor}`);


            // 1. å›ç­”ãŒ1ã€œ9ã®ç¯„å›²å†…ã‹ã€ã¾ãŸã¯æ•°å­—ã‹ãƒã‚§ãƒƒã‚¯
            if (isNaN(userAnswer) || userAnswer < 1 || userAnswer > 9) {
                console.log('[checkAnswer] ERROR: Input out of range (1-9).');
                showMessage('ç­”ãˆã¯1ã‹ã‚‰9ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼', 'error');
                // ç„¡åŠ¹ãªå…¥åŠ›ã®å ´åˆã€å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã€åŒã˜å•é¡Œã«å†æŒ‘æˆ¦ã§ãã‚‹ã‚ˆã†ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
                answerInput.value = '';
                answerInput.focus();
                return; // ã“ã“ã§å‡¦ç†ã‚’çµ‚äº†ã—ã€å†æŒ‘æˆ¦ã‚’ä¿ƒã™
            }

            // 2. æ­£èª¤åˆ¤å®š
            const isCorrect = userAnswer === correctFactor;
            const timeBonus = 3; // æ­£è§£æ™‚ã€æ®‹ã‚Šæ™‚é–“ãŒ3ç§’ä»¥ä¸‹ãªã‚‰ãƒœãƒ¼ãƒŠã‚¹

            if (isCorrect) {
                console.log('[checkAnswer] CORRECT PATH EXECUTED.');
                // æ­£è§£ã®å‡¦ç†
                score++;
                scoreEl.textContent = score;

                // åŠ¹æœéŸ³
                if(correctSynth) correctSynth.triggerAttackRelease("C5", "8n");

                // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                let feedbackText;
                if (timeRemaining <= timeBonus) {
                    // ã‚¹ã‚³ã‚¢ãŒé«˜ã„å ´åˆã‚„æ™‚é–“ãŒå°‘ãªã„å ´åˆã€ã‚ˆã‚Šå¼·èª¿
                    feedbackText = 'ğŸ‰ è¶…é€Ÿæ­£è§£ï¼æ®‹ã‚Šã‚ãšã‹ã§ãƒœãƒ¼ãƒŠã‚¹ç²å¾—ï¼';
                } else if (answerInput.dataset.responseTime && (Date.now() - parseInt(answerInput.dataset.responseTime) < 2000)) {
                     feedbackText = 'ğŸ‘ æ­£è§£ï¼ç´ æ™´ã‚‰ã—ã„ã‚¹ãƒ”ãƒ¼ãƒ‰ï¼';
                } else {
                    feedbackText = 'ğŸ˜Š æ­£è§£ï¼æ¬¡ã¸é€²ã‚‚ã†ï¼';
                }
                showMessage(feedbackText, 'success');

                // æ¬¡ã®å•é¡Œã¸
                setTimeout(generateProblem, 500); // 0.5ç§’å¾Œã«æ¬¡ã®å•é¡Œã‚’å‡ºã™
                answerInput.dataset.responseTime = Date.now(); // å¿œç­”æ™‚é–“è¨˜éŒ²ã®é–‹å§‹
            } else {
                // ä¸æ­£è§£ã®å‡¦ç† (ãƒšãƒŠãƒ«ãƒ†ã‚£ãªã—)
                console.log('[checkAnswer] INCORRECT PATH EXECUTED. No time penalty applied.');
                
                // === ä»¥å‰ã®æ™‚é–“ãƒšãƒŠãƒ«ãƒ†ã‚£ã®è¡Œã‚’å‰Šé™¤/ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ ===
                // timeRemaining = Math.max(0, timeRemaining - 3);
                // timerEl.textContent = timeRemaining;
                // ===============================================

                // åŠ¹æœéŸ³
                if(incorrectSynth) incorrectSynth.triggerAttackRelease("A3", "16n");

                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                showMessage('âŒ æ®‹å¿µï¼é•ã†ã‚ˆã€‚å†ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼', 'error');
                
                // è¦–è¦šçš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¿½åŠ  (æºã‚Œ)
                messageArea.classList.add('shake-error');
                setTimeout(() => {
                    messageArea.classList.remove('shake-error');
                }, 300);

                // ä¸æ­£è§£ã®å ´åˆã€å•é¡Œã¯å¤‰ãˆãšã€å…¥åŠ›ã ã‘ãƒªã‚»ãƒƒãƒˆ
                answerInput.value = '';
                answerInput.focus();
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        document.addEventListener('DOMContentLoaded', () => {
            // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
            startButton.addEventListener('click', startGame);

            // è§£ç­”ãƒœã‚¿ãƒ³
            submitButton.addEventListener('click', checkAnswer);

            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§Enterã‚­ãƒ¼ã‚’æŠ¼ã—ãŸæ™‚
            answerInput.addEventListener('keydown', (e) => {
                // ã‚²ãƒ¼ãƒ ãŒå‹•ã„ã¦ã„ã‚‹ã€ã‹ã¤Enterã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸå ´åˆ
                if (gameRunning && e.key === 'Enter') {
                    e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®Enterå‹•ä½œï¼ˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãªã©ï¼‰ã‚’é˜²ã
                    checkAnswer();
                }
            });
        });

    </script>
</body>
</html>
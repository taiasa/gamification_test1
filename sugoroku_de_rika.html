<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã™ã”ã‚ã DE ç†ç§‘ï¼ ãƒã‚¤ãƒ‘ãƒ¼ãƒ—ãƒ©ã‚¹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700;900&display=swap');

        :root {
            --bg-gradient: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background: var(--bg-gradient);
            height: 100vh;
            margin: 0;
            overflow: hidden;
            color: #ffffff;
        }

        .board-wrapper {
            width: 98vw;
            max-width: 1100px;
            height: 55vh;
            margin: 0 auto;
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 15px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
        }

        .board-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 4px;
            height: 100%;
            width: 100%;
        }

        .tile {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            position: relative;
            transition: all 0.2s;
            border-bottom: 3px solid rgba(0,0,0,0.3);
            font-weight: 800;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .tile.active-path {
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255,255,255,0.5);
        }

        .tile-gimmick { animation: pulse 1.5s infinite; background: #fbbf24 !important; color: #000 !important; }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(251, 191, 36, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); }
        }

        .tile-danger { background: #ef4444 !important; animation: shake 0.5s infinite; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-1px, -2px) rotate(-1deg); }
            50% { transform: translate(-2px, 0px) rotate(1deg); }
            100% { transform: translate(1px, 1px) rotate(0deg); }
        }

        .player-pawn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            position: absolute;
            z-index: 100;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border: 2px solid white;
        }

        .dice-btn {
            background: linear-gradient(to bottom, #fde68a, #fbbf24);
            color: #1e293b;
            padding: 12px 50px;
            font-size: 1.8rem;
            font-weight: 900;
            border-radius: 50px;
            box-shadow: 0 6px 0 #b45309;
            transition: all 0.1s;
        }
        .dice-btn:active:not(:disabled) { transform: translateY(4px); box-shadow: 0 2px 0 #b45309; }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }
        .modal.active { display: flex; }

        .card {
            background: white;
            padding: 30px;
            border-radius: 30px;
            max-width: 600px;
            width: 90%;
            color: #1e293b;
            text-align: center;
        }

        .option-btn {
            width: 100%;
            padding: 15px;
            margin: 8px 0;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 700;
        }
        .option-btn:hover { background: #eff6ff; border-color: #3b82f6; }

        .flash-correct { animation: flashG 0.4s ease-out; }
        @keyframes flashG { 0% { background: #22c55e; } 100% { background: transparent; } }
        .flash-wrong { animation: flashR 0.4s ease-out; }
        @keyframes flashR { 0% { background: #ef4444; } 100% { background: transparent; } }
    </style>
</head>
<body id="gameBody">

    <!-- Start Screen -->
    <div id="startScreen" class="fixed inset-0 z-[2000] bg-slate-900 flex flex-col items-center justify-center p-6 text-center">
        <h1 class="text-6xl font-black text-yellow-400 mb-4 drop-shadow-2xl">ã™ã”ã‚ã DE ç†ç§‘ï¼<br><span class="text-3xl text-white">â˜… å°ä¸­ä¸€è²«ãƒã‚¤ãƒ‘ãƒ¼ãƒ—ãƒ©ã‚¹ â˜…</span></h1>
        
        <div class="bg-white/5 p-6 rounded-2xl mb-8 max-w-xl border border-white/10 text-sm">
            <p class="text-yellow-300 font-bold mb-2">ã€ãƒ¬ãƒ™ãƒ«è¨­å®šã€‘</p>
            <p>å‰åŠï¼ˆ1ã€œ39ãƒã‚¹ï¼‰ï¼šå°å­¦æ ¡ãƒ¬ãƒ™ãƒ«ã®åŸºç¤çŸ¥è­˜</p>
            <p class="mb-4">å¾ŒåŠï¼ˆåˆ†å²ä»¥é™ï¼‰ï¼šä¸­å­¦æ ¡ãƒ¬ãƒ™ãƒ«ã®ç™ºå±•çŸ¥è­˜</p>
            <p class="text-xs text-slate-400">â€»å…¨100å•ä»¥ä¸Šã®å•é¡Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ­è¼‰ï¼</p>
        </div>

        <div class="mb-8">
            <p class="text-xl font-bold mb-4">å‚åŠ äººæ•°ã‚’é¸ã‚“ã§ã‚¹ã‚¿ãƒ¼ãƒˆï¼</p>
            <div class="flex gap-4">
                <button onclick="startGame(1)" class="w-16 h-16 bg-blue-500 rounded-2xl text-2xl font-black shadow-lg">1</button>
                <button onclick="startGame(2)" class="w-16 h-16 bg-green-500 rounded-2xl text-2xl font-black shadow-lg">2</button>
                <button onclick="startGame(3)" class="w-16 h-16 bg-orange-500 rounded-2xl text-2xl font-black shadow-lg">3</button>
                <button onclick="startGame(4)" class="w-16 h-16 bg-red-500 rounded-2xl text-2xl font-black shadow-lg">4</button>
            </div>
        </div>
    </div>

    <!-- UI -->
    <div class="flex flex-col h-full items-center justify-between py-4">
        <div id="playerStats" class="w-full max-w-4xl grid grid-cols-4 gap-2 px-4"></div>

        <div class="board-wrapper">
            <div id="board" class="board-grid"></div>
        </div>

        <div class="controls flex flex-col items-center gap-2">
            <div id="diceResult" class="text-5xl h-14">ğŸ²</div>
            <button id="diceBtn" class="dice-btn">ROLL!</button>
            <div id="statusMessage" class="bg-black/40 px-6 py-1 rounded-full font-bold text-lg text-yellow-300"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="quizModal" class="modal">
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <span id="quizDifficulty" class="px-3 py-1 bg-yellow-400 text-black rounded-full font-black text-sm"></span>
                <span id="quizCategory" class="text-xl font-black text-blue-600"></span>
            </div>
            <h2 id="quizQuestion" class="text-xl md:text-2xl font-bold mb-6"></h2>
            <div id="quizOptions" class="grid grid-cols-1 gap-2"></div>
        </div>
    </div>

    <div id="branchModal" class="modal">
        <div class="card !bg-slate-800 !text-white">
            <h2 class="text-3xl font-black mb-4 text-yellow-400">ä¸­å­¦æ ¡ãƒ¬ãƒ™ãƒ«çªå…¥ï¼</h2>
            <p class="mb-6">ã“ã“ã‹ã‚‰ã¯ä¸­å­¦æ ¡ç†ç§‘ã®å•é¡Œã§ã™ã€‚<br>å¾—æ„ãªåˆ†é‡ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="selectBranch('bio')" class="p-4 rounded-xl bg-green-700 font-bold">ğŸŒ¿ ç”Ÿç‰©</button>
                <button onclick="selectBranch('chem')" class="p-4 rounded-xl bg-purple-700 font-bold">ğŸ§ª åŒ–å­¦</button>
                <button onclick="selectBranch('phy')" class="p-4 rounded-xl bg-orange-700 font-bold">âš¡ ç‰©ç†</button>
                <button onclick="selectBranch('geo')" class="p-4 rounded-xl bg-blue-700 font-bold">ğŸŒ åœ°å­¦</button>
            </div>
        </div>
    </div>

    <div id="resultModal" class="modal">
        <div class="card">
            <h2 class="text-4xl font-black text-blue-600 mb-6">çµæœç™ºè¡¨</h2>
            <div id="rankingList" class="space-y-3 mb-6"></div>
            <button onclick="location.reload()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold">ã‚‚ã†ä¸€åº¦ã‚ãã¶</button>
        </div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(freqs, type, duration, vol=0.3) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            freqs.forEach((f, i) => {
                setTimeout(() => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(f, audioCtx.currentTime);
                    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
                    osc.connect(gain); gain.connect(audioCtx.destination);
                    osc.start(); osc.stop(audioCtx.currentTime + duration);
                }, i * 80);
            });
        }
        const sfx = {
            move: () => playSfx([400], 'sine', 0.1, 0.2),
            dice: () => playSfx([1000], 'square', 0.05, 0.1),
            correct: () => {
                playSfx([523, 659, 783, 1046], 'triangle', 0.5, 0.5);
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            },
            wrong: () => playSfx([200, 100], 'sawtooth', 0.5, 0.5),
            gimmick: () => playSfx([800, 1200], 'sine', 0.3, 0.4),
            goal: () => {
                playSfx([523, 783, 1046], 'square', 1.0, 0.5);
                confetti({ particleCount: 200, spread: 160 });
            }
        };

        const quizBank = {
            normal: [
                // å°å­¦æ ¡ãƒ¬ãƒ™ãƒ«ï¼ˆç”Ÿç‰©ï¼‰
                {q:"æ˜†è™«ã®è¶³ã¯ä½•æœ¬ï¼Ÿ", a:["4æœ¬","6æœ¬","8æœ¬","10æœ¬"], c:1, cat:"å°ãƒ»ç”Ÿç‰©", p:100},
                {q:"ã‚¢ãƒ–ãƒ©ãƒŠã®èŠ±ã³ã‚‰ã¯ä½•æšï¼Ÿ", a:["3æš","4æš","5æš","6æš"], c:1, cat:"å°ãƒ»ç”Ÿç‰©", p:100},
                {q:"ã‚µã‚±ã®ãŸã¾ã”ã‚’ä½•ã¨ã„ã†ï¼Ÿ", a:["ã‚«ã‚ºãƒã‚³","ã‚¤ã‚¯ãƒ©","ã‚¿ãƒ©ã‚³","ãƒ¡ãƒ€ã‚«"], c:1, cat:"å°ãƒ»ç”Ÿç‰©", p:100},
                {q:"æ¤ç‰©ãŒæ—¥å…‰ã‚’æµ´ã³ã¦æ „é¤Šã‚’ä½œã‚‹ã“ã¨ã‚’ä½•ã¨ã„ã†ï¼Ÿ", a:["å‘¼å¸","å…‰åˆæˆ","è’¸æ•£","å—ç²‰"], c:1, cat:"å°ãƒ»ç”Ÿç‰©", p:150},
                {q:"ãƒ¡ãƒ€ã‚«ã®ã‚ªã‚¹ã«ã‚ã‚‹ã€èƒŒã³ã‚Œã®åˆ‡ã‚Œè¾¼ã¿ã¯ï¼Ÿ", a:["ã‚ã‚‹","ãªã„","ãƒ¡ã‚¹ã«ã‚ã‚‹","å­£ç¯€ã«ã‚ˆã‚‹"], c:0, cat:"å°ãƒ»ç”Ÿç‰©", p:150},
                {q:"ç¨®å­ãŒç™ºèŠ½ã™ã‚‹ãŸã‚ã«å¿…è¦ãª3æ¡ä»¶ã¯ï¼Ÿ", a:["æ°´ãƒ»ç©ºæ°—ãƒ»æ—¥å…‰","æ°´ãƒ»ç©ºæ°—ãƒ»æ¸©åº¦","ç©ºæ°—ãƒ»æ¸©åº¦ãƒ»è‚¥æ–™","æ°´ãƒ»æ¸©åº¦ãƒ»åœŸ"], c:1, cat:"å°ãƒ»ç”Ÿç‰©", p:200},
                {q:"äººã®å¿ƒè‡“ãŒè¡€æ¶²ã‚’é€ã‚Šå‡ºã™å½¹å‰²ã‚’ã—ã¦ã„ã‚‹ã®ã¯ï¼Ÿ", a:["èƒƒ","è‚º","å¿ƒè‡“","è‚è‡“"], c:2, cat:"å°ãƒ»ç”Ÿç‰©", p:100},
                {q:"ãƒãƒ§ã‚¦ã®è‚²ã¡æ–¹ã§æ­£ã—ã„é †ç•ªã¯ï¼Ÿ", a:["åµâ†’ã•ãªãâ†’å¹¼è™«â†’æˆè™«","åµâ†’å¹¼è™«â†’ã•ãªãâ†’æˆè™«","åµâ†’å¹¼è™«â†’æˆè™«","ã•ãªãâ†’åµâ†’å¹¼è™«â†’æˆè™«"], c:1, cat:"å°ãƒ»ç”Ÿç‰©", p:150},
                // å°å­¦æ ¡ãƒ¬ãƒ™ãƒ«ï¼ˆåŒ–å­¦ãƒ»ç‰©ç†ï¼‰
                {q:"æ°´ãŒæ²¸é¨°ã™ã‚‹ã¨ãã®æ¸©åº¦ã¯ç´„ä½•åº¦ï¼Ÿ", a:["50åº¦","80åº¦","100åº¦","120åº¦"], c:2, cat:"å°ãƒ»åŒ–å­¦", p:100},
                {q:"ç£çŸ³ã®åŒã˜æ¥µï¼ˆNã¨Nãªã©ï¼‰ã‚’è¿‘ã¥ã‘ã‚‹ã¨ã©ã†ãªã‚‹ï¼Ÿ", a:["å¼•ãåˆã†","é€€ã‘åˆã†","ä½•ã‚‚èµ·ããªã„","çˆ†ç™ºã™ã‚‹"], c:1, cat:"å°ãƒ»ç‰©ç†", p:100},
                {q:"é£Ÿå¡©ã‚’æ°´ã«æº¶ã‹ã—ãŸã‚‚ã®ã‚’ä½•ã¨ã„ã†ï¼Ÿ", a:["é£Ÿå¡©æ°´","é£½å’Œæ°´","æ°´æº¶æ¶²","æ··åˆç‰©"], c:0, cat:"å°ãƒ»åŒ–å­¦", p:100},
                {q:"ä¹¾é›»æ± ã®å‘ãã‚’é€†ã«ã™ã‚‹ã¨é›»æµã®å‘ãã¯ã©ã†ãªã‚‹ï¼Ÿ", a:["å¤‰ã‚ã‚‰ãªã„","é€†ã«ãªã‚‹","æ­¢ã¾ã‚‹","å¼·ããªã‚‹"], c:1, cat:"å°ãƒ»ç‰©ç†", p:150},
                {q:"è±†é›»çƒ2å€‹ã‚’ã€Œç›´åˆ—ã€ã«ã¤ãªãã¨ã€ä¸¦åˆ—ã®æ™‚ã‚ˆã‚Šæ˜ã‚‹ã•ã¯ï¼Ÿ", a:["æ˜ã‚‹ã„","æš—ã„","åŒã˜","ã¤ã‹ãªã„"], c:1, cat:"å°ãƒ»ç‰©ç†", p:150},
                {q:"ãµã‚Šã“ãŒ1å¾€å¾©ã™ã‚‹æ™‚é–“ã¯ã€ä½•ã‚’å¤‰ãˆã‚‹ã¨å¤‰ã‚ã‚‹ï¼Ÿ", a:["ãŠã‚‚ã‚Šã®é‡ã•","ãµã‚Šã“ã®é•·ã•","æŒ¯ã‚Œã¯ã°","è‰²"], c:1, cat:"å°ãƒ»ç‰©ç†", p:200},
                {q:"æ°´æº¶æ¶²ã®ä¸­ã§ã€é‰„ã‚’æº¶ã‹ã™æ€§è³ªãŒã‚ã‚‹ã®ã¯ï¼Ÿ", a:["é£Ÿå¡©æ°´","ç ‚ç³–æ°´","å¡©é…¸","é‡æ›¹æ°´"], c:2, cat:"å°ãƒ»åŒ–å­¦", p:200},
                {q:"ç©ºæ°—ã«æœ€ã‚‚å¤šãå«ã¾ã‚Œã¦ã„ã‚‹æ°—ä½“ã¯ï¼Ÿ", a:["é…¸ç´ ","äºŒé…¸åŒ–ç‚­ç´ ","çª’ç´ ","æ°´ç´ "], c:2, cat:"å°ãƒ»åŒ–å­¦", p:150},
                // å°å­¦æ ¡ãƒ¬ãƒ™ãƒ«ï¼ˆåœ°å­¦ï¼‰
                {q:"å¤ªé™½ã¯ã©ã®æ–¹è§’ã‹ã‚‰ã®ã¼ã‚‹ï¼Ÿ", a:["æ±","è¥¿","å—","åŒ—"], c:0, cat:"å°ãƒ»åœ°å­¦", p:100},
                {q:"æœˆãŒè‡ªåˆ†ã§å…‰ã£ã¦ã„ã‚‹ã®ã¯ï¼Ÿ", a:["ã¯ã„","ã„ã„ãˆ","å¤œã ã‘","æ–°æœˆã ã‘"], c:1, cat:"å°ãƒ»åœ°å­¦", p:100},
                {q:"å¤ã®å¤§ä¸‰è§’ã«å«ã¾ã‚Œãªã„æ˜Ÿã¯ï¼Ÿ", a:["ãƒ™ã‚¬","ã‚¢ãƒ«ã‚¿ã‚¤ãƒ«","ãƒ‡ãƒãƒ–","ã‚¢ãƒ³ã‚¿ãƒ¬ã‚¹"], c:3, cat:"å°ãƒ»åœ°å­¦", p:200},
                {q:"åœ°å±¤ãŒã§ãã‚‹ã¨ãã€ä¸€èˆ¬çš„ã«æ–°ã—ã„å±¤ã¯ã©ã“ï¼Ÿ", a:["ä¸€ç•ªä¸‹","ä¸€ç•ªä¸Š","çœŸã‚“ä¸­","æ±ºã¾ã£ã¦ã„ãªã„"], c:1, cat:"å°ãƒ»åœ°å­¦", p:150},
                {q:"æµã‚Œã‚‹æ°´ã®3ã¤ã®åƒãã¯ã€ã—ã‚“é£Ÿã€é‹æ¬ã¨ä½•ï¼Ÿ", a:["è’¸ç™º","ãŸã„ç©","ã‚é","æº¶è§£"], c:1, cat:"å°ãƒ»åœ°å­¦", p:150}
            ],
            bio: [
                {q:"æ¤ç‰©ç´°èƒã«ã‚ã‚Šã€å‹•ç‰©ç´°èƒã«ãªã„ã‚‚ã®ã¯ï¼Ÿ", a:["æ ¸","ç´°èƒè³ª","ç´°èƒå£","ç´°èƒè†œ"], c:2, cat:"ä¸­ãƒ»ç”Ÿç‰©", p:400},
                {q:"ã‚»ã‚­ãƒãƒ¥ã‚¦å‹•ç‰©ã§ã€ä¸€ç”Ÿã‚¨ãƒ©å‘¼å¸ã‚’ã™ã‚‹ã®ã¯ï¼Ÿ", a:["é­šé¡","ä¸¡ç”Ÿé¡","ã¯è™«é¡","å“ºä¹³é¡"], c:0, cat:"ä¸­ãƒ»ç”Ÿç‰©", p:400},
                {q:"å„ªæ€§ã®æ³•å‰‡ã‚’ç™ºè¦‹ã—ãŸäººç‰©ã¯ï¼Ÿ", a:["ãƒ€ãƒ¼ã‚¦ã‚£ãƒ³","ãƒ¡ãƒ³ãƒ‡ãƒ«","ãƒ‘ã‚¹ãƒ„ãƒ¼ãƒ«","ãƒ•ãƒƒã‚¯"], c:1, cat:"ä¸­ãƒ»ç”Ÿç‰©", p:500},
                {q:"è‚ºã§é…¸ç´ ã¨äºŒé…¸åŒ–ç‚­ç´ ã®äº¤æ›ãŒè¡Œã‚ã‚Œã‚‹å°ã•ãªè¢‹ã‚’ï¼Ÿ", a:["è‚ºèƒ","æ°—ç®¡æ”¯","æ¨ªéš”è†œ","è‚ºé–€"], c:0, cat:"ä¸­ãƒ»ç”Ÿç‰©", p:400},
                {q:"æ¶ˆåŒ–æ¶²ã®ã€Œèƒ†æ±ã€ãŒä½œã‚‰ã‚Œã‚‹å ´æ‰€ã¯ï¼Ÿ", a:["èƒƒ","èƒ†ã®ã†","è‚è‡“","ã™ã„è‡“"], c:2, cat:"ä¸­ãƒ»ç”Ÿç‰©", p:500}
            ],
            chem: [
                {q:"åŸå­ã®è¨˜å·ã€ŒCuã€ã¯ä½•ã‚’è¡¨ã™ï¼Ÿ", a:["é‡‘","éŠ€","éŠ…","é‰„"], c:2, cat:"ä¸­ãƒ»åŒ–å­¦", p:400},
                {q:"æ°´ã®é›»æ°—åˆ†è§£ã§ã€é™½æ¥µã«ç™ºç”Ÿã™ã‚‹æ°—ä½“ã¯ï¼Ÿ", a:["æ°´ç´ ","é…¸ç´ ","å¡©ç´ ","çª’ç´ "], c:1, cat:"ä¸­ãƒ»åŒ–å­¦", p:400},
                {q:"ç‰©è³ªãŒé…¸ç´ ã¨çµã³ã¤ãåŒ–å­¦å¤‰åŒ–ã‚’ï¼Ÿ", a:["é‚„å…ƒ","é…¸åŒ–","åˆ†è§£","åŒ–åˆ"], c:1, cat:"ä¸­ãƒ»åŒ–å­¦", p:400},
                {q:"å¡©åŒ–ãƒŠãƒˆãƒªã‚¦ãƒ ãŒæ°´ã«æº¶ã‘ã¦é›»é›¢ã™ã‚‹æ§˜å­ã‚’è¡¨ã™å¼ã¯ï¼Ÿ", a:["Na+ + Cl-","NaCl2","Na + Cl","H + Cl"], c:0, cat:"ä¸­ãƒ»åŒ–å­¦", p:500},
                {q:"ã‚¢ãƒ³ãƒ¢ãƒ‹ã‚¢ã®æ€§è³ªã¨ã—ã¦æ­£ã—ã„ã®ã¯ï¼Ÿ", a:["é…¸æ€§","ã‚¢ãƒ«ã‚«ãƒªæ€§","ä¸­æ€§","ç„¡è‡­"], c:1, cat:"ä¸­ãƒ»åŒ–å­¦", p:400}
            ],
            phy: [
                {q:"é›»æµã®å˜ä½ã€ŒAã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ", a:["ã‚¢ãƒ³ãƒšã‚¢","ãƒœãƒ«ãƒˆ","ã‚ªãƒ¼ãƒ ","ãƒ¯ãƒƒãƒˆ"], c:0, cat:"ä¸­ãƒ»ç‰©ç†", p:400},
                {q:"10Î©ã®æŠµæŠ—ã«3Vã®é›»åœ§ã‚’ã‹ã‘ãŸæ™‚ã®é›»æµã¯ï¼Ÿ", a:["30A","3.3A","0.3A","13A"], c:2, cat:"ä¸­ãƒ»ç‰©ç†", p:500},
                {q:"å‡¸ãƒ¬ãƒ³ã‚ºã§å®Ÿç‰©ã¨åŒã˜å¤§ãã•ã®å®ŸåƒãŒã§ãã‚‹ä½ç½®ã¯ï¼Ÿ", a:["ç„¦ç‚¹ã®ä¸Š","ç„¦ç‚¹è·é›¢ã®2å€","ç„¡é™é ","ãƒ¬ãƒ³ã‚ºã®ã™ããã°"], c:1, cat:"ä¸­ãƒ»ç‰©ç†", p:500},
                {q:"ä»•äº‹ç‡ã®å˜ä½ã¯ï¼Ÿ", a:["J","W","N","Pa"], c:1, cat:"ä¸­ãƒ»ç‰©ç†", p:400},
                {q:"åŠ›ã®å˜ä½ã€ŒNï¼ˆãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ³ï¼‰ã€ã€1Nã¯ç´„ä½•gã®é‡ã•ï¼Ÿ", a:["10g","100g","1kg","10kg"], c:1, cat:"ä¸­ãƒ»ç‰©ç†", p:400}
            ],
            geo: [
                {q:"åœ°éœ‡ã®æºã‚Œã®å¤§ãã•ã‚’è¡¨ã™å°ºåº¦ã¯ï¼Ÿ", a:["ãƒã‚°ãƒ‹ãƒãƒ¥ãƒ¼ãƒ‰","éœ‡åº¦","ã‚¬ãƒ«","æ³¢é•·"], c:1, cat:"ä¸­ãƒ»åœ°å­¦", p:400},
                {q:"å†¬ã«æ—¥æœ¬ä»˜è¿‘ã§ç™ºé”ã™ã‚‹æ°—åœ§é…ç½®ã¯ï¼Ÿ", a:["å—é«˜åŒ—ä½","è¥¿é«˜æ±ä½","ç§»å‹•æ€§é«˜æ°—åœ§","æ¢…é›¨å‰ç·š"], c:1, cat:"ä¸­ãƒ»åœ°å­¦", p:400},
                {q:"é‡‘æ˜ŸãŒå¤•æ–¹ã®è¥¿ã®ç©ºã«è¦‹ãˆã‚‹æ™‚ã®å‘¼ã³åã¯ï¼Ÿ", a:["æ˜ã‘ã®æ˜æ˜Ÿ","å®µã®æ˜æ˜Ÿ","ã»ã†ãæ˜Ÿ","ä¸€ç•ªæ˜Ÿ"], c:1, cat:"ä¸­ãƒ»åœ°å­¦", p:400},
                {q:"é£½å’Œæ°´è’¸æ°—é‡ã¯ã€æ°—æ¸©ãŒä¸ŠãŒã‚‹ã¨ã©ã†ãªã‚‹ï¼Ÿ", a:["å¢—ãˆã‚‹","æ¸›ã‚‹","å¤‰ã‚ã‚‰ãªã„","0ã«ãªã‚‹"], c:0, cat:"ä¸­ãƒ»åœ°å­¦", p:500},
                {q:"ç«æˆå²©ã®ã†ã¡ã€åœ°ä¸‹æ·±ãã§ã‚†ã£ãã‚Šå†·ãˆã¦å›ºã¾ã£ãŸã‚‚ã®ã¯ï¼Ÿ", a:["ç«å±±å²©","æ·±æˆå²©","å †ç©å²©","å¤‰æˆå²©"], c:1, cat:"ä¸­ãƒ»åœ°å­¦", p:500}
            ]
        };

        let players = [];
        let currentPlayerIndex = 0;
        let isMoving = false;
        let path = [];
        const wrongAnswers = [];
        const gimmicks = [
            {t:"Ã—2", desc:"ã“ã®ã‚¿ãƒ¼ãƒ³ã®ãƒã‚¤ãƒ³ãƒˆ2å€ï¼", f:(p)=>p.bonusMul=2},
            {t:"Ã—5", desc:"è¶…ãƒ©ãƒƒã‚­ãƒ¼ï¼ãƒã‚¤ãƒ³ãƒˆ5å€ï¼", f:(p)=>p.bonusMul=5},
            {t:"+3", desc:"3ãƒã‚¹é€²ã‚€ï¼", f:async (p)=>await forceMove(p,3)},
            {t:"+5", desc:"ä¸€æ°—ã«5ãƒã‚¹é€²ã‚€ï¼", f:async (p)=>await forceMove(p,5)},
            {t:"-3", desc:"3ãƒã‚¹æˆ»ã‚‹...", f:async (p)=>await forceMove(p,-3)},
            {t:"ç›—", desc:"ä»–å…¨å“¡ã‹ã‚‰300ptå¥ªã†ï¼", f:(p)=>{
                players.forEach(op=>{if(op.id!==p.id){op.score=Math.max(0,op.score-300);p.score+=300;}});
            }},
            {t:"æ›", desc:"æœ€ä¸‹ä½ã¨å…¥ã‚Œæ›¿ã‚ã‚‹ï¼", f:(p)=>{
                let last = [...players].sort((a,b)=>a.pos-b.pos)[0];
                let tmp = p.pos; p.pos = last.pos; last.pos = tmp;
            }},
            {t:"0", desc:"ãƒã‚¤ãƒ³ãƒˆãŒ0ã«ãªã£ãŸï¼", f:(p)=>p.score=0},
            {t:"ç¥", desc:"å…¨å“¡ã«500ptï¼", f:()=>{players.forEach(p=>p.score+=500);}},
            {t:"çµ‚", desc:"ã‚´ãƒ¼ãƒ«ã¾ã§ä¸€æ°—ã«åŠ é€Ÿï¼(+5)", f:async (p)=>await forceMove(p,5)}
        ];

        function startGame(num) {
            const icons = ['ğŸš€', 'ğŸ›¸', 'â­', 'ğŸŒ™'];
            const colors = ['#f87171', '#4ade80', '#fbbf24', '#60a5fa'];
            players = Array.from({length: num}, (_, i) => ({
                id: i, name: `Player ${i+1}`, icon: icons[i], color: colors[i],
                pos: 0, score: 0, branch: null, isGoal: false, bonusMul: 1
            }));
            document.getElementById('startScreen').classList.add('hidden');
            initBoard();
            renderStats();
        }

        function createPath() {
            path = [];
            for(let r=0; r<6; r++) {
                if(r % 2 === 0) for(let c=0; c<10; c++) path.push({r, c, gimmick:null});
                else for(let c=9; c>=0; c--) path.push({r, c, gimmick:null});
            }
            for(let i=5; i<55; i+=Math.floor(Math.random()*4)+4) {
                path[i].gimmick = gimmicks[Math.floor(Math.random()*gimmicks.length)];
            }
            path[39].isBranch = true;
            path[59].isGoal = true;
        }

        function initBoard() {
            createPath();
            const board = document.getElementById('board');
            board.innerHTML = '';
            for(let r=0; r<6; r++) {
                for(let c=0; c<10; c++) {
                    const tile = document.createElement('div');
                    tile.className = 'tile';
                    tile.id = `tile-${r}-${c}`;
                    board.appendChild(tile);
                }
            }
            path.forEach((p, i) => {
                const el = document.getElementById(`tile-${p.r}-${p.c}`);
                el.classList.add('active-path');
                if(p.isGoal) {
                    el.innerHTML = `<span class='text-[8px]'>GOAL</span>`;
                    el.style.background = "linear-gradient(45deg, #fbbf24, #ea580c)";
                } else if(p.isBranch) {
                    el.innerHTML = `<span>åˆ†å²</span>`;
                    el.style.background = "#8b5cf6";
                } else if(p.gimmick) {
                    el.classList.add(p.gimmick.t.includes('-') || p.gimmick.t === '0' ? 'tile-danger' : 'tile-gimmick');
                    el.innerHTML = `<span>${p.gimmick.t}</span>`;
                } else {
                    el.innerText = i;
                }
            });
            updatePawns();
        }

        function updatePawns() {
            players.forEach(p => {
                let pwn = document.getElementById(`pawn-${p.id}`);
                if(!pwn) {
                    pwn = document.createElement('div');
                    pwn.id = `pawn-${p.id}`;
                    pwn.className = 'player-pawn';
                    pwn.style.backgroundColor = p.color;
                    pwn.innerText = p.icon;
                    document.body.appendChild(pwn);
                }
                const tilePos = path[p.pos];
                const tileEl = document.getElementById(`tile-${tilePos.r}-${tilePos.c}`);
                const rect = tileEl.getBoundingClientRect();
                const offset = (p.id * 4) - 8;
                pwn.style.top = `${rect.top + rect.height/2 - 17 + offset}px`;
                pwn.style.left = `${rect.left + rect.width/2 - 17 + offset}px`;
            });
        }

        function renderStats() {
            const stats = document.getElementById('playerStats');
            stats.innerHTML = '';
            players.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = `p-2 rounded-xl transition-all ${i === currentPlayerIndex ? 'bg-white/30 ring-2 ring-white scale-105' : 'bg-white/5'}`;
                div.innerHTML = `
                    <div class="flex items-center gap-1">
                        <span class="text-xl">${p.icon}</span>
                        <div class="flex flex-col">
                            <span class="text-[8px] font-bold opacity-70">${p.name}</span>
                            <span class="text-xs font-black">${p.score}pt</span>
                        </div>
                    </div>
                `;
                stats.appendChild(div);
            });
            const cp = players[currentPlayerIndex];
            document.getElementById('statusMessage').innerText = `${cp.name}ã®ç•ªã§ã™ï¼`;
            document.getElementById('statusMessage').style.color = cp.color;
        }

        const diceBtn = document.getElementById('diceBtn');
        diceBtn.onclick = async () => {
            if(isMoving) return;
            diceBtn.disabled = true;
            const roll = Math.floor(Math.random() * 6) + 1;
            let count = 0;
            const anim = setInterval(() => {
                const icons = ['âš€','âš','âš‚','âšƒ','âš„','âš…'];
                document.getElementById('diceResult').innerText = icons[Math.floor(Math.random()*6)];
                sfx.dice();
                if(count++ > 10) {
                    clearInterval(anim);
                    document.getElementById('diceResult').innerText = icons[roll-1];
                    movePlayer(roll);
                }
            }, 80);
        };

        async function movePlayer(steps) {
            isMoving = true;
            const p = players[currentPlayerIndex];
            for(let i=0; i<steps; i++) {
                if(p.pos >= path.length-1) break;
                if(p.pos === 39 && !p.branch) {
                    document.getElementById('branchModal').classList.add('active');
                    return;
                }
                p.pos++;
                sfx.move();
                updatePawns();
                await new Promise(r => setTimeout(r, 250));
            }
            checkLanding();
        }

        async function forceMove(p, n) {
            const direction = n > 0 ? 1 : -1;
            const absoluteN = Math.abs(n);
            for(let i=0; i<absoluteN; i++) {
                if(direction > 0 && p.pos >= path.length-1) break;
                if(direction < 0 && p.pos <= 0) break;
                p.pos += direction;
                updatePawns();
                await new Promise(r => setTimeout(r, 150));
            }
        }

        async function checkLanding() {
            const p = players[currentPlayerIndex];
            const tile = path[p.pos];
            if(tile.isGoal) {
                sfx.goal();
                p.isGoal = true; p.score += 2000;
                nextTurn(); return;
            }
            if(tile.gimmick) {
                sfx.gimmick();
                document.getElementById('statusMessage').innerText = tile.gimmick.desc;
                await tile.gimmick.f(p);
                updatePawns();
                await new Promise(r => setTimeout(r, 800));
            }
            showQuiz();
        }

        function showQuiz() {
            const p = players[currentPlayerIndex];
            const pool = (p.branch && p.pos > 39) ? quizBank[p.branch] : quizBank.normal;
            const quiz = pool[Math.floor(Math.random() * pool.length)];
            const modal = document.getElementById('quizModal');
            document.getElementById('quizDifficulty').innerText = `å ±é…¬: ${quiz.p * p.bonusMul}pt`;
            document.getElementById('quizCategory').innerText = quiz.cat;
            document.getElementById('quizQuestion').innerText = quiz.q;
            const options = document.getElementById('quizOptions');
            options.innerHTML = '';
            quiz.a.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => {
                    modal.classList.remove('active');
                    if(idx === quiz.c) {
                        sfx.correct();
                        p.score += (quiz.p * p.bonusMul);
                        p.bonusMul = 1;
                        document.getElementById('gameBody').classList.add('flash-correct');
                        setTimeout(()=>document.getElementById('gameBody').classList.remove('flash-correct'), 400);
                        nextTurn();
                    } else {
                        sfx.wrong();
                        wrongAnswers.push({q:quiz.q, a:quiz.a[quiz.c]});
                        document.getElementById('gameBody').classList.add('flash-wrong');
                        setTimeout(()=>document.getElementById('gameBody').classList.remove('flash-wrong'), 400);
                        forceMove(p, -2).then(nextTurn);
                    }
                };
                options.appendChild(btn);
            });
            modal.classList.add('active');
        }

        function nextTurn() {
            if(players.every(p => p.isGoal)) { showFinal(); return; }
            currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
            while(players[currentPlayerIndex].isGoal) currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
            isMoving = false;
            diceBtn.disabled = false;
            renderStats();
            updatePawns();
        }

        window.selectBranch = (type) => {
            players[currentPlayerIndex].branch = type;
            document.getElementById('branchModal').classList.remove('active');
            checkLanding();
        };

        function showFinal() {
            const sorted = [...players].sort((a,b) => b.score - a.score);
            const rankList = document.getElementById('rankingList');
            rankList.innerHTML = sorted.map((p, i) => `
                <div class="p-4 rounded-xl flex justify-between items-center bg-slate-100 ${i===0?'ring-2 ring-yellow-400':''}">
                    <span>${i+1}ä½ ${p.icon} ${p.name}</span>
                    <span class="font-bold">${p.score}pt</span>
                </div>
            `).join('');
            document.getElementById('resultModal').classList.add('active');
        }

        window.onresize = updatePawns;
    </script>
</body>
</html>
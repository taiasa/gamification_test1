<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¡ãƒ¢ãƒªãƒ¼è¨ˆç®—ã‚²ãƒ¼ãƒ </title>
    <!-- Tailwind CSS CDNã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Interãƒ•ã‚©ãƒ³ãƒˆã‚’ä½¿ç”¨ -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ã¨Tailwindã®çµ„ã¿åˆã‚ã› */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* è–„ã„é’ç³»ã®èƒŒæ™¯ */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* ä¸Šéƒ¨ã‹ã‚‰å§‹ã‚ã‚‹ */
            min-height: 100vh;
            padding: 20px;
        }

        /* ã‚«ãƒ¼ãƒ‰ã®åŸºæœ¬è¨­å®š */
        .card {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem; /* ã‚¹ãƒãƒ›ã§èª­ã¿ã‚„ã™ã„ã‚µã‚¤ã‚º */
            font-weight: 600;
            color: #ffffff;
            cursor: pointer;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.5s ease-in-out, box-shadow 0.3s;
            transform-style: preserve-3d;
            perspective: 1000px;
            user-select: none; /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã‚’é˜²æ­¢ */
            position: relative; /* å­è¦ç´ ã®position: absoluteã®åŸºæº– */
        }

        /* ã‚«ãƒ¼ãƒ‰ã®ã‚³ãƒ³ãƒ†ãƒŠï¼ˆã‚°ãƒªãƒƒãƒ‰ã‚¢ã‚¤ãƒ†ãƒ ï¼‰ */
        .card-container {
            aspect-ratio: 1 / 1; /* æ­£æ–¹å½¢ã‚’ç¶­æŒ */
        }

        /* ã‚«ãƒ¼ãƒ‰ã®è¡¨ (è¡¨é¢) ã¨è£ (è£é¢) */
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden; /* è£å´ã‚’è¦‹ã›ãªã„ */
            border-radius: 12px;
            padding: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ã‚«ãƒ¼ãƒ‰ã®è¡¨é¢ (è¨ˆç®—å¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹é¢) - æœ€åˆã«è¦‹ãˆã‚‹é¢ */
        .card-front {
            background-color: #ffffff; /* ç™½ */
            color: #1f2937; /* æ¿ƒã„ã‚°ãƒ¬ãƒ¼ã®æ–‡å­— */
            border: 3px solid #60a5fa;
            font-size: 1.5rem;
            transform: rotateY(0deg); /* åˆæœŸçŠ¶æ…‹ */
        }

        /* ã‚«ãƒ¼ãƒ‰ã®è£é¢ (ç­”ãˆãŒè¡¨ç¤ºã•ã‚Œã‚‹é¢) */
        .card-back {
            background-color: #3b82f6; /* é’ */
            color: #ffffff;
            font-size: 2rem; /* ç­”ãˆã®æ–‡å­—ã‚’å¤§ãã */
            transform: rotateY(180deg); /* è£è¿”ã™æº–å‚™ */
        }

        /* ã‚«ãƒ¼ãƒ‰ãŒã‚ãã‚‰ã‚ŒãŸçŠ¶æ…‹ */
        .card-flipped {
            transform: rotateY(180deg);
        }

        /* ãƒãƒƒãƒã—ãŸã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .card-matched .card-back {
            background-color: #10b981; /* ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã‚°ãƒªãƒ¼ãƒ³ */
            border-color: #059669;
            color: #ffffff;
        }

        /* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .game-button {
            transition: all 0.15s ease-in-out;
        }
        .game-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="game-container" class="w-full max-w-4xl">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
        <header class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-2">ğŸ§  è¨ˆç®—ãƒ¡ãƒ¢ãƒªãƒ¼ã‚²ãƒ¼ãƒ  ğŸ§ </h1>
            <p class="text-gray-600">åŒã˜ç­”ãˆã«ãªã‚‹è¨ˆç®—å¼ã‚’ãƒšã‚¢ã«ã—ã¦ã‚«ãƒ¼ãƒ‰ã‚’ã™ã¹ã¦æ¶ˆãã†ï¼</p>
            
            <!-- é›£æ˜“åº¦é¸æŠ -->
            <div class="mt-4 p-4 bg-white rounded-xl shadow-lg border border-gray-200">
                <p class="text-sm font-bold text-gray-700 mb-2">é›£æ˜“åº¦ã‚’é¸æŠï¼š</p>
                <div id="difficulty-selector" class="flex justify-center flex-wrap gap-4 text-sm font-semibold">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" name="difficulty" value="beginner" checked class="form-radio text-blue-600 h-4 w-4" onchange="initGame()">
                        <span class="ml-2 text-gray-700">åˆç´š (60ç§’)</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" name="difficulty" value="intermediate" class="form-radio text-yellow-600 h-4 w-4" onchange="initGame()">
                        <span class="ml-2 text-gray-700">ä¸­ç´š (30ç§’)</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" name="difficulty" value="expert" class="form-radio text-red-600 h-4 w-4" onchange="initGame()">
                        <span class="ml-2 text-gray-700">ä¸Šç´š (10ç§’)</span>
                    </label>
                </div>
            </div>

            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
            <div id="status" class="flex justify-center space-x-4 mt-4 text-lg font-semibold flex-wrap gap-4">
                <div class="p-2 bg-white rounded-lg shadow-md border-2 border-green-500">
                    å¾—ç‚¹: <span id="points" class="text-green-600 font-extrabold text-xl">0</span>
                </div>
                <div class="p-2 bg-white rounded-lg shadow-md">
                    ãƒšã‚¢æ•°: <span id="score" class="text-blue-600">0</span>
                </div>
                <div class="p-2 bg-white rounded-lg shadow-md">
                    è©¦è¡Œå›æ•°: <span id="attempts" class="text-purple-600">0</span>
                </div>
                <div class="p-2 bg-white rounded-lg shadow-md bg-red-100 border-2 border-red-400">
                    æ®‹ã‚Šæ™‚é–“: <span id="timer" class="text-red-600 font-extrabold">00:00</span>
                </div>
            </div>
        </header>

        <!-- ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ -->
        <div id="game-board" class="grid grid-cols-5 gap-3 sm:gap-4 p-4 bg-white rounded-xl shadow-2xl transition-all duration-300">
            <!-- ã‚«ãƒ¼ãƒ‰ã¯JavaScriptã§æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </div>

        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div class="mt-8 flex flex-col items-center">
            <button id="reset-button" class="game-button px-6 py-3 bg-blue-600 text-white font-bold rounded-full shadow-lg hover:bg-blue-700 active:bg-blue-800">
                ğŸ”„ æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã‚‹
            </button>

            <div id="message-box" class="mt-6 w-full max-w-sm p-4 text-center bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-lg shadow-md hidden transition-all duration-300">
                <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        const board = document.getElementById('game-board');
        const scoreElement = document.getElementById('score');
        const attemptsElement = document.getElementById('attempts');
        const timerElement = document.getElementById('timer');
        const pointsElement = document.getElementById('points'); // æ–°ã—ã„å¾—ç‚¹è¦ç´ 
        const resetButton = document.getElementById('reset-button');
        const messageBox = document.getElementById('message-box');
        
        // ã‚¿ã‚¤ãƒãƒ¼é–¢é€£ã®å®šæ•°ã¨å¤‰æ•°
        const TIME_LIMITS = {
            beginner: 60,
            intermediate: 30,
            expert: 10
        };

        // ãƒã‚¤ãƒ³ãƒˆé–¢é€£ã®å®šæ•°
        const BASE_MATCH_SCORE = 100;
        const BONUS_MULTIPLIER = {
            beginner: 1, // 100 + 100 = 200
            intermediate: 3, // 100 + 300 = 400
            expert: 5    // 100 + 500 = 600
        };

        let timerId = null;
        let timeLeft = 0;
        let totalPoints = 0; // æ–°ã—ã„åˆè¨ˆå¾—ç‚¹å¤‰æ•°

        let cards = []; // å…¨ã¦ã®ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿
        let flippedCards = []; // ç¾åœ¨ã‚ãã‚‰ã‚Œã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰
        let matchedPairs = 0; // ç²å¾—ã—ãŸãƒšã‚¢ã®æ•°
        let attempts = 0; // è©¦è¡Œå›æ•°
        let lockBoard = false; // ã‚«ãƒ¼ãƒ‰æ“ä½œãƒ­ãƒƒã‚¯ãƒ•ãƒ©ã‚°

        // ----------------------------------------------------
        // 1. ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®å‹•çš„ç”Ÿæˆ
        // ----------------------------------------------------

        /**
         * ä¸ãˆã‚‰ã‚ŒãŸç­”ãˆã«å¯¾ã—ã¦ã€é‡è¤‡ã—ãªã„è¨ˆç®—å¼ã‚’ç”Ÿæˆã™ã‚‹
         * @param {number} answer - è¨ˆç®—ã®ç­”ãˆ
         * @param {Set<string>} formulaSet - ä½¿ç”¨æ¸ˆã¿ã®è¨ˆç®—å¼ã‚’æ ¼ç´ã™ã‚‹Set
         * @returns {string | null} ç”Ÿæˆã•ã‚ŒãŸè¨ˆç®—å¼ã€ã¾ãŸã¯å¤±æ•—ã—ãŸå ´åˆã¯null
         */
        function generateFormula(answer, formulaSet) {
            let formula = null;
            let attempts = 0;

            // 50å›è©¦è¡Œã—ã¦ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè¨ˆç®—å¼ã‚’è¦‹ã¤ã‘ã‚‹
            while (attempts < 50) {
                attempts++;
                const type = Math.floor(Math.random() * 4); // 0: +, 1: -, 2: Ã—, 3: Ã·
                
                let tempFormula = '';

                if (type === 0) { // è¶³ã—ç®— (A + B = Answer)
                    const num1 = Math.floor(Math.random() * (answer - 1)) + 1;
                    const num2 = answer - num1;
                    tempFormula = `${num1} + ${num2}`;
                } else if (type === 1) { // å¼•ãç®— (A - B = Answer)
                    const num2 = Math.floor(Math.random() * 10) + 1; // B = 1ã‹ã‚‰10
                    const num1 = answer + num2;
                    tempFormula = `${num1} - ${num2}`;
                } else if (type === 2) { // æ›ã‘ç®— (A Ã— B = Answer)
                    let num1 = 0;
                    let num2 = 0;
                    
                    // Answerã®å› æ•°ã‚’è¦‹ã¤ã‘ã‚‹
                    for (let i = 2; i <= Math.sqrt(answer); i++) {
                        if (answer % i === 0) {
                            // å°ã•ã„æ–¹ã®å› æ•°ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶
                            if (Math.random() < 0.5) {
                                num1 = i;
                                num2 = answer / i;
                            } else {
                                num1 = answer / i;
                                num2 = i;
                            }
                            break;
                        }
                    }
                    
                    if (num1 === 0 && answer > 1 && answer <= 25) { // ç´ æ•°ã¾ãŸã¯1æ¡ã®ç­”ãˆã®å ´åˆã€1 x Answerã‚’ä½¿ã†
                        num1 = 1;
                        num2 = answer;
                    }
                    
                    if (num1 !== 0) {
                        tempFormula = `${num1} Ã— ${num2}`;
                    } else {
                        continue; // å› æ•°åˆ†è§£ãŒé›£ã—ã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                    }

                } else if (type === 3) { // å‰²ã‚Šç®— (A Ã· B = Answer)
                    const num2 = Math.floor(Math.random() * 5) + 2; // B = 2ã‹ã‚‰6
                    const num1 = answer * num2;
                    tempFormula = `${num1} Ã· ${num2}`;
                }

                // è¨ˆç®—å¼ãŒãƒ¦ãƒ‹ãƒ¼ã‚¯ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
                if (tempFormula !== '' && !formulaSet.has(tempFormula)) {
                    formula = tempFormula;
                    formulaSet.add(formula);
                    return formula;
                }
            }
            return null; // 50å›è©¦è¡Œã—ã¦ã‚‚è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆ
        }

        /**
         * ãƒ©ãƒ³ãƒ€ãƒ ãªç­”ãˆã¨ãã‚Œã«å¯¾å¿œã™ã‚‹è¨ˆç®—å¼ãƒšã‚¢ã‚’ç”Ÿæˆã™ã‚‹
         * @param {number} numPairs - ç”Ÿæˆã™ã‚‹ãƒšã‚¢ã®æ•° (ã‚«ãƒ¼ãƒ‰ç·æ•°ã¯ numPairs * 2)
         * @returns {Array<Object>} è¨ˆç®—å¼ã¨ç­”ãˆã®ãƒšã‚¢ã®é…åˆ—
         */
        function generateCardPairs(numPairs = 5) {
            const minAnswer = 5;
            const maxAnswer = 25;
            const allPairs = [];
            const uniqueAnswers = new Set();
            const formulaSet = new Set(); 
            
            // å¿…è¦ãªæ•°ã ã‘ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªç­”ãˆã‚’ç”Ÿæˆã™ã‚‹
            while (uniqueAnswers.size < numPairs) {
                const answer = Math.floor(Math.random() * (maxAnswer - minAnswer + 1)) + minAnswer;
                if (answer > 1) { // ç­”ãˆã¯1ã‚ˆã‚Šå¤§ããã™ã‚‹
                    uniqueAnswers.add(answer);
                }
            }
            
            // å„ç­”ãˆã«å¯¾ã—ã¦2ã¤ã®ç•°ãªã‚‹è¨ˆç®—å¼ã‚’ç”Ÿæˆã™ã‚‹
            uniqueAnswers.forEach(answer => {
                let formulasForAnswer = [];
                let count = 0;

                while (count < 2) {
                    const formula = generateFormula(answer, formulaSet);
                    
                    // ç”Ÿæˆã•ã‚ŒãŸè¨ˆç®—å¼ãŒæœ‰åŠ¹ã§ã€ã‹ã¤ã“ã®ç­”ãˆã«å¯¾ã—ã¦ã¾ã ä½¿ã‚ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
                    if (formula && formulasForAnswer.indexOf(formula) === -1) {
                        formulasForAnswer.push(formula);
                        count++;
                    } else if (formula === null) {
                        // ç”Ÿæˆã«å¤±æ•—ã—ãŸå ´åˆã€ã“ã®ç­”ãˆã§ã®è©¦è¡Œã‚’è«¦ã‚ã€æ¬¡ã®ç­”ãˆã«é€²ã‚€
                        console.warn(`Failed to generate distinct formulas for answer: ${answer}. Retrying generation of pairs.`);
                        return; 
                    }
                } 
                
                // 2ã¤ã®ç•°ãªã‚‹è¨ˆç®—å¼ãŒç”Ÿæˆã§ããŸå ´åˆã€ãƒšã‚¢ã¨ã—ã¦è¿½åŠ 
                if (formulasForAnswer.length === 2) {
                    allPairs.push({ formula: formulasForAnswer[0], answer: answer });
                    allPairs.push({ formula: formulasForAnswer[1], answer: answer });
                }
            });
            
            // ã‚«ãƒ¼ãƒ‰ç·æ•°ãŒæœŸå¾…é€šã‚Šã§ãªã„å ´åˆã¯å†å¸°çš„ã«å†è©¦è¡Œ
            if (allPairs.length !== numPairs * 2) {
                return generateCardPairs(numPairs);
            }

            return allPairs;
        }


        // ã‚«ãƒ¼ãƒ‰ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹ãƒ•ã‚£ãƒƒã‚·ãƒ£ãƒ¼ãƒ»ã‚¤ã‚§ãƒ¼ãƒ„ãƒ»ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // ----------------------------------------------------
        // 2. UIã®ç”Ÿæˆã¨æç”»
        // ----------------------------------------------------

        // ã‚«ãƒ¼ãƒ‰UIã‚’ç”Ÿæˆã—ã€ãƒœãƒ¼ãƒ‰ã«æç”»
        function renderBoard() {
            board.innerHTML = ''; // ãƒœãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢
            
            // å‹•çš„ã«ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ (5ãƒšã‚¢ = 10æšã®ã‚«ãƒ¼ãƒ‰)
            const generatedPairs = generateCardPairs(5);

            let cardIdCounter = 0;
            cards = [];

            generatedPairs.forEach(pair => {
                cards.push({
                    id: cardIdCounter++, // ã‚«ãƒ¼ãƒ‰å›ºæœ‰ã®ID
                    displayFormula: pair.formula,
                    answerValue: pair.answer, // ãƒãƒƒãƒãƒ³ã‚°ã«ä½¿ã†å€¤
                    isFlipped: false,
                    isMatched: false
                });
            });

            shuffleArray(cards);
            
            // 10æšã®ã‚«ãƒ¼ãƒ‰ãªã®ã§ã€5x2ã‚°ãƒªãƒƒãƒ‰ã‚’ä½¿ç”¨
            board.className = 'grid grid-cols-5 gap-3 sm:gap-4 p-4 bg-white rounded-xl shadow-2xl transition-all duration-300';


            cards.forEach((card, index) => {
                const container = document.createElement('div');
                container.classList.add('card-container');
                container.dataset.index = index;

                container.innerHTML = `
                    <div class="card" onclick="handleCardClick(${index})">
                        <!-- è¡¨é¢: è¨ˆç®—å¼ (å¸¸ã«è¡¨ç¤º) -->
                        <div class="card-face card-front text-xl sm:text-2xl font-extrabold">${card.displayFormula}</div>
                        <!-- è£é¢: ç­”ãˆã®æ•°å€¤ (ã‚ãã‚‹ã¨è¡¨ç¤º) -->
                        <div class="card-face card-back">${card.answerValue}</div>
                    </div>
                `;
                board.appendChild(container);
            });
        }

        // ----------------------------------------------------
        // 3. ã‚¿ã‚¤ãƒãƒ¼ãƒ­ã‚¸ãƒƒã‚¯
        // ----------------------------------------------------

        /**
         * ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹
         */
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // æ™‚é–“ãŒå°‘ãªããªã£ãŸã‚‰å¼·èª¿è¡¨ç¤º
            if (timeLeft <= 10 && timeLeft > 0) {
                timerElement.classList.add('text-4xl', 'animate-pulse');
            } else {
                timerElement.classList.remove('text-4xl', 'animate-pulse');
            }
        }

        /**
         * ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ã™ã‚‹
         */
        function startTimer() {
            if (timerId) clearInterval(timerId); // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢
            
            timerId = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();

                if (timeLeft <= 0) {
                    stopTimer();
                    gameOver(false); // ã‚¿ã‚¤ãƒ ã‚ªãƒ¼ãƒãƒ¼ã§ã‚²ãƒ¼ãƒ çµ‚äº†
                }
            }, 1000);
        }

        /**
         * ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢ã™ã‚‹
         */
        function stopTimer() {
            if (timerId) {
                clearInterval(timerId);
                timerId = null;
            }
        }

        // ----------------------------------------------------
        // 4. ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯
        // ----------------------------------------------------

        /**
         * ç¾åœ¨ã®é›£æ˜“åº¦ã«åŸºã¥ã„ã¦ã€ãƒãƒƒãƒæˆåŠŸæ™‚ã®ç²å¾—ãƒã‚¤ãƒ³ãƒˆã‚’è¨ˆç®—ã™ã‚‹
         * @returns {number} ç²å¾—ãƒã‚¤ãƒ³ãƒˆ
         */
        function getMatchScore() {
            const selectedDifficulty = document.querySelector('input[name="difficulty"]:checked').value;
            const bonus = BASE_MATCH_SCORE * BONUS_MULTIPLIER[selectedDifficulty];
            
            // ä¾‹: åˆç´š(100) + 100 = 200, ä¸Šç´š(100) + 500 = 600
            return BASE_MATCH_SCORE + bonus;
        }


        // ----------------------------------------------------
        // 5. ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
        // ----------------------------------------------------

        // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
        window.handleCardClick = function(index) {
            if (lockBoard || timeLeft <= 0) return;
            const card = cards[index];

            // ã™ã§ã«ã‚ãã‚‰ã‚Œã¦ã„ã‚‹ã‹ã€ãƒãƒƒãƒã—ã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã¯ç„¡è¦–
            if (card.isFlipped || card.isMatched) return;

            // ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã‚‹
            card.isFlipped = true;
            const cardElement = board.querySelector(`[data-index="${index}"] .card`);
            cardElement.classList.add('card-flipped');

            flippedCards.push(card);

            if (flippedCards.length === 2) {
                lockBoard = true;
                attempts++;
                attemptsElement.textContent = attempts;
                checkForMatch();
            }
        }

        // ãƒšã‚¢ãƒã‚§ãƒƒã‚¯
        function checkForMatch() {
            const [card1, card2] = flippedCards;

            // åŒã˜ã‚«ãƒ¼ãƒ‰ã¯å¼•ã‘ãªã„ãŸã‚ã€IDãŒç•°ãªã‚‹ã“ã¨ã¨ã€è£é¢ã®ç­”ãˆãŒä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ãƒã‚§ãƒƒã‚¯
            const isMatch = (card1.id !== card2.id) && (card1.answerValue === card2.answerValue);

            if (isMatch) {
                handleMatch();
            } else {
                // é•ã£ãŸå ´åˆã¯1ç§’å¾Œã«è£è¿”ã™
                setTimeout(handleMismatch, 1000);
            }
        }

        // ãƒšã‚¢ãŒæˆåŠŸã—ãŸå ´åˆ
        function handleMatch() {
            const [card1, card2] = flippedCards;

            // å¾—ç‚¹ã‚’åŠ ç®—
            const awardedPoints = getMatchScore();
            totalPoints += awardedPoints;
            pointsElement.textContent = totalPoints;

            // ãƒãƒƒãƒçŠ¶æ…‹ã«ã™ã‚‹
            card1.isMatched = true;
            card2.isMatched = true;

            // UIã‚’æ›´æ–°
            const cardElement1 = board.querySelector(`[data-index="${cards.indexOf(card1)}"] .card`);
            const cardElement2 = board.querySelector(`[data-index="${cards.indexOf(card2)}"] .card`);

            // ãƒãƒƒãƒã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            cardElement1.classList.add('card-matched', 'scale-105');
            cardElement2.classList.add('card-matched', 'scale-105');
            
            setTimeout(() => {
                cardElement1.classList.remove('scale-105');
                cardElement2.classList.remove('scale-105');
            }, 300);

            matchedPairs++;
            scoreElement.textContent = matchedPairs;

            // ãƒªã‚»ãƒƒãƒˆ
            resetTurn();

            // ã‚²ãƒ¼ãƒ çµ‚äº†ãƒã‚§ãƒƒã‚¯
            if (matchedPairs === cards.length / 2) { // 10æšãªã®ã§ 5ãƒšã‚¢
                gameOver(true);
            }
        }

        // ãƒšã‚¢ãŒå¤±æ•—ã—ãŸå ´åˆ
        function handleMismatch() {
            const [card1, card2] = flippedCards;

            // ã‚«ãƒ¼ãƒ‰ã‚’è£è¿”ã™
            card1.isFlipped = false;
            card2.isFlipped = false;

            const cardElement1 = board.querySelector(`[data-index="${cards.indexOf(card1)}"] .card`);
            const cardElement2 = board.querySelector(`[data-index="${cards.indexOf(card2)}"] .card`);

            cardElement1.classList.remove('card-flipped');
            cardElement2.classList.remove('card-flipped');

            // ãƒªã‚»ãƒƒãƒˆ
            resetTurn();
        }

        // ã‚¿ãƒ¼ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
        function resetTurn() {
            // flippedCards = []; ã®ä»£ã‚ã‚Šã«ä½¿ç”¨
            flippedCards.length = 0; 
            lockBoard = false; // ãƒœãƒ¼ãƒ‰ã®ãƒ­ãƒƒã‚¯ã‚’è§£é™¤
        }

        /**
         * ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†
         * @param {boolean} win - å‹åˆ© (true) ã¾ãŸã¯ ã‚¿ã‚¤ãƒ ã‚ªãƒ¼ãƒãƒ¼ (false)
         */
        function gameOver(win = true) {
            stopTimer(); // ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢

            if (win) {
                messageBox.innerHTML = `
                    ğŸ‰ å…¨ã¦ã®ãƒšã‚¢ã‚’è¦‹ã¤ã‘ã¾ã—ãŸï¼ ğŸ‰
                    <br>
                    æœ€çµ‚å¾—ç‚¹: <span class="text-green-800 font-extrabold text-xl">${totalPoints} ãƒã‚¤ãƒ³ãƒˆ</span>
                    <br>
                    è©¦è¡Œå›æ•° ${attempts} å›ã§ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã—ã¾ã—ãŸï¼
                `;
                messageBox.classList.remove('hidden', 'bg-yellow-100', 'border-yellow-500', 'text-yellow-800', 'bg-red-100', 'border-red-500', 'text-red-800');
                messageBox.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
            } else {
                // ã‚¿ã‚¤ãƒ ã‚ªãƒ¼ãƒãƒ¼
                messageBox.innerHTML = `
                    â° ã‚¿ã‚¤ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼ ğŸ˜­
                    <br>
                    ç²å¾—å¾—ç‚¹: <span class="text-red-800 font-extrabold text-xl">${totalPoints} ãƒã‚¤ãƒ³ãƒˆ</span>
                    <br>
                    æ®‹å¿µã€æ™‚é–“åˆ‡ã‚Œã§ã™ã€‚ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼
                `;
                messageBox.classList.remove('hidden', 'bg-green-100', 'border-green-500', 'text-green-800', 'bg-yellow-100', 'border-yellow-500', 'text-yellow-800');
                messageBox.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
            }
        }


        // ----------------------------------------------------
        // 6. åˆæœŸåŒ–ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        // ----------------------------------------------------

        // ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–
        function initGame() {
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            messageBox.classList.add('hidden');
            messageBox.classList.remove('bg-green-100', 'border-green-500', 'text-green-800', 'bg-red-100', 'border-red-500', 'text-red-800');
            messageBox.classList.add('bg-yellow-100', 'border-yellow-500', 'text-yellow-800');
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            flippedCards = [];
            matchedPairs = 0;
            attempts = 0;
            totalPoints = 0; // å¾—ç‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            lockBoard = false;
            
            scoreElement.textContent = matchedPairs;
            attemptsElement.textContent = attempts;
            pointsElement.textContent = totalPoints; // UIã‚’æ›´æ–°

            // é›£æ˜“åº¦ã«åŸºã¥ã„ãŸã‚¿ã‚¤ãƒãƒ¼è¨­å®š
            const selectedDifficulty = document.querySelector('input[name="difficulty"]:checked').value;
            timeLeft = TIME_LIMITS[selectedDifficulty];
            updateTimerDisplay();
            stopTimer(); // ã‚¿ã‚¤ãƒãƒ¼ã‚’ç¢ºå®Ÿã«åœæ­¢

            renderBoard(); // ãƒœãƒ¼ãƒ‰ã‚’å†æç”»ï¼ˆæ–°ã—ã„è¨ˆç®—å¼ã‚’ç”Ÿæˆï¼‰
            
            startTimer(); // ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
        }

        // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        resetButton.addEventListener('click', initGame);

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹
        window.onload = initGame;
    </script>
</body>
</html>
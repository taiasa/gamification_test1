<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ãã‚ãï¼ãŸã—ç®—ãƒ©ãƒ³ãƒ‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap');

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #fff9e6;
            overflow: hidden;
            touch-action: manipulation;
            transition: background-color 0.8s;
        }

        .sleepy-bg {
            background-color: #e0f2fe !important;
        }

        .char-container {
            transition: all 0.3s ease;
        }

        .bounce {
            animation: bounce 0.5s infinite alternate;
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-20px); }
        }

        .sparkle {
            position: absolute;
            pointer-events: none;
            animation: fly 1s forwards;
        }

        @keyframes fly {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--x), var(--y)) scale(0); opacity: 0; }
        }

        .combo-text {
            animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: linear-gradient(to bottom, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8b00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1.2); opacity: 1; }
        }

        .btn-number {
            box-shadow: 0 4px 0 #d97706;
            transition: all 0.1s;
        }

        .btn-number:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .btn-check {
            box-shadow: 0 4px 0 #059669;
            transition: all 0.1s;
        }

        .btn-check:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .message-bubble {
            position: relative;
            background: #ffffff;
            border: 3px solid #fbbf24;
            border-radius: 15px;
        }

        .message-bubble::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 50%;
            margin-left: -12px;
            border-width: 12px 12px 0;
            border-style: solid;
            border-color: #fbbf24 transparent;
        }

        #user-input-display {
            min-width: 1.5em;
            display: inline-block;
            border-bottom: 4px solid #3b82f6;
            min-height: 1.2em;
        }

        .char-select-btn {
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid transparent;
        }
        .char-select-btn:hover {
            transform: scale(1.2);
        }
        .char-selected {
            background: white;
            border-color: #fbbf24;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(251, 191, 36, 0.3);
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-2" id="game-body">

    <!-- Game Header -->
    <div class="fixed top-2 left-0 right-0 flex justify-center gap-2 items-center px-2 z-10 flex-wrap">
        <div class="bg-white px-3 py-1 rounded-full border-2 border-yellow-400 font-bold text-yellow-700 text-xs shadow-sm">
            ã›ã„ã‹ã„ï¼š<span id="score">0</span>
        </div>
        <div class="bg-white px-3 py-1 rounded-full border-2 border-pink-400 font-bold text-pink-700 text-xs shadow-sm">
            ãƒ©ãƒ³ã‚¯ï¼š<span id="rank">ã¯ã˜ã‚ã¦</span>
        </div>
        <button onclick="resetGame()" class="bg-blue-400 hover:bg-blue-500 text-white px-3 py-1 rounded-full border-2 border-blue-200 font-bold text-xs shadow-sm transition-colors">
            ã¯ã˜ã‚ã‹ã‚‰
        </button>
    </div>

    <!-- Character Selector -->
    <div id="selector-area" class="flex gap-2 mb-2 mt-12 bg-white/60 p-2 rounded-full overflow-x-auto max-w-full">
        <div onclick="changeChar('bear')" id="btn-bear" class="char-select-btn char-selected text-2xl p-2">ğŸ»</div>
        <div onclick="changeChar('cat')" id="btn-cat" class="char-select-btn text-2xl p-2">ğŸ±</div>
        <div onclick="changeChar('panda')" id="btn-panda" class="char-select-btn text-2xl p-2">ğŸ¼</div>
        <div onclick="changeChar('giraffe')" id="btn-giraffe" class="char-select-btn text-2xl p-2">ğŸ¦’</div>
        <div onclick="changeChar('lion')" id="btn-lion" class="char-select-btn text-2xl p-2">ğŸ¦</div>
        <div onclick="changeChar('elephant')" id="btn-elephant" class="char-select-btn text-2xl p-2">ğŸ˜</div>
        <div onclick="changeChar('hamster')" id="btn-hamster" class="char-select-btn text-2xl p-2">ğŸ¹</div>
    </div>

    <!-- Main Game Area -->
    <div class="w-full max-w-sm bg-white/90 backdrop-blur-sm rounded-3xl p-4 shadow-xl border-4 border-white flex flex-col items-center">
        
        <!-- Character Area -->
        <div id="character" class="char-container mb-2 relative">
            <div id="combo-container" class="absolute -top-12 -right-8 pointer-events-none"></div>
            
            <div id="bubble" class="message-bubble px-4 py-1 mb-3 text-lg font-bold text-yellow-800 text-center min-w-[160px]">
                ã„ã£ã—ã‚‡ã« ã‚ãã¼ã†â™ª
            </div>
            <div id="char-icon" class="text-7xl select-none text-center">ğŸ»</div>
        </div>

        <!-- Question Area -->
        <div class="bg-yellow-50 rounded-2xl p-4 mb-4 w-full text-center border-2 border-yellow-100">
            <div class="text-4xl font-bold text-gray-800 flex justify-center items-center gap-3">
                <span id="num1">?</span>
                <span>+</span>
                <span id="num2">?</span>
                <span>=</span>
                <span id="user-input-display" class="text-blue-600"></span>
            </div>
        </div>

        <!-- Input Area -->
        <div id="numpad" class="grid grid-cols-3 gap-3 w-full"></div>
        <div class="grid grid-cols-3 gap-3 w-full mt-3">
            <button onclick="addNumber(0)" class="btn-number bg-yellow-400 hover:bg-yellow-500 text-white text-2xl font-bold py-3 rounded-xl">0</button>
            <button onclick="clearInput()" class="btn-number bg-gray-400 hover:bg-gray-500 text-white text-2xl font-bold py-3 rounded-xl">ã‘ã™</button>
            <button onclick="submitAnswer()" class="btn-check bg-emerald-500 hover:bg-emerald-600 text-white text-xl font-bold py-3 rounded-xl">ã“ã‚Œï¼</button>
        </div>
        
        <p class="mt-4 text-[10px] text-gray-400 font-bold text-center">ã™ã†ã˜ã‚­ãƒ¼ï¼šã«ã‚…ã†ã‚Šã‚‡ã / Enterï¼šã‘ã£ã¦ã„ / Backspaceï¼šã‘ã™</p>
    </div>

    <div id="overlay" class="fixed inset-0 pointer-events-none flex items-center justify-center z-50 opacity-0 transition-opacity duration-300">
        <div id="overlay-icon" class="text-8xl">âœ¨ğŸ’®âœ¨</div>
    </div>

    <script>
        let score = 0;
        let combo = 0;
        let currentAnswer = 0;
        let userInput = "";
        let num1 = 0;
        let num2 = 0;
        let currentChar = 'bear';
        let wrongCount = 0;
        let isSleepy = false;
        
        const ranks = ["ã¯ã˜ã‚ã¦", "ã¿ãªã‚‰ã„", "ãŸã¤ã˜ã‚“", "ãŠã†ã•ã¾", "ã‹ã¿ã•ã¾"];

        const charData = {
            bear: { base: 'ğŸ»', happy: 'ğŸ¤©', think: 'ğŸ¤”', sleepy: 'ğŸ˜ª' },
            cat: { base: 'ğŸ±', happy: 'ğŸ˜¸', think: 'ğŸ˜¿', sleepy: 'ğŸ˜ª' },
            panda: { base: 'ğŸ¼', happy: 'ğŸ˜†', think: 'ğŸ¼', sleepy: 'ğŸ˜ª' },
            giraffe: { base: 'ğŸ¦’', happy: 'â˜ºï¸', think: 'ğŸ¦’', sleepy: 'ğŸ˜ª' },
            lion: { base: 'ğŸ¦', happy: 'ğŸ¦', think: 'ğŸ§', sleepy: 'ğŸ˜ª' },
            elephant: { base: 'ğŸ˜', happy: 'ğŸ˜', think: 'ğŸ§', sleepy: 'ğŸ˜ª' },
            hamster: { base: 'ğŸ¹', happy: 'ğŸ¹', think: 'ğŸ¹', sleepy: 'ğŸ˜ª' }
        };

        const charIcon = document.getElementById('char-icon');
        const bubble = document.getElementById('bubble');
        const scoreEl = document.getElementById('score');
        const rankEl = document.getElementById('rank');
        const num1El = document.getElementById('num1');
        const num2El = document.getElementById('num2');
        const inputDisplay = document.getElementById('user-input-display');
        const overlay = document.getElementById('overlay');
        const comboContainer = document.getElementById('combo-container');
        const gameBody = document.getElementById('game-body');

        const messages = {
            correct: ["ã™ã”ãƒ¼ã„ï¼", "ã¦ã‚“ã•ã„ã ã­ï¼", "ã‚„ã£ãŸã­ï¼", "ã ã„ã›ã„ã‹ã„ï¼", "ãã®ã¡ã‚‡ã†ã—â™ª"],
            wrong: ["ãŠã—ã„ãªãã€ã‚‚ã†ã„ã£ã‹ã„ï¼", "ã‚ã‚Œã‚Œï¼Ÿã‚‚ã†ã™ã“ã—ï¼", "ã‚†ã£ãã‚Š ã‹ã‚“ãŒãˆã¦ã¿ã¦ã­"],
            combo: ["ãƒãƒªãƒãƒªã ã­ã£ï¼", "ã¨ã¾ã‚‰ãªãƒ¼ã„ï¼", "ã™ã”ã™ãã‚‹ã‚ˆï¼", "ã‚­ãƒ©ã‚­ãƒ©ã ã­ï¼"],
            sleepy: ["ãµãã€œã‚ã€ã­ã‚€ããªã£ã¡ã‚ƒã£ãŸ...", "ã¡ã‚‡ã£ã¨ ãŠã‚„ã™ã¿ã™ã‚‹ã­...", "ã¾ãŸ ã‚ã¨ã§ ã‚ãã¼ã†ã­â™ª"]
        };

        window.addEventListener('keydown', (e) => {
            if (isSleepy) return;
            if (e.key >= '0' && e.key <= '9') {
                addNumber(parseInt(e.key));
            } else if (e.key === 'Enter') {
                submitAnswer();
            } else if (e.key === 'Backspace') {
                clearInput();
            }
        });

        function changeChar(type) {
            if (isSleepy) return;
            currentChar = type;
            charIcon.innerText = charData[type].base;
            Object.keys(charData).forEach(t => {
                const btn = document.getElementById('btn-' + t);
                if(btn) btn.classList.remove('char-selected');
            });
            document.getElementById('btn-' + type).classList.add('char-selected');
            bubble.innerText = "ã‚ˆã‚ã—ãã­â™ª";
        }

        function initNumpad() {
            const pad = document.getElementById('numpad');
            pad.innerHTML = '';
            for (let i = 1; i <= 9; i++) {
                const btn = document.createElement('button');
                btn.className = "btn-number bg-yellow-400 hover:bg-yellow-500 text-white text-3xl font-bold py-3 rounded-xl";
                btn.innerText = i;
                btn.onclick = () => addNumber(i);
                pad.appendChild(btn);
            }
        }

        function generateQuestion() {
            let max = score < 10 ? 10 : (score < 20 ? 15 : 20);
            num1 = Math.floor(Math.random() * (max - 1)) + 1;
            num2 = Math.floor(Math.random() * (max - num1 + 1));
            num1El.innerText = num1;
            num2El.innerText = num2;
            currentAnswer = num1 + num2;
            userInput = "";
            inputDisplay.innerText = "";
            wrongCount = 0;
        }

        function addNumber(n) {
            if (isSleepy) return;
            if (userInput.length < 2) {
                userInput += n;
                inputDisplay.innerText = userInput;
            }
        }

        function clearInput() {
            if (isSleepy) return;
            userInput = "";
            inputDisplay.innerText = "";
        }

        function resetGame() {
            score = 0;
            combo = 0;
            wrongCount = 0;
            isSleepy = false;
            gameBody.classList.remove('sleepy-bg');
            scoreEl.innerText = score;
            rankEl.innerText = ranks[0];
            comboContainer.innerHTML = '';
            bubble.innerText = "ã•ã„ã—ã‚‡ã‹ã‚‰ ã‚ãã¼ã†ï¼";
            charIcon.innerText = charData[currentChar].base;
            generateQuestion();
        }

        function showComboEffect() {
            if (combo < 2) return;
            const comboEl = document.createElement('div');
            comboEl.className = 'combo-text text-3xl font-black italic whitespace-nowrap';
            comboEl.innerText = `${combo}ã‚³ãƒ³ãƒœï¼`;
            comboContainer.innerHTML = '';
            comboContainer.appendChild(comboEl);
            if (combo % 3 === 0) {
                bubble.innerText = messages.combo[Math.floor(Math.random() * messages.combo.length)];
            }
        }

        function startSleep() {
            isSleepy = true;
            gameBody.classList.add('sleepy-bg');
            charIcon.innerText = charData[currentChar].sleepy;
            bubble.innerText = messages.sleepy[Math.floor(Math.random() * messages.sleepy.length)];
            
            // 3ç§’é–“ãŠã‚„ã™ã¿ã—ã¦ã‹ã‚‰ãƒªã‚»ãƒƒãƒˆ
            setTimeout(() => {
                resetGame();
            }, 3000);
        }

        function submitAnswer() {
            if (userInput === "" || isSleepy) return;

            if (parseInt(userInput) === currentAnswer) {
                score++;
                combo++;
                wrongCount = 0;
                scoreEl.innerText = score;
                rankEl.innerText = ranks[Math.min(Math.floor(score / 10), ranks.length - 1)];
                
                charIcon.innerText = combo >= 5 ? 'ğŸ‘‘' : charData[currentChar].happy;
                charIcon.parentElement.classList.add('bounce');
                
                const randomMsg = messages.correct[Math.floor(Math.random() * messages.correct.length)];
                bubble.innerText = combo >= 3 ? `${combo}ã‚³ãƒ³ãƒœï¼ã™ã”ã„ã£ï¼` : randomMsg;
                
                showComboEffect();
                overlay.style.opacity = '1';
                createSparkles(combo >= 5 ? 40 : 15);

                setTimeout(() => {
                    if (!isSleepy) {
                        charIcon.innerText = charData[currentChar].base;
                        charIcon.parentElement.classList.remove('bounce');
                        overlay.style.opacity = '0';
                        generateQuestion();
                    }
                }, 800);
            } else {
                combo = 0;
                wrongCount++;
                comboContainer.innerHTML = '';
                
                if (wrongCount >= 3) {
                    startSleep();
                } else {
                    charIcon.innerText = charData[currentChar].think;
                    bubble.innerText = messages.wrong[Math.floor(Math.random() * messages.wrong.length)];
                    userInput = "";
                    inputDisplay.innerText = "";
                    setTimeout(() => {
                        if (!isSleepy) charIcon.innerText = charData[currentChar].base;
                    }, 800);
                }
            }
        }

        function createSparkles(count) {
            for (let i = 0; i < count; i++) {
                const s = document.createElement('div');
                s.className = 'sparkle';
                const items = ['âœ¨', 'â­', 'ğŸˆ', 'ğŸ‰', 'ğŸŠ', 'ğŸ’®'];
                s.innerHTML = items[Math.floor(Math.random() * items.length)];
                s.style.left = '50%';
                s.style.top = '40%';
                s.style.fontSize = (Math.random() * 20 + 20) + 'px';
                const angle = Math.random() * Math.PI * 2;
                const dist = Math.random() * 250 + 50;
                s.style.setProperty('--x', Math.cos(angle) * dist + 'px');
                s.style.setProperty('--y', Math.sin(angle) * dist + 'px');
                document.body.appendChild(s);
                setTimeout(() => s.remove(), 1000);
            }
        }

        initNumpad();
        generateQuestion();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>部首レイダー EX - THE 50 CHALLENGE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap');
        
        body {
            margin: 0;
            overflow: hidden;
            background-color: #020617;
            color: white;
            font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            touch-action: none;
        }
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background: radial-gradient(circle at center, #0f172a 0%, #020617 100%);
        }
        /* 走査線エフェクト */
        #game-container::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }
        canvas {
            background-color: #070b14;
            box-shadow: 0 0 100px rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.4);
            border-radius: 4px;
            max-width: 95vw;
            max-height: 60vh;
            z-index: 1;
        }
        .ui-overlay {
            position: absolute;
            top: 20px;
            pointer-events: none;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }
        .stats-bar {
            display: flex;
            justify-content: space-between;
            width: 90%;
            max-width: 800px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.25rem;
            letter-spacing: 2px;
        }
        #combo-container {
            margin-top: 20px;
            text-align: center;
        }
        .combo-text {
            font-size: 4rem;
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            color: #fbbf24;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.8);
            display: block;
        }
        #quiz-overlay {
            position: absolute;
            background: rgba(2, 6, 23, 0.98);
            padding: 40px;
            border: 4px solid #3b82f6;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1000;
            pointer-events: auto;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 0 150px rgba(59, 130, 246, 0.5);
        }
        .quiz-option {
            background: rgba(30, 41, 59, 0.8);
            padding: 20px;
            margin: 8px;
            border-radius: 4px;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid rgba(255,255,255,0.1);
            width: 100%;
            text-align: center;
            font-weight: bold;
        }
        .quiz-option:hover { 
            background: #3b82f6;
            color: white;
            transform: scale(1.02);
        }
        .hidden { display: none !important; }
        #start-screen, #result-screen {
            position: absolute;
            inset: 0;
            background: #020617;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }
        .mode-btn {
            width: 300px;
            padding: 24px;
            margin: 12px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.4rem;
            font-weight: 900;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s;
        }
        .mode-relax { background: #064e3b; }
        .mode-relax:hover { background: #10b981; box-shadow: 0 0 30px #10b981; }
        .mode-hard { background: #7f1d1d; }
        .mode-hard:hover { background: #ef4444; box-shadow: 0 0 30px #ef4444; }

        .score-pop {
            position: absolute;
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            pointer-events: none;
            animation: scoreFloat 1s ease-out forwards;
            z-index: 500;
        }
        @keyframes scoreFloat {
            0% { transform: translateY(0); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translateY(-100px); opacity: 0; }
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="start-screen">
        <h1 class="text-6xl md:text-8xl font-black mb-4 text-white italic tracking-tighter uppercase" style="font-family: 'Orbitron', sans-serif;">Radical<br><span class="text-blue-500">Raider</span> <span class="text-yellow-400">EX</span></h1>
        <p class="text-blue-400 mb-12 tracking-[0.3em] font-bold">CYBERNETIC RADICAL LEARNING SYSTEM</p>
        <div class="flex flex-col items-center">
            <button class="mode-btn mode-relax" onclick="startGame('relax')">ゆったりモード</button>
            <button class="mode-btn mode-hard" onclick="startGame('hard')">雨後の筍モード</button>
        </div>
        <p class="mt-10 text-slate-500 text-sm">矢印キーまたはWSADで移動。100コンボでクイズフェーズ突入。</p>
    </div>

    <div id="result-screen" class="hidden">
        <h2 class="text-4xl font-bold mb-8 text-blue-400 tracking-widest uppercase">Mission Result</h2>
        <div class="text-9xl font-black mb-4 text-white" id="final-score" style="font-family: 'Orbitron', sans-serif;">0</div>
        <div id="final-stats" class="text-xl text-slate-400 mb-10"></div>
        <div class="w-full max-w-lg mb-10">
            <p class="text-xs text-slate-500 uppercase tracking-widest mb-2">Review Required:</p>
            <div id="review-list" class="max-height-[200px] overflow-y-auto bg-slate-900/50 p-4 border border-white/10 rounded"></div>
        </div>
        <button onclick="location.reload()" class="px-12 py-4 bg-blue-600 text-white font-bold hover:bg-blue-400 transition">REBOOT SYSTEM</button>
    </div>

    <!-- Quiz UI -->
    <div id="quiz-overlay" class="hidden">
        <div id="quiz-combo-label" class="text-yellow-400 font-black mb-2 tracking-widest text-sm">MAX COMBO REACHED - ENTERING QUIZ</div>
        <div id="quiz-progress" class="text-slate-500 font-bold mb-6">PROGRESS: 1 / 50</div>
        <div id="quiz-question" class="text-[10rem] font-bold mb-10 text-white leading-none">氵</div>
        <div id="quiz-options" class="grid grid-cols-1 gap-4 w-full"></div>
    </div>

    <div id="ui-overlay" class="ui-overlay hidden">
        <div class="stats-bar">
            <div>SCORE: <span id="score" class="text-white">0</span></div>
            <div id="timer-display">LIMIT: <span id="timer" class="text-red-500">30.0</span></div>
        </div>
        <div id="combo-container" class="hidden">
            <span class="combo-text" id="combo-count">00</span>
            <div class="text-xs tracking-[0.5em] text-yellow-500 font-bold uppercase">Combo Chain</div>
            <div class="w-64 bg-slate-900 h-1 mt-2 mx-auto">
                <div id="combo-bar" class="bg-yellow-400 h-full w-full"></div>
            </div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="mobile-ui" class="mt-8 sm:hidden hidden">
        <div class="grid grid-cols-3 gap-4">
            <div></div><button class="w-16 h-16 bg-slate-800 rounded flex items-center justify-center text-2xl" id="up-btn">▲</button><div></div>
            <button class="w-16 h-16 bg-slate-800 rounded flex items-center justify-center text-2xl" id="left-btn">◀</button>
            <button class="w-16 h-16 bg-slate-800 rounded flex items-center justify-center text-2xl" id="down-btn">▼</button>
            <button class="w-16 h-16 bg-slate-800 rounded flex items-center justify-center text-2xl" id="right-btn">▶</button>
        </div>
    </div>
</div>

<script>
/**
 * AUDIO ENGINE
 */
let audioCtx;
function initAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
function playSound(type, freq = 440) {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    const now = audioCtx.currentTime;
    if (type === 'move') {
        osc.frequency.setValueAtTime(100, now);
        gain.gain.setValueAtTime(0.05, now);
        osc.start(); osc.stop(now + 0.05);
    } else if (type === 'hit') {
        osc.type = 'square';
        osc.frequency.setValueAtTime(freq, now);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        osc.start(); osc.stop(now + 0.1);
    } else if (type === 'correct') {
        osc.frequency.setValueAtTime(523, now);
        osc.frequency.exponentialRampToValueAtTime(1046, now + 0.3);
        gain.gain.setValueAtTime(0.1, now);
        osc.start(); osc.stop(now + 0.3);
    }
}

/**
 * DATA - ユニーク50問
 */
const MASTER_RADICAL_LIST = [
    { q: "氵", a: "さんずい", opts: ["さんずい", "にすい", "したみず"] },
    { q: "亻", a: "にんべん", opts: ["にんべん", "ぎょうにんべん", "けものへん"] },
    { q: "扌", a: "てへん", opts: ["てへん", "つくり", "ほこづくり"] },
    { q: "彳", a: "ぎょうにんべん", opts: ["ぎょうにんべん", "にんべん", "いとへん"] },
    { q: "艹", a: "くさかんむり", opts: ["くさかんむり", "たけかんむり", "あめかんむり"] },
    { q: "宀", a: "うかんむり", opts: ["うかんむり", "わかんむり", "あなかんむり"] },
    { q: "辶", a: "しんにょう", opts: ["しんにょう", "えんにょう", "かんにょう"] },
    { q: "阝(左)", a: "こざとへん", opts: ["こざとへん", "おおざと", "のぎへん"] },
    { q: "阝(右)", a: "おおざと", opts: ["おおざと", "こざとへん", "つくり"] },
    { q: "刂", a: "りっとう", opts: ["りっとう", "かたなへん", "のぶん"] },
    { q: "犭", a: "けものへん", opts: ["けものへん", "にんべん", "さんずい"] },
    { q: "礻", a: "しめすへん", opts: ["しめすへん", "ころもへん", "のぎへん"] },
    { q: "攵", a: "のぶん", opts: ["のぶん", "ぼくづくり", "あくび"] },
    { q: "欠", a: "あくび", opts: ["あくび", "のぶん", "るまた"] },
    { q: "疒", a: "やまいだれ", opts: ["やまいだれ", "まだれ", "かばね"] },
    { q: "广", a: "まだれ", opts: ["まだれ", "やまいだれ", "しかばね"] },
    { q: "貝", a: "かいへん", opts: ["かいへん", "めへん", "たまへん"] },
    { q: "言", a: "ごんべん", opts: ["ごんべん", "にんべん", "いとへん"] },
    { q: "衤", a: "ころもへん", opts: ["ころもへん", "しめすへん", "いとへん"] },
    { q: "禾", a: "のぎへん", opts: ["のぎへん", "きへん", "いとへん"] },
    { q: "虫", a: "むしへん", opts: ["むしへん", "けものへん", "さかなへん"] },
    { q: "足", a: "あしへん", opts: ["あしへん", "みへん", "くるまへん"] },
    { q: "酉", a: "とりへん", opts: ["とりへん", "さかなへん", "むしへん"] },
    { q: "釒", a: "かねへん", opts: ["かねへん", "いしへん", "たまへん"] },
    { q: "虍", a: "とらかんむり", opts: ["とらかんむり", "むしかんむり", "あなかんむり"] },
    { q: "門", a: "もんがまえ", opts: ["もんがまえ", "くにがまえ", "ぎょうがまえ"] },
    { q: "囗", a: "くにがまえ", opts: ["くにがまえ", "もんがまえ", "しかばね"] },
    { q: "尸", a: "しかばね", opts: ["しかばね", "まだれ", "やまいだれ"] },
    { q: "目", a: "めへん", opts: ["めへん", "ひへん", "かねへん"] },
    { q: "日", a: "ひへん", opts: ["ひへん", "めへん", "かねへん"] },
    { q: "月", a: "にくづき", opts: ["にくづき", "つきへん", "ふねへん"] },
    { q: "舟", a: "ふねへん", opts: ["ふねへん", "にくづき", "くるまへん"] },
    { q: "車", a: "くるまへん", opts: ["くるまへん", "ふねへん", "かねへん"] },
    { q: "馬", a: "うまへん", opts: ["うまへん", "しかへん", "とりへん"] },
    { q: "鳥", a: "とりへん", opts: ["とりへん", "うまへん", "さかなへん"] },
    { q: "魚", a: "さかなへん", opts: ["さかなへん", "とりへん", "むしへん"] },
    { q: "竹", a: "たけかんむり", opts: ["たけかんむり", "くさかんむり", "あめかんむり"] },
    { q: "雨", a: "あめかんむり", opts: ["あめかんむり", "たけかんむり", "うかんむり"] },
    { q: "田", a: "たへん", opts: ["たへん", "いしへん", "のぎへん"] },
    { q: "石", a: "いしへん", opts: ["いしへん", "かねへん", "たまへん"] },
    { q: "王", a: "たまへん", opts: ["たまへん", "かねへん", "いしへん"] },
    { q: "巾", a: "はばへん", opts: ["はばへん", "いとへん", "ころもへん"] },
    { q: "糸", a: "いとへん", opts: ["いとへん", "はばへん", "ごんべん"] },
    { q: "耳", a: "みみへん", opts: ["みみへん", "めへん", "くちへん"] },
    { q: "土", a: "つちへん", opts: ["つちへん", "おんなへん", "きへん"] },
    { q: "女", a: "おんなへん", opts: ["おんなへん", "つちへん", "にんべん"] },
    { q: "弓", a: "ゆみへん", opts: ["ゆみへん", "かたなへん", "ほこづくり"] },
];

/**
 * GAME ENGINE
 */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const timerEl = document.getElementById('timer');
const comboEl = document.getElementById('combo-count');
const comboContainer = document.getElementById('combo-container');
const comboBar = document.getElementById('combo-bar');

const CELL_COUNT = 9;
let cellSize, width, height;

let player = { gridX: 4, gridY: 4, vX: 4, vY: 4, score: 0, combo: 0, comboTimer: 0, maxCombo: 0 };
let enemies = [];
let particles = [];
let usedQuizzes = [];
let reviewData = [];
let gameStarted = false, isGameOver = false, isPaused = false;
let lastTime = 0, spawnTimer = 0, timeLeft = 30.0, shake = 0;
let moveCooldown = 0;
let gameMode = 'relax';
const keys = {};

function resize() {
    const size = Math.min(window.innerWidth * 0.95, window.innerHeight * 0.6);
    canvas.width = canvas.height = width = height = size;
    cellSize = size / CELL_COUNT;
}
window.addEventListener('resize', resize);
resize();

function spawnEnemy() {
    if (isPaused) return;
    const limit = gameMode === 'hard' ? 45 : 18;
    if (enemies.length > limit) return;
    let x, y;
    do {
        x = Math.floor(Math.random() * CELL_COUNT);
        y = Math.floor(Math.random() * CELL_COUNT);
    } while (Math.abs(x - player.gridX) + Math.abs(y - player.gridY) < 2);
    
    enemies.push({ 
        gridX: x, gridY: y, vX: x, vY: y, 
        moveTimer: 0, 
        isRare: Math.random() < (gameMode === 'hard' ? 0.15 : 0.08),
        phase: Math.random() * Math.PI * 2
    });
}

function handleInput(dt) {
    if (isPaused || isGameOver) return;
    moveCooldown -= dt;
    if (moveCooldown <= 0) {
        let dx = 0, dy = 0;
        if (keys['ArrowUp'] || keys['w']) dy = -1;
        else if (keys['ArrowDown'] || keys['s']) dy = 1;
        else if (keys['ArrowLeft'] || keys['a']) dx = -1;
        else if (keys['ArrowRight'] || keys['d']) dx = 1;
        
        if (dx !== 0 || dy !== 0) {
            const nx = Math.max(0, Math.min(CELL_COUNT-1, player.gridX + dx));
            const ny = Math.max(0, Math.min(CELL_COUNT-1, player.gridY + dy));
            if (nx !== player.gridX || ny !== player.gridY) {
                player.gridX = nx; player.gridY = ny;
                playSound('move');
                checkHit();
                moveCooldown = 0.08;
            }
        }
    }
}

function checkHit() {
    for (let i = enemies.length - 1; i >= 0; i--) {
        const e = enemies[i];
        if (e.gridX === player.gridX && e.gridY === player.gridY) {
            enemies.splice(i, 1);
            player.combo++;
            player.comboTimer = 1.4; // 70% duration
            player.maxCombo = Math.max(player.maxCombo, player.combo);
            
            const points = e.isRare ? 500 : 100;
            player.score += points;
            scoreEl.innerText = player.score;
            shake = e.isRare ? 25 : 10;
            createExplosion(e.gridX, e.gridY, e.isRare ? '#fbbf24' : '#ef4444', e.isRare ? 30 : 15);
            playSound('hit', 200 + player.combo * 5);

            if (player.combo >= 100) {
                enemies = []; // 100コンボで敵一掃
                startQuizSequence();
            }
        }
    }
}

function startQuizSequence() {
    isPaused = true;
    const available = MASTER_RADICAL_LIST.filter(r => !usedQuizzes.includes(r.q));
    if (available.length === 0) {
        // 全問解いた場合はリセットして継続
        usedQuizzes = [];
    }
    
    // 50問の中からランダムに1問選択
    const quiz = available[Math.floor(Math.random() * available.length)];
    usedQuizzes.push(quiz.q);
    
    const overlay = document.getElementById('quiz-overlay');
    document.getElementById('quiz-progress').innerText = `UNIQUE CHALLENGE: ${usedQuizzes.length} / 50`;
    document.getElementById('quiz-question').innerText = quiz.q;
    
    const optsBox = document.getElementById('quiz-options');
    optsBox.innerHTML = '';
    [...quiz.opts].sort(() => Math.random() - 0.5).forEach(opt => {
        const btn = document.createElement('div');
        btn.className = 'quiz-option';
        btn.innerText = opt;
        btn.onclick = () => {
            if (opt === quiz.a) {
                const bonus = 10000;
                player.score += bonus;
                scoreEl.innerText = player.score;
                playSound('correct');
                showPop(`QUIZ BONUS +${bonus}`, '#fbbf24');
                createExplosion(CELL_COUNT/2, CELL_COUNT/2, '#3b82f6', 50, true);
            } else {
                reviewData.push(quiz);
                showPop(`MISS`, '#ef4444');
            }
            overlay.classList.add('hidden');
            isPaused = false;
            player.combo = 0; // コンボリセット
            comboContainer.classList.add('hidden');
        };
        optsBox.appendChild(btn);
    });
    
    overlay.classList.remove('hidden');
}

function createExplosion(gx, gy, color, count, center = false) {
    const sx = center ? width/2 : (gx + 0.5) * cellSize;
    const sy = center ? height/2 : (gy + 0.5) * cellSize;
    for (let i = 0; i < count; i++) {
        particles.push({
            x: sx, y: sy,
            vx: (Math.random()-0.5)*20, vy: (Math.random()-0.5)*20,
            life: 1.0, color, size: Math.random()*5 + 1
        });
    }
}

function showPop(text, color) {
    const div = document.createElement('div');
    div.className = 'score-pop';
    div.style.color = color;
    div.style.left = '50%';
    div.style.top = '45%';
    div.innerText = text;
    document.getElementById('game-container').appendChild(div);
    setTimeout(() => div.remove(), 1000);
}

function update(dt) {
    if (isGameOver || !gameStarted || isPaused) return;
    
    handleInput(dt);
    timeLeft -= dt;
    if (timeLeft <= 0) { timeLeft = 0; isGameOver = true; showResults(); }
    timerEl.innerText = timeLeft.toFixed(1);

    // ビジュアル同期 (Lerp)
    const l = 25 * dt;
    player.vX += (player.gridX - player.vX) * l;
    player.vY += (player.gridY - player.vY) * l;

    if (player.combo > 0) {
        player.comboTimer -= dt;
        comboContainer.classList.remove('hidden');
        comboEl.innerText = player.combo.toString().padStart(2, '0');
        comboBar.style.width = (player.comboTimer / 1.4 * 100) + "%";
        if (player.comboTimer <= 0) {
            startQuizSequence();
        }
    }

    spawnTimer += dt;
    const rate = gameMode === 'hard' ? 0.07 : 0.4;
    if (spawnTimer > rate) { spawnEnemy(); spawnTimer = 0; }

    enemies.forEach(e => {
        e.vX += (e.gridX - e.vX) * (l * 0.5);
        e.vY += (e.gridY - e.vY) * (l * 0.5);
        e.moveTimer += dt;
        const mRate = gameMode === 'hard' ? 0.35 : 0.8;
        if (e.moveTimer > mRate) {
            e.moveTimer = 0;
            const dirs = [[0,1],[0,-1],[1,0],[-1,0]];
            const d = dirs[Math.floor(Math.random()*4)];
            e.gridX = Math.max(0, Math.min(CELL_COUNT-1, e.gridX + d[0]));
            e.gridY = Math.max(0, Math.min(CELL_COUNT-1, e.gridY + d[1]));
            if (e.gridX === player.gridX && e.gridY === player.gridY) checkHit();
        }
    });

    particles.forEach((p, i) => {
        p.x += p.vx; p.y += p.vy; p.life -= dt;
        if (p.life <= 0) particles.splice(i, 1);
    });
    if (shake > 0) shake *= 0.9;
}

function draw() {
    ctx.clearRect(0, 0, width, height);
    ctx.save();
    if (shake > 1) ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake);

    // グリッド線
    ctx.strokeStyle = 'rgba(59, 130, 246, 0.15)';
    ctx.lineWidth = 1;
    for (let i = 0; i <= CELL_COUNT; i++) {
        ctx.beginPath(); ctx.moveTo(i*cellSize, 0); ctx.lineTo(i*cellSize, height); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0, i*cellSize); ctx.lineTo(width, i*cellSize); ctx.stroke();
    }

    // パーティクル
    particles.forEach(p => {
        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
    });
    ctx.globalAlpha = 1;

    // 敵の描画 (幾何学的なクリスタル)
    enemies.forEach(e => {
        const x = (e.vX + 0.5) * cellSize;
        const y = (e.vY + 0.5) * cellSize;
        const r = cellSize * 0.35 + Math.sin(Date.now()*0.01 + e.phase)*3;
        
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(Date.now() * 0.003 + e.phase);
        
        ctx.shadowBlur = e.isRare ? 20 : 10;
        ctx.shadowColor = e.isRare ? '#fbbf24' : '#ef4444';
        ctx.fillStyle = e.isRare ? '#fbbf24' : '#ef4444';
        
        // 八角形
        ctx.beginPath();
        for (let i = 0; i < 8; i++) {
            const ang = i * Math.PI / 4;
            const dist = i % 2 === 0 ? r : r * 0.6;
            ctx.lineTo(Math.cos(ang)*dist, Math.sin(ang)*dist);
        }
        ctx.closePath();
        ctx.fill();
        
        ctx.fillStyle = 'rgba(255,255,255,0.3)';
        ctx.beginPath(); ctx.arc(0, 0, r*0.2, 0, Math.PI*2); ctx.fill();
        ctx.restore();
    });

    // プレイヤーの描画 (スラスター付)
    const px = (player.vX + 0.5) * cellSize;
    const py = (player.vY + 0.5) * cellSize;
    const ps = cellSize * 0.6;

    // スラスター
    ctx.fillStyle = '#3b82f6';
    ctx.globalAlpha = 0.4 + Math.random()*0.4;
    for(let i=0; i<3; i++) {
        const rx = px + (Math.random()-0.5)*ps;
        const ry = py + ps*0.4 + Math.random()*ps*0.3;
        ctx.beginPath(); ctx.arc(rx, ry, Math.random()*5, 0, Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha = 1.0;

    ctx.save();
    ctx.shadowBlur = 15 + player.combo;
    ctx.shadowColor = '#3b82f6';
    ctx.fillStyle = '#0f172a';
    ctx.strokeStyle = '#60a5fa';
    ctx.lineWidth = 2;
    
    // ボディ
    ctx.beginPath();
    ctx.moveTo(px, py - ps/2);
    ctx.lineTo(px + ps/2, py + ps/3);
    ctx.lineTo(px, py + ps/6);
    ctx.lineTo(px - ps/2, py + ps/3);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();

    // コア
    ctx.fillStyle = '#60a5fa';
    ctx.beginPath(); ctx.arc(px, py, ps*0.15, 0, Math.PI*2); ctx.fill();
    ctx.restore();

    ctx.restore();
}

function showResults() {
    document.getElementById('ui-overlay').classList.add('hidden');
    document.getElementById('result-screen').classList.remove('hidden');
    document.getElementById('final-score').innerText = player.score.toLocaleString();
    document.getElementById('final-stats').innerText = `MAX COMBO: ${player.maxCombo} | UNIQUE SOLVED: ${usedQuizzes.length}`;
    
    const list = document.getElementById('review-list');
    list.innerHTML = reviewData.length > 0 
        ? [...new Set(reviewData)].map(r => `<div class="p-2 mb-1 bg-white/5 border-l-2 border-red-500 text-sm">【${r.q}】 : ${r.a}</div>`).join('')
        : "<div class='text-blue-400 font-bold'>PERFECT PERFORMANCE</div>";
}

function loop(time) {
    const dt = Math.min(0.1, (time - (lastTime || time)) / 1000);
    lastTime = time;
    update(dt);
    draw();
    if (!isGameOver) requestAnimationFrame(loop);
}

function startGame(mode) {
    initAudio();
    gameMode = mode;
    gameStarted = true; isGameOver = false; isPaused = false;
    timeLeft = 30.0; player.score = 0; player.combo = 0; player.maxCombo = 0;
    player.gridX = 4; player.gridY = 4; player.vX = 4; player.vY = 4;
    enemies = []; particles = []; reviewData = []; usedQuizzes = [];
    scoreEl.innerText = "0";
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('result-screen').classList.add('hidden');
    document.getElementById('ui-overlay').classList.remove('hidden');
    lastTime = performance.now();
    requestAnimationFrame(loop);
}

window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = keys[e.key] = true);
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = keys[e.key] = false);

// Mobile
['up-btn','down-btn','left-btn','right-btn'].forEach((id, i) => {
    const b = document.getElementById(id);
    const k = ['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'][i];
    b.onpointerdown = (e) => { e.preventDefault(); keys[k] = true; };
    b.onpointerup = () => keys[k] = false;
});
</script>
</body>
</html>
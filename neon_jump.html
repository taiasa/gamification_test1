<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Jump Action Game - Math Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0f172a;
            touch-action: manipulation;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        canvas {
            display: block;
            max-width: 100%;
            max-height: 100%;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
            background: linear-gradient(to bottom, #1e293b, #0f172a);
        }
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }
        .menu-card {
            pointer-events: auto;
            background: rgba(15, 23, 42, 0.95);
            padding: 2rem;
            border-radius: 1rem;
            border: 2px solid #38bdf8;
            text-align: center;
            backdrop-filter: blur(10px);
            min-width: 320px;
        }
        .btn {
            pointer-events: auto;
            background: #38bdf8;
            color: #0f172a;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            margin-top: 1rem;
        }
        .btn:hover {
            background: #7dd3fc;
            transform: scale(1.05);
        }
        #score-display {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #38bdf8;
            text-shadow: 0 0 10px rgba(56, 189, 248, 0.5);
        }
        .difficulty-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 1.5rem 0;
        }
        .diff-option {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(56, 189, 248, 0.3);
            border-radius: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .diff-option:hover {
            background: rgba(56, 189, 248, 0.1);
        }
        input[type="radio"]:checked + span {
            color: #38bdf8;
            font-weight: bold;
        }
        input[type="radio"] {
            cursor: pointer;
        }
        #math-answer {
            -moz-appearance: textfield;
        }
        #math-answer::-webkit-outer-spin-button,
        #math-answer::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <div id="score-display">Distance: 0m</div>

    <div id="ui-layer">
        <!-- Start Menu -->
        <div id="start-menu" class="menu-card">
            <h1 class="text-3xl font-bold mb-2 text-sky-400">NEON JUMP MATH</h1>
            <p class="mb-4 opacity-80 text-sm">障害物を算数で破壊せよ！</p>
            
            <div class="text-left text-sm font-bold text-sky-200 mb-2">難易度を選択:</div>
            <div class="difficulty-selector">
                <label class="diff-option">
                    <input type="radio" name="difficulty" value="B">
                    <span>B (ゆっくり)</span>
                </label>
                <label class="diff-option">
                    <input type="radio" name="difficulty" value="A" checked>
                    <span>A (ふつう)</span>
                </label>
                <label class="diff-option">
                    <input type="radio" name="difficulty" value="S">
                    <span>S (速い)</span>
                </label>
                <label class="diff-option border-red-500">
                    <input type="radio" name="difficulty" value="SSS">
                    <span class="text-red-400">SSS (激ムズ)</span>
                </label>
            </div>

            <button class="btn w-full" onclick="startGame()">ゲームスタート</button>
        </div>

        <!-- Math Quiz Menu -->
        <div id="math-quiz-menu" class="menu-card hidden">
            <h2 class="text-2xl font-bold mb-4 text-yellow-400">MATH SHIELD!</h2>
            <div id="math-question" class="text-3xl font-mono font-bold my-4 text-white">0.5 + 0.3 = ?</div>
            <input type="number" id="math-answer" step="0.01" class="w-full p-3 rounded bg-slate-800 border-2 border-sky-500 text-center text-2xl focus:outline-none focus:border-yellow-400 text-white mb-4" placeholder="答えを入力">
            <button class="btn w-full" onclick="checkAnswer()">回答する</button>
        </div>

        <!-- Game Over Menu -->
        <div id="game-over-menu" class="menu-card hidden">
            <h1 class="text-4xl font-bold mb-2 text-red-500">GAME OVER</h1>
            <p id="final-score" class="text-2xl mb-6">Distance: 0m</p>
            <button class="btn" onclick="startGame()">もう一度挑戦</button>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreDisplay = document.getElementById('score-display');
    const startMenu = document.getElementById('start-menu');
    const mathQuizMenu = document.getElementById('math-quiz-menu');
    const mathQuestionEl = document.getElementById('math-question');
    const mathAnswerInput = document.getElementById('math-answer');
    const gameOverMenu = document.getElementById('game-over-menu');
    const finalScoreTxt = document.getElementById('final-score');

    // Configuration
    let gameActive = false;
    let isPaused = false;
    let score = 0;
    let gameSpeed = 5;
    let speedIncrement = 0.0008;
    const gravity = 0.6;
    const jumpForce = -12;
    const groundHeight = 80;

    // Difficulty Settings
    const DIFFICULTY_CONFIG = {
        'B':   { initialSpeed: 4, accel: 0.0004, minSpawn: 800, maxSpawn: 2200 },
        'A':   { initialSpeed: 6, accel: 0.0008, minSpawn: 100, maxSpawn: 2000 },
        'S':   { initialSpeed: 9, accel: 0.0015, minSpawn: 50,  maxSpawn: 1500 },
        'SSS': { initialSpeed: 14, accel: 0.003, minSpawn: 10,  maxSpawn: 800 }
    };
    let currentDiff = 'A';

    // Obstacle Spawning Logic
    let nextSpawnTime = 0;
    let lastSpawnTime = 0;

    // Quiz State
    let currentCorrectAnswer = 0;
    let collisionTargetIdx = -1;

    // Player Object
    const player = {
        x: 100,
        y: 0,
        width: 40,
        height: 40,
        dy: 0,
        color: '#38bdf8',
        isGrounded: false,
        jumpCount: 0,
        rotate: 0,
        invulnTime: 0
    };

    // Obstacles & Particles
    let obstacles = [];
    let particles = [];

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = Math.min(window.innerHeight, 500);
        player.y = canvas.height - groundHeight - player.height;
    }

    window.addEventListener('resize', resize);
    resize();

    // Input Handling
    function handleAction() {
        if (!gameActive || isPaused) return;
        
        if (player.isGrounded || player.jumpCount < 2) {
            player.dy = jumpForce;
            player.isGrounded = false;
            player.jumpCount++;
            
            const particleColor = player.jumpCount === 2 ? '#fff' : '#38bdf8';
            createParticles(player.x + player.width / 2, player.y + player.height, particleColor, 12);
        }
    }

    window.addEventListener('keydown', (e) => {
        if (e.code === 'Space') handleAction();
        if (e.code === 'Enter' && isPaused) checkAnswer();
    });
    canvas.addEventListener('mousedown', (e) => {
        if (e.button === 0) handleAction();
    });
    canvas.addEventListener('touchstart', (e) => {
        if (!isPaused) e.preventDefault();
        handleAction();
    });

    function createParticles(x, y, color, count) {
        for (let i = 0; i < count; i++) {
            particles.push({
                x: x,
                y: y,
                vx: (Math.random() - 0.5) * 8,
                vy: (Math.random() - 0.5) * 8,
                life: 1,
                color: color,
                size: Math.random() * 4 + 2
            });
        }
    }

    function generateMathProblem() {
        const level = Math.floor(score / 50);
        const isSubtraction = Math.random() > 0.5;
        let a, b;

        if (level === 0) {
            a = parseFloat((Math.random() * 5 + 1).toFixed(1));
            b = parseFloat((Math.random() * 5 + 1).toFixed(1));
        } else {
            const precision = level > 2 ? 2 : 1;
            a = parseFloat((Math.random() * 10 + 1).toFixed(precision));
            b = parseFloat((Math.random() * 10 + 1).toFixed(precision));
        }

        if (isSubtraction && a < b) [a, b] = [b, a];

        const op = isSubtraction ? '-' : '+';
        const answer = isSubtraction ? a - b : a + b;

        currentCorrectAnswer = parseFloat(answer.toFixed(2));
        mathQuestionEl.innerText = `${a} ${op} ${b} = ?`;
        
        isPaused = true;
        mathQuizMenu.classList.remove('hidden');
        mathAnswerInput.value = "";
        setTimeout(() => mathAnswerInput.focus(), 100);
    }

    function checkAnswer() {
        const userAnswer = parseFloat(mathAnswerInput.value);
        if (Math.abs(userAnswer - currentCorrectAnswer) < 0.01) {
            isPaused = false;
            mathQuizMenu.classList.add('hidden');
            
            const o = obstacles[collisionTargetIdx];
            if (o) {
                createParticles(o.x + o.width/2, o.y + o.height/2, o.color, 30);
                obstacles.splice(collisionTargetIdx, 1);
            }
            
            player.invulnTime = 30; 
            requestAnimationFrame(update);
        } else {
            mathQuizMenu.classList.add('hidden');
            gameOver();
        }
    }

    function getNextSpawnDelay() {
        const config = DIFFICULTY_CONFIG[currentDiff];
        const minDelay = config.minSpawn;
        const maxDelay = Math.max(minDelay + 200, config.maxSpawn - (score * 5));
        return Math.random() * (maxDelay - minDelay) + minDelay;
    }

    function spawnObstacle() {
        const h = Math.random() * 60 + 30;
        const w = 30;
        obstacles.push({
            x: canvas.width,
            y: canvas.height - groundHeight - h,
            width: w,
            height: h,
            color: '#f43f5e'
        });
        nextSpawnTime = getNextSpawnDelay();
    }

    function startGame() {
        // Read selected difficulty
        const radios = document.getElementsByName('difficulty');
        for (let r of radios) {
            if (r.checked) currentDiff = r.value;
        }

        const config = DIFFICULTY_CONFIG[currentDiff];
        gameSpeed = config.initialSpeed;
        speedIncrement = config.accel;

        gameActive = true;
        isPaused = false;
        score = 0;
        obstacles = [];
        particles = [];
        player.dy = 0;
        player.jumpCount = 0;
        player.invulnTime = 0;
        player.y = canvas.height - groundHeight - player.height;
        
        startMenu.classList.add('hidden');
        gameOverMenu.classList.add('hidden');
        mathQuizMenu.classList.add('hidden');
        
        lastSpawnTime = Date.now();
        nextSpawnTime = getNextSpawnDelay(); 
        requestAnimationFrame(update);
    }

    function update() {
        if (!gameActive || isPaused) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Ground
        ctx.fillStyle = '#1e293b';
        ctx.fillRect(0, canvas.height - groundHeight, canvas.width, groundHeight);
        ctx.strokeStyle = '#38bdf8';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(0, canvas.height - groundHeight);
        ctx.lineTo(canvas.width, canvas.height - groundHeight);
        ctx.stroke();

        // Player physics
        player.dy += gravity;
        player.y += player.dy;

        if (player.y > canvas.height - groundHeight - player.height) {
            player.y = canvas.height - groundHeight - player.height;
            player.dy = 0;
            if (!player.isGrounded) {
                player.isGrounded = true;
                player.jumpCount = 0;
            }
            player.rotate = 0;
        } else {
            player.rotate += 0.15;
        }

        if (player.invulnTime > 0) player.invulnTime--;

        // Draw Player
        if (player.invulnTime % 6 < 3) {
            ctx.save();
            ctx.translate(player.x + player.width/2, player.y + player.height/2);
            ctx.rotate(player.rotate);
            ctx.shadowBlur = player.invulnTime > 0 ? 25 : 15;
            ctx.shadowColor = player.invulnTime > 0 ? '#fff' : player.color;
            ctx.fillStyle = player.invulnTime > 0 ? '#fff' : player.color;
            ctx.fillRect(-player.width/2, -player.height/2, player.width, player.height);
            
            if (player.jumpCount === 1) {
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.strokeRect(-player.width/2 - 2, -player.height/2 - 2, player.width + 4, player.height + 4);
            }
            ctx.restore();
        }

        // Particles
        for (let i = particles.length - 1; i >= 0; i--) {
            const p = particles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.life -= 0.025;
            ctx.globalAlpha = Math.max(0, p.life);
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, p.size, p.size);
            if (p.life <= 0) particles.splice(i, 1);
        }
        ctx.globalAlpha = 1;

        // Obstacles
        const now = Date.now();
        if (now - lastSpawnTime > nextSpawnTime) {
            spawnObstacle();
            lastSpawnTime = now;
        }

        for (let i = obstacles.length - 1; i >= 0; i--) {
            const o = obstacles[i];
            o.x -= gameSpeed;

            ctx.shadowBlur = 10;
            ctx.shadowColor = o.color;
            ctx.fillStyle = o.color;
            ctx.fillRect(o.x, o.y, o.width, o.height);

            if (
                player.invulnTime <= 0 &&
                player.x < o.x + o.width &&
                player.x + player.width > o.x &&
                player.y < o.y + o.height &&
                player.y + player.height > o.y
            ) {
                collisionTargetIdx = i;
                generateMathProblem();
                return;
            }

            if (o.x + o.width < 0) {
                obstacles.splice(i, 1);
            }
        }

        score += 0.1;
        gameSpeed += speedIncrement;
        scoreDisplay.innerText = `Distance: ${Math.floor(score)}m [${currentDiff} Class]`;

        requestAnimationFrame(update);
    }

    function gameOver() {
        gameActive = false;
        isPaused = false;
        createParticles(player.x + player.width/2, player.y + player.height/2, '#38bdf8', 25);
        createParticles(player.x + player.width/2, player.y + player.height/2, '#f43f5e', 25);
        
        finalScoreTxt.innerText = `Distance: ${Math.floor(score)}m (${currentDiff} Class)`;
        gameOverMenu.classList.remove('hidden');
    }
</script>

</body>
</html>
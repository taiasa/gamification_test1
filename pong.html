<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>çˆ½å¿«ãƒ”ãƒ³ãƒãƒ³ã‚²ãƒ¼ãƒ  ULTIMATE++</title>
<style>
body{
  margin:0;
  background:radial-gradient(#111,#000);
  color:#0ff;
  font-family:sans-serif;
}
canvas{
  display:block;
  margin:auto;
  background:#000;
}
#ui{
  position:absolute;
  top:10px;
  width:100%;
  text-align:center;
  pointer-events:none;
}
#overlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.85);
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  z-index:10;
}
#overlay button{
  margin-top:20px;
  font-size:18px;
  padding:10px 20px;
}
.ruleBox{
  margin-top:10px;
  font-size:16px;
}
</style>
</head>
<body>

<div id="ui">
  <div id="score">LEFT 0 : 0 RIGHT</div>
</div>

<div id="overlay">
  <div>
    <h1>çˆ½å¿«ãƒ”ãƒ³ãƒãƒ³ã‚²ãƒ¼ãƒ </h1>
    <p>
      å·¦ï¼šW / Sï¼ˆA/Dã¯ç‰¹åˆ¥ãƒ«ãƒ¼ãƒ«ï¼‰<br>
      å³ï¼šâ†‘ / â†“ï¼ˆâ†/â†’ã¯ç‰¹åˆ¥ãƒ«ãƒ¼ãƒ«ï¼‰<br><br>
      ğŸ”¥ Sï¼šé€Ÿåº¦UPã€€ğŸŒ€ Cï¼šæ€¥ã‚«ãƒ¼ãƒ–<br>
      ğŸ“ Lï¼šç›¸æ‰‹ãƒãƒ¼æ‹¡å¼µ<br><br>
      å…ˆã« <b>10ç‚¹</b> å–ã£ãŸæ–¹ã®å‹ã¡
    </p>

    <div class="ruleBox">
      <label>
        <input type="radio" name="rule" value="normal" checked>
        é€šå¸¸ãƒ«ãƒ¼ãƒ«
      </label><br>
      <label>
        <input type="radio" name="rule" value="volley">
        ç‰¹åˆ¥ãƒ«ãƒ¼ãƒ«ï¼ˆãƒœãƒ¬ãƒ¼ã‚ã‚Šï¼‰
      </label>
    </div>

    <button onclick="startGame()">START</button>
  </div>
</div>

<canvas id="game" width="900" height="500"></canvas>

<script>
/* ========= AUDIO ========= */
let audioCtx;
function initAudio(){
  if(!audioCtx){
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  }
}
function se(freq,d=0.1,type="sine",v=0.2){
  if(!audioCtx) return;
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type=type; o.frequency.value=freq; g.gain.value=v;
  o.connect(g).connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime+d);
}
const seHit=()=>se(900,0.05,"square",0.15);
const seScore=()=>se(220,0.3,"sawtooth",0.25);
const seItem=()=>se(1200,0.12,"triangle",0.2);

/* ========= GAME ========= */
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const W=canvas.width,H=canvas.height;
const WIN_SCORE=10;

let rule="normal";
let left,right,ball;
let items=[];                // â˜… è¿½åŠ 
let scoreL=0,scoreR=0;
let running=false,gameOver=false;
let curveDelay=0,curvePower=0;

function init(){
  left={x:30,y:H/2,tx:30,ty:H/2,h:100};
  right={x:W-42,y:H/2,tx:W-42,ty:H/2,h:100};
  items=[];
  resetBall();
}
function resetBall(dir=1){
  ball={x:W/2,y:H/2,vx:dir*6,vy:(Math.random()*2-1)*4,r:8,speed:1};
  curveDelay=curvePower=0;
}
init();

const keys={};
addEventListener("keydown",e=>keys[e.key]=true);
addEventListener("keyup",e=>keys[e.key]=false);

function startGame(){
  initAudio();
  rule=document.querySelector("input[name=rule]:checked").value;
  document.getElementById("overlay").style.display="none";
  scoreL=scoreR=0;
  updateScore();
  gameOver=false;
  running=true;
  items=[];
  resetBall(Math.random()>0.5?1:-1);
}

function updateScore(){
  document.getElementById("score").textContent=
    `LEFT ${scoreL} : ${scoreR} RIGHT`;
}

/* ========= ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆ ========= */
setInterval(()=>{
  if(!running||gameOver) return;
  if(items.length>=5) return;

  items.push({
    x:Math.random()*(W-200)+100,
    y:Math.random()*(H-100)+50,
    r:18,
    type:["speed","curve","long"][Math.floor(Math.random()*3)]
  });
},4000);

function applyItem(type,player){
  seItem();
  if(type==="speed") ball.speed+=0.7;
  if(type==="curve"){
    curveDelay=40;
    curvePower=(Math.random()>0.5?1:-1)*(4+Math.random()*3);
  }
  if(type==="long"){
    const t = player===left ? right : left;
    t.h=160;
    setTimeout(()=>t.h=100,5000);
  }
}

/* ========= UPDATE ========= */
function update(){
  if(!running||gameOver) return;

  if(keys["w"]) left.ty-=8;
  if(keys["s"]) left.ty+=8;
  if(keys["ArrowUp"]) right.ty-=8;
  if(keys["ArrowDown"]) right.ty+=8;

  if(rule==="volley"){
    if(keys["a"]) left.tx-=6;
    if(keys["d"]) left.tx+=6;
    if(keys["ArrowLeft"]) right.tx-=6;
    if(keys["ArrowRight"]) right.tx+=6;
  }

  left.tx=Math.max(10,Math.min(W/2-20,left.tx));
  right.tx=Math.max(W/2+8,Math.min(W-20,right.tx));
  left.ty=Math.max(left.h/2,Math.min(H-left.h/2,left.ty));
  right.ty=Math.max(right.h/2,Math.min(H-right.h/2,right.ty));

  left.x+=(left.tx-left.x)*0.25;
  left.y+=(left.ty-left.y)*0.25;
  right.x+=(right.tx-right.x)*0.25;
  right.y+=(right.ty-right.y)*0.25;

  ball.x+=ball.vx*ball.speed;
  ball.y+=ball.vy*ball.speed;

  if(curveDelay>0 && --curveDelay===0) ball.vy+=curvePower;
  if(ball.y<ball.r||ball.y>H-ball.r) ball.vy*=-1;

  function hit(p,isLeft){
    if(ball.x+ball.r>p.x && ball.x-ball.r<p.x+12 &&
       ball.y>p.y-p.h/2 && ball.y<p.y+p.h/2){
      seHit();
      const pos=(ball.y-p.y)/(p.h/2);
      ball.vy=pos*7;
      ball.vx=isLeft?Math.abs(ball.vx):-Math.abs(ball.vx);
    }
  }
  hit(left,true);
  hit(right,false);

  items=items.filter(it=>{
    if(Math.hypot(ball.x-it.x,ball.y-it.y)<ball.r+it.r){
      applyItem(it.type,ball.vx<0?left:right);
      return false;
    }
    return true;
  });

  if(ball.x<0){ scoreR++; score(); }
  if(ball.x>W){ scoreL++; score(); }
}

function score(){
  seScore();
  updateScore();
  items=[];
  if(scoreL>=WIN_SCORE||scoreR>=WIN_SCORE){
    gameOver=true;
    setTimeout(()=>location.reload(),5000);
  }
  resetBall(scoreL>scoreR?1:-1);
}

/* ========= DRAW ========= */
function draw(){
  ctx.clearRect(0,0,W,H);

  ctx.fillStyle="#333";
  for(let y=0;y<H;y+=20) ctx.fillRect(W/2-1,y,2,10);

  ctx.fillStyle="#0ff";
  ctx.fillRect(left.x,left.y-left.h/2,12,left.h);
  ctx.fillRect(right.x,right.y-right.h/2,12,right.h);

  ctx.beginPath();
  ctx.arc(ball.x,ball.y,ball.r,0,Math.PI*2);
  ctx.fillStyle="#fff";
  ctx.fill();

  items.forEach(it=>{
    ctx.fillStyle=
      it.type==="speed"?"#f33":
      it.type==="curve"?"#3f3":"#ff3";
    ctx.beginPath();
    ctx.arc(it.x,it.y,it.r,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle="#000";
    ctx.font="bold 16px sans-serif";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(it.type[0].toUpperCase(),it.x,it.y);
  });

  if(gameOver){
    ctx.font="bold 64px sans-serif";
    ctx.fillStyle="#fff";
    ctx.textAlign="center";
    ctx.fillText(scoreL>scoreR?"LEFT WIN!!":"RIGHT WIN!!",W/2,H/2);
  }
}

(function loop(){
  update(); draw();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>

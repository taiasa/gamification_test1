<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Royal Concierge: HYPER</title>
    <style>
        /* --- 0. Global & Reset --- */
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;900&display=swap');

        :root {
            --primary: #4f46e5;
            --accent: #f43f5e;
            --success: #059669;
            --gold: #fbbf24;
            --dark: #0f172a;
            --glass: rgba(255, 255, 255, 0.95);
            --font-main: "Zen Maru Gothic", sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            font-family: var(--font-main);
            margin: 0;
            height: 100vh; /* Fallback */
            height: 100dvh;
            overflow: hidden; /* Prevent Scroll */
            background: radial-gradient(circle at center, #2e1065, #0f172a);
            color: #334155;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ËÉåÊôØ„Ç®„Éï„Çß„ÇØ„Éà */
        .stars {
            position: absolute; width: 100%; height: 100%;
            background-image: 
                radial-gradient(white 2px, transparent 2px),
                radial-gradient(rgba(255,255,255,0.5) 1px, transparent 1px);
            background-size: 60px 60px, 20px 20px;
            opacity: 0.2; z-index: -1;
            animation: moveStars 60s linear infinite;
        }
        @keyframes moveStars { from { background-position: 0 0, 0 0; } to { background-position: 60px 60px, 20px 20px; } }

        /* --- 1. App Frame --- */
        #app-frame {
            width: 100%; height: 100%; max-width: 600px;
            background: var(--glass);
            position: relative; overflow: hidden;
            display: flex; flex-direction: column;
            box-shadow: 0 0 50px rgba(79, 70, 229, 0.3);
        }
        @media (min-width: 600px) {
            #app-frame { height: 95dvh; border-radius: 30px; border: 4px solid rgba(255,255,255,0.2); }
        }

        /* Shake & Flash Effects */
        .shake-hard { animation: shakeHard 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        .shake-soft { animation: shakeSoft 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        .flash-screen { animation: flashWhite 0.3s ease-out; }

        @keyframes shakeHard { 
            0% { transform: translate(0, 0) rotate(0deg); } 
            25% { transform: translate(5px, 5px) rotate(2deg); } 
            50% { transform: translate(-5px, -5px) rotate(-2deg); } 
            75% { transform: translate(5px, -5px) rotate(1deg); } 
            100% { transform: translate(0, 0) rotate(0deg); } 
        }
        @keyframes shakeSoft { 
            0%, 100% { transform: translateX(0); } 
            25% { transform: translateX(-4px); } 
            75% { transform: translateX(4px); } 
        }
        @keyframes flashWhite { 0% { background-color: white; } 100% { background-color: var(--glass); } }

        /* --- 2. Screens --- */
        .screen {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
            padding: 16px;
        }
        .screen.active { opacity: 1; pointer-events: auto; z-index: 10; }

        /* --- 3. Start Screen --- */
        #start-screen { background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(240,249,255,0.9)); }
        
        .title-box { text-align: center; margin-bottom: 20px; animation: floatTitle 3s ease-in-out infinite; }
        .title-main { 
            font-size: clamp(2.5rem, 5vh, 3.5rem); font-weight: 900; line-height: 1;
            background: linear-gradient(45deg, #4f46e5, #ec4899, #f59e0b);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 4px 0 rgba(0,0,0,0.1));
        }
        .title-sub { font-size: 1rem; color: #475569; font-weight: bold; letter-spacing: 0.2em; margin-top: 10px; }

        @keyframes floatTitle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .btn-mode {
            width: 100%; max-width: 340px; margin: 8px; padding: 16px;
            background: white; border: 3px solid transparent; border-radius: 20px;
            box-shadow: 0 8px 0 #e2e8f0, 0 10px 20px rgba(0,0,0,0.1);
            display: flex; align-items: center; gap: 16px;
            cursor: pointer; transition: all 0.1s;
        }
        .btn-mode:active { transform: translateY(4px); box-shadow: 0 4px 0 #cbd5e1; }
        .btn-icon { font-size: 2rem; background: #e0e7ff; padding: 10px; border-radius: 12px; min-width: 60px; text-align: center; }
        .btn-text h3 { margin: 0; font-size: 1.2rem; color: var(--primary); }
        .btn-text p { margin: 4px 0 0; font-size: 0.8rem; color: #64748b; font-weight: bold; }

        /* --- 4. Game UI --- */
        header {
            width: 100%; height: 60px; padding: 0 16px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(0,0,0,0.05); z-index: 20; flex-shrink: 0;
        }
        .score-box { 
            font-weight: 900; color: white; font-size: 1.2rem; 
            background: var(--gold); padding: 4px 12px; border-radius: 50px;
            box-shadow: 0 3px 0 #d97706; text-shadow: 0 1px 0 rgba(0,0,0,0.2);
        }
        .progress { font-weight: 900; color: #64748b; font-size: 1rem; }

        /* --- 5. Scenario Mode Layout (Adjusted for Fit) --- */
        #scenario-container { 
            flex: 1; width: 100%; overflow: hidden; 
            display: flex; flex-direction: column; 
        }
        
        .stage-area {
            flex: 1; width: 100%; min-height: 0; /* Important for scroll prevention */
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            padding: 10px; position: relative;
        }
        .avatar { 
            font-size: clamp(60px, 12vh, 100px); /* ÁîªÈù¢„Çµ„Ç§„Ç∫„Å´Âêà„Çè„Åõ„Å¶Ëá™ÂãïË™øÊï¥ */
            line-height: 1; filter: drop-shadow(0 8px 0 rgba(0,0,0,0.1)); 
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin-bottom: 10px;
        }
        .speech-bubble {
            background: white; padding: 16px; border-radius: 20px; border-bottom-left-radius: 4px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); max-width: 95%;
            font-size: clamp(0.9rem, 2.5vh, 1.2rem); font-weight: 900; line-height: 1.5; color: var(--dark);
            border: 3px solid var(--dark); text-align: center;
        }
        .mission-tag {
            background: var(--accent); color: white;
            padding: 6px 16px; border-radius: 50px; font-size: 0.85rem; font-weight: bold;
            margin-bottom: 5px; box-shadow: 0 3px 0 #be123c;
            transform: rotate(-2deg);
        }

        /* Deck Area - Compact */
        .deck-area {
            width: 100%; background: white;
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            padding: 12px; box-shadow: 0 -5px 30px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 10px;
            flex-shrink: 0; z-index: 15;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        /* Answer Slot - Fixed Height */
        .answer-slot {
            width: 100%; height: 60px; /* Âõ∫ÂÆö */
            background: #f1f5f9; border: 3px dashed #cbd5e1; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            padding: 4px 10px; transition: all 0.2s; overflow-x: auto; /* Ê®™„Å´„ÅÇ„Åµ„Çå„Åü„Çâ„Çπ„ÇØ„É≠„Éº„É´ */
        }
        .answer-slot.error { background: #fee2e2; border-color: var(--accent); border-style: solid; }
        .slot-placeholder { color: #94a3b8; font-weight: bold; font-size: 0.8rem; pointer-events: none; }

        /* Chips - Fixed & Stable */
        .chip-pool {
            display: flex; flex-wrap: wrap; justify-content: center; align-content: center;
            gap: 8px; min-height: 80px; /* È´ò„ÅïÁ¢∫‰øù */
            padding: 4px;
        }
        
        /* ÂÖ±ÈÄö„ÉÅ„ÉÉ„Éó„Çπ„Çø„Ç§„É´Ôºà„Éó„Éº„É´„Éª„Çπ„É≠„ÉÉ„ÉàÔºâ */
        .chip-base {
            height: 40px; /* È´ò„ÅïÂõ∫ÂÆö */
            padding: 0 12px; border-radius: 10px; font-weight: bold; font-size: 0.9rem;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; user-select: none;
        }

        .chip {
            background: white; border: 2px solid #cbd5e1; border-bottom-width: 4px;
            color: var(--primary);
            transition: transform 0.1s;
        }
        .chip:active { transform: translateY(2px); border-bottom-width: 2px; }
        
        /* ‰ΩøÁî®Ê∏à„ÅøÁä∂ÊÖãÔºöÊ∂à„Åï„Åö„Å´ÈÄèÊòéÂ∫¶„Çí‰∏ã„Åí„ÇãÔºà„É¨„Ç§„Ç¢„Ç¶„ÉàÂõ∫ÂÆö„ÅÆ„Åü„ÇÅÔºâ */
        .chip.used { 
            opacity: 0.2; pointer-events: none; border-color: #e2e8f0; border-bottom-width: 2px; transform: translateY(2px);
        }

        .chip-ans {
            background: var(--primary); color: white; 
            box-shadow: 0 3px 0 #3730a3; animation: popIn 0.2s;
            white-space: nowrap; /* Êäò„ÇäËøî„ÅóÈò≤Ê≠¢ */
        }
        .chip-ans:active { transform: translateY(2px); box-shadow: 0 0 0 transparent; }

        .btn-check {
            width: 100%; padding: 12px; background: var(--success); color: white; border: none;
            border-radius: 50px; font-weight: 900; font-size: 1.1rem;
            box-shadow: 0 5px 0 #047857; cursor: pointer; transition: transform 0.1s;
        }
        .btn-check:active { transform: translateY(5px); box-shadow: 0 0 0 transparent; }

        /* --- 6. Word Mode --- */
        #word-container {
            flex: 1; width: 100%; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 10px;
        }
        .quiz-card {
            background: white; width: 100%; padding: 20px; border-radius: 20px;
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px; border: 3px solid #e2e8f0;
        }
        .q-word { font-size: clamp(2rem, 5vh, 2.5rem); font-weight: 900; color: var(--dark); margin-bottom: 5px; }
        .q-type { font-size: 1.1rem; color: #64748b; font-weight: bold; }
        
        .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
        .btn-opt {
            background: white; border: 2px solid #e2e8f0; border-bottom-width: 5px;
            padding: 15px; border-radius: 16px; font-weight: bold; color: #475569;
            font-size: 1rem; cursor: pointer; transition: all 0.1s;
        }
        .btn-opt:active { transform: translateY(3px); border-bottom-width: 2px; }

        /* --- 7. Overlays --- */
        .overlay {
            position: absolute; inset: 0; background: rgba(15,23,42,0.95);
            z-index: 50; display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal {
            background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 24px;
            text-align: center; animation: popIn 0.3s;
            border: 4px solid var(--primary);
        }
        
        #particles { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: 100; overflow: hidden;}
        .particle { position: absolute; width: 8px; height: 8px; border-radius: 50%; }

        @keyframes popIn { from{transform:scale(0.8); opacity:0} to{transform:scale(1); opacity:1} }
        
    </style>
</head>
<body>

<div class="stars"></div>
<div id="particles"></div>

<div id="app-frame">
    <!-- START SCREEN -->
    <div id="start-screen" class="screen active">
        <div class="title-box">
            <div class="title-main">ROYAL<br>CONCIERGE</div>
            <div class="title-sub">HYPER EDITION</div>
        </div>

        <button class="btn-mode" onclick="initGame('scenario')">
            <div class="btn-icon">üè∞</div>
            <div class="btn-text">
                <h3>Â†¥Èù¢„É¢„Éº„Éâ</h3>
                <p>‰ºöË©±„ÇíÂÆåÊàê„Åï„Åõ„Çç (5Âïè)</p>
            </div>
        </button>

        <button class="btn-mode" onclick="initGame('word')">
            <div class="btn-icon">‚ö°</div>
            <div class="btn-text">
                <h3>ÂçòË™û„É¢„Éº„Éâ</h3>
                <p>ÂèçÂ∞ÑÁ•ûÁµå„ÇØ„Ç§„Ç∫ (10Âïè)</p>
            </div>
        </button>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="screen">
        <header>
            <div class="progress">Q. <span id="q-curr">1</span> / <span id="q-total">0</span></div>
            <div class="score-box">üíé <span id="score-val">0</span></div>
        </header>

        <!-- Scenario Mode -->
        <div id="scenario-container" style="display:none;">
            <div class="stage-area">
                <div class="mission-tag">üí° <span id="sc-mission">MISSION</span></div>
                <div class="avatar" id="sc-avatar">ü§¥</div>
                <div class="speech-bubble" id="sc-speech">...</div>
            </div>
            
            <div class="deck-area">
                <!-- „Çø„ÉÉ„ÉóÂºè„Çπ„É≠„ÉÉ„Éà (Ê®™„Çπ„ÇØ„É≠„Éº„É´ÂØæÂøú) -->
                <div class="answer-slot" id="ans-slot">
                    <span class="slot-placeholder">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
                </div>
                <!-- ÈÅ∏ÊäûËÇ¢„Éó„Éº„É´ -->
                <div class="chip-pool" id="chip-pool"></div>
                
                <button class="btn-check" onclick="checkScenario()">„Åä„ÇÇ„Å¶„Å™„ÅóÊ±∫ÂÆö</button>
            </div>
        </div>

        <!-- Word Mode -->
        <div id="word-container" style="display:none;">
            <div class="quiz-card">
                <div class="q-word" id="wq-word">...</div>
                <div class="q-type" id="wq-type">...</div>
            </div>
            <div class="opt-grid" id="opt-grid"></div>
        </div>
    </div>

    <!-- FEEDBACK OVERLAY -->
    <div id="feedback-overlay" class="overlay">
        <div class="modal">
            <div style="font-size:4rem; margin-bottom:5px;" id="fb-icon">‚≠ï</div>
            <h2 id="fb-title" style="font-size:1.8rem; margin:0;">Excellent!</h2>
            <div style="width:100%; height:2px; background:#f1f5f9; margin:10px 0;"></div>
            <p id="fb-msg" style="font-size:1rem; line-height:1.5; font-weight:bold;">Ëß£Ë™¨</p>
            <button class="btn-check" id="fb-next" onclick="nextQuestion()">Ê¨°„Å∏ÈÄ≤„ÇÄ</button>
        </div>
    </div>
</div>

<script>
    /* ------------------------------------------------
       DATA
    ------------------------------------------------ */
    const WORD_DB = [
        { b:"Ê∞¥", t:"‰∏ÅÂØßË™û", a:"„ÅäÊ∞¥", d:["„ÅîÊ∞¥","Ê∞¥„Åß„Åô","„Åø„Åö"] },
        { b:"Êú¨", t:"‰∏ÅÂØßË™û", a:"„ÅîÊú¨", d:["„ÅäÊú¨","Êú¨„Åß„Åî„Åñ„ÅÑ„Åæ„Åô","„Éñ„ÉÉ„ÇØ"] },
        { b:"ÂêçÂâç", t:"‰∏ÅÂØßË™û", a:"„ÅäÂêçÂâç", d:["„ÅîÂêçÂâç","Âêç","„Éç„Éº„É†"] },
        { b:"ÂÆ∂Êóè", t:"‰∏ÅÂØßË™û", a:"„ÅîÂÆ∂Êóè", d:["„ÅäÂÆ∂Êóè","„Éï„Ç°„Éü„É™„Éº","‰∏ÄÊóè"] },
        { b:"ÈõªË©±", t:"‰∏ÅÂØßË™û", a:"„ÅäÈõªË©±", d:["„ÅîÈõªË©±","„ÉÜ„É¨„Éï„Ç©„É≥","„Çπ„Éû„Éõ"] },
        { b:"ÈÄ£Áµ°", t:"‰∏ÅÂØßË™û", a:"„ÅîÈÄ£Áµ°", d:["„ÅäÈÄ£Áµ°","ÈÄöÈÅî","Áü•„Çâ„Åõ"] },
        { b:"Âøô„Åó„ÅÑ", t:"‰∏ÅÂØßË™û", a:"„ÅäÂøô„Åó„ÅÑ", d:["„ÅîÂøô„Åó„ÅÑ","„Éì„Ç∏„Éº","Â§öÂøô"] },
        { b:"Á´ãÊ¥æ", t:"‰∏ÅÂØßË™û", a:"„ÅîÁ´ãÊ¥æ", d:["„ÅäÁ´ãÊ¥æ","„Åô„Åî„ÅÑ","ÂÅâÂ§ß"] },
        { b:"Ë°å„Åè", t:"Â∞äÊï¨Ë™û", a:"„ÅÑ„Çâ„Å£„Åó„ÇÉ„Çã", d:["ÂèÇ„Çã","‰º∫„ÅÜ","Áî≥„Åô"] },
        { b:"Ë°å„Åè", t:"Ë¨ôË≠≤Ë™û", a:"ÂèÇ„Çã", d:["„ÅÑ„Çâ„Å£„Åó„ÇÉ„Çã","„Åä„ÅÑ„Åß„Å´„Å™„Çã","Âè¨„Åó‰∏ä„Åå„Çã"] },
        { b:"Êù•„Çã", t:"Â∞äÊï¨Ë™û", a:"„ÅäË¶ã„Åà„Å´„Å™„Çã", d:["ÂèÇ„Çã","‰º∫„ÅÜ","ÊãùË¶ã„Åô„Çã"] },
        { b:"Êù•„Çã", t:"Ë¨ôË≠≤Ë™û", a:"ÂèÇ„Çã", d:["„ÅÑ„Çâ„Å£„Åó„ÇÉ„Çã","„ÅäË∂ä„Åó„Å´„Å™„Çã","„Å™„Åï„Çã"] },
        { b:"Ë®Ä„ÅÜ", t:"Â∞äÊï¨Ë™û", a:"„Åä„Å£„Åó„ÇÉ„Çã", d:["Áî≥„Åô","Áî≥„Åó‰∏ä„Åí„Çã","Â≠ò„Åò„Çã"] },
        { b:"Ë®Ä„ÅÜ", t:"Ë¨ôË≠≤Ë™û", a:"Áî≥„Åó‰∏ä„Åí„Çã", d:["„Åä„Å£„Åó„ÇÉ„Çã","Ë®Ä„Çè„Çå„Çã","„ÅäËÅû„Åç„Åô„Çã"] },
        { b:"È£ü„Åπ„Çã", t:"Â∞äÊï¨Ë™û", a:"Âè¨„Åó‰∏ä„Åå„Çã", d:["„ÅÑ„Åü„Å†„Åè","È†ÇÊà¥„Åô„Çã","Áî≥„Åô"] },
        { b:"È£ü„Åπ„Çã", t:"Ë¨ôË≠≤Ë™û", a:"„ÅÑ„Åü„Å†„Åè", d:["Âè¨„Åó‰∏ä„Åå„Çã","„Åä‰∏ä„Åå„Çä„Å´„Å™„Çã","Ë¶ãÂ≠¶„Åô„Çã"] },
        { b:"Ë¶ã„Çã", t:"Â∞äÊï¨Ë™û", a:"„ÅîË¶ß„Å´„Å™„Çã", d:["ÊãùË¶ã„Åô„Çã","„ÅäÁõÆ„Å´„Åã„Åã„Çã","Ë¶ã„Çâ„Çå„Çã"] },
        { b:"Ë¶ã„Çã", t:"Ë¨ôË≠≤Ë™û", a:"ÊãùË¶ã„Åô„Çã", d:["„ÅîË¶ß„Å´„Å™„Çã","Ë¶ã„Åï„Åõ„Å¶„ÅÑ„Åü„Å†„Åè","„ÅäË¶ã„Åà„Å´„Å™„Çã"] },
        { b:"ËÅû„Åè", t:"Â∞äÊï¨Ë™û", a:"„ÅäËÅû„Åç„Å´„Å™„Çã", d:["‰º∫„ÅÜ","Êâø„Çã","ÊãùËÅ¥„Åô„Çã"] },
        { b:"ËÅû„Åè", t:"Ë¨ôË≠≤Ë™û", a:"‰º∫„ÅÜ", d:["„ÅäËÅû„Åç„Å´„Å™„Çã","ËÅû„Åã„Çå„Çã","„Åä„Å£„Åó„ÇÉ„Çã"] },
        { b:"Áü•„Çã", t:"Â∞äÊï¨Ë™û", a:"„ÅîÂ≠ò„Åò„Å†", d:["Â≠ò„Åò‰∏ä„Åí„Çã","ÊâøÁü•„Åô„Çã","Áü•„ÇäÁî≥„Åô"] },
        { b:"Áü•„Çã", t:"Ë¨ôË≠≤Ë™û", a:"Â≠ò„Åò‰∏ä„Åí„Çã", d:["„ÅîÂ≠ò„Åò„Å†","„ÅäÁü•„Çä„Å´„Å™„Çã","‰º∫„ÅÜ"] },
        { b:"ÂÆ∂", t:"Â∞äÊï¨Ë™û", a:"„ÅäÂÆÖ", d:["ÊãôÂÆÖ","Êàë„ÅåÂÆ∂","ÂÆ∂"] },
        { b:"ÂÆ∂", t:"Ë¨ôË≠≤Ë™û", a:"ÊãôÂÆÖ", d:["„ÅäÂÆÖ","Âæ°ÊÆø","„ÅäÂ±ãÊï∑"] },
        { b:"‰ºöÁ§æ", t:"Â∞äÊï¨Ë™û", a:"Âæ°Á§æ", d:["ÂºäÁ§æ","ÂΩìÁ§æ","‰ºöÁ§æ"] },
        { b:"‰ºöÁ§æ", t:"Ë¨ôË≠≤Ë™û", a:"ÂºäÁ§æ", d:["Âæ°Á§æ","Ë≤¥Á§æ","‰ºöÁ§æ"] },
        { b:"Ê≠ª„Å¨", t:"Â∞äÊï¨Ë™û", a:"„Åä‰∫°„Åè„Å™„Çä„Å´„Å™„Çã", d:["Ê≠ª„Å™„Çå„Çã","‰ªñÁïå„Åô„Çã","ÈÄù„Åè"] },
        { b:"ÂÄü„Çä„Çã", t:"Ë¨ôË≠≤Ë™û", a:"ÊãùÂÄü„Åô„Çã", d:["„ÅäÂÄü„Çä„Åô„Çã","Ë≤∏„Åó„Å¶„ÅÑ„Åü„Å†„Åè","ÂÄü„ÇäÁî≥„Åô"] },
        { b:"Ë¶ã„Åõ„Çã", t:"Ë¨ôË≠≤Ë™û", a:"„ÅäÁõÆ„Å´„Åã„Åë„Çã", d:["„ÅîË¶ß„Å´ÂÖ•„Çå„Çã","„ÅäË¶ã„Åõ„Åô„Çã","Ë¶ã„Åõ„Çâ„Çå„Çã"] }
    ];

    const SCENARIO_DB = [
        { 
            av:"üëµ", q:"„Äå„Åæ„ÅÇ„ÄÅÁ¥†Êïµ„Å™„ÅäÈÉ®Â±ã„Å≠„ÄÇ„Äç", m:"Ë§í„ÇÅ„Çâ„Çå„Åü„ÅÆ„ÅßË¨ôÈÅú„Åô„Çã", 
            a:["„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô","Ê∞ó„Å´ÂÖ•„Å£„Å¶„ÅÑ„Åü„Å†„Åë„Å¶","Â¨â„Åó„ÅÑ„Åß„Åô"], 
            d:["„Å®„Çì„Åß„ÇÇ„Å™„ÅÑ„Åß„Åô","ËâØ„ÅÑ„Åß„Åó„Çá„ÅÜ"],
            exp:"Á¥†Áõ¥„Å´ÊÑüË¨ù„Åó„ÄÅ„ÄåÔΩû„Å¶Â¨â„Åó„ÅÑ„Åß„Åô„Äç„Å®Ê∑ª„Åà„Çã„Å®‰∏äÂìÅ„Åß„Åô„ÄÇ"
        },
        { 
            av:"ü§¥", q:"„Äå„Åä„ÅÑ„ÄÅÈ¢®ÂëÇ„ÅØ„Åæ„Å†„ÅãÔºü„Äç", m:"Ê∫ñÂÇôÂÆå‰∫Ü„Çí‰ºù„Åà„Çã", 
            a:["„ÅäÂæÖ„Åü„Åõ„Åó„Åæ„Åó„Åü","„ÅäÈ¢®ÂëÇ„ÅÆ","„ÅîÁî®ÊÑè„Åå","Êï¥„ÅÑ„Åæ„Åó„Åü"], 
            d:["„ÅäÈ¢®ÂëÇ„Åå","Ê≤∏„Åç„Åæ„Åó„Åü"],
            exp:"„Äå„ÅîÁî®ÊÑè„ÄçÔºã„ÄåÊï¥„ÅÑ„Åæ„Åó„Åü„Äç„ÅÆ„Ç≥„É≥„Éú„ÅåÊúÄÂº∑„ÅÆÊï¨Ë™û„Åß„Åô„ÄÇ"
        },
        { 
            av:"üé©", q:"„ÄåÂêõ„ÅÆÂêçÂâç„ÅØÔºü„Äç", m:"Âêç‰πó„ÇãÔºàË¨ôË≠≤Ë™ûÔºâ", 
            a:["ÁßÅ„ÅØ","Âü∑‰∫ã„ÅÆ","„Çª„Éê„Çπ„ÉÅ„É£„É≥„Å®","Áî≥„Åó„Åæ„Åô"], 
            d:["Ë®Ä„ÅÑ„Åæ„Åô","Âêç‰πó„Çä„Åæ„Åô"],
            exp:"Ëá™ÂàÜ„ÅÆÂêçÂâç„ÇíË®Ä„ÅÜ„Å®„Åç„ÅØ„ÄåÁî≥„Åô„Äç„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ"
        },
        { 
            av:"üëΩ", q:"„Äå„Ç≥„ÉéÊñôÁêÜ„ÄÅ„Ç™„Éû„Ç®„Ç¨‰Ωú„ÉÉ„Çø„Éé„Ç´Ôºü„Äç", m:"„Ç∑„Çß„Éï„Åå‰Ωú„Å£„Åü„Å®‰ºù„Åà„Çã", 
            a:["ÂΩì„Éõ„ÉÜ„É´„ÅÆ","„Ç∑„Çß„Éï„Åå","‰Ωú„Çä„Åæ„Åó„Åü"], 
            d:["„Åä‰Ωú„Çä„Å´„Å™„Çä„Åæ„Åó„Åü","Êãù‰Ωú„Åó„Åæ„Åó„Åü"],
            exp:"Ë∫´ÂÜÖÔºà„Ç∑„Çß„ÉïÔºâ„ÇíÈ´ò„ÇÅ„Å¶„ÅØ„ÅÑ„Åë„Åæ„Åõ„Çì„ÄÇÊôÆÈÄö„ÅÆ‰∏ÅÂØßË™û„ÅßOK„ÄÇ"
        },
        { 
            av:"üë©", q:"„ÄåÊ†°Èï∑ÂÖàÁîü„ÅØ„ÅÑ„Çâ„Å£„Åó„ÇÉ„ÅÑ„Åæ„Åô„ÅãÔºü„Äç", m:"‰∏çÂú®„Çí‰ºù„Åà„Çã", 
            a:["Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì","Ê†°Èï∑„ÅØ","„Åü„Å†„ÅÑ„Åæ","Â∏≠„ÇíÂ§ñ„Åó„Å¶„Åä„Çä„Åæ„Åô"], 
            d:["Ê†°Èï∑ÂÖàÁîü„ÅØ","„ÅÑ„Çâ„Å£„Åó„ÇÉ„ÅÑ„Åæ„Åõ„Çì"],
            exp:"Â§ñÈÉ®„ÅÆ‰∫∫„Å´„ÄåÂÖàÁîü„Äç„ÅØ‰ªò„Åë„Åö„ÄÅ„Äå„Åä„Çã„Äç„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ"
        },
        { 
            av:"üç∑", q:"„Äå‰Ωï„ÅãÈ£≤„ÅøÁâ©„Çí„ÇÇ„Çâ„Åà„Çã„Åã„Å≠Ôºü„Äç", m:"È£≤„ÅøÁâ©„ÇíÂãß„ÇÅ„Çã", 
            a:["„Åì„Å°„Çâ„ÅÆ","Á¥ÖËå∂„Çí","Âè¨„Åó‰∏ä„Åå„Å£„Å¶","„Åè„Å†„Åï„ÅÑ"], 
            d:["„ÅÑ„Åü„Å†„ÅÑ„Å¶","È£≤„Çì„Åß"],
            exp:"„ÄåÈ£≤„ÇÄ„Äç„ÅÆÂ∞äÊï¨Ë™û„ÄåÂè¨„Åó‰∏ä„Åå„Çã„Äç„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ"
        },
        { 
            av:"üèÉ", q:"„ÄåÊÄ•„ÅÑ„ÅßËç∑Áâ©„ÇíÈÅã„Çì„Åß„Åè„Çå„ÄÇ„Äç", m:"ÊâøÁü•„Åó„Åü„Å®Á≠î„Åà„Çã", 
            a:["„Åã„Åó„Åì„Åæ„Çä„Åæ„Åó„Åü","„ÅäËç∑Áâ©„Çí","„ÅäÊåÅ„Å°","„Åó„Åæ„Åô"], 
            d:["ÊåÅ„Å°„Åæ„Åô","ÊåÅ„Å£„Å¶„ÅÇ„Åí„Åæ„Åô"],
            exp:"„ÄåÊåÅ„Å§„Äç„ÅÆË¨ôË≠≤Ë™û„Äå„ÅäÊåÅ„Å°„Åô„Çã„Äç„ÄÇ„ÄåÔΩû„Åó„Å¶„ÅÇ„Åí„Çã„Äç„ÅØNG„ÄÇ"
        },
        { 
            av:"‚ùì", q:"„Äå„Éà„Ç§„É¨„ÅØ„Å©„Åì„Åß„Åô„ÅãÔºü„Äç", m:"Â†¥ÊâÄ„ÇíÊ°àÂÜÖ„Åô„Çã", 
            a:["„ÅÇ„Å°„Çâ„Å´","„Åî„Åñ„ÅÑ„Åæ„Åô","„ÅîÊ°àÂÜÖ","„ÅÑ„Åü„Åó„Åæ„Åô"], 
            d:["„ÅÇ„Çä„Åæ„Åô","Ê°àÂÜÖ„Åó„Åæ„Åô"],
            exp:"„Äå„ÅÇ„Çã„Äç‚Üí„Äå„Åî„Åñ„ÅÑ„Åæ„Åô„Äç„ÄÅ„ÄåÊ°àÂÜÖ„Åô„Çã„Äç‚Üí„Äå„ÅîÊ°àÂÜÖ„ÅÑ„Åü„Åô„Äç„ÄÇ"
        },
        { 
            av:"üéÅ", q:"„Äå„Åì„Çå„ÄÅÂêõ„Å∏„ÅÆ„ÉÅ„ÉÉ„Éó„Å†„ÄÇ„Äç", m:"Âèó„ÅëÂèñ„Çã", 
            a:["„ÅäÂøÉÈÅ£„ÅÑ","„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô","È†ÇÊà¥","„ÅÑ„Åü„Åó„Åæ„Åô"], 
            d:["„ÇÇ„Çâ„ÅÑ„Åæ„Åô","„ÅÑ„Åü„Å†„Åç„Åæ„Åô"],
            exp:"„Äå„ÇÇ„Çâ„ÅÜ„Äç„ÅÆÊúÄ‰∏äÁ¥öË¨ôË≠≤Ë™û„ÄåÈ†ÇÊà¥Ôºà„Å°„Çá„ÅÜ„Å†„ÅÑÔºâ„Åô„Çã„Äç„Çí‰ΩøÁî®„ÄÇ"
        },
        { 
            av:"üìú", q:"„ÄåÁéãÊßò„Åã„Çâ„ÅÆÊâãÁ¥ô„ÇíÈ†ê„Åã„Å£„Å¶„Åª„Åó„ÅÑ„ÄÇ„Äç", m:"È†ê„Åã„Çã", 
            a:["ÁéãÊßò„ÅÆ","„ÅäÊâãÁ¥ô„Çí","„ÅäÈ†ê„Åã„Çä","„Åó„Åæ„Åô"], 
            d:["È†ê„Åã„Çä„Åæ„Åô","È†ê„Åã„Å£„Å¶„ÅÇ„Åí„Åæ„Åô"],
            exp:"„ÄåÈ†ê„Åã„Çã„Äç„ÅÆË¨ôË≠≤Ë™û„Äå„ÅäÈ†ê„Åã„Çä„Åô„Çã„Äç„ÄÇ"
        },
        { 
            av:"üíº", q:"„Äå„Åì„ÅÆ‰ª∂„ÄÅ„Å©„ÅÜ„Å™„Å£„Å¶„ÅÑ„ÇãÔºü„Äç", m:"Á¢∫Ë™ç„Åó„Å¶Â†±Âëä„Åô„Çã", 
            a:["Á¢∫Ë™ç„ÅÆ‰∏ä","Êîπ„ÇÅ„Å¶","„ÅîÂ†±Âëä","„ÅÑ„Åü„Åó„Åæ„Åô"], 
            d:["Á¢∫Ë™ç„Åó„Å¶","ÈÄ£Áµ°„Åó„Åæ„Åô"],
            exp:"„Éì„Ç∏„Éç„Çπ„ÅÆÈâÑÊùø„Éï„É¨„Éº„Ç∫„ÄÇ„Äå„ÅîÂ†±Âëä„ÅÑ„Åü„Åó„Åæ„Åô„Äç„Çí‰Ωø„Åä„ÅÜ„ÄÇ"
        },
        { 
            av:"üßì", q:"„Äå„Åì„ÅÆÂ∫¶„ÅØ„Åä‰∏ñË©±„Å´„Å™„Çä„Åæ„Åó„Åü„ÄÇ„Äç", m:"ÊÑüË¨ù„ÇíËø∞„Åπ„Çã", 
            a:["„Åì„Å°„Çâ„Åì„Åù","Â§ßÂ§â","„Åä‰∏ñË©±„Å´","„Å™„Çä„Åæ„Åó„Åü"], 
            d:["„ÅÇ„Çä„Åå„Å®„ÅÜ","Âä©„Åã„Çä„Åæ„Åó„Åü"],
            exp:"„Äå„Åì„Å°„Çâ„Åì„Åù„Äç„Å®Âç≥Â∫ß„Å´Ëøî„Åõ„Çã„Å®„Çπ„Éû„Éº„Éà„Åß„Åô„ÄÇ"
        }
    ];

    /* ------------------------------------------------
       SYSTEM CORE
    ------------------------------------------------ */
    let audioCtx = null;
    let currentMode = null;
    let qQueue = [];
    let qIndex = 0;
    let score = 0;
    
    // „Ç∑„Éä„É™„Ç™„É¢„Éº„Éâ„ÅÆÁä∂ÊÖã
    let slotChips = []; // {id, text}

    /* --- Audio System --- */
    function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playSound(type) {
        initAudio();
        const t = audioCtx.currentTime;
        const gain = audioCtx.createGain();
        gain.connect(audioCtx.destination);

        if (type === 'tap') {
            const osc = audioCtx.createOscillator();
            osc.connect(gain);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, t);
            osc.frequency.exponentialRampToValueAtTime(1200, t + 0.1);
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
            osc.start(t); osc.stop(t + 0.1);
        }
        else if (type === 'remove') {
            const osc = audioCtx.createOscillator();
            osc.connect(gain);
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(400, t);
            osc.frequency.linearRampToValueAtTime(100, t + 0.1);
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.1);
            osc.start(t); osc.stop(t + 0.1);
        }
        else if (type === 'correct') {
            const notes = [523.25, 659.25, 783.99, 1046.50, 1318.51];
            notes.forEach((freq, i) => {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.connect(g);
                g.connect(audioCtx.destination);
                o.type = i % 2 === 0 ? 'sine' : 'triangle';
                o.frequency.value = freq;
                g.gain.setValueAtTime(0.05, t + i*0.06);
                g.gain.exponentialRampToValueAtTime(0.001, t + i*0.06 + 0.5);
                o.start(t + i*0.06);
                o.stop(t + i*0.06 + 0.5);
            });
        }
        else if (type === 'wrong') {
            const osc1 = audioCtx.createOscillator();
            const osc2 = audioCtx.createOscillator();
            osc1.connect(gain); osc2.connect(gain);
            osc1.type = 'sawtooth'; osc2.type = 'square';
            osc1.frequency.setValueAtTime(150, t);
            osc2.frequency.setValueAtTime(140, t); 
            osc1.frequency.linearRampToValueAtTime(50, t+0.4);
            osc2.frequency.linearRampToValueAtTime(40, t+0.4);
            gain.gain.setValueAtTime(0.2, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.4);
            osc1.start(t); osc1.stop(t + 0.4);
            osc2.start(t); osc2.stop(t + 0.4);
        }
    }

    /* --- Visual Effects --- */
    function triggerShake(intensity = 'soft') {
        const frame = document.getElementById('app-frame');
        frame.classList.remove('shake-hard', 'shake-soft');
        void frame.offsetWidth; 
        frame.classList.add(intensity === 'hard' ? 'shake-hard' : 'shake-soft');
    }

    function triggerFlash() {
        const body = document.body;
        body.classList.remove('flash-screen');
        void body.offsetWidth;
        body.classList.add('flash-screen');
    }

    function spawnConfetti() {
        const container = document.getElementById('particles');
        container.innerHTML = '';
        const colors = ['#f43f5e', '#fbbf24', '#10b981', '#3b82f6', '#8b5cf6'];
        
        for (let i = 0; i < 50; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            p.style.left = '50%';
            p.style.top = '50%';
            
            const angle = Math.random() * Math.PI * 2;
            const vel = 5 + Math.random() * 10;
            const dx = Math.cos(angle) * vel;
            const dy = Math.sin(angle) * vel;
            
            p.animate([
                { transform: `translate(0,0) scale(1)`, opacity: 1 },
                { transform: `translate(${dx * 20}px, ${dy * 20}px) scale(0)`, opacity: 0 }
            ], {
                duration: 800 + Math.random() * 400,
                easing: 'cubic-bezier(0, .9, .57, 1)',
                fill: 'forwards'
            });
            
            container.appendChild(p);
        }
    }

    /* --- Game Logic --- */
    function initGame(mode) {
        playSound('tap');
        currentMode = mode;
        score = 0;
        qIndex = 0;
        
        if (mode === 'scenario') {
            qQueue = shuffle([...SCENARIO_DB]).slice(0, 5);
            document.getElementById('q-total').textContent = "5";
            toggleView('scenario');
        } else {
            qQueue = shuffle([...WORD_DB]).slice(0, 10);
            document.getElementById('q-total').textContent = "10";
            toggleView('word');
        }
        
        updateScore();
        switchScreen('game-screen');
        loadQuestion();
    }

    function toggleView(mode) {
        document.getElementById('scenario-container').style.display = (mode === 'scenario') ? 'flex' : 'none';
        document.getElementById('word-container').style.display = (mode === 'word') ? 'flex' : 'none';
    }

    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function loadQuestion() {
        if (qIndex >= qQueue.length) {
            showResult();
            return;
        }

        document.getElementById('q-curr').textContent = qIndex + 1;
        const q = qQueue[qIndex];

        if (currentMode === 'scenario') {
            setupScenario(q);
        } else {
            setupWord(q);
        }
    }

    // --- Scenario Mode ---
    function setupScenario(q) {
        document.getElementById('sc-mission').textContent = q.m;
        document.getElementById('sc-avatar').textContent = q.av;
        document.getElementById('sc-speech').textContent = q.q;
        
        // Reset state
        slotChips = [];
        renderSlot();
        document.getElementById('ans-slot').classList.remove('error');
        
        const pool = document.getElementById('chip-pool');
        pool.innerHTML = '';
        
        let chipItems = [];
        q.a.forEach(txt => chipItems.push({ text: txt }));
        q.d.forEach(txt => chipItems.push({ text: txt }));
        chipItems = shuffle(chipItems);
        
        chipItems.forEach((item, idx) => {
            const id = `chip-${idx}`;
            const btn = document.createElement('div');
            btn.className = 'chip chip-base'; // chip-base„Åß„Çµ„Ç§„Ç∫Áµ±‰∏Ä
            btn.textContent = item.text;
            btn.id = id;
            btn.onclick = () => tapPoolChip(id, item.text);
            pool.appendChild(btn);
        });
    }

    function tapPoolChip(id, text) {
        playSound('tap');
        // „Éó„Éº„É´„ÅÆ„ÉÅ„ÉÉ„Éó„Çí„Äå‰ΩøÁî®Ê∏à„ÅøÔºàËñÑ„ÅèÔºâ„Äç„Å´„Åô„Çã„Å†„ÅëÔºà„É¨„Ç§„Ç¢„Ç¶„Éà‰øùÊåÅÔºâ
        const poolBtn = document.getElementById(id);
        if (poolBtn.classList.contains('used')) return;
        poolBtn.classList.add('used');
        
        // Add to slot
        slotChips.push({ id: id, text: text });
        renderSlot();
    }

    function tapSlotChip(index) {
        playSound('remove');
        const chip = slotChips[index];
        
        // Remove from slot
        slotChips.splice(index, 1);
        renderSlot();
        
        // Restore pool chip
        const poolBtn = document.getElementById(chip.id);
        if(poolBtn) poolBtn.classList.remove('used');
    }

    function renderSlot() {
        const slot = document.getElementById('ans-slot');
        slot.innerHTML = '';
        
        if (slotChips.length === 0) {
            slot.innerHTML = '<span class="slot-placeholder">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>';
            return;
        }
        
        slotChips.forEach((chip, idx) => {
            const el = document.createElement('div');
            el.className = 'chip-ans chip-base'; // chip-base„Åß„Çµ„Ç§„Ç∫Áµ±‰∏Ä
            el.textContent = chip.text;
            el.onclick = () => tapSlotChip(idx);
            slot.appendChild(el);
        });
    }

    function checkScenario() {
        const q = qQueue[qIndex];
        const userStr = slotChips.map(c => c.text).join('');
        const ansStr = q.a.join('');

        if (userStr === ansStr) {
            score += 20;
            showFeedback(true, q.exp);
        } else {
            playSound('wrong');
            triggerShake('soft');
            const slot = document.getElementById('ans-slot');
            slot.classList.add('error');
            setTimeout(() => slot.classList.remove('error'), 400);
        }
    }

    // --- Word Mode ---
    function setupWord(q) {
        document.getElementById('wq-word').textContent = q.b;
        document.getElementById('wq-type').textContent = `„ÅÆ„Äå${q.t}„Äç„ÅØÔºü`;
        
        const grid = document.getElementById('opt-grid');
        grid.innerHTML = '';
        
        const opts = shuffle([q.a, ...q.d]);
        opts.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'btn-opt';
            btn.textContent = opt;
            btn.onclick = () => checkWord(opt, q);
            grid.appendChild(btn);
        });
    }

    function checkWord(ans, q) {
        if (ans === q.a) {
            score += 10;
            showFeedback(true, `Ê≠£Ëß£ÔºÅ<br>„Äå${q.b}„Äç„ÅÆ${q.t}„ÅØ<br><b>„Äå${q.a}„Äç</b>„Åß„Åô„ÄÇ`);
        } else {
            playSound('wrong');
            triggerShake('hard');
            showFeedback(false, `ÊÆãÂøµ...<br>Ê≠£Ëß£„ÅØ<b>„Äå${q.a}„Äç</b>„Åß„Åô„ÄÇ`);
        }
    }

    // --- Feedback & Result ---
    function showFeedback(isCorrect, msg) {
        if (isCorrect) {
            playSound('correct');
            spawnConfetti();
            triggerFlash();
        }
        
        const ov = document.getElementById('feedback-overlay');
        const icon = document.getElementById('fb-icon');
        const title = document.getElementById('fb-title');
        const fbMsg = document.getElementById('fb-msg');
        
        ov.classList.add('active');
        
        if (isCorrect) {
            icon.textContent = "üíÆ";
            title.textContent = "EXCELLENT!";
            title.style.color = "var(--success)";
        } else {
            icon.textContent = "üò±";
            title.textContent = "MISS...";
            title.style.color = "var(--accent)";
        }
        
        fbMsg.innerHTML = msg;
        updateScore();
    }

    function nextQuestion() {
        playSound('tap');
        document.getElementById('feedback-overlay').classList.remove('active');
        qIndex++;
        loadQuestion();
    }

    function showResult() {
        playSound('correct');
        spawnConfetti();
        const ov = document.getElementById('feedback-overlay');
        ov.classList.add('active');
        document.getElementById('fb-icon').textContent = "üèÜ";
        document.getElementById('fb-title').textContent = "ALL FINISHED!";
        document.getElementById('fb-msg').innerHTML = `
            „ÅÇ„Å™„Åü„ÅÆ„Çπ„Ç≥„Ç¢<br>
            <strong style="font-size:3rem; color:var(--primary)">${score}</strong>
        `;
        const btn = document.getElementById('fb-next');
        btn.textContent = "„Çø„Ç§„Éà„É´„Å´Êàª„Çã";
        btn.onclick = () => location.reload();
    }

    function updateScore() {
        document.getElementById('score-val').textContent = score;
    }

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å›³å½¢ãŠçµµæãã‚¯ã‚¨ã‚¹ãƒˆï¼šé¢ç©ã®é­”æ³•ä½¿ã„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            touch-action: none;
            user-select: none;
            overflow: hidden; /* ç”»é¢å¤–ã¸ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æŠ‘åˆ¶ */
        }
        .canvas-container {
            position: relative;
            background-color: #ffffff;
            background-image: 
                linear-gradient(to right, #e2e8f0 1px, transparent 1px),
                linear-gradient(to bottom, #e2e8f0 1px, transparent 1px);
            background-size: 15px 15px; /* ã‚°ãƒªãƒƒãƒ‰ã‚‚å°‘ã—å°ã•ã */
            cursor: crosshair;
        }
        .canvas-container::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                linear-gradient(to right, #cbd5e1 1px, transparent 1px),
                linear-gradient(to bottom, #cbd5e1 1px, transparent 1px);
            background-size: 75px 75px;
            pointer-events: none;
        }
        .monster-bounce {
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .overlay {
            backdrop-filter: blur(4px);
            transition: opacity 0.3s ease;
        }
        #timer-bar {
            transition: width 0.1s linear;
        }
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .heart-active { color: #f43f5e; filter: drop-shadow(0 0 2px #fda4af); }
        .heart-empty { color: #e2e8f0; }
    </style>
</head>
<body class="bg-slate-200 min-h-screen flex flex-col items-center p-2 font-sans text-slate-800">

    <!-- ãƒ¬ãƒ™ãƒ«é¸æŠã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="tutorial-overlay" class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4 overlay">
        <div class="bg-white rounded-2xl max-w-sm w-full p-6 shadow-2xl text-center">
            <h2 id="overlay-title" class="text-2xl font-black text-emerald-600 mb-4">ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠ</h2>
            <div class="space-y-3 mb-4">
                <button onclick="setLevel(1)" class="w-full text-left p-3 bg-blue-50 rounded-xl border-2 border-blue-200 hover:border-blue-500 transition-all group">
                    <h3 class="font-bold text-blue-700 text-center">åˆç´šï¼šè¦‹ç¿’ã„</h3>
                    <p class="text-[10px] text-blue-600/80 text-center">ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ã€‚ãƒ©ã‚¤ãƒ•æ¸›å°‘ãªã—ã€‚</p>
                </button>
                <button onclick="setLevel(2)" class="w-full text-left p-3 bg-amber-50 rounded-xl border-2 border-amber-200 hover:border-amber-500 transition-all group">
                    <h3 class="font-bold text-amber-700 text-center">ä¸­ç´šï¼šä¸€äººå‰</h3>
                    <p class="text-[10px] text-amber-600/80 text-center">ãƒ©ã‚¤ãƒ•3ã€‚å›³å½¢ã‚’æŒ‡å®šã•ã‚Œã¾ã™ã€‚</p>
                </button>
                <button onclick="setLevel(3)" class="w-full text-left p-3 bg-purple-50 rounded-xl border-2 border-purple-200 hover:border-purple-500 transition-all group">
                    <h3 class="font-bold text-purple-700 text-center">ä¸Šç´šï¼šä¼èª¬</h3>
                    <p class="text-[10px] text-purple-600/80 text-center">ãƒ©ã‚¤ãƒ•3ã€‚å›³å½¢æŒ‡å®šï¼‹20ç§’åˆ¶é™ï¼</p>
                </button>
            </div>
        </div>
    </div>

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ (ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ) -->
    <div class="w-full max-w-md bg-white rounded-xl shadow-md p-3 mb-2 flex justify-between items-center border-b-2 border-slate-300">
        <div class="flex flex-col">
            <div class="flex items-center gap-2">
                <h1 id="show-help" class="text-lg font-bold text-emerald-600 cursor-pointer">é¢ç©ã®é­”æ³•ä½¿ã„ â„¹ï¸</h1>
                <div id="life-container" class="flex gap-0.5 ml-2 hidden">
                    <span class="heart text-sm heart-active">â¤ï¸</span>
                    <span class="heart text-sm heart-active">â¤ï¸</span>
                    <span class="heart text-sm heart-active">â¤ï¸</span>
                </div>
            </div>
            <div class="flex gap-1 mt-1">
                <button id="lvl-btn-1" class="px-2 py-0.5 rounded-full text-[8px] font-bold uppercase bg-slate-200 text-slate-500">åˆç´š</button>
                <button id="lvl-btn-2" class="px-2 py-0.5 rounded-full text-[8px] font-bold uppercase bg-slate-200 text-slate-500">ä¸­ç´š</button>
                <button id="lvl-btn-3" class="px-2 py-0.5 rounded-full text-[8px] font-bold uppercase bg-slate-200 text-slate-500">ä¸Šç´š</button>
            </div>
        </div>
        <div class="text-right">
            <div class="text-[8px] font-bold uppercase text-slate-400">Score</div>
            <div id="score" class="text-xl font-black text-emerald-500 leading-none">0</div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
    <div id="main-container" class="w-full max-w-md bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col border border-white">
        
        <div id="timer-container" class="h-1.5 w-full bg-slate-100 hidden">
            <div id="timer-bar" class="h-full bg-rose-500 w-full"></div>
        </div>

        <div id="mission-panel" class="p-3 bg-emerald-50 border-b border-emerald-100 flex items-center gap-3">
            <div id="monster-emoji" class="text-4xl monster-bounce">ğŸ‘¾</div>
            <div class="flex-1">
                <div class="flex gap-2 items-center">
                    <div class="bg-white px-2 py-1 rounded-lg border border-emerald-200 shadow-sm">
                        <span class="text-[10px] font-bold text-slate-500">é¢ç©:</span>
                        <span id="target-area" class="text-lg font-black text-rose-500">12</span>
                    </div>
                    <div id="target-shape-panel" class="bg-white px-2 py-1 rounded-lg border border-blue-200 shadow-sm hidden">
                        <span class="text-[10px] font-bold text-slate-500">å›³å½¢:</span>
                        <span id="target-shape-name" class="text-sm font-black text-blue-600">é•·æ–¹å½¢</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-3 flex flex-col items-center bg-slate-50 relative">
            <div id="beginner-hud" class="absolute top-4 left-4 z-20 bg-white/90 px-2 py-1 rounded-lg border border-blue-200 text-[10px] shadow-sm hidden">
                <div id="hud-dimensions" class="font-bold text-blue-600"></div>
            </div>

            <div id="canvas-wrapper" class="canvas-container border-2 border-slate-300 rounded-lg shadow-inner relative overflow-hidden" 
                 style="width: 300px; height: 300px;">
                <canvas id="gameCanvas" width="300" height="300"></canvas>
            </div>
            
            <div id="mode-buttons" class="mt-3 grid grid-cols-4 gap-1 w-full max-w-[300px]">
                <button id="btn-rect" onclick="setMode('rect')" class="mode-btn py-2 rounded-lg text-[10px] font-bold transition-all bg-emerald-600 text-white border-b-2 border-emerald-800">é•·æ–¹å½¢</button>
                <button id="btn-tri" onclick="setMode('tri')" class="mode-btn py-2 rounded-lg text-[10px] font-bold transition-all bg-slate-300 text-slate-700 border-b-2 border-slate-400">ä¸‰è§’å½¢</button>
                <button id="btn-para" onclick="setMode('para')" class="mode-btn py-2 rounded-lg text-[10px] font-bold transition-all bg-slate-300 text-slate-700 border-b-2 border-slate-400">å¹³è¡Œå››è¾ºå½¢</button>
                <button id="btn-rhombus" onclick="setMode('rhombus')" class="mode-btn py-2 rounded-lg text-[10px] font-bold transition-all bg-slate-300 text-slate-700 border-b-2 border-slate-400">ã²ã—å½¢</button>
            </div>
        </div>

        <div class="p-3 bg-white flex justify-between items-center border-t border-slate-200">
            <div id="area-display-container" class="flex flex-col items-center px-2">
                <div class="text-[8px] text-slate-400 font-bold uppercase">ç¾åœ¨ã®é¢ç©</div>
                <div id="current-area" class="text-2xl font-black text-slate-700">0.0</div>
            </div>
            <div class="flex flex-col items-end flex-1 ml-4">
                <div id="status-msg" class="text-[10px] font-bold text-emerald-600 mb-1">æã„ã¦ç™ºå‹•ï¼</div>
                <div class="flex gap-2">
                    <button onclick="clearCanvas()" class="px-3 py-2 bg-rose-100 text-rose-600 rounded-lg text-xs font-bold border-b-2 border-rose-300">æ¶ˆå»</button>
                    <button id="attack-btn" onclick="performAttack()" class="px-6 py-2 bg-emerald-600 text-white rounded-lg font-black text-lg shadow-md hover:bg-emerald-700 border-b-4 border-emerald-900">
                        é­”æ³•ï¼
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const GRID_SIZE = 15; // ã‚°ãƒªãƒƒãƒ‰ã‚’å°‘ã—ç´°ã‹ã/å°ã•ã
        
        let score = 0;
        let lives = 3;
        let targetArea = 0;
        let targetShape = ''; 
        let currentArea = 0;
        let mode = 'rect'; 
        let level = 0; 
        let isDrawing = false;
        let startX, startY, currentX, currentY;
        let shapes = [];
        
        let timeLeft = 20;
        let timerInterval = null;
        const TIME_LIMIT = 20;
        let audioCtx = null;

        const shapeNames = { 'rect': 'é•·æ–¹å½¢', 'tri': 'ä¸‰è§’å½¢', 'para': 'å¹³è¡Œå››è¾ºå½¢', 'rhombus': 'ã²ã—å½¢' };

        function getGridCoord(val) { return Math.round(val / GRID_SIZE) * GRID_SIZE; }

        function playSound(type) {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                const now = audioCtx.currentTime;
                if (type === 'success') {
                    osc.frequency.setValueAtTime(523, now); osc.frequency.exponentialRampToValueAtTime(1046, now + 0.1);
                    gain.gain.setValueAtTime(0.2, now); osc.start(); osc.stop(now + 0.3);
                } else if (type === 'fail') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(110, now);
                    gain.gain.setValueAtTime(0.1, now); osc.start(); osc.stop(now + 0.4);
                }
            } catch (e) {}
        }

        function setLevel(l) {
            level = l; lives = 3; score = 0;
            document.getElementById('score').innerText = score;
            document.getElementById('tutorial-overlay').classList.add('hidden');
            updateLevelUI(); updateHearts(); setNewMission();
        }

        function updateLevelUI() {
            [1, 2, 3].forEach(l => {
                const btn = document.getElementById(`lvl-btn-${l}`);
                if (level === l) btn.className = `px-2 py-0.5 rounded-full text-[8px] font-bold uppercase text-white bg-emerald-500`;
                else btn.className = `px-2 py-0.5 rounded-full text-[8px] font-bold uppercase bg-slate-200 text-slate-500`;
            });
            document.getElementById('area-display-container').style.visibility = (level === 1) ? 'visible' : 'hidden';
            document.getElementById('beginner-hud').style.display = (level === 1) ? 'block' : 'none';
            document.getElementById('timer-container').classList.toggle('hidden', level !== 3);
            document.getElementById('life-container').classList.toggle('hidden', level === 1);
        }

        function updateHearts() {
            const hearts = document.querySelectorAll('.heart');
            hearts.forEach((h, i) => h.className = i < lives ? "heart text-sm heart-active" : "heart text-sm heart-empty");
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            if (level !== 3) return;
            timeLeft = TIME_LIMIT;
            timerInterval = setInterval(() => {
                timeLeft -= 0.1;
                document.getElementById('timer-bar').style.width = (timeLeft / TIME_LIMIT * 100) + "%";
                if (timeLeft <= 0) { clearInterval(timerInterval); handleFail("æ™‚é–“åˆ‡ã‚Œï¼"); }
            }, 100);
        }

        function handleFail(reason) {
            lives--; updateHearts(); playSound('fail'); failEffect();
            document.getElementById('status-msg').innerText = reason;
            if (lives <= 0) setTimeout(gameOver, 800);
            else setTimeout(setNewMission, 1200);
        }

        function gameOver() {
            document.getElementById('overlay-title').innerText = "GAME OVER";
            document.getElementById('tutorial-overlay').classList.remove('hidden');
        }

        function generateValidArea() {
            let minSide = 2, maxSide = level === 1 ? 6 : (level === 2 ? 8 : 10);
            const side1 = Math.floor(Math.random() * (maxSide - minSide + 1)) + minSide;
            const side2 = Math.floor(Math.random() * (maxSide - minSide + 1)) + minSide;
            const currentShapeType = targetShape || 'rect';

            if (currentShapeType === 'rect' || currentShapeType === 'para') targetArea = side1 * side2;
            else {
                const s1 = side1 % 2 === 0 ? side1 : side1 + 1;
                targetArea = (s1 * side2) / 2;
            }
        }

        function setNewMission() {
            if (level > 1) {
                const keys = Object.keys(shapeNames);
                targetShape = keys[Math.floor(Math.random() * keys.length)];
                document.getElementById('target-shape-panel').classList.remove('hidden');
                document.getElementById('target-shape-name').innerText = shapeNames[targetShape];
            } else {
                targetShape = '';
                document.getElementById('target-shape-panel').classList.add('hidden');
            }
            generateValidArea();
            document.getElementById('target-area').innerText = targetArea;
            document.getElementById('status-msg').innerText = "æã„ã¦ç™ºå‹•ï¼";
            clearCanvas();
            if (level === 3) startTimer();
        }

        function updateAreaHUD(w, h) {
            document.getElementById('current-area').innerText = currentArea.toFixed(1);
            if (level === 1) {
                const hud = document.getElementById('hud-dimensions');
                if (mode === 'rect') hud.innerHTML = `ç¸¦:${h} æ¨ª:${w}`;
                else if (mode === 'tri' || mode === 'para') hud.innerHTML = `åº•:${w} é«˜:${h}`;
                else if (mode === 'rhombus') hud.innerHTML = `å¯¾1:${w} å¯¾2:${h}`;
            }
        }

        function calculateArea(x1, y1, x2, y2, type) {
            const w = Math.abs(x2 - x1) / GRID_SIZE;
            const h = Math.abs(y2 - y1) / GRID_SIZE;
            return (type === 'rect' || type === 'para') ? w * h : (w * h) / 2;
        }

        function drawShape(s, isPreview = false) {
            ctx.fillStyle = isPreview ? 'rgba(59, 130, 246, 0.3)' : 'rgba(16, 185, 129, 0.4)';
            ctx.strokeStyle = isPreview ? '#2563eb' : '#059669';
            ctx.lineWidth = 2;
            const {x1, y1, x2, y2, type} = s;
            const minX = Math.min(x1, x2), maxX = Math.max(x1, x2), minY = Math.min(y1, y2), maxY = Math.max(y1, y2);
            const w = maxX - minX, h = maxY - minY;
            ctx.beginPath();
            if (type === 'rect') ctx.rect(minX, minY, w, h);
            else if (type === 'tri') { ctx.moveTo(minX, maxY); ctx.lineTo(maxX, maxY); ctx.lineTo(minX + w/2, minY); }
            else if (type === 'para') { const sh = GRID_SIZE; ctx.moveTo(minX + sh, minY); ctx.lineTo(maxX + sh, minY); ctx.lineTo(maxX, maxY); ctx.lineTo(minX, maxY); }
            else if (type === 'rhombus') { ctx.moveTo(minX+w/2, minY); ctx.lineTo(maxX, minY+h/2); ctx.lineTo(minX+w/2, maxY); ctx.lineTo(minX, minY+h/2); }
            ctx.closePath(); ctx.fill(); ctx.stroke();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            shapes.forEach(s => drawShape(s));
            if (isDrawing) drawShape({x1: startX, y1: startY, x2: currentX, y2: currentY, type: mode}, true);
        }

        canvas.addEventListener('mousedown', e => {
            if (level === 0) return;
            const rect = canvas.getBoundingClientRect();
            startX = getGridCoord(e.clientX - rect.left); startY = getGridCoord(e.clientY - rect.top);
            currentX = startX; currentY = startY; isDrawing = true;
        });

        window.addEventListener('mousemove', e => {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            currentX = getGridCoord(e.clientX - rect.left); currentY = getGridCoord(e.clientY - rect.top);
            currentArea = calculateArea(startX, startY, currentX, currentY, mode);
            updateAreaHUD(Math.abs(currentX - startX) / GRID_SIZE, Math.abs(currentY - startY) / GRID_SIZE);
            draw();
        });

        window.addEventListener('mouseup', () => {
            if (!isDrawing) return; isDrawing = false;
            if (currentArea > 0) shapes = [{x1: startX, y1: startY, x2: currentX, y2: currentY, type: mode}];
            draw();
        });

        function setMode(m) {
            mode = m;
            document.querySelectorAll('.mode-btn').forEach(b => {
                b.className = b.id === `btn-${m}` ? "mode-btn py-2 rounded-lg text-[10px] font-bold transition-all bg-emerald-600 text-white border-b-2 border-emerald-800" : "mode-btn py-2 rounded-lg text-[10px] font-bold transition-all bg-slate-300 text-slate-700 border-b-2 border-slate-400";
            });
            clearCanvas();
        }

        function clearCanvas() { shapes = []; currentArea = 0; updateAreaHUD(0, 0); draw(); }

        function performAttack() {
            if (shapes.length === 0) return;
            const areaMatches = Math.abs(currentArea - targetArea) < 0.01;
            const shapeMatches = !targetShape || shapes[0].type === targetShape;

            if (areaMatches && shapeMatches) {
                score += 100; document.getElementById('score').innerText = score;
                document.getElementById('status-msg').innerText = "æˆåŠŸï¼"; playSound('success');
                if (timerInterval) clearInterval(timerInterval);
                setTimeout(setNewMission, 800);
            } else {
                if (level === 1) { document.getElementById('status-msg').innerText = "ãŠã—ã„ï¼"; playSound('fail'); failEffect(); }
                else handleFail(shapeMatches ? "é¢ç©ãŒé•ã†ï¼" : "å›³å½¢ãŒé•ã†ï¼");
            }
        }

        function failEffect() {
            const container = document.getElementById('main-container');
            container.classList.add('shake');
            setTimeout(() => container.classList.remove('shake'), 500);
        }

        document.getElementById('show-help').onclick = () => {
            document.getElementById('overlay-title').innerText = "ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠ";
            document.getElementById('tutorial-overlay').classList.remove('hidden');
        };

        draw();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¢ç©ã®é­”æ³•ä½¿ã„ - Jumbo Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            touch-action: none;
            user-select: none;
            background-color: #f8fafc;
            overflow-y: auto;
        }
        .canvas-container {
            position: relative;
            background-color: #ffffff;
            background-image: 
                linear-gradient(to right, #f1f5f9 1px, transparent 1px),
                linear-gradient(to bottom, #f1f5f9 1px, transparent 1px);
            background-size: 30px 30px;
            cursor: crosshair;
        }
        .canvas-container::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                linear-gradient(to right, #e2e8f0 1px, transparent 1px),
                linear-gradient(to bottom, #e2e8f0 1px, transparent 1px);
            background-size: 150px 150px;
            pointer-events: none;
        }
        .mode-btn-active {
            background-color: #059669 !important;
            color: white !important;
            border-bottom-width: 0px !important;
            transform: translateY(2px);
        }
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
        }
    </style>
</head>
<body class="flex flex-col items-center p-2 font-sans text-slate-800">

    <!-- åˆæœŸãƒ¬ãƒ™ãƒ«é¸æŠã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆèª¬æ˜ä»˜ãï¼‰ -->
    <div id="tutorial-overlay" class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl max-w-md w-full p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h2 class="text-3xl font-black text-emerald-600 mb-2 text-center">é¢ç©ã®é­”æ³•ä½¿ã„</h2>
            
            <!-- ã‚²ãƒ¼ãƒ èª¬æ˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="bg-emerald-50 rounded-2xl p-5 mb-6 text-sm text-slate-700 leading-relaxed border border-emerald-100">
                <p class="font-bold text-emerald-800 mb-2">âœ¨ ã‚ãã³ã‹ãŸ</p>
                <ul class="space-y-2 list-disc list-inside">
                    <li>ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãŒã ã™<span class="font-bold text-rose-600">ã€Œã‚‚ãã²ã‚‡ã†ã®é¢ç©ã€</span>ã«ã´ã£ãŸã‚Šåˆã†ã‚ˆã†ã«ã€ãƒã‚¹ç›®ã«å›³å½¢ã‚’æãã¾ã—ã‚‡ã†ã€‚</li>
                    <li>æããŸã„å›³å½¢ã®ãƒœã‚¿ãƒ³ã‚’é¸ã‚“ã§ã€ãƒã‚¹ç›®ã‚’<span class="font-bold text-blue-600">ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆãªãã‚‹ï¼‰</span>ã™ã‚‹ã¨å›³å½¢ãŒæã‘ã¾ã™ã€‚</li>
                    <li>æº–å‚™ãŒã§ããŸã‚‰<span class="font-bold text-emerald-600">ã€Œé­”æ³•ç™ºå‹•ï¼ã€</span>ãƒœã‚¿ãƒ³ã§ã“ã†ã’ãï¼</li>
                    <li>ä¸­ç´šã‹ã‚‰ã¯<span class="font-bold text-blue-600">å›³å½¢ã®å½¢</span>ã‚‚æŒ‡å®šã•ã‚Œã¾ã™ã€‚è‡ªåˆ†ã§è¨ˆç®—ã—ã¦é­”æ³•ã‚’å®Œæˆã•ã›ã¾ã—ã‚‡ã†ï¼</li>
                </ul>
            </div>

            <p class="text-center font-bold text-slate-500 mb-4 tracking-tighter">ã¡ã‚‡ã†ã›ã‚“ã™ã‚‹ãƒ¬ãƒ™ãƒ«ã‚’ãˆã‚‰ã‚“ã§ã­ï¼</p>
            
            <div class="grid gap-3">
                <button onclick="changeLevel(1)" class="group flex flex-col items-center justify-center py-4 bg-blue-50 text-blue-700 rounded-2xl border-2 border-blue-200 hover:bg-blue-100 transition-all">
                    <span class="text-xl font-black">åˆç´šï¼šè¦‹ç¿’ã„</span>
                    <span class="text-xs font-bold opacity-70">ãƒ’ãƒ³ãƒˆã‚ã‚Šãƒ»ãƒ©ã‚¤ãƒ•ãªã—</span>
                </button>
                <button onclick="changeLevel(2)" class="group flex flex-col items-center justify-center py-4 bg-amber-50 text-amber-700 rounded-2xl border-2 border-amber-200 hover:bg-amber-100 transition-all">
                    <span class="text-xl font-black">ä¸­ç´šï¼šä¸€äººå‰</span>
                    <span class="text-xs font-bold opacity-70">ãƒ’ãƒ³ãƒˆãªã—ãƒ»å½¢æŒ‡å®šã‚ã‚Š</span>
                </button>
                <button onclick="changeLevel(3)" class="group flex flex-col items-center justify-center py-4 bg-purple-50 text-purple-700 rounded-2xl border-2 border-purple-200 hover:bg-purple-100 transition-all">
                    <span class="text-xl font-black">ä¸Šç´šï¼šä¼èª¬</span>
                    <span class="text-xs font-bold opacity-70">ãƒ’ãƒ³ãƒˆãªã—ãƒ»20ç§’ã®æ™‚é–“åˆ¶é™</span>
                </button>
            </div>
        </div>
    </div>

    <div id="main-wrapper" class="w-full max-w-2xl bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col border border-slate-200">
        
        <!-- Header -->
        <div class="bg-slate-800 text-white p-3 flex justify-between items-center">
            <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3">
                    <span class="text-sm font-black text-emerald-400 tracking-widest">AREA MAGE</span>
                    <div id="life-container" class="flex gap-1">
                        <span class="heart text-base">â¤ï¸</span>
                        <span class="heart text-base">â¤ï¸</span>
                        <span class="heart text-base">â¤ï¸</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="changeLevel(1)" id="lvl-1" class="px-3 py-1 rounded text-xs font-bold bg-slate-700 hover:bg-blue-600 transition-colors">åˆç´š</button>
                    <button onclick="changeLevel(2)" id="lvl-2" class="px-3 py-1 rounded text-xs font-bold bg-slate-700 hover:bg-amber-600 transition-colors">ä¸­ç´š</button>
                    <button onclick="changeLevel(3)" id="lvl-3" class="px-3 py-1 rounded text-xs font-bold bg-slate-700 hover:bg-purple-600 transition-colors">ä¸Šç´š</button>
                </div>
            </div>
            <div class="text-right">
                <div class="text-xs text-slate-400 uppercase font-bold">Score</div>
                <div id="score" class="text-3xl font-black leading-none text-emerald-400">0</div>
            </div>
        </div>

        <div id="timer-container" class="h-2 w-full bg-slate-200 hidden">
            <div id="timer-bar" class="h-full bg-rose-500 w-full transition-all"></div>
        </div>

        <!-- Mission Area & Action Buttons -->
        <div class="px-4 py-3 bg-emerald-50 border-b border-emerald-100 flex items-center justify-between gap-4">
            <div class="flex items-center gap-4 flex-1">
                <div id="monster-emoji" class="text-4xl">ğŸ‘¾</div>
                <div class="flex flex-col">
                    <div class="flex items-center gap-2">
                        <div class="bg-white border border-emerald-200 px-3 py-2 rounded-lg shadow-sm flex items-baseline gap-1">
                            <span class="text-xs font-bold text-slate-400">ã‚‚ãã²ã‚‡ã†:</span>
                            <span id="target-area" class="text-2xl font-black text-rose-500">12</span>
                            <span class="text-sm font-bold text-slate-500">ã </span>
                        </div>
                        <div id="target-shape-panel" class="bg-white border border-blue-200 px-3 py-2 rounded-lg shadow-sm hidden">
                            <span id="target-shape-name" class="text-base font-black text-blue-600">é•·æ–¹å½¢</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="clearCanvas()" class="px-3 py-2 bg-rose-100 text-rose-600 rounded-xl text-xs font-bold border-b-4 border-rose-300 active:translate-y-1 active:border-b-0 transition-all">
                    å›³å½¢æ¶ˆå»
                </button>
                <button id="attack-btn" onclick="performAttack()" class="px-6 py-2 bg-emerald-600 text-white rounded-xl font-black text-lg shadow-md border-b-4 border-emerald-800 active:border-b-0 active:translate-y-1 transition-all">
                    é­”æ³•ç™ºå‹•ï¼
                </button>
            </div>
        </div>

        <!-- Game Area (æ¨ªä¸¦ã³) -->
        <div class="flex p-4 gap-6 bg-slate-50 items-start justify-center">
            <!-- Left Side Buttons -->
            <div class="flex flex-col gap-2 w-28">
                <button id="btn-rect" onclick="setMode('rect')" class="mode-btn py-4 text-xs font-bold bg-slate-200 rounded-xl border-b-4 border-slate-400">é•·æ–¹å½¢</button>
                <button id="btn-tri" onclick="setMode('tri')" class="mode-btn py-4 text-xs font-bold bg-slate-200 rounded-xl border-b-4 border-slate-400">ä¸‰è§’å½¢</button>
                <button id="btn-para" onclick="setMode('para')" class="mode-btn py-4 text-xs font-bold bg-slate-200 rounded-xl border-b-4 border-slate-400">å¹³è¡Œå››è¾ºå½¢</button>
                <button id="btn-rhombus" onclick="setMode('rhombus')" class="mode-btn py-4 text-xs font-bold bg-slate-200 rounded-xl border-b-4 border-slate-400">ã²ã—å½¢</button>
                
                <!-- ã„ã¾ã®é¢ç©è¡¨ç¤ºï¼ˆåˆç´šã®ã¿è¡¨ç¤ºï¼‰ -->
                <div id="current-area-display" class="mt-6 p-3 bg-white rounded-xl border border-slate-200 text-center shadow-sm">
                    <span class="text-xs font-bold text-slate-400 block">ã„ã¾ã®é¢ç©</span>
                    <span id="current-area" class="text-2xl font-black text-slate-700">0.0</span>
                    <span class="text-sm font-bold text-slate-500">ã </span>
                </div>
            </div>

            <!-- Canvas Container -->
            <div class="relative">
                <div id="beginner-hud" class="absolute top-2 left-2 z-20 bg-white/90 px-3 py-1 rounded-lg border-2 border-blue-400 text-sm font-bold text-blue-700 shadow-md hidden"></div>
                <div id="canvas-wrapper" class="canvas-container border-4 border-slate-400 rounded-2xl shadow-lg overflow-hidden" 
                     style="width: 420px; height: 420px;">
                    <canvas id="gameCanvas" width="420" height="420"></canvas>
                </div>
            </div>
        </div>

        <!-- Footer Message -->
        <div id="status-msg" class="bg-white px-4 py-3 text-center text-sm font-bold text-emerald-600 border-t border-slate-100">
            å›³å½¢ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é­”æ³•ã‚’çµ„ã¿ç«‹ã¦ã‚ˆã†ï¼
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const GRID_SIZE = 30;
        
        let score = 0;
        let lives = 3;
        let targetArea = 0;
        let targetShape = ''; 
        let currentArea = 0;
        let mode = 'rect'; 
        let level = 0; 
        let isDrawing = false;
        let startX, startY, currentX, currentY;
        let shapes = [];
        let timerInterval = null;
        let timeLeft = 20;

        const shapeNames = { 'rect': 'é•·æ–¹å½¢', 'tri': 'ä¸‰è§’å½¢', 'para': 'å¹³è¡Œå››è¾ºå½¢', 'rhombus': 'ã²ã—å½¢' };

        function getGridCoord(val) { return Math.round(val / GRID_SIZE) * GRID_SIZE; }

        function changeLevel(l) {
            level = l;
            lives = 3;
            score = 0;
            document.getElementById('score').innerText = score;
            document.getElementById('tutorial-overlay').classList.add('hidden');
            
            [1, 2, 3].forEach(lv => {
                const btn = document.getElementById(`lvl-${lv}`);
                btn.classList.remove('bg-blue-600', 'bg-amber-600', 'bg-purple-600');
                if (lv === level) {
                    const colors = { 1: 'bg-blue-600', 2: 'bg-amber-600', 3: 'bg-purple-600' };
                    btn.classList.add(colors[level]);
                }
            });

            document.getElementById('timer-container').classList.toggle('hidden', level !== 3);
            document.getElementById('life-container').classList.toggle('hidden', level === 1);
            
            // åˆç´š(1)ã®ã¿è¡¨ç¤ºã™ã‚‹è¦ç´ ã®åˆ¶å¾¡
            document.getElementById('beginner-hud').classList.toggle('hidden', level !== 1);
            document.getElementById('current-area-display').classList.toggle('hidden', level !== 1);
            
            updateHearts();
            setNewMission();
            setMode(mode);
        }

        function updateHearts() {
            const hearts = document.querySelectorAll('.heart');
            hearts.forEach((h, i) => {
                h.innerText = i < lives ? "â¤ï¸" : "ğŸ–¤";
                h.style.opacity = i < lives ? "1" : "0.3";
            });
        }

        function setNewMission() {
            if (timerInterval) clearInterval(timerInterval);
            
            if (level > 1) {
                const keys = Object.keys(shapeNames);
                targetShape = keys[Math.floor(Math.random() * keys.length)];
                document.getElementById('target-shape-panel').classList.remove('hidden');
                document.getElementById('target-shape-name').innerText = shapeNames[targetShape];
            } else {
                targetShape = '';
                document.getElementById('target-shape-panel').classList.add('hidden');
            }

            let minS = 2, maxS = level === 1 ? 5 : (level === 2 ? 7 : 9);
            const side1 = Math.floor(Math.random() * (maxS - minS + 1)) + minS;
            const side2 = Math.floor(Math.random() * (maxS - minS + 1)) + minS;
            const currentShapeType = targetShape || 'rect';

            if (currentShapeType === 'rect' || currentShapeType === 'para') targetArea = side1 * side2;
            else {
                const s1 = side1 % 2 === 0 ? side1 : side1 + 1;
                targetArea = (s1 * side2) / 2;
            }

            document.getElementById('target-area').innerText = targetArea;
            document.getElementById('status-msg').innerText = "æ­£ã—ã„é¢ç©ã‚’æã„ã¦ç™ºå‹•ã—ã‚ˆã†ï¼";
            clearCanvas();

            if (level === 3) {
                timeLeft = 20;
                timerInterval = setInterval(() => {
                    timeLeft -= 0.1;
                    document.getElementById('timer-bar').style.width = (timeLeft / 20 * 100) + "%";
                    if (timeLeft <= 0) { handleFail("æ™‚é–“åˆ‡ã‚Œï¼"); }
                }, 100);
            }
        }

        function handleFail(msg) {
            if (timerInterval) clearInterval(timerInterval);
            lives--;
            updateHearts();
            document.getElementById('status-msg').innerText = msg;
            document.getElementById('main-wrapper').classList.add('shake');
            setTimeout(() => document.getElementById('main-wrapper').classList.remove('shake'), 500);

            if (lives <= 0) {
                document.getElementById('status-msg').innerText = "ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼ãƒ¬ãƒ™ãƒ«ã‚’é¸ã³ç›´ã—ã¦ã­";
                setTimeout(() => { document.getElementById('tutorial-overlay').classList.remove('hidden'); }, 1500);
            } else {
                setTimeout(setNewMission, 1200);
            }
        }

        function calculateArea(x1, y1, x2, y2, type) {
            const w = Math.abs(x2 - x1) / GRID_SIZE;
            const h = Math.abs(y2 - y1) / GRID_SIZE;
            return (type === 'rect' || type === 'para') ? w * h : (w * h) / 2;
        }

        function drawShape(s, isPreview = false) {
            ctx.fillStyle = isPreview ? 'rgba(59, 130, 246, 0.3)' : 'rgba(16, 185, 129, 0.4)';
            ctx.strokeStyle = isPreview ? '#2563eb' : '#059669';
            ctx.lineWidth = 4;
            const {x1, y1, x2, y2, type} = s;
            const minX = Math.min(x1, x2), maxX = Math.max(x1, x2), minY = Math.min(y1, y2), maxY = Math.max(y1, y2);
            const w = maxX - minX, h = maxY - minY;
            ctx.beginPath();
            if (type === 'rect') ctx.rect(minX, minY, w, h);
            else if (type === 'tri') { ctx.moveTo(minX, maxY); ctx.lineTo(maxX, maxY); ctx.lineTo(minX + w/2, minY); }
            else if (type === 'para') { const sh = GRID_SIZE; ctx.moveTo(minX + sh, minY); ctx.lineTo(maxX + sh, minY); ctx.lineTo(maxX, maxY); ctx.lineTo(minX, maxY); }
            else if (type === 'rhombus') { ctx.moveTo(minX+w/2, minY); ctx.lineTo(maxX, minY+h/2); ctx.lineTo(minX+w/2, maxY); ctx.lineTo(minX, minY+h/2); }
            ctx.closePath(); ctx.fill(); ctx.stroke();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            shapes.forEach(s => drawShape(s));
            if (isDrawing) drawShape({x1: startX, y1: startY, x2: currentX, y2: currentY, type: mode}, true);
        }

        canvas.addEventListener('mousedown', e => {
            if (level === 0) return;
            const rect = canvas.getBoundingClientRect();
            startX = getGridCoord(e.clientX - rect.left); startY = getGridCoord(e.clientY - rect.top);
            currentX = startX; currentY = startY; isDrawing = true;
        });

        window.addEventListener('mousemove', e => {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            currentX = getGridCoord(e.clientX - rect.left); currentY = getGridCoord(e.clientY - rect.top);
            currentArea = calculateArea(startX, startY, currentX, currentY, mode);
            
            if (level === 1) {
                document.getElementById('current-area').innerText = currentArea.toFixed(1);
                const w = Math.abs(currentX - startX) / GRID_SIZE;
                const h = Math.abs(currentY - startY) / GRID_SIZE;
                let label = "";
                if(mode==='rect') label=`ãŸã¦:${h}ã ã‚ˆã“:${w}ã`;
                else if(mode==='tri' || mode==='para') label=`åº•è¾º:${w}ã é«˜ã•:${h}ã`;
                else if(mode==='rhombus') label=`å¯¾è§’ç·š:${w}ã / ${h}ã`;
                document.getElementById('beginner-hud').innerText = label;
            }
            draw();
        });

        window.addEventListener('mouseup', () => {
            if (!isDrawing) return; isDrawing = false;
            if (currentArea > 0) shapes = [{x1: startX, y1: startY, x2: currentX, y2: currentY, type: mode}];
            draw();
        });

        function setMode(m) {
            mode = m;
            document.querySelectorAll('.mode-btn').forEach(b => {
                b.classList.remove('mode-btn-active');
                if (b.id === `btn-${m}`) b.classList.add('mode-btn-active');
            });
            clearCanvas();
        }

        function clearCanvas() { 
            shapes = []; 
            currentArea = 0; 
            if (level === 1) {
                document.getElementById('current-area').innerText = "0.0";
                document.getElementById('beginner-hud').innerText = "";
            }
            draw(); 
        }

        function performAttack() {
            if (shapes.length === 0) return;
            const areaMatches = Math.abs(currentArea - targetArea) < 0.01;
            const shapeMatches = !targetShape || shapes[0].type === targetShape;

            if (areaMatches && shapeMatches) {
                score += 100; document.getElementById('score').innerText = score;
                document.getElementById('status-msg').innerText = "æˆåŠŸï¼âœ¨ é¢ç©ã¯ãƒ”ãƒƒã‚¿ãƒª " + targetArea + "ã  ã ï¼";
                if (timerInterval) clearInterval(timerInterval);
                setTimeout(setNewMission, 1200);
            } else {
                if (level === 1) {
                    document.getElementById('status-msg').innerText = "é¢ç©ã‚„å›³å½¢ãŒã¡ãŒã†ã¿ãŸã„ã ...";
                } else {
                    handleFail(shapeMatches ? "é¢ç©ãŒã¡ãŒã†ãï¼" : "å›³å½¢ã®å½¢ãŒã¡ãŒã†ï¼");
                }
            }
        }

        setMode('rect');
    </script>
</body>
</html>

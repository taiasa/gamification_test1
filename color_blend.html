<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Color Blend Quiz - Versus Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #121212;
            color: white;
            overflow: hidden;
            touch-action: none;
            font-family: 'sans-serif';
        }

        .main-wrapper {
            display: flex;
            width: 100vw;
            height: 100vh;
        }

        /* Player Side Layout */
        .player-side {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transition: background-color 0.3s;
            position: relative;
        }

        /* Center Divider */
        .center-divider {
            width: 140px;
            background: #1a1a1a;
            border-left: 2px solid #333;
            border-right: 2px solid #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            position: relative;
        }

        .target-box {
            width: 100px;
            height: 100px;
            border-radius: 16px;
            border: 4px solid #fff;
            box-shadow: 0 0 25px rgba(0,0,0,0.6);
            margin-bottom: 10px;
        }

        .timer-ring {
            background: #e11d48;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 20px;
        }

        /* Slider Styles */
        .controls-container {
            width: 100%;
            max-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .slider-item {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .label-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            font-weight: bold;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .color-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 40px;
            background: transparent;
            outline: none;
        }

        .color-slider::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        .color-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 32px;
            width: 32px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            margin-top: -12px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            border: 2px solid currentColor;
        }

        .red-slider { color: #ff4d4d; }
        .green-slider { color: #4dff4d; }
        .blue-slider { color: #4d4dff; }

        /* Modals and Overlays */
        .modal-overlay {
            background: rgba(0,0,0,0.95);
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 20px;
        }

        .result-card {
            background: #222;
            border: 1px solid #444;
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 600px;
            text-align: center;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Judging Overlay */
        #judging-overlay {
            z-index: 200;
            background: radial-gradient(circle, rgba(20,20,20,0.95) 0%, rgba(0,0,0,1) 100%);
        }

        .judging-text {
            font-size: 4rem;
            font-weight: 900;
            font-style: italic;
            letter-spacing: -2px;
            color: #3b82f6;
            text-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            animation: pulse 0.2s infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); opacity: 0.8; }
            to { transform: scale(1.1); opacity: 1; }
        }

        .player-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .val-chip {
            font-family: monospace;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(0,0,0,0.3);
        }

        .home-btn {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.1);
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 30;
        }
    </style>
</head>
<body>

    <!-- Game Main UI -->
    <div id="game-ui" class="main-wrapper hidden">
        <div id="player-0" class="player-side">
            <div class="controls-container" id="controls-0"></div>
        </div>

        <div class="center-divider">
            <div id="timer-box" class="timer-ring">10s</div>
            <div id="target-display" class="target-box"></div>
            <div class="text-[10px] font-bold text-gray-500 text-center uppercase tracking-widest">Target<br>Color</div>
            <button onclick="showSetup()" class="home-btn hover:bg-white/20">HOME</button>
            <button id="practice-check-btn" onclick="triggerJudgment()" class="mt-8 bg-green-600 px-4 py-2 rounded-lg text-xs font-bold hidden">判定する</button>
        </div>

        <div id="player-1" class="player-side">
            <div class="controls-container" id="controls-1"></div>
        </div>
    </div>

    <!-- 判定中エフェクト -->
    <div id="judging-overlay" class="modal-overlay hidden">
        <div class="judging-text" id="judging-label">JUDGING...</div>
        <div class="mt-4 text-gray-500 font-bold tracking-[0.5em] uppercase text-xs">分析中</div>
    </div>

    <!-- メインオーバーレイ -->
    <div id="overlay" class="modal-overlay">
        <!-- セットアップ画面 -->
        <div id="setup-panel" class="flex flex-col items-center">
            <h1 class="text-4xl font-black mb-10 tracking-tighter italic">COLOR BLEND</h1>
            <div class="space-y-6 w-72 text-center">
                <div>
                    <p class="text-xs font-bold text-gray-400 mb-2">MODE SELECT</p>
                    <div class="flex flex-col gap-2">
                        <button onclick="selectMode(1, this)" class="mode-btn border-2 border-transparent bg-white/5 py-4 rounded-xl font-bold">練習モード (1人用)</button>
                        <button onclick="selectMode(2, this)" id="default-mode-btn" class="mode-btn border-2 border-blue-600 bg-blue-900/40 py-4 rounded-xl font-bold">対戦モード (2人用)</button>
                    </div>
                </div>
                <div id="time-select-area">
                    <p class="text-xs font-bold text-gray-400 mb-2">TIME LIMIT</p>
                    <div class="flex gap-2">
                        <button onclick="selectTime(5, this)" class="time-btn flex-1 bg-white/5 py-2 rounded-lg text-sm">5s</button>
                        <button onclick="selectTime(10, this)" class="time-btn flex-1 bg-blue-600 py-2 rounded-lg text-sm font-bold">10s</button>
                        <button onclick="selectTime(20, this)" class="time-btn flex-1 bg-white/5 py-2 rounded-lg text-sm">20s</button>
                    </div>
                </div>
                <button onclick="initGame()" class="w-full bg-white text-black py-5 rounded-full font-black text-xl shadow-2xl transition active:scale-95">START GAME</button>
            </div>
        </div>

        <!-- リザルト画面 -->
        <div id="result-panel" class="hidden result-card">
            <h2 id="winner-text" class="text-3xl font-black mb-2">RESULT</h2>
            <div class="bg-black/30 p-4 rounded-xl inline-block mb-6">
                <p class="text-[10px] text-gray-400 mb-1">TARGET RGB</p>
                <div class="font-mono font-bold text-xl">
                    <span class="text-red-400" id="ans-r"></span> . 
                    <span class="text-green-400" id="ans-g"></span> . 
                    <span class="text-blue-400" id="ans-b"></span>
                </div>
            </div>
            <div class="player-summary" id="summary-container"></div>
            <div class="mt-8 flex gap-3 justify-center">
                <button onclick="initGame()" class="bg-blue-600 px-8 py-3 rounded-full font-bold">次の色で遊ぶ</button>
                <button onclick="showSetup()" class="bg-gray-700 px-8 py-3 rounded-full font-bold">タイトルへ</button>
            </div>
        </div>
    </div>

    <script>
        let mode = 2; 
        let timeLimit = 10;
        let timeLeft = 0;
        let timer = null;
        let targetColor = { r: 0, g: 0, b: 0 };
        let playerColors = [{r:127,g:127,b:127}, {r:127,g:127,b:127}];

        // Audio System
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        // 電子音（カウントダウン等）
        function playBeep(freq, vol, duration) {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        // ドラムロール音（判定中）- 音量を強化
        function playDrumRoll(durationSec) {
            initAudio();
            const startTime = audioCtx.currentTime;
            const stopTime = startTime + durationSec;
            
            const interval = setInterval(() => {
                if (audioCtx.currentTime > stopTime) {
                    clearInterval(interval);
                    return;
                }
                // 低音（ボディ感）
                const osc1 = audioCtx.createOscillator();
                const gain1 = audioCtx.createGain();
                osc1.type = 'triangle';
                osc1.frequency.setValueAtTime(50 + Math.random() * 30, audioCtx.currentTime);
                gain1.gain.setValueAtTime(0.6, audioCtx.currentTime);
                gain1.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.12);
                osc1.connect(gain1);
                gain1.connect(audioCtx.destination);
                osc1.start();
                osc1.stop(audioCtx.currentTime + 0.12);

                // 少し高めのノイズ成分
                const osc2 = audioCtx.createOscillator();
                const gain2 = audioCtx.createGain();
                osc2.type = 'sawtooth';
                osc2.frequency.setValueAtTime(80 + Math.random() * 40, audioCtx.currentTime);
                gain2.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.08);
                osc2.connect(gain2);
                gain2.connect(audioCtx.destination);
                osc2.start();
                osc2.stop(audioCtx.currentTime + 0.08);
            }, 70);
        }

        // 判定完了音
        function playFinishSound() {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.6);
            gain.gain.setValueAtTime(0.4, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.6);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.6);
        }

        function selectMode(m, el) {
            mode = m;
            document.querySelectorAll('.mode-btn').forEach(b => b.className = 'mode-btn border-2 border-transparent bg-white/5 py-4 rounded-xl font-bold');
            el.className = 'mode-btn border-2 border-blue-600 bg-blue-900/40 py-4 rounded-xl font-bold';
            document.getElementById('time-select-area').style.opacity = m === 1 ? '0.3' : '1';
        }

        function selectTime(t, el) {
            timeLimit = t;
            document.querySelectorAll('.time-btn').forEach(b => b.className = 'time-btn flex-1 bg-white/5 py-2 rounded-lg text-sm');
            el.className = 'time-btn flex-1 bg-blue-600 py-2 rounded-lg text-sm font-bold';
        }

        function showSetup() {
            clearInterval(timer);
            document.getElementById('overlay').classList.remove('hidden');
            document.getElementById('setup-panel').classList.remove('hidden');
            document.getElementById('result-panel').classList.add('hidden');
            document.getElementById('judging-overlay').classList.add('hidden');
            document.getElementById('game-ui').classList.add('hidden');
        }

        function initGame() {
            initAudio();
            document.getElementById('overlay').classList.add('hidden');
            document.getElementById('setup-panel').classList.add('hidden');
            document.getElementById('result-panel').classList.add('hidden');
            document.getElementById('judging-overlay').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            
            clearInterval(timer); 
            
            targetColor = {
                r: Math.floor(Math.random() * 256),
                g: Math.floor(Math.random() * 256),
                b: Math.floor(Math.random() * 256)
            };
            document.getElementById('target-display').style.backgroundColor = `rgb(${targetColor.r}, ${targetColor.g}, ${targetColor.b})`;

            setupPlayerArea(0);
            if (mode === 2) {
                document.getElementById('player-1').style.display = 'flex';
                setupPlayerArea(1);
                startVersusTimer();
                document.getElementById('timer-box').classList.remove('hidden');
                document.getElementById('practice-check-btn').classList.add('hidden');
            } else {
                document.getElementById('player-1').style.display = 'none';
                document.getElementById('timer-box').classList.add('hidden');
                document.getElementById('practice-check-btn').classList.remove('hidden');
            }
        }

        function setupPlayerArea(id) {
            const container = document.getElementById(`controls-${id}`);
            container.innerHTML = `
                <div class="slider-item">
                    <div class="label-row"><span class="text-red-400">Red</span><span id="p${id}-rv">127</span></div>
                    <input type="range" min="0" max="255" value="127" class="color-slider red-slider" oninput="updateColor(${id}, 'r', this.value)">
                </div>
                <div class="slider-item">
                    <div class="label-row"><span class="text-green-400">Green</span><span id="p${id}-gv">127</span></div>
                    <input type="range" min="0" max="255" value="127" class="color-slider green-slider" oninput="updateColor(${id}, 'g', this.value)">
                </div>
                <div class="slider-item">
                    <div class="label-row"><span class="text-blue-400">Blue</span><span id="p${id}-bv">127</span></div>
                    <input type="range" min="0" max="255" value="127" class="color-slider blue-slider" oninput="updateColor(${id}, 'b', this.value)">
                </div>
            `;
            playerColors[id] = {r:127, g:127, b:127};
            updateAreaColor(id);
        }

        function updateColor(id, channel, val) {
            playerColors[id][channel] = parseInt(val);
            document.getElementById(`p${id}-${channel}v`).innerText = val;
            updateAreaColor(id);
        }

        function updateAreaColor(id) {
            const c = playerColors[id];
            document.getElementById(`player-${id}`).style.backgroundColor = `rgb(${c.r}, ${c.g}, ${c.b})`;
        }

        function startVersusTimer() {
            timeLeft = timeLimit;
            updateTimerDisplay();
            timer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                // カウントダウン音 (残り3, 2, 1秒でピッ、0秒でポーン)
                if (timeLeft >= 1 && timeLeft <= 3) {
                    playBeep(880, 0.2, 0.1);
                } else if (timeLeft === 0) {
                    playBeep(1320, 0.3, 0.3);
                }

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    triggerJudgment();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const el = document.getElementById('timer-box');
            if (el) {
                el.innerText = timeLeft + "s";
                el.style.backgroundColor = timeLeft <= 3 ? "#ff0000" : "#e11d48";
            }
        }

        function triggerJudgment() {
            clearInterval(timer);
            const judgingOverlay = document.getElementById('judging-overlay');
            judgingOverlay.classList.remove('hidden');
            
            const waitTime = 2.0; 
            playDrumRoll(waitTime);

            setTimeout(() => {
                judgingOverlay.classList.add('hidden');
                playFinishSound();
                showResults();
            }, waitTime * 1000);
        }

        function showResults() {
            const results = playerColors.map((c, i) => {
                const diff = Math.sqrt(
                    Math.pow(targetColor.r - c.r, 2) +
                    Math.pow(targetColor.g - c.g, 2) +
                    Math.pow(targetColor.b - c.b, 2)
                );
                const accuracy = Math.max(0, 100 - (diff / 4.4167)).toFixed(1);
                return { id: i, accuracy: parseFloat(accuracy), color: c };
            });

            document.getElementById('ans-r').innerText = targetColor.r;
            document.getElementById('ans-g').innerText = targetColor.g;
            document.getElementById('ans-b').innerText = targetColor.b;

            const summary = document.getElementById('summary-container');
            summary.innerHTML = '';

            const activePlayers = mode === 2 ? [0, 1] : [0];
            activePlayers.forEach(i => {
                const p = results[i];
                const card = document.createElement('div');
                card.className = "bg-white/5 p-4 rounded-xl border border-white/10";
                card.innerHTML = `
                    <p class="text-[10px] text-gray-400 font-bold mb-2">PLAYER ${i+1}</p>
                    <div class="text-3xl font-black mb-2">${p.accuracy}%</div>
                    <div class="flex justify-center gap-2 text-[10px]">
                        <span class="val-chip text-red-400">${p.color.r}</span>
                        <span class="val-chip text-green-400">${p.color.g}</span>
                        <span class="val-chip text-blue-400">${p.color.b}</span>
                    </div>
                    <div class="mt-3 w-full h-8 rounded-md" style="background: rgb(${p.color.r}, ${p.color.g}, ${p.color.b}); border: 1px solid #555;"></div>
                `;
                summary.appendChild(card);
            });

            const winText = document.getElementById('winner-text');
            if (mode === 2) {
                if (results[0].accuracy === results[1].accuracy) {
                    winText.innerText = "DRAW";
                    winText.className = "text-3xl font-black text-white mb-2";
                } else {
                    const winIdx = results[0].accuracy > results[1].accuracy ? 0 : 1;
                    winText.innerText = `PLAYER ${winIdx+1} WIN!`;
                    winText.className = "text-3xl font-black text-blue-500 mb-2";
                }
            } else {
                winText.innerText = "YOUR SCORE";
                winText.className = "text-3xl font-black text-yellow-500 mb-2";
            }

            document.getElementById('overlay').classList.remove('hidden');
            document.getElementById('setup-panel').classList.add('hidden');
            document.getElementById('result-panel').classList.remove('hidden');
        }

        window.onload = showSetup;

        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) e.preventDefault();
        }, { passive: false });
    </script>
</body>
</html>
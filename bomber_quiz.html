<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bomber Quiz Arena 100</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0f172a;
            color: white;
            font-family: 'Hiragino Kaku Gothic Pro', 'Meiryo', sans-serif;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        #game-container {
            position: relative;
            box-shadow: 0 0 60px rgba(0,0,0,0.8);
            border: 4px solid #334155;
            background-color: #064e3b;
            border-radius: 8px;
            overflow: hidden;
        }
        canvas { display: block; }
        .ui-panel {
            background: rgba(15, 23, 42, 0.95);
            padding: 2.5rem;
            border-radius: 32px;
            text-align: center;
            max-width: 550px;
            border: 2px solid #475569;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }
        #quiz-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #020617;
            padding: 2.5rem;
            border: 5px solid #fbbf24;
            border-radius: 32px;
            z-index: 100;
            width: 90%;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 0 200px rgba(0,0,0,1);
        }
        .choice-btn {
            background: #1e293b;
            border: 2px solid #334155;
            padding: 1.25rem;
            border-radius: 16px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: bold;
            font-size: 1.1rem;
            width: 100%;
            color: #f1f5f9;
        }
        .choice-btn:hover { background: #334155; border-color: #fbbf24; transform: translateY(-3px); }
        .choice-btn:active { transform: scale(0.95); }
        .stat-badge {
            background: rgba(0,0,0,0.5);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-family: monospace;
        }
    </style>
</head>
<body>

    <!-- Lobby UI -->
    <div id="lobby" class="ui-panel">
        <h1 class="text-5xl font-black mb-2 text-yellow-500 italic drop-shadow-2xl">BOMBER QUIZ</h1>
        <div class="text-yellow-200 text-sm font-bold mb-8 tracking-widest uppercase">Elite 100 Edition</div>
        
        <div class="grid grid-cols-2 gap-4 mb-8 text-sm text-left">
            <div class="bg-slate-900 p-4 rounded-2xl border-l-4 border-yellow-500">
                <div class="text-yellow-400 font-bold mb-2 flex items-center gap-2">ğŸ•¹ï¸ æ“ä½œ</div>
                <div class="text-[11px] space-y-1 text-slate-300">
                    <p>ç§»å‹•: åå­—ã‚­ãƒ¼ / WASD / UHJK / 8456</p>
                    <p>çˆ†å¼¾: Enter / Space / Y / 0</p>
                </div>
            </div>
            <div class="bg-slate-900 p-4 rounded-2xl border-l-4 border-blue-500">
                <div class="text-blue-400 font-bold mb-2 flex items-center gap-2">ğŸ“ å­¦ç¿’åŠ¹æœ</div>
                <div class="text-[11px] text-slate-300">
                    å…¨100å•ã®ã‚¯ã‚¤ã‚ºã‚’åéŒ²ã€‚<br>æ­£è§£ã™ã‚‹ã¨10ç§’é–“ã€ç‰¹æ®Šèƒ½åŠ›ï¼ˆã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ»ç«åŠ›ãƒ»è²«é€šï¼‰ãŒä»˜ä¸ã•ã‚Œã¾ã™ã€‚
                </div>
            </div>
        </div>

        <div class="flex flex-wrap gap-3 justify-center mb-6">
            <button onclick="startGame(2)" class="bg-blue-600 hover:bg-blue-700 px-8 py-5 rounded-2xl font-black transition flex-1 text-xl shadow-xl border-b-4 border-blue-900">2äººå¯¾æˆ¦</button>
            <button onclick="startGame(3)" class="bg-emerald-600 hover:bg-emerald-700 px-8 py-5 rounded-2xl font-black transition flex-1 text-xl shadow-xl border-b-4 border-emerald-900">3äººå¯¾æˆ¦</button>
            <button onclick="startGame(4)" class="bg-rose-600 hover:bg-rose-700 px-8 py-5 rounded-2xl font-black transition flex-1 text-xl shadow-xl border-b-4 border-rose-900">4äººå¯¾æˆ¦</button>
        </div>
        <p class="text-slate-500 text-xs mt-2">â€»çˆ†é¢¨ã«å½“ãŸã‚‹ã¨è„±è½ã€‚æœ€å¾Œã¾ã§æ®‹ã£ãŸäººãŒå‹è€…ï¼</p>
    </div>

    <!-- Status UI -->
    <div id="game-info" class="hidden flex gap-4 mb-3"></div>

    <!-- Canvas -->
    <div id="game-container" class="hidden">
        <canvas id="gameCanvas"></canvas>
    </div>

    <!-- Quiz Modal -->
    <div id="quiz-modal">
        <div id="quiz-player-tag" class="inline-block px-6 py-1.5 rounded-full text-sm font-black mb-4 uppercase tracking-tighter"></div>
        <div id="quiz-subject" class="text-cyan-400 font-bold text-xl mb-1">ç§‘ç›®</div>
        <div id="quiz-question" class="text-2xl font-bold text-white mb-8 px-4 leading-relaxed min-h-[4rem]">å•é¡Œæ–‡</div>
        <div id="quiz-choices" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8"></div>
        <div id="quiz-timer-container" class="w-full bg-slate-800 h-4 rounded-full overflow-hidden mb-2">
            <div id="quiz-timer-bar" class="bg-gradient-to-r from-rose-500 via-orange-400 to-yellow-400 h-full w-full transition-all duration-100 linear"></div>
        </div>
        <div id="quiz-timer-text" class="text-rose-500 font-mono font-black text-2xl">10.0s</div>
    </div>

    <!-- Game Over Overlay -->
    <div id="game-over" class="hidden absolute inset-0 bg-slate-950 bg-opacity-95 flex flex-col items-center justify-center z-50">
        <div class="text-slate-500 font-bold mb-4 tracking-[0.5em] uppercase">Victory Achieved</div>
        <h2 id="winner-text" class="text-8xl font-black text-yellow-400 mb-16 italic">PLAYER 1 WIN!</h2>
        <button onclick="location.reload()" class="bg-white text-black px-20 py-8 rounded-full font-black text-3xl hover:bg-yellow-400 transition transform hover:scale-110 shadow-2xl">å†æŒ‘æˆ¦</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const lobby = document.getElementById('lobby');
        const gameContainer = document.getElementById('game-container');
        const gameInfo = document.getElementById('game-info');
        const gameOverScreen = document.getElementById('game-over');
        const winnerText = document.getElementById('winner-text');
        const quizModal = document.getElementById('quiz-modal');
        const quizTimerBar = document.getElementById('quiz-timer-bar');

        const TILE_SIZE = 40;
        const GRID_WIDTH = 15;
        const GRID_HEIGHT = 13;
        const WALL = 1, BLOCK = 2, EMPTY = 0;

        let grid = [];
        let players = [];
        let bombs = [];
        let explosions = [];
        let items = [];
        let gameActive = false;
        let playerCount = 2;
        let currentQuiz = null;

        const COLORS = {
            P1: '#3b82f6', P2: '#ef4444', P3: '#10b981', P4: '#f59e0b',
            WALL: '#1e293b', BLOCK: '#4b5563', BOMB: '#020617', FIRE: '#f97316', ITEM: '#fbbf24'
        };

        const CONTROL_SCHEMES = [
            { up: 'w', left: 'a', down: 's', right: 'd', action: ' ' },
            { up: 'ArrowUp', left: 'ArrowLeft', down: 'ArrowDown', right: 'ArrowRight', action: 'Enter' },
            { up: 'u', left: 'h', down: 'j', right: 'k', action: 'y' },
            { up: '8', left: '4', down: '5', right: '6', action: '0' }
        ];

        // --- ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ (å…¨100å•) ---
        const QUIZ_BANK = [
            // ç®—æ•° (20)
            {s:"ç®—æ•°",q:"12 Ã— 12 = ?",c:["124","144","164","142"],a:1},
            {s:"ç®—æ•°",q:"åŠå¾„5cmã®å††ã®ç›´å¾„ã¯ï¼Ÿ",c:["5cm","10cm","15.7cm","25cm"],a:1},
            {s:"ç®—æ•°",q:"1kmã¯ä½•ãƒ¡ãƒ¼ãƒˆãƒ«ï¼Ÿ",c:["100m","1000m","10000m","10m"],a:1},
            {s:"ç®—æ•°",q:"25%ã‚’å°æ•°ã§è¡¨ã™ã¨ï¼Ÿ",c:["2.5","0.25","0.025","25"],a:1},
            {s:"ç®—æ•°",q:"2/5 + 1/5 = ?",c:["3/10","3/5","2/25","1/5"],a:1},
            {s:"ç®—æ•°",q:"å…­è§’å½¢ã®å†…è§’ã®å’Œã¯ï¼Ÿ",c:["360åº¦","540åº¦","720åº¦","900åº¦"],a:2},
            {s:"ç®—æ•°",q:"1æ™‚é–“ã¯ä½•ç§’ï¼Ÿ",c:["60ç§’","600ç§’","3600ç§’","360ç§’"],a:2},
            {s:"ç®—æ•°",q:"81ã®å¹³æ–¹æ ¹ã¯ï¼Ÿ",c:["7","8","9","10"],a:2},
            {s:"ç®—æ•°",q:"1ãƒ€ãƒ¼ã‚¹ã¯ä½•æœ¬ï¼Ÿ",c:["10æœ¬","12æœ¬","14æœ¬","24æœ¬"],a:1},
            {s:"ç®—æ•°",q:"æ­£ä¸‰è§’å½¢ã®1ã¤ã®è§’ã®å¤§ãã•ã¯ï¼Ÿ",c:["30åº¦","45åº¦","60åº¦","90åº¦"],a:2},
            {s:"ç®—æ•°",q:"3.14 Ã— 2 = ?",c:["6.24","6.28","6.42","6.18"],a:1},
            {s:"ç®—æ•°",q:"æœ€å°ã®ç´ æ•°ã¯ï¼Ÿ",c:["0","1","2","3"],a:2},
            {s:"ç®—æ•°",q:"1Lã¯ä½•mLï¼Ÿ",c:["100mL","500mL","1000mL","10000mL"],a:2},
            {s:"ç®—æ•°",q:"5ã®3ä¹—(5Ã—5Ã—5)ã¯ï¼Ÿ",c:["15","25","125","625"],a:2},
            {s:"ç®—æ•°",q:"å°å½¢ã®é¢ç©ã¯ï¼Ÿ",c:["åº•è¾ºÃ—é«˜","(ä¸Šåº•+ä¸‹åº•)Ã—é«˜Ã·2","åº•è¾ºÃ—é«˜Ã·2","è¾ºÃ—è¾º"],a:1},
            {s:"ç®—æ•°",q:"0.125ã‚’åˆ†æ•°ã«ã™ã‚‹ã¨ï¼Ÿ",c:["1/4","1/5","1/8","1/10"],a:2},
            {s:"ç®—æ•°",q:"40ã®30%ã¯ï¼Ÿ",c:["12","15","20","30"],a:0},
            {s:"ç®—æ•°",q:"ç›´è§’ä¸‰è§’å½¢ã§ä¸€ç•ªé•·ã„è¾ºã‚’ä½•ã¨ã„ã†ï¼Ÿ",c:["åº•è¾º","é«˜ã•","æ–œè¾º","å¯¾è§’ç·š"],a:2},
            {s:"ç®—æ•°",q:"2, 3, 5, 7, 11... æ¬¡ã®ç´ æ•°ã¯ï¼Ÿ",c:["12","13","15","17"],a:1},
            {s:"ç®—æ•°",q:"5è§’å½¢ã®å¯¾è§’ç·šã®æœ¬æ•°ã¯ï¼Ÿ",c:["2æœ¬","3æœ¬","5æœ¬","10æœ¬"],a:2},
            // å›½èª (20)
            {s:"å›½èª",q:"ã€Œæµ·å¥³ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ",c:["ã†ã¿ãŠã‚“ãª","ã‚ã¾","ã‹ã„ã˜ã‚‡","ã†ã¿ã‚"],a:1},
            {s:"å›½èª",q:"ã€Œææ†‚ã€ã®æ„å‘³ã¯ï¼Ÿ",c:["å–œã³","å–ã‚Šè¶Šã—è‹¦åŠ´","å‹‡æ°—","æ‚²ã—ã¿"],a:1},
            {s:"å›½èª",q:"ã€Œæ¡ˆãšã‚‹ã‚ˆã‚Šï¼ˆã€€ï¼‰ãŒæ˜“ã—ã€",c:["ç”Ÿã‚€","èã","è¡Œã","ç”£ã‚€"],a:3},
            {s:"å›½èª",q:"ã€Œæœˆä¸‹ï¼ˆã€€ï¼‰äººã€",c:["æ°·","é›ª","è¯","é¢¨"],a:0},
            {s:"å›½èª",q:"ã€Œæœªæ›¾æœ‰ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ",c:["ã¿ãã†","ã¿ãã†ã‚†ã†","ã¿ãã†ã„","ã¿ãã‚"],a:0},
            {s:"å›½èª",q:"ã€ŒãŠã‚‚ã‚€ã‚ã«ã€ã®æ„å‘³ã¯ï¼Ÿ",c:["çªç„¶ã«","ã‚†ã£ãã‚Šã¨","æ¿€ã—ã","å¯†ã‹ã«"],a:1},
            {s:"å›½èª",q:"ã€Œäº”æœˆé›¨ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ",c:["ã•ã¿ã ã‚Œ","ã”ãŒã¤ã‚ã‚","ã•ã¤ãã‚ã‚","ã•ã ã‚Œ"],a:0},
            {s:"å›½èª",q:"ã€Œå¿–åº¦ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ",c:["ã—ã‚…ã‚“ãŸã","ãã‚“ãŸã","ãµã‚“ãŸã","ã™ã‚“ãŸã"],a:1},
            {s:"å›½èª",q:"ã€Œï¼ˆã€€ï¼‰ã‚’æŠ˜ã‚‹ã€è‹¦åŠ´ã™ã‚‹ã“ã¨",c:["è…°","éª¨","æŒ‡","è†"],a:1},
            {s:"å›½èª",q:"ã€Œä¸€çŸ³ï¼ˆã€€ï¼‰é³¥ã€",c:["ä¸€","äºŒ","ä¸‰","å››"],a:1},
            {s:"å›½èª",q:"ã€Œæƒ…ã‘ã¯äººã®ï¼ˆã€€ï¼‰ãªã‚‰ãšã€",c:["ãŸã‚","ãŸã‚ã®ã¿","ãŸã‚ã«ãªã‚‰ã¬","ãŸã‚ã«ãªã‚‰ãªã„"],a:0},
            {s:"å›½èª",q:"ã€Œå¾¡ç”°ã€ã¨æ›¸ãé£Ÿã¹ç‰©ã¯ï¼Ÿ",c:["ãŠã«ãã‚Š","ãŠã§ã‚“","ãŠã‚‚ã¡","ãŠã™ã—"],a:1},
            {s:"å›½èª",q:"ã€ŒäºŒåæ­³ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ",c:["ã«ã˜ã‚…ã†ã•ã„","ã¯ãŸã¡","ã¯ãŸã—","ã«ã˜ã£ã•ã„"],a:1},
            {s:"å›½èª",q:"ã€Œå—šå’½ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ",c:["ã‚ãˆã¤","ãŠãˆã¤","ã‚ãˆã¤","ã¾ãˆã¤"],a:1},
            {s:"å›½èª",q:"ã€Œä»–å±±ã®çŸ³ã€ã®æ„å‘³ã¯ï¼Ÿ",c:["é–¢ä¿‚ãªã„ã“ã¨","åé¢æ•™å¸«ã«ã™ã‚‹ã“ã¨","é‚ªé­”ãªã‚‚ã®","çã—ã„çŸ³"],a:1},
            {s:"å›½èª",q:"ã€Œé£ŸæŒ‡ãŒï¼ˆã€€ï¼‰ã€èˆˆå‘³ãŒã‚ã",c:["ã®ã³ã‚‹","ã†ã”ã","ã™ã™ã‚€","ãŸã¤"],a:1},
            {s:"å›½èª",q:"ã€ŒçŸ¥é¢ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ",c:["ã¡ã‚ã‚“","ã—ã‚Šã‚ã„","ã¡ã‚ã‚“","ã—ã‚Šã‚ã‚“"],a:1},
            {s:"å›½èª",q:"ã€Œç™½é›¨ã€ã®èª­ã¿æ–¹ã¯ï¼Ÿ",c:["ã¯ãã†","ã—ã‚‰ã‚ã‚","ã«ã‚ã‹ã‚ã‚","ã—ã‚ã‚ã‚"],a:2},
            {s:"å›½èª",q:"ã€Œç ´ç«¹ã®å‹¢ã„ã€ã®ç«¹ã¯ã©ã†ãªã‚‹ï¼Ÿ",c:["æŠ˜ã‚Œã‚‹","å‰²ã‚Œã‚‹","æ¯ã‚Œã‚‹","ä¼¸ã³ã‚‹"],a:1},
            {s:"å›½èª",q:"ã€Œå¤ªå…¬æœ›ã€ã¨ã¯ä½•ã‚’ã™ã‚‹äººï¼Ÿ",c:["ç™»å±±","é‡£ã‚Š","èª­æ›¸","æ–™ç†"],a:1},
            // ç†ç§‘ (20)
            {s:"ç†ç§‘",q:"æœˆãŒåœ°çƒã‚’ä¸€å‘¨ã™ã‚‹ã®ã«ã‹ã‹ã‚‹æ™‚é–“ã¯ï¼Ÿ",c:["1æ—¥","1ãƒ¶æœˆ","1å¹´","1é€±é–“"],a:1},
            {s:"ç†ç§‘",q:"æ¤ç‰©ã®è‘‰ã«ã‚ã‚‹ç·‘è‰²ã®ç²’ã‚’ä½•ã¨ã„ã†ï¼Ÿ",c:["æ°—å­”","è‘‰ç·‘ä½“","ç´°èƒæ ¸","ç¶­ç®¡æŸ"],a:1},
            {s:"ç†ç§‘",q:"å…‰ã®ä¸‰åŸè‰²ã¯ï¼Ÿ",c:["èµ¤ãƒ»é’ãƒ»é»„","èµ¤ãƒ»ç·‘ãƒ»é’","é»„ãƒ»ç·‘ãƒ»ç´«","ç™½ãƒ»é»’ãƒ»èµ¤"],a:1},
            {s:"ç†ç§‘",q:"æ°´ã«æº¶ã‘ã¦ã„ã‚‹ç‰©è³ªã‚’å–ã‚Šå‡ºã™ã“ã¨ã‚’ï¼Ÿ",c:["æº¶è§£","å†çµæ™¶","å‡å›º","è’¸ç•™"],a:1},
            {s:"ç†ç§‘",q:"åœ°éœ‡ã®æºã‚Œã®å¤§ãã•ã‚’è¡¨ã™ã®ã¯ï¼Ÿ",c:["éœ‡åº¦","ãƒã‚°ãƒ‹ãƒãƒ¥ãƒ¼ãƒ‰","ãƒ‡ã‚·ãƒ™ãƒ«","ãƒ¡ãƒ¼ãƒˆãƒ«"],a:0},
            {s:"ç†ç§‘",q:"ç©ºæ°—ä¸­ã«ä¸€ç•ªå¤šã„æ°—ä½“ã¯ï¼Ÿ",c:["é…¸ç´ ","äºŒé…¸åŒ–ç‚­ç´ ","çª’ç´ ","ã‚¢ãƒ«ã‚´ãƒ³"],a:2},
            {s:"ç†ç§‘",q:"æ°´ã¯ä½•åº¦ã§æ²¸é¨°ã™ã‚‹ï¼Ÿ",c:["0åº¦","50åº¦","100åº¦","200åº¦"],a:2},
            {s:"ç†ç§‘",q:"ã‚¢ãƒªã®è¶³ã¯ä½•æœ¬ï¼Ÿ",c:["4æœ¬","6æœ¬","8æœ¬","10æœ¬"],a:1},
            {s:"ç†ç§‘",q:"å¤ªé™½ç³»ã§ä¸€ç•ªå¤§ããªæƒ‘æ˜Ÿã¯ï¼Ÿ",c:["åœ°çƒ","ç«æ˜Ÿ","æœ¨æ˜Ÿ","åœŸæ˜Ÿ"],a:2},
            {s:"ç†ç§‘",q:"éŸ³ã®ä¼ã‚ã‚‹é€Ÿã•ãŒä¸€ç•ªé€Ÿã„ã®ã¯ï¼Ÿ",c:["ç©ºæ°—ä¸­","æ°´ä¸­","é‰„ã®ä¸­","çœŸç©ºä¸­"],a:2},
            {s:"ç†ç§‘",q:"å…‰åˆæˆã§æ¤ç‰©ãŒå¸åã™ã‚‹æ°—ä½“ã¯ï¼Ÿ",c:["é…¸ç´ ","äºŒé…¸åŒ–ç‚­ç´ ","çª’ç´ ","æ°´ç´ "],a:1},
            {s:"ç†ç§‘",q:"äººã®ä½“æ¸©ã‚’èª¿ç¯€ã™ã‚‹ä¸­æ¢ã¯ã©ã“ï¼Ÿ",c:["å¿ƒè‡“","è‚º","è„³","èƒƒ"],a:2},
            {s:"ç†ç§‘",q:"åŒ—æ¥µæ˜ŸãŒå«ã¾ã‚Œã‚‹æ˜Ÿåº§ã¯ï¼Ÿ",c:["ãŠãŠãã¾åº§","ã“ãã¾åº§","ã‚«ã‚·ã‚ªãƒšãƒ¤åº§","ã‚ªãƒªã‚ªãƒ³åº§"],a:1},
            {s:"ç†ç§‘",q:"ã‚¸ãƒ£ã‚¬ã‚¤ãƒ¢ã®é£Ÿã¹ã¦ã„ã‚‹éƒ¨åˆ†ã¯ï¼Ÿ",c:["æ ¹","èŒ","å®Ÿ","è‘‰"],a:1},
            {s:"ç†ç§‘",q:"ç«æˆå²©ã®ã†ã¡ã€åœ°è¡¨è¿‘ãã§æ€¥ã«å†·ãˆãŸã®ã¯ï¼Ÿ",c:["æ·±æˆå²©","ç«å±±å²©","å †ç©å²©","å¤‰æˆå²©"],a:1},
            {s:"ç†ç§‘",q:"é…¸æ€§ã®æ¶²ä½“ã‚’èµ¤ãå¤‰ãˆã‚‹ã®ã¯ï¼Ÿ",c:["ãƒªãƒˆãƒã‚¹ç´™","BTBæº¶æ¶²","ãƒ•ã‚§ãƒãƒ¼ãƒ«ãƒ•ã‚¿ãƒ¬ã‚¤ãƒ³","ãƒ¡ãƒãƒ«ã‚ªãƒ¬ãƒ³ã‚¸"],a:0},
            {s:"ç†ç§‘",q:"ã§ã‚“ã·ã‚“ã‚’èª¿ã¹ã‚‹æ™‚ã«ä½¿ã†æ¶²ã¯ï¼Ÿ",c:["ãƒ™ãƒã‚¸ã‚¯ãƒˆæ¶²","ãƒ¨ã‚¦ç´ æ¶²","çŸ³ç°æ°´","é£Ÿå¡©æ°´"],a:1},
            {s:"ç†ç§‘",q:"ä¸€å††ç‰ã¯ä½•ã§ã§ãã¦ã„ã‚‹ï¼Ÿ",c:["é‰„","éŠ…","ã‚¢ãƒ«ãƒŸãƒ‹ã‚¦ãƒ ","é‡‘"],a:2},
            {s:"ç†ç§‘",q:"æ˜†è™«ã®å¿ƒè‡“ã¯ä½“ã®ã©ã“ã«ã‚ã‚‹ï¼Ÿ",c:["é ­","èƒ¸","èƒŒä¸­å´","ãŠè…¹å´"],a:2},
            {s:"ç†ç§‘",q:"é£½å’Œæ°´æº¶æ¶²ã®æ¸©åº¦ã‚’ä¸‹ã’ã¦çµæ™¶ã‚’å‡ºã™ã“ã¨ã‚’ï¼Ÿ",c:["å†çµæ™¶","ã‚é","è’¸ç•™","æ˜‡è¯"],a:0},
            // ç¤¾ä¼š (20)
            {s:"ç¤¾ä¼š",q:"æ—¥æœ¬ã§ä¸€ç•ªé•·ã„å·ã¯ï¼Ÿ",c:["åˆ©æ ¹å·","ä¿¡æ¿ƒå·","çŸ³ç‹©å·","æ·€å·"],a:1},
            {s:"ç¤¾ä¼š",q:"ã€Œé£éš‹ä½¿ã€ã‚’æ´¾é£ã—ãŸäººç‰©ã¯ï¼Ÿ",c:["è–å¾³å¤ªå­","ç¹”ç”°ä¿¡é•·","å‘å¼¥å‘¼","å¾³å·å®¶åº·"],a:0},
            {s:"ç¤¾ä¼š",q:"ä¸–ç•Œæœ€å¤§ã®å³¶ã¯ï¼Ÿ",c:["ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢","ã‚°ãƒªãƒ¼ãƒ³ãƒ©ãƒ³ãƒ‰","æœ¬å·","ãƒãƒ€ã‚¬ã‚¹ã‚«ãƒ«"],a:1},
            {s:"ç¤¾ä¼š",q:"æ—¥æœ¬ã®éƒ½é“åºœçœŒã®æ•°ã¯ï¼Ÿ",c:["43","45","47","50"],a:2},
            {s:"ç¤¾ä¼š",q:"é–¢ãƒ¶åŸã®æˆ¦ã„ãŒèµ·ããŸã®ã¯è¥¿æš¦ä½•å¹´ï¼Ÿ",c:["1560å¹´","1582å¹´","1600å¹´","1868å¹´"],a:2},
            {s:"ç¤¾ä¼š",q:"ä¸–ç•Œã§ä¸€ç•ªäººå£ãŒå¤šã„å›½ã¯ï¼Ÿ(2023å¹´) ",c:["ä¸­å›½","ã‚¤ãƒ³ãƒ‰","ã‚¢ãƒ¡ãƒªã‚«","ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢"],a:1},
            {s:"ç¤¾ä¼š",q:"æ—¥æœ¬ã®æ¨™æº–æ™‚ã‚’æ±ºã‚ã¦ã„ã‚‹éƒ½å¸‚ã¯ï¼Ÿ",c:["æ±äº¬","äº¬éƒ½","æ˜çŸ³","å¤§é˜ª"],a:2},
            {s:"ç¤¾ä¼š",q:"æ—¥æœ¬åˆã®å¾å¤·å¤§å°†è»ã¯ï¼Ÿ",c:["æºé ¼æœ","è¶³åˆ©å°Šæ°","å¾³å·å®¶åº·","å‚ä¸Šç”°æ‘éº»å‘‚"],a:3},
            {s:"ç¤¾ä¼š",q:"EUã®æœ¬éƒ¨ãŒã‚ã‚‹éƒ½å¸‚ã¯ï¼Ÿ",c:["ãƒ‘ãƒª","ãƒ­ãƒ³ãƒ‰ãƒ³","ãƒ–ãƒªãƒ¥ãƒƒã‚»ãƒ«","ãƒ™ãƒ«ãƒªãƒ³"],a:2},
            {s:"ç¤¾ä¼š",q:"æ—¥æœ¬æœ€å¤§ã®æ¹–ã¯ï¼Ÿ",c:["éœãƒ¶æµ¦","ä¸­æµ·","çµç¶æ¹–","ã‚µãƒ­ãƒæ¹–"],a:2},
            {s:"ç¤¾ä¼š",q:"1867å¹´ã«æ”¿æ¨©ã‚’æœå»·ã«è¿”ã—ãŸã“ã¨ã‚’ï¼Ÿ",c:["æ˜æ²»ç¶­æ–°","å¤§æ”¿å¥‰é‚„","ç‰ˆç±å¥‰é‚„","å»ƒè—©ç½®çœŒ"],a:1},
            {s:"ç¤¾ä¼š",q:"ã‚¢ãƒã‚¾ãƒ³å·ãŒã‚ã‚‹å¤§é™¸ã¯ï¼Ÿ",c:["ã‚¢ãƒ•ãƒªã‚«","å—ã‚¢ãƒ¡ãƒªã‚«","åŒ—ã‚¢ãƒ¡ãƒªã‚«","ã‚¢ã‚¸ã‚¢"],a:1},
            {s:"ç¤¾ä¼š",q:"è¡†è­°é™¢è­°å“¡ã®ä»»æœŸã¯ä½•å¹´ï¼Ÿ",c:["2å¹´","4å¹´","6å¹´","ãªã—"],a:1},
            {s:"ç¤¾ä¼š",q:"ã€Œé³´ã‹ã¬ãªã‚‰æ®ºã—ã¦ã—ã¾ãˆã€ã¨è¨€ã£ãŸã®ã¯ï¼Ÿ",c:["ä¿¡é•·","ç§€å‰","å®¶åº·","å…‰ç§€"],a:0},
            {s:"ç¤¾ä¼š",q:"æ—¥æœ¬æœ€å—ç«¯ã®å³¶ã¯ï¼Ÿ",c:["æ²–ãƒé³¥å³¶","å—é³¥å³¶","ä¸é‚£å›½å³¶","æŠæ‰å³¶"],a:0},
            {s:"ç¤¾ä¼š",q:"é‡‘é–£å¯ºã‚’å»ºã¦ãŸã®ã¯ï¼Ÿ",c:["è¶³åˆ©ç¾©æº€","è¶³åˆ©ç¾©æ”¿","è–æ­¦å¤©çš‡","è±Šè‡£ç§€å‰"],a:0},
            {s:"ç¤¾ä¼š",q:"ä¸‰å¤§éšç­†ã€Œæ•è‰å­ã€ã®ä½œè€…ã¯ï¼Ÿ",c:["ç´«å¼éƒ¨","æ¸…å°‘ç´è¨€","ç´€è²«ä¹‹","é´¨é•·æ˜"],a:1},
            {s:"ç¤¾ä¼š",q:"ãƒŠãƒãƒ¬ã‚ªãƒ³ãŒç”Ÿã¾ã‚ŒãŸå³¶ã¯ï¼Ÿ",c:["ã‚¨ãƒ«ãƒå³¶","ã‚³ãƒ«ã‚·ã‚«å³¶","ã‚»ãƒ³ãƒˆãƒ˜ãƒ¬ãƒŠå³¶","ã‚·ãƒãƒªã‚¢å³¶"],a:1},
            {s:"ç¤¾ä¼š",q:"ä¸–ç•Œã§ä¸€ç•ªé¢ç©ãŒåºƒã„å›½ã¯ï¼Ÿ",c:["ã‚«ãƒŠãƒ€","ãƒ­ã‚·ã‚¢","ã‚¢ãƒ¡ãƒªã‚«","ä¸­å›½"],a:1},
            {s:"ç¤¾ä¼š",q:"æ—¥æœ¬æœ€å¤ã®è²¨å¹£ã¨ã•ã‚Œã‚‹ã®ã¯ï¼Ÿ",c:["å’ŒåŒé–‹ç","å¯Œæœ¬éŠ­","å¯›æ°¸é€šå®","æ…¶é•·å°åˆ¤"],a:1},
            // è‹±èª (20)
            {s:"è‹±èª",q:"ã€Œæ°´æ›œæ—¥ã€ã‚’è‹±èªã§ï¼Ÿ",c:["Tuesday","Wednesday","Thursday","Friday"],a:1},
            {s:"è‹±èª",q:"ã€Œæ˜¨æ—¥ã€ã‚’è‹±èªã§ï¼Ÿ",c:["Today","Tomorrow","Yesterday","Tonight"],a:2},
            {s:"è‹±èª",q:"ã€Œ15ã€ã‚’è‹±èªã§ï¼Ÿ",c:["Fifty","Fifteen","Fiveteen","Fifth"],a:1},
            {s:"è‹±èª",q:"ã€Œã©ã“ï¼Ÿã€ã‚’èãè¨€è‘‰ã¯ï¼Ÿ",c:["When","Where","Who","What"],a:1},
            {s:"è‹±èª",q:"ã€ŒAppleã€ã®è¤‡æ•°å½¢ã¯ï¼Ÿ",c:["Apples","Applees","Applis","Appls"],a:0},
            {s:"è‹±èª",q:"ã€Œç¾å‘³ã—ã„ã€ã‚’è‹±èªã§ï¼Ÿ",c:["Delicious","Difficult","Dangerous","Different"],a:0},
            {s:"è‹±èª",q:"ã€Œå›³æ›¸é¤¨ã€ã¯è‹±èªã§ï¼Ÿ",c:["Hospital","Library","Station","Museum"],a:1},
            {s:"è‹±èª",q:"ã€Œç®¸ã€ã¯è‹±èªã§ï¼Ÿ",c:["Forks","Spoons","Chopsticks","Knives"],a:2},
            {s:"è‹±èª",q:"ã€Œæœé£Ÿã€ã¯è‹±èªã§ï¼Ÿ",c:["Lunch","Dinner","Breakfast","Snack"],a:2},
            {s:"è‹±èª",q:"ã€ŒI (  ) a student.ã€å…¥ã‚‹ã®ã¯ï¼Ÿ",c:["is","am","are","be"],a:1},
            {s:"è‹±èª",q:"ã€ŒBeautifulã€ã®åå¯¾èªã¯ï¼Ÿ",c:["Ugly","Pretty","Cute","Nice"],a:0},
            {s:"è‹±èª",q:"ã€Œç­†ç®±ã€ã¯è‹±èªã§ï¼Ÿ",c:["Notebook","Pencil case","Eraser","Ruler"],a:1},
            {s:"è‹±èª",q:"ã€Œ12æœˆã€ã¯è‹±èªã§ï¼Ÿ",c:["October","November","December","January"],a:2},
            {s:"è‹±èª",q:"ã€Œæ­©ãã€ã‚’è‹±èªã§ï¼Ÿ",c:["Run","Swim","Walk","Jump"],a:2},
            {s:"è‹±èª",q:"ã€ŒWe (  ) football.ã€å…¥ã‚‹ã®ã¯ï¼Ÿ",c:["play","plays","playing","to play"],a:0},
            {s:"è‹±èª",q:"ã€Œçœ¼é¡ã€ã¯è‹±èªã§ï¼Ÿ",c:["Cups","Glasses","Plates","Bottles"],a:1},
            {s:"è‹±èª",q:"ã€Œå¤ªé™½ã€ã¯è‹±èªã§ï¼Ÿ",c:["Moon","Star","Sun","Sky"],a:2},
            {s:"è‹±èª",q:"ã€ŒSorry.ã€ã©ã†ã„ã†æ™‚ã«ä½¿ã†ï¼Ÿ",c:["è¬ã‚‹æ™‚","è©±ã—ã‹ã‘ã‚‹æ™‚","åˆ¥ã‚Œã‚‹æ™‚","å–œã¶æ™‚"],a:1},
            {s:"è‹±èª",q:"ã€ŒAlwaysã€ã®æ„å‘³ã¯ï¼Ÿ",c:["æ™‚ã€…","ã‚ã£ãŸã«ãªã„","ã„ã¤ã‚‚","ãŸã¶ã‚“"],a:2},
            {s:"è‹±èª",q:"ã€Œç§‹ã€ã‚’è‹±èªã§ï¼Ÿ",c:["Spring","Summer","Autumn","Winter"],a:2}
        ];

        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            if(type === 'bomb'){
                osc.type = 'triangle'; osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(40, now + 0.3);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(); osc.stop(now + 0.3);
            } else if(type === 'explosion'){
                const noise = audioCtx.createBufferSource();
                const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.4, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1;
                noise.buffer = buffer;
                const filter = audioCtx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.setValueAtTime(400, now);
                noise.connect(filter);
                const g = audioCtx.createGain(); g.gain.setValueAtTime(0.3, now); g.gain.linearRampToValueAtTime(0, now + 0.4);
                filter.connect(g); g.connect(audioCtx.destination);
                noise.start();
            } else if(type === 'item'){
                osc.type = 'sine'; osc.frequency.setValueAtTime(900, now); osc.frequency.exponentialRampToValueAtTime(1800, now + 0.1);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(); osc.stop(now + 0.1);
            } else if(type === 'correct'){
                osc.type = 'sine'; osc.frequency.setValueAtTime(523, now); 
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(); osc.stop(now + 0.5);
                const osc2 = audioCtx.createOscillator(); osc2.connect(gain); osc2.type='sine';
                osc2.frequency.setValueAtTime(659, now+0.1); osc2.start(now+0.1); osc2.stop(now+0.5);
            } else if(type === 'wrong'){
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(110, now); osc.frequency.linearRampToValueAtTime(55, now+0.4);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.4);
                osc.start(); osc.stop(now + 0.4);
            }
        }

        class Player {
            constructor(id, x, y, color, controls) {
                this.id = id; this.gridX = x; this.gridY = y; this.color = color; this.controls = controls;
                this.alive = true; this.bombsMax = 1; this.bombsPlaced = 0;
                this.range = 2; this.speed = 4; this.isPiercing = false; this.isMaxFire = false;
                this.powerupTimers = { piercing: 0, maxFire: 0, speed: 0 };
                this.pixelX = x * TILE_SIZE; this.pixelY = y * TILE_SIZE;
                this.moving = false; this.dirX = 0; this.dirY = 0;
            }
            draw() {
                if (!this.alive) return;
                ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(this.pixelX + TILE_SIZE/2, this.pixelY + TILE_SIZE/2, TILE_SIZE/2 - 4, 0, Math.PI * 2); ctx.fill();
                if (this.isPiercing || this.isMaxFire || this.speed > 4) {
                    ctx.strokeStyle = 'white'; ctx.lineWidth = 3; ctx.stroke();
                }
                ctx.fillStyle = 'rgba(255,255,255,0.8)'; ctx.fillRect(this.pixelX + 12, this.pixelY + 12, 4, 4); ctx.fillRect(this.pixelX + 24, this.pixelY + 12, 4, 4);
                ctx.font = "bold 10px Arial"; ctx.fillStyle = "white"; ctx.textAlign = "center";
                ctx.fillText(`P${this.id}`, this.pixelX + TILE_SIZE/2, this.pixelY + 10);
            }
            update() {
                if (!this.alive || currentQuiz) return;
                Object.keys(this.powerupTimers).forEach(key => {
                    if (this.powerupTimers[key] > 0) {
                        this.powerupTimers[key]--;
                        if (this.powerupTimers[key] <= 0) {
                            if (key === 'piercing') this.isPiercing = false;
                            if (key === 'maxFire') this.isMaxFire = false;
                            if (key === 'speed') this.speed = 4;
                            updateUI();
                        }
                    }
                });
                if (this.pixelX % TILE_SIZE === 0 && this.pixelY % TILE_SIZE === 0) {
                    this.dirX = 0; this.dirY = 0;
                    if (keys[this.controls.up]) this.dirY = -1;
                    else if (keys[this.controls.down]) this.dirY = 1;
                    else if (keys[this.controls.left]) this.dirX = -1;
                    else if (keys[this.controls.right]) this.dirX = 1;
                    if (this.dirX !== 0 || this.dirY !== 0) {
                        if (canMoveTo(this.pixelX/TILE_SIZE + this.dirX, this.pixelY/TILE_SIZE + this.dirY)) this.moving = true;
                    }
                }
                if (this.moving) {
                    this.pixelX += this.dirX * this.speed; this.pixelY += this.dirY * this.speed;
                    if (this.pixelX % TILE_SIZE === 0 && this.pixelY % TILE_SIZE === 0) {
                        this.moving = false; this.checkItemCollision();
                    }
                }
            }
            checkItemCollision() {
                const gx = this.pixelX / TILE_SIZE, gy = this.pixelY / TILE_SIZE;
                const itemIdx = items.findIndex(it => it.x === gx && it.y === gy);
                if (itemIdx !== -1) { items.splice(itemIdx, 1); playSound('item'); startQuiz(this); }
            }
            placeBomb() {
                if (!this.alive || currentQuiz) return;
                const bx = Math.round(this.pixelX / TILE_SIZE), by = Math.round(this.pixelY / TILE_SIZE);
                if (this.bombsPlaced < this.bombsMax && !bombs.some(b => b.x === bx && b.y === by)) {
                    playSound('bomb');
                    bombs.push({ x: bx, y: by, timer: 120, range: this.isMaxFire ? 15 : this.range, owner: this, isPiercing: this.isPiercing });
                    this.bombsPlaced++;
                }
            }
        }

        const keys = {};
        window.addEventListener('keydown', e => { if(!currentQuiz) keys[e.key] = true; players.forEach(p => { if (e.key === p.controls.action) p.placeBomb(); }); });
        window.addEventListener('keyup', e => keys[e.key] = false);

        function canMoveTo(x, y) {
            return x >= 0 && y >= 0 && x < GRID_WIDTH && y < GRID_HEIGHT && grid[y][x] === EMPTY && !bombs.some(b => b.x === x && b.y === y);
        }

        function startQuiz(player) {
            const problem = QUIZ_BANK[Math.floor(Math.random() * QUIZ_BANK.length)];
            currentQuiz = { player, problem, timeLeft: 10.0 };
            
            quizModal.style.display = 'block';
            const tag = document.getElementById('quiz-player-tag');
            tag.innerText = `Player ${player.id}`;
            tag.style.backgroundColor = player.color;
            document.getElementById('quiz-subject').innerText = `ã€${problem.s}ã€‘`;
            document.getElementById('quiz-question').innerText = problem.q;
            
            const choicesDiv = document.getElementById('quiz-choices');
            choicesDiv.innerHTML = '';
            problem.c.forEach((choice, idx) => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.innerText = choice;
                btn.onclick = () => submitAnswer(idx);
                choicesDiv.appendChild(btn);
            });

            const timerUpdate = setInterval(() => {
                if (!currentQuiz) { clearInterval(timerUpdate); return; }
                currentQuiz.timeLeft -= 0.1;
                const percent = (currentQuiz.timeLeft / 10) * 100;
                quizTimerBar.style.width = `${percent}%`;
                document.getElementById('quiz-timer-text').innerText = `${Math.max(0, currentQuiz.timeLeft).toFixed(1)}s`;
                if (currentQuiz.timeLeft <= 0) { playSound('wrong'); endQuiz(false); clearInterval(timerUpdate); }
            }, 100);
        }

        function submitAnswer(idx) {
            if (idx === currentQuiz.problem.a) { playSound('correct'); endQuiz(true); }
            else { playSound('wrong'); endQuiz(false); }
        }

        function endQuiz(success) {
            if (success) applyPowerup(currentQuiz.player);
            currentQuiz = null; quizModal.style.display = 'none';
        }

        function applyPowerup(player) {
            const types = ['è²«é€šå¼¾', 'ç«åŠ›MAX', 'è¶…é«˜é€Ÿ', 'çˆ†å¼¾ï¼‹'];
            const choice = types[Math.floor(Math.random() * types.length)];
            if (choice === 'è²«é€šå¼¾') { player.isPiercing = true; player.powerupTimers.piercing = 600; }
            else if (choice === 'ç«åŠ›MAX') { player.isMaxFire = true; player.powerupTimers.maxFire = 600; }
            else if (choice === 'è¶…é«˜é€Ÿ') { player.speed = 8; player.powerupTimers.speed = 600; }
            else { player.bombsMax++; }
            updateUI();
            
            const msg = document.createElement('div');
            msg.className = "fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-5xl font-black text-white z-[200] animate-bounce text-center bg-black bg-opacity-80 p-10 rounded-3xl border-4 border-yellow-500 shadow-2xl";
            msg.innerHTML = `<span style="color:${player.color}">Player ${player.id}</span><br>èƒ½åŠ›è§£æ”¾ï¼<br><span class="text-yellow-400">${choice}</span>`;
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 1500);
        }

        function initMap() {
            grid = [];
            for (let y = 0; y < GRID_HEIGHT; y++) {
                grid[y] = [];
                for (let x = 0; x < GRID_WIDTH; x++) {
                    if (x === 0 || y === 0 || x === GRID_WIDTH-1 || y === GRID_HEIGHT-1 || (x%2===0 && y%2===0)) grid[y][x] = WALL;
                    else {
                        const isSafe = (x<=2 && y<=2) || (x>=GRID_WIDTH-3 && y<=2) || (x<=2 && y>=GRID_HEIGHT-3) || (x>=GRID_WIDTH-3 && y>=GRID_HEIGHT-3);
                        grid[y][x] = (!isSafe && Math.random() < 0.75) ? BLOCK : EMPTY;
                    }
                }
            }
            items = []; bombs = []; explosions = [];
        }

        function startGame(num) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            playerCount = num;
            lobby.classList.add('hidden'); gameContainer.classList.remove('hidden'); gameInfo.classList.remove('hidden');
            canvas.width = GRID_WIDTH * TILE_SIZE; canvas.height = GRID_HEIGHT * TILE_SIZE;
            initMap(); players = [];
            const starts = [{x:1,y:1}, {x:GRID_WIDTH-2,y:GRID_HEIGHT-2}, {x:GRID_WIDTH-2,y:1}, {x:1,y:GRID_HEIGHT-2}];
            for (let i = 0; i < playerCount; i++) players.push(new Player(i+1, starts[i].x, starts[i].y, Object.values(COLORS)[i], CONTROL_SCHEMES[i]));
            updateUI(); gameActive = true; requestAnimationFrame(gameLoop);
        }

        function updateUI() {
            gameInfo.innerHTML = players.map(p => `
                <div class="bg-slate-900 bg-opacity-90 p-3 rounded-2xl border-b-4 min-w-[100px] text-center shadow-lg transition-all" style="border-color: ${p.color}; opacity: ${p.alive?1:0.3}">
                    <div class="text-[10px] font-black uppercase tracking-widest text-slate-400">P${p.id}</div>
                    <div class="stat-badge my-1">${p.bombsMax} Bombs</div>
                    <div class="flex justify-center gap-1.5 mt-1 h-2">
                        ${p.powerupTimers.piercing>0?'<div class="w-2 h-2 rounded-full bg-white shadow-[0_0_8px_white]"></div>':''}
                        ${p.powerupTimers.maxFire>0?'<div class="w-2 h-2 rounded-full bg-orange-500 shadow-[0_0_8px_orange]"></div>':''}
                        ${p.powerupTimers.speed>0?'<div class="w-2 h-2 rounded-full bg-cyan-400 shadow-[0_0_8px_cyan]"></div>':''}
                    </div>
                </div>
            `).join('');
        }

        function gameLoop() {
            if (!gameActive) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let y = 0; y < GRID_HEIGHT; y++) {
                for (let x = 0; x < GRID_WIDTH; x++) {
                    if (grid[y][x] === WALL) {
                        ctx.fillStyle = COLORS.WALL; ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        ctx.strokeStyle = "#334155"; ctx.lineWidth = 1; ctx.strokeRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else if (grid[y][x] === BLOCK) { 
                        ctx.fillStyle = COLORS.BLOCK; ctx.fillRect(x*TILE_SIZE+2, y*TILE_SIZE+2, TILE_SIZE-4, TILE_SIZE-4);
                        ctx.fillStyle = "rgba(0,0,0,0.3)"; ctx.fillRect(x*TILE_SIZE+2, y*TILE_SIZE+TILE_SIZE-6, TILE_SIZE-4, 4);
                    }
                }
            }
            items.forEach(it => {
                const s = Math.sin(Date.now()*0.01)*4;
                ctx.fillStyle = COLORS.ITEM; ctx.beginPath(); ctx.arc(it.x*TILE_SIZE+TILE_SIZE/2, it.y*TILE_SIZE+TILE_SIZE/2, TILE_SIZE/3+s, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle="black"; ctx.font="bold 18px Arial"; ctx.textAlign="center"; ctx.fillText("?", it.x*TILE_SIZE+TILE_SIZE/2, it.y*TILE_SIZE+27);
            });
            for (let i = bombs.length-1; i >= 0; i--) {
                const b = bombs[i]; if (!currentQuiz) b.timer--;
                const pulse = Math.sin(b.timer*0.15)*4;
                ctx.fillStyle = COLORS.BOMB; ctx.beginPath(); ctx.arc(b.x*TILE_SIZE+TILE_SIZE/2, b.y*TILE_SIZE+TILE_SIZE/2, TILE_SIZE/2.5+pulse, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "rgba(255,255,255,0.4)"; ctx.beginPath(); ctx.arc(b.x*TILE_SIZE+TILE_SIZE/2-4, b.y*TILE_SIZE+TILE_SIZE/2-4, 4, 0, Math.PI*2); ctx.fill();
                if (b.timer <= 0) { explode(b); bombs.splice(i, 1); }
            }
            for (let i = explosions.length-1; i >= 0; i--) {
                const e = explosions[i]; if (!currentQuiz) e.timer--;
                ctx.fillStyle = COLORS.FIRE; ctx.globalAlpha = Math.min(1, e.timer/15); ctx.fillRect(e.x*TILE_SIZE, e.y*TILE_SIZE, TILE_SIZE, TILE_SIZE); ctx.globalAlpha = 1;
                players.forEach(p => { if (p.alive && Math.floor((p.pixelX+TILE_SIZE/2)/TILE_SIZE) === e.x && Math.floor((p.pixelY+TILE_SIZE/2)/TILE_SIZE) === e.y) { p.alive = false; playSound('wrong'); updateUI(); } });
                if (e.timer <= 0) explosions.splice(i, 1);
            }
            players.forEach(p => { p.update(); p.draw(); });
            checkGameOver(); requestAnimationFrame(gameLoop);
        }

        function explode(bomb) {
            bomb.owner.bombsPlaced--; playSound('explosion');
            [[0,0],[1,0],[-1,0],[0,1],[0,-1]].forEach(dir => {
                for (let r = (dir[0]===0&&dir[1]===0?0:1); r <= bomb.range; r++) {
                    const ex = bomb.x+dir[0]*r, ey = bomb.y+dir[1]*r;
                    if (ex<0||ex>=GRID_WIDTH||ey<0||ey>=GRID_HEIGHT||grid[ey][ex]===WALL) break;
                    explosions.push({ x: ex, y: ey, timer: 20 });
                    const itIdx = items.findIndex(it => it.x === ex && it.y === ey);
                    if (itIdx !== -1) items.splice(itIdx, 1);
                    if (grid[ey][ex] === BLOCK) {
                        grid[ey][ex] = EMPTY; if (Math.random() < 0.35) items.push({ x: ex, y: ey });
                        if (!bomb.isPiercing) break;
                    }
                    const otherBomb = bombs.find(b => b.x === ex && b.y === ey);
                    if (otherBomb) otherBomb.timer = Math.min(otherBomb.timer, 3);
                }
            });
        }

        function checkGameOver() {
            const alive = players.filter(p => p.alive);
            if (gameActive && alive.length <= (playerCount > 1 ? 1 : 0)) {
                gameActive = false;
                setTimeout(() => {
                    gameOverScreen.classList.remove('hidden');
                    winnerText.innerText = alive.length === 1 ? `PLAYER ${alive[0].id} WIN!` : (alive.length === 0 ? "DRAW!" : "BATTLE ENDED");
                    winnerText.style.color = alive.length === 1 ? alive[0].color : "white";
                }, 1000);
            }
        }
    </script>
</body>
</html>

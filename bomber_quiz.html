<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bomber Quiz Arena Gold</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #111;
            color: white;
            font-family: 'Hiragino Kaku Gothic Pro', 'Meiryo', sans-serif;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        #game-container {
            position: relative;
            box-shadow: 0 0 60px rgba(0,0,0,0.7);
            border: 4px solid #444;
            background-color: #1e3a1a;
        }
        canvas { display: block; }
        .ui-panel {
            background: rgba(15, 15, 15, 0.95);
            padding: 2rem;
            border-radius: 24px;
            text-align: center;
            max-width: 520px;
            border: 2px solid #555;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #quiz-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #0a0a0a;
            padding: 2rem;
            border: 4px solid #fbbf24;
            border-radius: 24px;
            z-index: 100;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 0 150px rgba(0,0,0,0.9);
        }
        .choice-btn {
            background: #222;
            border: 2px solid #444;
            padding: 1.2rem;
            border-radius: 12px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: bold;
            font-size: 1.1rem;
            width: 100%;
        }
        .choice-btn:hover { background: #333; border-color: #fbbf24; transform: translateY(-2px); }
        .choice-btn:active { transform: scale(0.96); }
    </style>
</head>
<body>

    <!-- Lobby UI -->
    <div id="lobby" class="ui-panel">
        <h1 class="text-4xl font-black mb-6 text-yellow-500 tracking-tighter italic drop-shadow-lg">BOMBER QUIZ ARENA GOLD</h1>
        
        <div class="grid grid-cols-2 gap-4 mb-8 text-sm text-left">
            <div class="bg-gray-900 p-3 rounded-xl border-l-4 border-yellow-500">
                <div class="text-yellow-400 font-bold mb-1 flex items-center gap-1">üéÆ „É´„Éº„É´</div>
                <ul class="text-gray-300 text-[11px] leading-relaxed">
                    <li>„ÉªÁàÜÂºæ„Åß„Éñ„É≠„ÉÉ„ÇØ„ÇíÂ£ä„Åõ</li>
                    <li>„Éª„ÄåÔºü„Äç„Å´Ëß¶„Çå„Å¶„ÇØ„Ç§„Ç∫ÈñãÂßã</li>
                    <li>„ÉªÊ≠£Ëß£„Åß10ÁßíÈñì„Çπ„Éº„Éë„ÉºÂåñÔºÅ</li>
                    <li>„ÉªÊúÄÂæå„Åæ„ÅßÁîü„ÅçÊÆã„Çå„Å∞ÂãùÂà©</li>
                </ul>
            </div>
            <div class="bg-gray-900 p-3 rounded-xl border-l-4 border-blue-500">
                <div class="text-blue-400 font-bold mb-1 flex items-center gap-1">üöÄ Â†±ÈÖ¨</div>
                <div class="flex flex-col gap-1 text-[10px] text-gray-300">
                    <span>üî• ÁÅ´ÂäõMAX: ÁàÜÈ¢®„ÅåÁ´Ø„Åæ„ÅßÂ±ä„Åè</span>
                    <span>‚ö° „Çπ„Éî„Éº„Éâ: ÁßªÂãïÈÄüÂ∫¶„ÅåÂ§ßÂπÖUP</span>
                    <span>üíé Ë≤´ÈÄö: „Éñ„É≠„ÉÉ„ÇØ„ÇíÊäú„Åë„ÇãÁÇé</span>
                    <span>üí£ ÁàÜÂºæ+: ÊúÄÂ§ßË®≠ÁΩÆÊï∞„ÅåUP(Ê∞∏Á∂ö)</span>
                </div>
            </div>
        </div>

        <div class="flex gap-3 justify-center mb-6">
            <button onclick="startGame(2)" class="bg-blue-600 hover:bg-blue-700 px-6 py-4 rounded-2xl font-bold transition flex-1 text-lg shadow-xl border-b-4 border-blue-800">2‰∫∫ÂØæÊà¶</button>
            <button onclick="startGame(3)" class="bg-green-600 hover:bg-green-700 px-6 py-4 rounded-2xl font-bold transition flex-1 text-lg shadow-xl border-b-4 border-green-800">3‰∫∫ÂØæÊà¶</button>
            <button onclick="startGame(4)" class="bg-red-600 hover:bg-red-700 px-6 py-4 rounded-2xl font-bold transition flex-1 text-lg shadow-xl border-b-4 border-red-800">4‰∫∫ÂØæÊà¶</button>
        </div>

        <div class="text-[10px] text-gray-500 flex justify-between px-2 font-mono">
            <span>P1:WASD/Space</span>
            <span>P2:Áü¢Âç∞/Enter</span>
            <span>P3:UHJK/Y</span>
            <span>P4:Num8456/0</span>
        </div>
    </div>

    <!-- Status UI -->
    <div id="game-info" class="hidden flex gap-3 mb-2"></div>

    <!-- Canvas -->
    <div id="game-container" class="hidden">
        <canvas id="gameCanvas"></canvas>
    </div>

    <!-- Quiz Modal -->
    <div id="quiz-modal">
        <div id="quiz-player-tag" class="inline-block px-5 py-1 rounded-full text-xs font-bold mb-3 uppercase tracking-widest shadow-lg"></div>
        <div id="quiz-subject" class="text-yellow-500 font-bold text-lg mb-1">ÁßëÁõÆ</div>
        <div id="quiz-question" class="text-2xl font-bold text-white mb-8 px-2 leading-tight">ÂïèÈ°åÊñá</div>
        <div id="quiz-choices" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8"></div>
        <div id="quiz-timer-container" class="w-full bg-gray-800 h-3 rounded-full overflow-hidden mb-1 border border-gray-700">
            <div id="quiz-timer-bar" class="bg-gradient-to-r from-red-600 to-yellow-500 h-full w-full transition-all duration-100 ease-linear"></div>
        </div>
        <div id="quiz-timer-text" class="text-red-500 font-mono font-black text-xl">10.0s</div>
    </div>

    <!-- Game Over Overlay -->
    <div id="game-over" class="hidden absolute inset-0 bg-black bg-opacity-95 flex flex-col items-center justify-center z-50">
        <div class="text-gray-500 font-bold mb-2 tracking-widest uppercase">Battle Result</div>
        <h2 id="winner-text" class="text-7xl font-black text-yellow-400 mb-12 drop-shadow-2xl">PLAYER 1 WIN!</h2>
        <button onclick="location.reload()" class="bg-yellow-500 text-black px-16 py-6 rounded-full font-black text-3xl hover:bg-white transition transform hover:scale-110 shadow-[0_0_30px_rgba(234,179,8,0.4)]">TITLE</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const lobby = document.getElementById('lobby');
        const gameContainer = document.getElementById('game-container');
        const gameInfo = document.getElementById('game-info');
        const gameOverScreen = document.getElementById('game-over');
        const winnerText = document.getElementById('winner-text');
        const quizModal = document.getElementById('quiz-modal');
        const quizTimerBar = document.getElementById('quiz-timer-bar');

        const TILE_SIZE = 40;
        const GRID_WIDTH = 15;
        const GRID_HEIGHT = 13;
        const WALL = 1, BLOCK = 2, EMPTY = 0;

        let grid = [];
        let players = [];
        let bombs = [];
        let explosions = [];
        let items = [];
        let gameActive = false;
        let playerCount = 2;
        let currentQuiz = null;

        const COLORS = {
            P1: '#3b82f6', P2: '#ef4444', P3: '#10b981', P4: '#f59e0b',
            WALL: '#374151', BLOCK: '#78350f', BOMB: '#111', FIRE: '#ea580c', ITEM: '#fde047'
        };

        const CONTROL_SCHEMES = [
            { up: 'w', left: 'a', down: 's', right: 'd', action: ' ' },
            { up: 'ArrowUp', left: 'ArrowLeft', down: 'ArrowDown', right: 'ArrowRight', action: 'Enter' },
            { up: 'u', left: 'h', down: 'j', right: 'k', action: 'y' },
            { up: '8', left: '4', down: '5', right: '6', action: '0' }
        ];

        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            if(type === 'bomb'){
                osc.type = 'triangle'; osc.frequency.setValueAtTime(160, now); osc.frequency.exponentialRampToValueAtTime(40, now + 0.3);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(); osc.stop(now + 0.3);
            } else if(type === 'explosion'){
                const noise = audioCtx.createBufferSource();
                const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.4, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1;
                noise.buffer = buffer;
                const filter = audioCtx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.setValueAtTime(500, now);
                noise.connect(filter);
                const g = audioCtx.createGain(); g.gain.setValueAtTime(0.4, now); g.gain.linearRampToValueAtTime(0, now + 0.4);
                filter.connect(g); g.connect(audioCtx.destination);
                noise.start();
            } else if(type === 'item'){
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(1600, now + 0.1);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(); osc.stop(now + 0.1);
            } else if(type === 'correct'){
                osc.type = 'sine'; osc.frequency.setValueAtTime(523, now); 
                gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(); osc.stop(now + 0.5);
                const osc2 = audioCtx.createOscillator(); osc2.connect(gain); osc2.type='sine';
                osc2.frequency.setValueAtTime(659, now+0.1); osc2.start(now+0.1); osc2.stop(now+0.5);
            } else if(type === 'wrong'){
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(40, now+0.4);
                gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.4);
                osc.start(); osc.stop(now + 0.4);
            }
        }

        class Player {
            constructor(id, x, y, color, controls) {
                this.id = id; this.gridX = x; this.gridY = y; this.color = color; this.controls = controls;
                this.alive = true; this.bombsMax = 1; this.bombsPlaced = 0;
                this.range = 2; this.speed = 4; this.isPiercing = false; this.isMaxFire = false;
                this.powerupTimers = { piercing: 0, maxFire: 0, speed: 0 };
                this.pixelX = x * TILE_SIZE; this.pixelY = y * TILE_SIZE;
                this.moving = false; this.dirX = 0; this.dirY = 0;
            }
            draw() {
                if (!this.alive) return;
                ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(this.pixelX + TILE_SIZE/2, this.pixelY + TILE_SIZE/2, TILE_SIZE/2 - 4, 0, Math.PI * 2); ctx.fill();
                if (this.isPiercing || this.isMaxFire || this.speed > 4) {
                    ctx.strokeStyle = 'white'; ctx.lineWidth = 3; ctx.stroke();
                }
                ctx.fillStyle = 'white'; ctx.fillRect(this.pixelX + 11, this.pixelY + 14, 5, 5); ctx.fillRect(this.pixelX + 24, this.pixelY + 14, 5, 5);
            }
            update() {
                if (!this.alive || currentQuiz) return;
                Object.keys(this.powerupTimers).forEach(key => {
                    if (this.powerupTimers[key] > 0) {
                        this.powerupTimers[key]--;
                        if (this.powerupTimers[key] <= 0) {
                            if (key === 'piercing') this.isPiercing = false;
                            if (key === 'maxFire') this.isMaxFire = false;
                            if (key === 'speed') this.speed = 4;
                            updateUI();
                        }
                    }
                });
                if (this.pixelX % TILE_SIZE === 0 && this.pixelY % TILE_SIZE === 0) {
                    this.dirX = 0; this.dirY = 0;
                    if (keys[this.controls.up]) this.dirY = -1;
                    else if (keys[this.controls.down]) this.dirY = 1;
                    else if (keys[this.controls.left]) this.dirX = -1;
                    else if (keys[this.controls.right]) this.dirX = 1;
                    if (this.dirX !== 0 || this.dirY !== 0) {
                        if (canMoveTo(this.pixelX/TILE_SIZE + this.dirX, this.pixelY/TILE_SIZE + this.dirY)) this.moving = true;
                    }
                }
                if (this.moving) {
                    this.pixelX += this.dirX * this.speed; this.pixelY += this.dirY * this.speed;
                    if (this.pixelX % TILE_SIZE === 0 && this.pixelY % TILE_SIZE === 0) {
                        this.moving = false; this.checkItemCollision();
                    }
                }
            }
            checkItemCollision() {
                const gx = this.pixelX / TILE_SIZE, gy = this.pixelY / TILE_SIZE;
                const itemIdx = items.findIndex(it => it.x === gx && it.y === gy);
                if (itemIdx !== -1) { items.splice(itemIdx, 1); playSound('item'); startQuiz(this); }
            }
            placeBomb() {
                if (!this.alive || currentQuiz) return;
                const bx = Math.round(this.pixelX / TILE_SIZE), by = Math.round(this.pixelY / TILE_SIZE);
                if (this.bombsPlaced < this.bombsMax && !bombs.some(b => b.x === bx && b.y === by)) {
                    playSound('bomb');
                    bombs.push({ x: bx, y: by, timer: 120, range: this.isMaxFire ? 20 : this.range, owner: this, isPiercing: this.isPiercing });
                    this.bombsPlaced++;
                }
            }
        }

        const keys = {};
        window.addEventListener('keydown', e => { if(!currentQuiz) keys[e.key] = true; players.forEach(p => { if (e.key === p.controls.action) p.placeBomb(); }); });
        window.addEventListener('keyup', e => keys[e.key] = false);

        function canMoveTo(x, y) {
            return x >= 0 && y >= 0 && x < GRID_WIDTH && y < GRID_HEIGHT && grid[y][x] === EMPTY && !bombs.some(b => b.x === x && b.y === y);
        }

        // --- EXTENDED QUIZ DATABASE (60 QUESTIONS) ---
        const QUIZ_BANK = [
            // ÁÆóÊï∞
            { s: "ÁÆóÊï∞", q: "12 √ó 12 „ÅØÔºü", c: ["124", "144", "164", "142"], a: 1 },
            { s: "ÁÆóÊï∞", q: "ÂçäÂæÑ 5cm „ÅÆÂÜÜ„ÅÆÁõ¥ÂæÑ„ÅØÔºü", c: ["5cm", "10cm", "15.7cm", "25cm"], a: 1 },
            { s: "ÁÆóÊï∞", q: "1km „ÅØ‰Ωï„É°„Éº„Éà„É´Ôºü", c: ["100m", "1000m", "10000m", "10m"], a: 1 },
            { s: "ÁÆóÊï∞", q: "25% „ÇíÂ∞èÊï∞„ÅßË°®„Åô„Å®Ôºü", c: ["2.5", "0.25", "0.025", "25"], a: 1 },
            { s: "ÁÆóÊï∞", q: "2/5 + 1/5 „ÅØÔºü", c: ["3/10", "3/5", "2/25", "1/5"], a: 1 },
            { s: "ÁÆóÊï∞", q: "ÂÖ≠ËßíÂΩ¢„ÅÆÂÜÖËßí„ÅÆÂíå„ÅØÔºü", c: ["360Â∫¶", "540Â∫¶", "720Â∫¶", "900Â∫¶"], a: 2 },
            { s: "ÁÆóÊï∞", q: "1ÊôÇÈñì„ÅØ‰ΩïÁßíÔºü", c: ["60Áßí", "600Áßí", "3600Áßí", "360Áßí"], a: 2 },
            { s: "ÁÆóÊï∞", q: "81 „ÅÆÂπ≥ÊñπÊ†πÔºà2‰πó„Åó„Å¶81„Å´„Å™„ÇãÊï∞Ôºâ„ÅØÔºü", c: ["7", "8", "9", "10"], a: 2 },
            { s: "ÁÆóÊï∞", q: "Âπ≥Âùá 80ÁÇπ„ÅÆ„ÉÜ„Çπ„Éà„Çí3ÂõûÂèó„Åë„ÅüÊôÇ„ÅÆÂêàË®àÁÇπ„ÅØÔºü", c: ["160ÁÇπ", "240ÁÇπ", "320ÁÇπ", "80ÁÇπ"], a: 1 },
            { s: "ÁÆóÊï∞", q: "0.5L „ÅÆ„Ç∏„É•„Éº„Çπ„Çí3Êú¨Ë≤∑„ÅÜ„Å®ÂÖ®ÈÉ®„Åß‰ΩïmLÔºü", c: ["150mL", "1500mL", "15000mL", "1.5mL"], a: 1 },
            { s: "ÁÆóÊï∞", q: "Âπ≥Ë°åÂõõËæ∫ÂΩ¢„ÅÆÈù¢Á©ç„ÅÆÊ±Ç„ÇÅÊñπ„ÅØÔºü", c: ["Â∫ïËæ∫√óÈ´ò„Åï", "Â∫ïËæ∫√óÈ´ò„Åï√∑2", "(‰∏äÂ∫ï+‰∏ãÂ∫ï)√óÈ´ò„Åï√∑2", "Ëæ∫√óËæ∫"], a: 0 },
            { s: "ÁÆóÊï∞", q: "ÂÅ∂Êï∞„Å®Â•áÊï∞„Çí„Åü„Åô„Å®Á≠î„Åà„ÅØÂøÖ„Åö‰Ωï„Å´„Å™„ÇãÔºü", c: ["ÂÅ∂Êï∞", "Â•áÊï∞", "0", "Ê±∫„Åæ„Å£„Å¶„ÅÑ„Å™„ÅÑ"], a: 1 },
            // ÂõΩË™û
            { s: "ÂõΩË™û", q: "„ÄåÊµ∑Â•≥„Äç„ÅÆË™≠„ÅøÊñπ„ÅØÔºü", c: ["„ÅÜ„Åø„Åä„Çì„Å™", "„ÅÇ„Åæ", "„Åã„ÅÑ„Åò„Çá", "„ÅÜ„Åø„ÇÅ"], a: 1 },
            { s: "ÂõΩË™û", q: "„ÄåÊùûÊÜÇ„Äç„ÅÆÊÑèÂë≥„ÅØÔºü", c: ["Âñú„Å≥", "Âèñ„ÇäË∂ä„ÅóËã¶Âä¥", "ÂãáÊ∞ó", "ÊÇ≤„Åó„Åø"], a: 1 },
            { s: "ÂõΩË™û", q: "„ÄåÊ°à„Åö„Çã„Çà„ÇäÔºà„ÄÄÔºâ„ÅåÊòì„Åó„Äç", c: ["Áîü„ÇÄ", "ËÅû„Åè", "Ë°å„Åè", "Áî£„ÇÄ"], a: 3 },
            { s: "ÂõΩË™û", q: "„Äå‰∏ÄÁü≥Ôºà„ÄÄÔºâÈ≥•„Äç", c: ["‰∏Ä", "‰∫å", "‰∏â", "Âõõ"], a: 1 },
            { s: "ÂõΩË™û", q: "„ÄåÊúà‰∏ãÔºà„ÄÄÔºâ‰∫∫„Äç", c: ["Ê∞∑", "Èõ™", "ËèØ", "È¢®"], a: 0 },
            { s: "ÂõΩË™û", q: "Ê¨°„ÅÆ„ÅÜ„Å°ÂãïË©û„ÅØ„Å©„ÇåÔºü", c: ["ÈÄü„ÅÑ", "Èùô„Åã„Å†", "Ëµ∞„Çã", "„Å®„Å¶„ÇÇ"], a: 2 },
            { s: "ÂõΩË™û", q: "„Äå‰ºØÁà∂„Äç„ÅØË™∞„ÅÆ„Åì„Å®Ôºü", c: ["„Åä„Åò„ÅÑ„Åï„Çì", "Áà∂„ÅÆÂÖÑ", "Áà∂„ÅÆÂºü", "„ÅÑ„Å®„Åì"], a: 1 },
            { s: "ÂõΩË™û", q: "„ÄåÊú™ÊõæÊúâ„Äç„ÅÆË™≠„ÅøÊñπ„ÅØÔºü", c: ["„Åø„Åû„ÅÜ", "„Åø„Åû„ÅÜ„ÇÜ„ÅÜ", "„Åø„Åû„ÅÜ„ÅÑ", "„Åø„Åù„ÅÇ"], a: 1 },
            { s: "ÂõΩË™û", q: "„Äå„Åä„ÇÇ„ÇÄ„Çç„Å´„Äç„ÅÆÊ≠£„Åó„ÅÑÊÑèÂë≥„ÅØÔºü", c: ["Á™ÅÁÑ∂„Å´", "„ÇÜ„Å£„Åè„Çä„Å®", "ÊøÄ„Åó„Åè", "ÂØÜ„Åã„Å´"], a: 1 },
            { s: "ÂõΩË™û", q: "„ÄåËõáË∂≥„Äç„ÅÆÁî±Êù•„Å®„Å™„Å£„ÅüÁîü„ÅçÁâ©„ÅØÔºü", c: ["„Ç´„Ç®„É´", "„Éò„Éì", "„Éà„Ç´„Ç≤", "„É†„Ç´„Éá"], a: 1 },
            { s: "ÂõΩË™û", q: "„ÄåÂøñÂ∫¶„Äç„ÅÆË™≠„ÅøÊñπ„ÅØÔºü", c: ["„Åó„ÇÖ„Çì„Åü„Åè", "„Åù„Çì„Åü„Åè", "„Åµ„Çì„Åü„Åè", "„Åô„Çì„Åü„Åè"], a: 1 },
            { s: "ÂõΩË™û", q: "„ÄåÈõ®Èôç„Å£„Å¶Âú∞Ôºà„ÄÄÔºâ„Åæ„Çã„Äç", c: ["Âõ∫„Åæ„Çã", "Âüã„Åæ„Çã", "Âº±„Åæ„Çã", "ÂÜ∑„ÇÅ„Çã"], a: 0 },
            // ÁêÜÁßë
            { s: "ÁêÜÁßë", q: "Êúà„ÅåÂú∞ÁêÉ„ÅÆÂë®„Çä„Çí‰∏ÄÂë®„Åô„Çã„ÅÆ„Å´„Åã„Åã„ÇãÊôÇÈñì„ÅØÔºü", c: ["Á¥Ñ1Êó•", "Á¥Ñ1„É∂Êúà", "Á¥Ñ1Âπ¥", "Á¥Ñ1ÈÄ±Èñì"], a: 1 },
            { s: "ÁêÜÁßë", q: "Ê§çÁâ©„ÅÆËëâ„Å´„ÅÇ„ÇãÁ∑ëËâ≤„ÅÆÁ≤í„Çí‰Ωï„Å®„ÅÑ„ÅÜÔºü", c: ["Ê∞óÂ≠î", "ËëâÁ∑ë‰Ωì", "Á¥∞ËÉûÊ†∏", "Á∂≠ÁÆ°Êùü"], a: 1 },
            { s: "ÁêÜÁßë", q: "ÈÖ∏ÊÄß„ÅÆÊ∂≤‰Ωì„ÇíÈùíËâ≤„É™„Éà„Éû„ÇπÁ¥ô„Å´„Å§„Åë„Çã„Å®Ôºü", c: ["Èùí„ÅÆ„Åæ„Åæ", "Ëµ§„Åè„Å™„Çã", "ÈªÑËâ≤„Å´„Å™„Çã", "Ê∂à„Åà„Çã"], a: 1 },
            { s: "ÁêÜÁßë", q: "ÂÖâ„ÅÆ‰∏âÂéüËâ≤„ÅØÔºü", c: ["Ëµ§„ÉªÈùí„ÉªÈªÑ", "Ëµ§„ÉªÁ∑ë„ÉªÈùí", "ÈªÑ„ÉªÁ∑ë„ÉªÁ¥´", "ÁôΩ„ÉªÈªí„ÉªËµ§"], a: 1 },
            { s: "ÁêÜÁßë", q: "ÊòÜËô´„ÅÆ‰Ωì„ÅØ„ÄåÈ†≠ÈÉ®„Äç„ÄåËÖπÈÉ®„Äç„Å®„ÇÇ„ÅÜ‰∏Ä„Å§„ÅØ‰ΩïÔºü", c: ["ËÉåÈÉ®", "ËÉ∏ÈÉ®", "Ë∂≥ÈÉ®", "ÁøºÈÉ®"], a: 1 },
            { s: "ÁêÜÁßë", q: "Ê∞¥„Å´Ê∫∂„Åë„Å¶„ÅÑ„ÇãÁâ©Ë≥™„ÇíÂèñ„ÇäÂá∫„Åô„Åì„Å®„ÇíÔºü", c: ["Ê∫∂Ëß£", "ÂÜçÁµêÊô∂", "ÂáùÂõ∫", "Ëí∏Áïô"], a: 1 },
            { s: "ÁêÜÁßë", q: "‰∫∫„ÅÆËÑàÊãç„ÇíÊ∏¨„ÇãÂ†¥ÊâÄ„Å®„Åó„Å¶Ê≠£„Åó„ÅÑ„ÅÆ„ÅØÔºü", c: ["ÊâãÈ¶ñ", "Êâã„ÅÆÁî≤", "ËÇ©", "„Å≤„Åò"], a: 0 },
            { s: "ÁêÜÁßë", q: "Èõ≤„ÅØ‰Ωï„Åã„Çâ„Åß„Åç„Å¶„ÅÑ„ÇãÔºü", c: ["Á©∫Ê∞ó", "Ê∞¥Êª¥„ÇÑÊ∞∑„ÅÆÁ≤í", "ÁÖô", "Á∂ø"], a: 1 },
            { s: "ÁêÜÁßë", q: "„É°„ÉÄ„Ç´„ÅÆ„Ç™„Çπ„Å®„É°„Çπ„ÅÆË¶ãÂàÜ„ÅëÊñπ„Åß„ÄÅËÉå„Å≥„Çå„Å´Âàá„ÇåËæº„Åø„Åå„ÅÇ„Çã„ÅÆ„ÅØÔºü", c: ["„Ç™„Çπ", "„É°„Çπ", "‰∏°Êñπ", "„ÅÑ„Å™„ÅÑ"], a: 0 },
            { s: "ÁêÜÁßë", q: "Âú∞Èúá„ÅÆÊè∫„Çå„ÅÆÂ§ß„Åç„Åï„ÇíË°®„ÅôÂ∞∫Â∫¶„ÅØÔºü", c: ["ÈúáÂ∫¶", "„Éû„Ç∞„Éã„ÉÅ„É•„Éº„Éâ", "„Éá„Ç∑„Éô„É´", "„É°„Éº„Éà„É´"], a: 0 },
            { s: "ÁêÜÁßë", q: "Â§è„ÅÆÂ§úÁ©∫„Å´Ë¶ã„Åà„Çã„ÄåÂ§è„ÅÆÂ§ß‰∏âËßí„Äç„Å´Âê´„Åæ„Çå„Å™„ÅÑÊòü„ÅØÔºü", c: ["„Éô„Ç¨", "„Ç¢„É´„Çø„Ç§„É´", "„Éá„Éç„Éñ", "„Ç∑„É™„Ç¶„Çπ"], a: 3 },
            { s: "ÁêÜÁßë", q: "Èü≥„ÅÆ‰ºù„Çè„ÇäÊñπ„Åå‰∏ÄÁï™ÈÄü„ÅÑ„ÅÆ„ÅØÔºü", c: ["Á©∫Ê∞ó‰∏≠", "Ê∞¥‰∏≠", "ÈâÑ„ÅÆ‰∏≠", "ÁúüÁ©∫‰∏≠"], a: 2 },
            // Á§æ‰ºö
            { s: "Á§æ‰ºö", q: "Êó•Êú¨„Åß‰∏ÄÁï™Èï∑„ÅÑÂ∑ù„ÅØÔºü", c: ["Âà©Ê†πÂ∑ù", "‰ø°ÊøÉÂ∑ù", "Áü≥Áã©Â∑ù", "Ê∑ÄÂ∑ù"], a: 1 },
            { s: "Á§æ‰ºö", q: "„ÄåËÅñÂæ≥Â§™Â≠ê„Äç„ÅåÊ¥æÈÅ£„Åó„Åü‰ΩøÁØÄ„ÅØÔºü", c: ["ÈÅ£Âîê‰Ωø", "ÈÅ£Èöã‰Ωø", "ÈÅ£Êòé‰Ωø", "ÊúùÈÆÆÈÄö‰ø°‰Ωø"], a: 1 },
            { s: "Á§æ‰ºö", q: "‰∏ñÁïåÊúÄÂ§ß„ÅÆÂ≥∂„ÅØÔºü", c: ["„Ç™„Éº„Çπ„Éà„É©„É™„Ç¢", "„Ç∞„É™„Éº„É≥„É©„É≥„Éâ", "Êú¨Â∑û", "„Éû„ÉÄ„Ç¨„Çπ„Ç´„É´"], a: 1 },
            { s: "Á§æ‰ºö", q: "Êó•Êú¨„ÅÆË°ÜË≠∞Èô¢Ë≠∞Âì°„ÅÆ‰ªªÊúü„ÅØ‰ΩïÂπ¥Ôºü", c: ["2Âπ¥", "4Âπ¥", "6Âπ¥", "ÁÑ°Âà∂Èôê"], a: 1 },
            { s: "Á§æ‰ºö", q: "„ÄåÁπîÁî∞‰ø°Èï∑„Äç„ÇíÂÄí„Åó„ÅüÊ≠¶Â∞Ü„ÅØÔºü", c: ["ÊòéÊô∫ÂÖâÁßÄ", "Ë±äËá£ÁßÄÂêâ", "Âæ≥Â∑ùÂÆ∂Â∫∑", "‰∏äÊùâË¨ô‰ø°"], a: 0 },
            { s: "Á§æ‰ºö", q: "Êó•Êú¨„ÅÆÊ®ôÊ∫ñÊôÇÂ≠êÂçàÁ∑ö„ÅåÈÄö„ÇãÂ∏Ç„ÅØÔºü", c: ["ÊòéÁü≥Â∏Ç", "‰∫¨ÈÉΩÂ∏Ç", "Êù±‰∫¨ÈÉΩ", "Â∫ÉÂ≥∂Â∏Ç"], a: 0 },
            { s: "Á§æ‰ºö", q: "„Çµ„Ç¶„Ç∏„Ç¢„É©„Éì„Ç¢„Å™„Å©„ÅÆÂõΩ„ÅåÂ§ö„ÅÑÂú∞Âüü„ÅØÔºü", c: ["Êù±Âçó„Ç¢„Ç∏„Ç¢", "‰∏≠ËøëÊù±", "‰∏≠Â§Æ„Ç¢„Ç∏„Ç¢", "Âåó„Ç¢„Éï„É™„Ç´"], a: 1 },
            { s: "Á§æ‰ºö", q: "Êó•Êú¨„ÅÆÊúÄÈ´òË£ÅÂà§ÊâÄ„Åå„ÅÇ„Çã„ÅÆ„ÅØ„Å©„ÅìÔºü", c: ["Â§ßÈò™", "Êù±‰∫¨", "‰∫¨ÈÉΩ", "Êú≠Âπå"], a: 1 },
            { s: "Á§æ‰ºö", q: "1945Âπ¥„Å´ÁµÇ„Çè„Å£„ÅüÊà¶‰∫â„ÅØÔºü", c: ["Êó•Ê∏ÖÊà¶‰∫â", "Êó•Èú≤Êà¶‰∫â", "Á¨¨‰∫åÊ¨°‰∏ñÁïåÂ§ßÊà¶", "„Éô„Éà„Éä„É†Êà¶‰∫â"], a: 2 },
            { s: "Á§æ‰ºö", q: "Êó•Êú¨„ÅÆÈÉΩÈÅìÂ∫úÁúå„ÅÆÊï∞„ÅØÔºü", c: ["43", "45", "47", "50"], a: 2 },
            { s: "Á§æ‰ºö", q: "Â∑•Ê•≠Âú∞Â∏Ø„Åß„ÄÅÊÑõÁü•Áúå„Çí‰∏≠ÂøÉ„Å®„Åô„Çã„ÅÆ„ÅØÔºü", c: ["‰∫¨Êµú", "Èò™Á•û", "‰∏≠‰∫¨", "ÁÄ¨Êà∏ÂÜÖ"], a: 2 },
            { s: "Á§æ‰ºö", q: "‰∏ñÁïå‰øùÂÅ•Ê©üÈñ¢„ÅÆÁï•Áß∞„ÅØÔºü", c: ["UNESCO", "WHO", "UNICEF", "NATO"], a: 1 },
            // Ëã±Ë™û
            { s: "Ëã±Ë™û", q: "„ÄåÊ∞¥ÊõúÊó•„Äç„ÅØËã±Ë™û„ÅßÔºü", c: ["Tuesday", "Wednesday", "Thursday", "Saturday"], a: 1 },
            { s: "Ëã±Ë™û", q: "„ÄåKitchen„Äç„ÅØ„Å©„ÅìÔºü", c: ["ÂØùÂÆ§", "Âè∞ÊâÄ", "Êµ¥ÂÆ§", "Â∫≠"], a: 1 },
            { s: "Ëã±Ë™û", q: "„ÄåI have a pen.„Äç„ÅÆÂê¶ÂÆöÊñá„ÅØÔºü", c: ["I no have a pen.", "I don't have a pen.", "I not have a pen.", "I have no a pen."], a: 1 },
            { s: "Ëã±Ë™û", q: "„ÄåYesterday„Äç„ÅÆÊÑèÂë≥„ÅØÔºü", c: ["‰ªäÊó•", "ÊòéÊó•", "Êò®Êó•", "ÂÖàÈÄ±"], a: 2 },
            { s: "Ëã±Ë™û", q: "„ÄåOrange„Äç„ÅÆË§áÊï∞„ÅØÔºü", c: ["Oranges", "Orangees", "Orangis", "Orangies"], a: 0 },
            { s: "Ëã±Ë™û", q: "„ÄåÁæéÂë≥„Åó„ÅÑ„Äç„ÇíËã±Ë™û„ÅßÔºü", c: ["Delicious", "Difficult", "Dangerous", "Different"], a: 0 },
            { s: "Ëã±Ë™û", q: "„Äå15„Äç„ÇíËã±Ë™û„ÅßÊõ∏„Åè„Å®Ôºü", c: ["Fifty", "Fifteen", "Fiveteen", "Fifth"], a: 1 },
            { s: "Ëã±Ë™û", q: "„ÄåÁßÅ„ÅØÈáéÁêÉ„ÅåÂ•Ω„Åç„Åß„Åô„Äç„ÅØÔºü", c: ["I like baseball.", "I likes baseball.", "I am like baseball.", "I baseball like."], a: 0 },
            { s: "Ëã±Ë™û", q: "„ÄåÊò•„Äç„ÅØËã±Ë™û„ÅßÔºü", c: ["Summer", "Autumn", "Winter", "Spring"], a: 3 },
            { s: "Ëã±Ë™û", q: "„ÄåWhere is it?„Äç„ÅÆÊÑèÂë≥„ÅØÔºü", c: ["„Åù„Çå„ÅØ‰ΩïÔºü", "„Åù„Çå„ÅØ„Å©„ÅìÔºü", "„Åù„Çå„ÅØË™∞„ÅÆÔºü", "„Åù„Çå„ÅØ„ÅÑ„Å§Ôºü"], a: 1 },
            { s: "Ëã±Ë™û", q: "„Äå„Åï„Çà„ÅÜ„Å™„Çâ„Äç„ÅÆÂà•„ÅÆË®Ä„ÅÑÊñπ„ÅØÔºü", c: ["See you.", "Nice to meet you.", "Pardon?", "Exactly."], a: 0 },
            { s: "Ëã±Ë™û", q: "„ÄåExcuse me.„Äç„ÅØ„Å©„ÅÜ„ÅÑ„ÅÜÊôÇ„Å´‰Ωø„ÅÜÔºü", c: ["Ë¨ù„ÇãÊôÇ", "Ë©±„Åó„Åã„Åë„ÇãÊôÇ", "Âà•„Çå„ÇãÊôÇ", "ÊÑüË¨ù„Åô„ÇãÊôÇ"], a: 1 }
        ];

        function startQuiz(player) {
            const problem = QUIZ_BANK[Math.floor(Math.random() * QUIZ_BANK.length)];
            currentQuiz = { player, problem, timeLeft: 10.0 };
            
            quizModal.style.display = 'block';
            const tag = document.getElementById('quiz-player-tag');
            tag.innerText = `P${player.id} Turn`;
            tag.style.backgroundColor = player.color;
            document.getElementById('quiz-subject').innerText = problem.s;
            document.getElementById('quiz-question').innerText = problem.q;
            
            const choicesDiv = document.getElementById('quiz-choices');
            choicesDiv.innerHTML = '';
            problem.c.forEach((choice, idx) => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.innerText = choice;
                btn.onclick = () => submitAnswer(idx);
                choicesDiv.appendChild(btn);
            });

            const timerUpdate = setInterval(() => {
                if (!currentQuiz) { clearInterval(timerUpdate); return; }
                currentQuiz.timeLeft -= 0.1;
                const percent = (currentQuiz.timeLeft / 10) * 100;
                quizTimerBar.style.width = `${percent}%`;
                document.getElementById('quiz-timer-text').innerText = `${currentQuiz.timeLeft.toFixed(1)}s`;
                if (currentQuiz.timeLeft <= 0) { playSound('wrong'); endQuiz(false); clearInterval(timerUpdate); }
            }, 100);
        }

        function submitAnswer(idx) {
            if (idx === currentQuiz.problem.a) { playSound('correct'); endQuiz(true); }
            else { playSound('wrong'); endQuiz(false); }
        }

        function endQuiz(success) {
            if (success) applyPowerup(currentQuiz.player);
            currentQuiz = null; quizModal.style.display = 'none';
        }

        function applyPowerup(player) {
            const types = ['Ë≤´ÈÄöÁàÜÂºæ', 'ÁÅ´ÂäõMAX', '„Çπ„Éî„Éº„Éâ„Ç¢„ÉÉ„Éó', 'ÁàÜÂºæÂ¢óÂä†'];
            const choice = types[Math.floor(Math.random() * types.length)];
            if (choice === 'Ë≤´ÈÄöÁàÜÂºæ') { player.isPiercing = true; player.powerupTimers.piercing = 600; }
            else if (choice === 'ÁÅ´ÂäõMAX') { player.isMaxFire = true; player.powerupTimers.maxFire = 600; }
            else if (choice === '„Çπ„Éî„Éº„Éâ„Ç¢„ÉÉ„Éó') { player.speed = 8; player.powerupTimers.speed = 600; }
            else { player.bombsMax++; }
            updateUI();
            const msg = document.createElement('div');
            msg.className = "fixed top-1/4 left-1/2 -translate-x-1/2 text-4xl font-black text-white z-[100] animate-bounce text-center bg-black bg-opacity-70 p-6 rounded-3xl border-4 border-yellow-500";
            msg.innerHTML = `<span class="text-yellow-400">P${player.id} POWER UP!</span><br>${choice}`;
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 2000);
        }

        // --- GAME SYSTEM ---
        function initMap() {
            grid = [];
            for (let y = 0; y < GRID_HEIGHT; y++) {
                grid[y] = [];
                for (let x = 0; x < GRID_WIDTH; x++) {
                    if (x === 0 || y === 0 || x === GRID_WIDTH-1 || y === GRID_HEIGHT-1 || (x%2===0 && y%2===0)) grid[y][x] = WALL;
                    else {
                        const isSafe = (x<=2 && y<=2) || (x>=GRID_WIDTH-3 && y<=2) || (x<=2 && y>=GRID_HEIGHT-3) || (x>=GRID_WIDTH-3 && y>=GRID_HEIGHT-3);
                        grid[y][x] = (!isSafe && Math.random() < 0.75) ? BLOCK : EMPTY;
                    }
                }
            }
            items = []; bombs = []; explosions = [];
        }

        function startGame(num) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            playerCount = num;
            lobby.classList.add('hidden'); gameContainer.classList.remove('hidden'); gameInfo.classList.remove('hidden');
            canvas.width = GRID_WIDTH * TILE_SIZE; canvas.height = GRID_HEIGHT * TILE_SIZE;
            initMap(); players = [];
            const starts = [{x:1,y:1}, {x:GRID_WIDTH-2,y:GRID_HEIGHT-2}, {x:GRID_WIDTH-2,y:1}, {x:1,y:GRID_HEIGHT-2}];
            for (let i = 0; i < playerCount; i++) players.push(new Player(i+1, starts[i].x, starts[i].y, Object.values(COLORS)[i], CONTROL_SCHEMES[i]));
            updateUI(); gameActive = true; requestAnimationFrame(gameLoop);
        }

        function updateUI() {
            gameInfo.innerHTML = players.map(p => `
                <div class="bg-black bg-opacity-80 p-2 rounded-xl border-t-4 min-w-[90px] text-center shadow-lg" style="border-color: ${p.color}; opacity: ${p.alive?1:0.3}">
                    <div class="text-[10px] font-black uppercase tracking-tighter">Player ${p.id}</div>
                    <div class="text-xs font-bold text-gray-400">Bomb ${p.bombsMax}</div>
                    <div class="flex justify-center gap-1 mt-1">
                        ${p.powerupTimers.piercing>0?'<div class="w-2 h-2 rounded-full bg-white shadow-[0_0_5px_white]"></div>':''}
                        ${p.powerupTimers.maxFire>0?'<div class="w-2 h-2 rounded-full bg-orange-500 shadow-[0_0_5px_orange]"></div>':''}
                        ${p.powerupTimers.speed>0?'<div class="w-2 h-2 rounded-full bg-blue-400 shadow-[0_0_5px_blue]"></div>':''}
                    </div>
                </div>
            `).join('');
        }

        function gameLoop() {
            if (!gameActive) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let y = 0; y < GRID_HEIGHT; y++) {
                for (let x = 0; x < GRID_WIDTH; x++) {
                    if (grid[y][x] === WALL) {
                        ctx.fillStyle = COLORS.WALL; ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        ctx.strokeStyle = "#1f2937"; ctx.strokeRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } else if (grid[y][x] === BLOCK) { 
                        ctx.fillStyle = COLORS.BLOCK; ctx.fillRect(x*TILE_SIZE+2, y*TILE_SIZE+2, TILE_SIZE-4, TILE_SIZE-4);
                        ctx.fillStyle = "rgba(0,0,0,0.2)"; ctx.fillRect(x*TILE_SIZE+4, y*TILE_SIZE+TILE_SIZE-10, TILE_SIZE-8, 4);
                    }
                }
            }
            items.forEach(it => {
                const s = Math.sin(Date.now()*0.01)*3;
                ctx.fillStyle = COLORS.ITEM; ctx.beginPath(); ctx.arc(it.x*TILE_SIZE+TILE_SIZE/2, it.y*TILE_SIZE+TILE_SIZE/2, TILE_SIZE/3+s, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle="black"; ctx.font="bold 18px Arial"; ctx.fillText("?", it.x*TILE_SIZE+15, it.y*TILE_SIZE+27);
            });
            for (let i = bombs.length-1; i >= 0; i--) {
                const b = bombs[i]; if (!currentQuiz) b.timer--;
                const pulse = Math.sin(b.timer*0.15)*3;
                ctx.fillStyle = COLORS.BOMB; ctx.beginPath(); ctx.arc(b.x*TILE_SIZE+TILE_SIZE/2, b.y*TILE_SIZE+TILE_SIZE/2, TILE_SIZE/2.5+pulse, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(b.x*TILE_SIZE+TILE_SIZE/2-4, b.y*TILE_SIZE+TILE_SIZE/2-4, 3, 0, Math.PI*2); ctx.fill();
                if (b.timer <= 0) { explode(b); bombs.splice(i, 1); }
            }
            for (let i = explosions.length-1; i >= 0; i--) {
                const e = explosions[i]; if (!currentQuiz) e.timer--;
                ctx.fillStyle = COLORS.FIRE; ctx.globalAlpha = e.timer/20; ctx.fillRect(e.x*TILE_SIZE, e.y*TILE_SIZE, TILE_SIZE, TILE_SIZE); ctx.globalAlpha = 1;
                players.forEach(p => { if (p.alive && Math.floor((p.pixelX+TILE_SIZE/2)/TILE_SIZE) === e.x && Math.floor((p.pixelY+TILE_SIZE/2)/TILE_SIZE) === e.y) { p.alive = false; playSound('wrong'); updateUI(); } });
                if (e.timer <= 0) explosions.splice(i, 1);
            }
            players.forEach(p => { p.update(); p.draw(); });
            checkGameOver(); requestAnimationFrame(gameLoop);
        }

        function explode(bomb) {
            bomb.owner.bombsPlaced--; playSound('explosion');
            [[0,0],[1,0],[-1,0],[0,1],[0,-1]].forEach(dir => {
                for (let r = (dir[0]===0&&dir[1]===0?0:1); r <= bomb.range; r++) {
                    const ex = bomb.x+dir[0]*r, ey = bomb.y+dir[1]*r;
                    if (ex<0||ex>=GRID_WIDTH||ey<0||ey>=GRID_HEIGHT||grid[ey][ex]===WALL) break;
                    explosions.push({ x: ex, y: ey, timer: 20 });
                    const itIdx = items.findIndex(it => it.x === ex && it.y === ey);
                    if (itIdx !== -1) items.splice(itIdx, 1);
                    if (grid[ey][ex] === BLOCK) {
                        grid[ey][ex] = EMPTY; if (Math.random() < 0.35) items.push({ x: ex, y: ey });
                        if (!bomb.isPiercing) break;
                    }
                    const otherBomb = bombs.find(b => b.x === ex && b.y === ey);
                    if (otherBomb) otherBomb.timer = Math.min(otherBomb.timer, 3);
                }
            });
        }

        function checkGameOver() {
            const alive = players.filter(p => p.alive);
            if (gameActive && alive.length <= (playerCount > 1 ? 1 : 0)) {
                gameActive = false;
                setTimeout(() => {
                    gameOverScreen.classList.remove('hidden');
                    winnerText.innerText = alive.length === 1 ? `PLAYER ${alive[0].id} WIN!` : "DRAW!";
                    winnerText.style.color = alive.length === 1 ? alive[0].color : "white";
                }, 1000);
            }
        }
    </script>
</body>
</html>
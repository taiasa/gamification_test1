<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®—æ•°ãƒ–ãƒ­ãƒƒã‚¯å´©ã—</title>
    <!-- Tailwind CSS CDNã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js CDNã®èª­ã¿è¾¼ã¿ (åŠ¹æœéŸ³ç”¨) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        #gameCanvas {
            border: 2px solid #4a90e2;
            background-color: #161b22;
            display: block;
            margin: 0 auto;
        }
        .container {
            width: 100%;
            max-width: 600px;
            padding: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            background-color: #1e242a;
        }
        .button-primary {
            background-color: #4a90e2;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            transition: background-color 0.2s;
            flex-grow: 1; /* ãƒœã‚¿ãƒ³ãŒç­‰ã—ã„å¹…ã«ãªã‚‹ã‚ˆã†ã«èª¿æ•´ */
            min-width: 80px;
        }
        .button-primary:hover {
            background-color: #3b7cdb;
        }
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ã®èƒŒæ™¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #quizModalOverlay {
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 10;
        }
    </style>
</head>
<body>

    <div class="container flex flex-col items-center">
        <h1 class="text-3xl font-bold text-white mb-4">ç®—æ•°ãƒ–ãƒ­ãƒƒã‚¯å´©ã—</h1>
        <canvas id="gameCanvas" width="500" height="400" class="rounded-lg shadow-xl"></canvas>

        <div id="controls" class="w-full flex flex-col items-center mt-4 p-3 bg-gray-700 rounded-lg">
            <!-- é›£æ˜“åº¦é¸æŠ -->
            <div id="difficulty-selection" class="flex flex-wrap justify-center items-center space-x-4 mb-3">
                <span class="text-white text-md">é›£æ˜“åº¦:</span>
                <label class="text-white flex items-center text-sm">
                    <input type="radio" name="difficulty" value="easy" checked class="form-radio text-green-500 mr-1">
                    åˆç´š
                </label>
                <label class="text-white flex items-center text-sm">
                    <input type="radio" name="difficulty" value="medium" class="form-radio text-yellow-500 mr-1">
                    ä¸­ç´š
                </label>
                <label class="text-white flex items-center text-sm">
                    <input type="radio" name="difficulty" value="hard" class="form-radio text-red-500 mr-1">
                    ä¸Šç´š
                </label>
                <label class="text-white flex items-center text-sm">
                    <input type="radio" name="difficulty" value="super_hard" class="form-radio text-purple-500 mr-1">
                    è¶…ç´š
                </label>
            </div>

            <!-- ã‚¹ã‚³ã‚¢ã¨ãƒœã‚¿ãƒ³ -->
            <div class="flex items-center space-x-4 w-full justify-between sm:justify-center mb-3">
                <div class="text-white text-lg">ã‚¹ã‚³ã‚¢: <span id="scoreDisplay" class="font-mono text-yellow-400">0</span></div>
            </div>

            <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
            <div class="flex space-x-2 w-full justify-center">
                <button id="retryButton" class="button-primary bg-yellow-600 hover:bg-yellow-700">ãƒªãƒˆãƒ©ã‚¤</button>
                <button id="cheatSpeedResetButton" class="button-primary bg-red-600 hover:bg-red-700 text-sm">ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ</button>
                <button id="startButton" class="button-primary">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
            </div>
        </div>
        
        <!-- ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—çŠ¶æ…‹è¡¨ç¤º -->
        <div id="powerUpStatus" class="mt-2 text-center text-lg text-green-400 h-6"></div>

        <!-- ç®—æ•°ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ€ãƒ« (ã‚²ãƒ¼ãƒ ä¸€æ™‚åœæ­¢ä¸­ã«è¡¨ç¤º) -->
        <div id="quizModalOverlay" class="fixed inset-0 hidden items-center justify-center">
            <div id="quizModal" class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm text-center border-t-4 border-yellow-500">
                <h2 class="text-2xl font-bold text-white mb-4">ç®—æ•°ã‚¯ã‚¤ã‚ºï¼</h2>
                <p id="quizProblem" class="text-3xl font-extrabold text-yellow-300 mb-6">$12 + 34$</p>
                <input type="number" id="quizAnswerInput" placeholder="ç­”ãˆã‚’å…¥åŠ›"
                       class="w-full p-3 mb-4 text-center text-gray-900 bg-white rounded-md border-2 border-gray-300 focus:border-blue-500 focus:outline-none"
                       autocomplete="off">
                <button id="submitAnswerButton" class="button-primary w-full">è§£ç­”</button>
                <p id="quizMessage" class="text-red-400 mt-3 h-5"></p>
            </div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼/ã‚¯ãƒªã‚¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="gameEndModalOverlay" class="fixed inset-0 hidden items-center justify-center">
            <div id="gameEndModal" class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm text-center border-t-4 border-red-500">
                <h2 id="gameEndTitle" class="text-3xl font-bold text-white mb-4"></h2>
                <!-- ã‚¹ã‚³ã‚¢ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹è¦ç´ ã‚’è¿½åŠ  -->
                <p id="scoreMessage" class="text-lg text-gray-300 mb-4"></p>
                <p class="text-xl text-white mb-6">æœ€çµ‚ã‚¹ã‚³ã‚¢: <span id="finalScoreDisplay" class="font-mono text-yellow-400">0</span></p>
                <button id="restartButton" class="button-primary w-full bg-green-500 hover:bg-green-600">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
            </div>
        </div>

    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨å®šæ•°ã®è¨­å®š
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // --- Tone.js (åŠ¹æœéŸ³) ã®è¨­å®š ---
        // å£ãƒ»ãƒ‘ãƒ‰ãƒ«è¡çªéŸ³ (PolySynth - Sine)
        const wallSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: 'sine' },
            envelope: { attack: 0.001, decay: 0.1, sustain: 0.1, release: 0.2 },
            volume: -15
        }).toDestination();
        
        // ã‚³ãƒ¼ãƒ‰éŸ³/ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼éŸ³ (PolySynth - Chord)
        // å’ŒéŸ³ã‚’é³´ã‚‰ã™ãŸã‚ã®å°‚ç”¨ã‚·ãƒ³ã‚»
        const chordSynth = new Tone.PolySynth(Tone.Synth, {
             oscillator: { type: 'triangle' }, 
             envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 1 },
             volume: -12
        }).toDestination();

        // ãƒ–ãƒ­ãƒƒã‚¯ç ´å£Šãƒ»ä¸æ­£è§£éŸ³ (MembraneSynth - Kick/Percussion)
        // å˜éŸ³ã®æ‰“æ¥½å™¨çš„ãªéŸ³ã«ä½¿ç”¨
        const blockSynth = new Tone.MembraneSynth({
            pitchDecay: 0.02,
            octaves: 5,
            envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 0.8 },
            volume: -10
        }).toDestination();

        // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—å–å¾—éŸ³
        const powerUpSynth = new Tone.DuoSynth({
            vibratoAmount: 0.5,
            vibratoRate: 5,
            harmonicity: 1.5,
            volume: -10,
            voice0: {
                oscillator: { type: 'sine' },
                filter: { Q: 2, type: 'lowpass', rolloff: -24 },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.4, release: 1 }
            },
            voice1: {
                oscillator: { type: 'sine' },
                filter: { Q: 2, type: 'lowpass', rolloff: -24 },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.4, release: 1 }
            }
        }).toDestination();
        
        // --- ã‚µã‚¦ãƒ³ãƒ‰å†ç”Ÿé–¢æ•° ---
        function playSound(type) {
            // Tone.jsãŒã¾ã åˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãªã—ã§å†ç”Ÿã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãŸã‚ã€å®‰å…¨ãƒã‚§ãƒƒã‚¯
            if (Tone.context.state !== 'running') {
                Tone.start();
            }

            if (type === 'wall') {
                wallSynth.triggerAttackRelease('C4', '16n');
            } else if (type === 'paddle') {
                wallSynth.triggerAttackRelease('E4', '32n');
            } else if (type === 'correct') {
                // æ­£è§£/ã‚¯ãƒªã‚¢éŸ³ã¯æ˜ã‚‹ã„ã‚³ãƒ¼ãƒ‰ (chordSynthã‚’ä½¿ç”¨)
                chordSynth.triggerAttackRelease(['C5', 'E5', 'G5'], '8n'); 
            } else if (type === 'incorrect') {
                // ä¸æ­£è§£éŸ³ã¯ä½ãçŸ­ã„éŸ³ (blockSynthã‚’ä½¿ç”¨)
                blockSynth.triggerAttackRelease('C3', '8n');
            } else if (type === 'powerup') {
                powerUpSynth.triggerAttackRelease('C6', '8n', Tone.now(), 0.5);
            } else if (type === 'gameover') {
                // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼éŸ³ã¯ä½ã„ä¸å”å’ŒéŸ³ (chordSynthã‚’ä½¿ç”¨)
                chordSynth.triggerAttackRelease(['G2', 'C#2'], '2n');
            }
        }
        // --- Tone.js è¨­å®šã“ã“ã¾ã§ ---

        // ãƒœãƒ¼ãƒ«é€Ÿåº¦ã®ãƒ¬ãƒ™ãƒ«å®šç¾©
        const speedLevels = {
            easy: 1.5,   // åˆç´š (é…ã„)
            medium: 2.5, // ä¸­ç´š (æ™®é€š)
            hard: 4,     // ä¸Šç´š (é€Ÿã„)
            super_hard: 5.5 // è¶…ç´š (è¶…é€Ÿã„)
        };
        
        // å‚ç›´æ–¹å‘ã®é€Ÿåº¦ã®æœ€ä½æ¯”ç‡ (ç·é€Ÿåº¦ã«å¯¾ã—ã¦)
        const MIN_VERTICAL_SPEED_FACTOR = 0.6; // |dy|/Speed >= 0.6 ã‚’ä¿è¨¼ (ç´„37åº¦ä»¥ä¸Šã®è§’åº¦)

        // ãƒ‘ãƒ‰ãƒ«åˆæœŸå¹…ã®å®šæ•°
        const PADDLE_INITIAL_WIDTH = 75; 

        // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—é–¢é€£ã®å®šæ•°ã¨å¤‰æ•°
        const POWERUP_DURATION = 10000; // 10ç§’ (ãƒŸãƒªç§’)
        let currentPowerUpTimer = null;
        let originalPaddleWidth = PADDLE_INITIAL_WIDTH; 
        let originalBallSpeed;

        // ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ç®¡ç†
        let gameActive = false;
        let gamePaused = true;
        let score = 0;
        let maxBricks = 0;
        let bricksLeft = 0;

        // ãƒ‘ãƒ‰ãƒ«ã€ãƒœãƒ¼ãƒ«ã€ãƒ–ãƒ­ãƒƒã‚¯ã®å®šç¾©
        const paddle = {
            height: 10,
            width: PADDLE_INITIAL_WIDTH,
            x: (canvas.width - PADDLE_INITIAL_WIDTH) / 2,
            dx: 5,
            color: '#00ffff' // è›å…‰ã‚·ã‚¢ãƒ³ (ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«å¼·åŒ–)
        };

        const ball = {
            radius: 5,
            x: canvas.width / 2,
            y: canvas.height - 30,
            dx: 2, // é€Ÿåº¦ã¯resetGameã§ä¸Šæ›¸ãã•ã‚Œã¾ã™
            dy: -2, // é€Ÿåº¦ã¯resetGameã§ä¸Šæ›¸ãã•ã‚Œã¾ã™
            color: '#ff69b4' // è›å…‰ãƒ”ãƒ³ã‚¯ (ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«å¼·åŒ–)
        };

        // ã‚°ãƒªãƒƒãƒ‰é…ç½®ç”¨ã®åˆæœŸè¨­å®š (éš™é–“ã‚’ç¢ºä¿ã—ã¤ã¤Canvaså¹…ã«åˆã‚ã›ã‚‹)
        // Canvaså¹…: 500px, åˆ—æ•°: 7, éš™é–“(Padding): 2px
        // 7 * 68 + 6 * 2 + 2 * 3 = 476 + 12 + 6 = 494 (å·¦å³ã«3pxã®éš™é–“ãŒæ®‹ã‚‹)
        const gridInfo = {
            rows: 5,
            cols: 7, // 7åˆ—
            width: 68, // ãƒ–ãƒ­ãƒƒã‚¯ã®æ¨ªå¹…
            height: 20,
            padding: 2, // ãƒ–ãƒ­ãƒƒã‚¯é–“ã®éš™é–“ (2px)
            offsetX: 3, // Canvaså·¦å³ã®éš™é–“ (3px)
            offsetY: 20,
            colors: ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6'] // èµ¤ã€ã‚ªãƒ¬ãƒ³ã‚¸ã€ç·‘ã€é’ã€ç´«
        };

        // ãƒ–ãƒ­ãƒƒã‚¯ã®é…åˆ—
        let bricks = [];
        // ç¾åœ¨ã€ãƒœãƒ¼ãƒ«ãŒè¡çªã—ãŸã€ã¾ãŸã¯è¡çªã™ã‚‹äºˆå®šã®ãƒ–ãƒ­ãƒƒã‚¯
        let currentTargetBrick = null;

        // DOMè¦ç´ 
        const scoreDisplay = document.getElementById('scoreDisplay');
        const startButton = document.getElementById('startButton');
        const retryButton = document.getElementById('retryButton'); 
        const cheatSpeedResetButton = document.getElementById('cheatSpeedResetButton'); 
        const quizModalOverlay = document.getElementById('quizModalOverlay');
        const quizProblemText = document.getElementById('quizProblem');
        const quizAnswerInput = document.getElementById('quizAnswerInput');
        const submitAnswerButton = document.getElementById('submitAnswerButton');
        const quizMessage = document.getElementById('quizMessage');
        const gameEndModalOverlay = document.getElementById('gameEndModalOverlay');
        const gameEndTitle = document.getElementById('gameEndTitle');
        const finalScoreDisplay = document.getElementById('finalScoreDisplay');
        const scoreMessage = document.getElementById('scoreMessage');
        const restartButton = document.getElementById('restartButton');
        const powerUpStatus = document.getElementById('powerUpStatus');
        const difficultySelection = document.getElementById('difficulty-selection'); 


        /**
         * ç®—æ•°ã®å•é¡Œã¨ç­”ãˆã‚’ç”Ÿæˆã™ã‚‹
         */
        function generateProblem() {
            let num1, num2, operation, problem, answer;

            // ãƒ©ãƒ³ãƒ€ãƒ ã«æ¼”ç®—å­ã‚’é¸æŠ (0: +, 1: -, 2: Ã—, 3: Ã·)
            operation = Math.floor(Math.random() * 4); 

            if (operation === 0) {
                // ãŸã—ç®—: 10ã‹ã‚‰99ã¾ã§ã®æ•° (2æ¡+2æ¡)
                num1 = Math.floor(Math.random() * 90) + 10;
                num2 = Math.floor(Math.random() * 90) + 10;
                problem = `${num1} + ${num2}`;
                answer = num1 + num2;
            } else if (operation === 1) {
                // ã²ãç®—: çµæœãŒæ­£ã«ãªã‚‹ã‚ˆã†ã«ã™ã‚‹ (10ã‹ã‚‰99ã®ç¯„å›²)
                num1 = Math.floor(Math.random() * 90) + 10;
                num2 = Math.floor(Math.random() * (num1 - 10)) + 10; 
                problem = `${num1} - ${num2}`;
                answer = num1 - num2;
            } else if (operation === 2) {
                // ã‹ã‘ç®—: 2ã‹ã‚‰12ã®ç¯„å›²ã®æ•°ã‚’ä½¿ç”¨ (ä¹ä¹ã‹ã‚‰å°‘ã—åºƒã‚ã®ç¯„å›²)
                num1 = Math.floor(Math.random() * 11) + 2; // 2ã‹ã‚‰12
                num2 = Math.floor(Math.random() * 11) + 2; // 2ã‹ã‚‰12
                problem = `${num1} Ã— ${num2}`;
                answer = num1 * num2;
            } else { // operation === 3
                // ã‚ã‚Šç®—: å‰²ã‚Šåˆ‡ã‚Œã‚‹å•é¡Œã®ã¿ (ç­”ãˆã¨å‰²ã‚‹æ•°ã¯2ã‹ã‚‰12ã®ç¯„å›²)
                let quotient = Math.floor(Math.random() * 11) + 2; // ç­”ãˆ (2ã‹ã‚‰12)
                num2 = Math.floor(Math.random() * 11) + 2; // å‰²ã‚‹æ•° (2ã‹ã‚‰12)
                num1 = quotient * num2; // å‰²ã‚‰ã‚Œã‚‹æ•°
                problem = `${num1} Ã· ${num2}`;
                answer = quotient;
            }

            return { problem, answer };
        }

        /**
         * é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        /**
         * ãƒ–ãƒ­ãƒƒã‚¯é…åˆ—ã‚’åˆæœŸåŒ–ï¼ˆå•é¡Œä»˜ãã€ç‰¹æ®Šãƒ–ãƒ­ãƒƒã‚¯å«ã‚€ï¼‰
         * @param {string} difficulty é¸æŠã•ã‚ŒãŸé›£æ˜“åº¦
         */
        function createBricks(difficulty) {
            bricks = [];
            let totalBricks = 0;
            const powerUpTypes = ['paddle_boost', 'slow_ball'];
            
            const BRICK_PADDING = gridInfo.padding; 

            if (difficulty === 'super_hard') {
                // --- è¶…ç´š (ãƒãƒ©ãƒãƒ©é…ç½®) ---
                const SCATTER_COUNT = 55; // ç›®æ¨™ãƒ–ãƒ­ãƒƒã‚¯æ•°
                const BRICK_WIDTH = 50;   // ãƒãƒ©ãƒãƒ©ãƒ¢ãƒ¼ãƒ‰ã§ã®å¹…
                const BRICK_HEIGHT = 20;
                const MIN_Y = gridInfo.offsetY;
                const MAX_Y = canvas.height / 2.5; // ç”»é¢ã®ä¸Š1/3ç¨‹åº¦ã«é…ç½®
                const MIN_X = 10;
                const MAX_X = canvas.width - BRICK_WIDTH - 10;
                
                const existingPositions = []; 

                // è¡çªãƒã‚§ãƒƒã‚¯é–¢æ•° (é…ç½®æ™‚ã®é‡ãªã‚Šé˜²æ­¢ç”¨)
                const isOverlapping = (x, y) => {
                    for (const pos of existingPositions) {
                        // 2ã¯é…ç½®ã®å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³ï¼ˆãƒãƒ©ãƒãƒ©é…ç½®ã§ã¯å°‘ã—éš™é–“ã‚’è¨­ã‘ã‚‹ï¼‰
                        if (
                            x < pos.x + BRICK_WIDTH + 2 && 
                            x + BRICK_WIDTH + 2 > pos.x &&
                            y < pos.y + BRICK_HEIGHT + 2 &&
                            y + BRICK_HEIGHT + 2 > pos.y
                        ) {
                            return true;
                        }
                    }
                    return false;
                };

                for (let i = 0; i < SCATTER_COUNT * 3 && totalBricks < SCATTER_COUNT; i++) { // æœ€å¤§è©¦è¡Œå›æ•°
                    // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®
                    const x = Math.floor(Math.random() * (MAX_X - MIN_X)) + MIN_X;
                    const y = Math.floor(Math.random() * (MAX_Y - MIN_Y)) + MIN_Y;

                    if (isOverlapping(x, y)) continue;
                    
                    // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ã®ç¢ºç‡ (ç´„10%)
                    let type = Math.random() < 0.1 ? powerUpTypes[Math.floor(Math.random() * powerUpTypes.length)] : 'none';
                    let display, problemData;
                    let color;

                    if (type !== 'none') {
                        color = '#FFD700'; // é‡‘è‰²
                        display = type === 'paddle_boost' ? 'P+' : 'S-';
                        problemData = { problem: '', answer: 0 };
                    } else {
                        problemData = generateProblem();
                        // ãƒ©ãƒ³ãƒ€ãƒ ãªè‰²ã‚’é¸æŠ
                        color = gridInfo.colors[Math.floor(Math.random() * gridInfo.colors.length)]; 
                        display = problemData.problem;
                    }

                    bricks.push({
                        x,
                        y,
                        width: BRICK_WIDTH,
                        height: BRICK_HEIGHT,
                        status: 1, 
                        color: color,
                        problem: problemData.problem,
                        answer: problemData.answer,
                        type: type, 
                        display: display,
                        reflect: null 
                    });
                    existingPositions.push({x, y});
                    totalBricks++;
                }

            } else {
                // --- åˆç´š/ä¸­ç´š/ä¸Šç´š (ã‚°ãƒªãƒƒãƒ‰é…ç½®) ---
                const GRID_WIDTH = gridInfo.width;
                const GRID_HEIGHT = gridInfo.height;
                const TOTAL_ROWS = gridInfo.rows;
                const TOTAL_COLS = gridInfo.cols; 
                const GRID_OFFSET_Y = gridInfo.offsetY;
                const GRID_OFFSET_X = gridInfo.offsetX; 

                
                // è¡Œã”ã¨ã«ç‰¹æ®Šãƒ–ãƒ­ãƒƒã‚¯ã®ä½ç½® (åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹) ã‚’æ±ºå®šã™ã‚‹
                const specialBrickPositions = []; 

                for (let r = 0; r < TOTAL_ROWS; r++) {
                    const positions = Array.from({ length: TOTAL_COLS }, (_, i) => i); 
                    shuffleArray(positions);
                    
                    // è¡Œã”ã¨ã«ç‰¹æ®Šãƒ–ãƒ­ãƒƒã‚¯ã®æ•°ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«1å€‹ã¾ãŸã¯2å€‹ã«æ±ºå®š
                    const specialCount = Math.random() < 0.5 ? 1 : 2; 
                    
                    // ãã®è¡Œã®æœ€åˆã® specialCount å€‹ã‚’ç‰¹æ®Šãƒ–ãƒ­ãƒƒã‚¯ã®ä½ç½®ã¨ã™ã‚‹
                    specialBrickPositions.push(positions.slice(0, specialCount));
                }


                for (let c = 0; c < TOTAL_COLS; c++) {
                    for (let r = 0; r < TOTAL_ROWS; r++) {
                        // ãƒ–ãƒ­ãƒƒã‚¯å¹…ã¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è€ƒæ…®ã—ã¦é…ç½®
                        const x = c * (GRID_WIDTH + BRICK_PADDING) + GRID_OFFSET_X; 
                        const y = r * (GRID_HEIGHT + BRICK_PADDING) + GRID_OFFSET_Y; 
                        
                        // ã“ã®åˆ—ãŒç‰¹æ®Šãƒ–ãƒ­ãƒƒã‚¯ã®ä½ç½®ã‹ãƒã‚§ãƒƒã‚¯
                        const isSpecial = specialBrickPositions[r].includes(c);

                        let type = 'none';
                        let display = '';
                        let problemData = { problem: '', answer: 0 };
                        let color;

                        if (isSpecial) {
                            // 2ç¨®é¡ã®ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å‰²ã‚Šå½“ã¦
                            type = powerUpTypes[Math.floor(Math.random() * powerUpTypes.length)];
                            color = '#FFD700'; // é‡‘è‰²
                            display = type === 'paddle_boost' ? 'P+' : 'S-';
                        } else {
                            problemData = generateProblem();
                            color = gridInfo.colors[r % gridInfo.colors.length];
                            display = problemData.problem;
                        }

                        bricks.push({ // ãƒ•ãƒ©ãƒƒãƒˆé…åˆ—ã«æ ¼ç´
                            x,
                            y,
                            width: GRID_WIDTH,
                            height: GRID_HEIGHT,
                            status: 1, 
                            color: color,
                            problem: problemData.problem,
                            answer: problemData.answer,
                            type: type, 
                            display: display,
                            reflect: null 
                        });
                        totalBricks++;
                    }
                }
            }

            maxBricks = totalBricks;
            bricksLeft = totalBricks;
        }

        /**
         * ãƒ‘ãƒ‰ãƒ«ã‚’æç”» (ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«å¼·åŒ–: å½±ã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆ)
         */
        function drawPaddle() {
            ctx.beginPath();
            ctx.rect(paddle.x, canvas.height - paddle.height, paddle.width, paddle.height);
            
            // ç«‹ä½“æ„Ÿã®ãŸã‚ã®å½± (è›å…‰è‰²)
            ctx.shadowColor = paddle.color;
            ctx.shadowBlur = 10;
            ctx.fillStyle = paddle.color;
            ctx.fill();
            ctx.closePath();
            ctx.shadowBlur = 0; // å½±ã‚’ãƒªã‚»ãƒƒãƒˆ
            
            // ãƒã‚¤ãƒ©ã‚¤ãƒˆ (ä¸Šé¢)
            ctx.fillStyle = '#ffffff80'; // åŠé€æ˜ã®ç™½
            ctx.fillRect(paddle.x, canvas.height - paddle.height, paddle.width, 1);
        }

        /**
         * ãƒœãƒ¼ãƒ«ã‚’æç”» (ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«å¼·åŒ–: è›å…‰åŠ¹æœ)
         */
        function drawBall() {
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            
            // è›å…‰è‰²ã®åŠ¹æœ
            ctx.shadowColor = ball.color;
            ctx.shadowBlur = 8;
            ctx.fillStyle = ball.color;
            ctx.fill();
            ctx.closePath();
            ctx.shadowBlur = 0; // å½±ã‚’ãƒªã‚»ãƒƒãƒˆ
        }

        /**
         * ãƒ–ãƒ­ãƒƒã‚¯ã‚’æç”» (ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«å¼·åŒ–: å¢ƒç•Œç·šã¨å½±)
         */
        function drawBricks() {
            for (const b of bricks) {
                if (b.status === 1) {
                    ctx.beginPath();
                    ctx.rect(b.x, b.y, b.width, b.height); 
                    
                    // ãƒ–ãƒ­ãƒƒã‚¯ã®å½±ã¨è‰²
                    ctx.shadowColor = b.color;
                    ctx.shadowBlur = 5;
                    ctx.fillStyle = b.color;
                    ctx.fill();
                    ctx.closePath();
                    ctx.shadowBlur = 0; // å½±ã‚’ãƒªã‚»ãƒƒãƒˆ
                    
                    // å¢ƒç•Œç·šã‚’è¿½åŠ 
                    ctx.strokeStyle = '#0d1117'; // èƒŒæ™¯è‰²ã«è¿‘ã„è‰²ã§å¢ƒç•Œç·šã‚’ä½œæˆ (éš™é–“ã‚’æ¼”å‡º)
                    ctx.lineWidth = 1;
                    ctx.stroke();

                    // å•é¡Œæ–‡ã¾ãŸã¯ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—è¨˜å·ã‚’æç”»
                    ctx.fillStyle = b.type === 'none' ? 'white' : 'black'; 
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(b.display, b.x + b.width / 2, b.y + b.height / 2);
                }
            }
        }

        /**
         * ãƒ‘ãƒ‰ãƒ«ã®ç§»å‹•
         */
        function movePaddle() {
            if (!gameActive || gamePaused) return;

            // ã“ã“ã§ã¯å¢ƒç•Œãƒã‚§ãƒƒã‚¯ã®ã¿
            if (paddle.x < 0) {
                paddle.x = 0;
            } else if (paddle.x + paddle.width > canvas.width) {
                paddle.x = canvas.width - paddle.width;
            }
        }

        /**
         * ãƒœãƒ¼ãƒ«é€Ÿåº¦ã«å‚ç›´æ–¹å‘ã®ãƒã‚¤ã‚¢ã‚¹ã‚’é©ç”¨ã—ã€ç·é€Ÿåº¦ã‚’ç¶­æŒã™ã‚‹
         */
        function applyVerticalBiasToBall() {
            const currentSpeed = Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy);
            
            if (currentSpeed < 0.5 || currentSpeed === 0) return;

            // å‚ç›´é€Ÿåº¦ã®çµ¶å¯¾å€¤ã®æœ€ä½é–¾å€¤
            const minDyMagnitude = currentSpeed * MIN_VERTICAL_SPEED_FACTOR;

            if (Math.abs(ball.dy) < minDyMagnitude) {
                const newDyMagnitude = minDyMagnitude;
                const newDxMagnitude = Math.sqrt(currentSpeed * currentSpeed - newDyMagnitude * newDyMagnitude);

                ball.dy = Math.sign(ball.dy) * newDyMagnitude;
                ball.dx = Math.sign(ball.dx) * newDxMagnitude;
            }
        }


        /**
         * ãƒœãƒ¼ãƒ«ã®ç§»å‹•ã¨å£ã¨ã®è¡çªåˆ¤å®š
         */
        function moveBall() {
            if (!gameActive || gamePaused) return;

            ball.x += ball.dx;
            ball.y += ball.dy;

            // å£ã®è¡çªåˆ¤å®š (å·¦å³)
            if (ball.x + ball.radius > canvas.width) {
                ball.dx *= -1;
                ball.x = canvas.width - ball.radius; 
                playSound('wall'); 
            } else if (ball.x - ball.radius < 0) {
                ball.dx *= -1;
                ball.x = ball.radius; 
                playSound('wall');
            }

            // å£ã®è¡çªåˆ¤å®š (ä¸Š)
            if (ball.y - ball.radius < 0) {
                ball.dy *= -1;
                ball.y = ball.radius;
                playSound('wall');
            }

            // å£ã®è¡çªåˆ¤å®š (ä¸‹ - ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼)
            if (ball.y + ball.radius > canvas.height) {
                endGame('ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼...');
                return;
            }

            // ãƒ‘ãƒ‰ãƒ«ã¨ã®è¡çªåˆ¤å®š
            if (
                ball.x - ball.radius < paddle.x + paddle.width &&
                ball.x + ball.radius > paddle.x &&
                ball.y + ball.radius > canvas.height - paddle.height
            ) {
                const relativeX = ball.x - (paddle.x + paddle.width / 2);
                const currentSpeed = Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy);
                
                // åå°„è§’åº¦ã®èª¿æ•´
                ball.dx = relativeX * 0.07; 
                ball.dy = -Math.abs(ball.dy); 

                // é€Ÿåº¦ã®ç·å’Œã‚’å…ƒã®ã‚¹ãƒ”ãƒ¼ãƒ‰ã«èª¿æ•´ã—ã¦ç¶­æŒ
                const newSpeed = Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy);
                const speedFactor = currentSpeed / newSpeed;
                ball.dx *= speedFactor;
                ball.dy *= speedFactor;

                // ãƒ‘ãƒ‰ãƒ«åå°„å¾Œã‚‚å‚ç›´ãƒã‚¤ã‚¢ã‚¹ã‚’é©ç”¨
                applyVerticalBiasToBall();
                playSound('paddle'); // ãƒ‘ãƒ‰ãƒ«è¡çªéŸ³
            }

            // ãƒ–ãƒ­ãƒƒã‚¯ã¨ã®è¡çªåˆ¤å®š
            checkBrickCollision();
        }

        /**
         * ãƒ–ãƒ­ãƒƒã‚¯ã¨ã®è¡çªåˆ¤å®šã¨ã‚¯ã‚¤ã‚ºå‡¦ç† (ãƒ•ãƒ©ãƒƒãƒˆé…åˆ—ã«å¯¾å¿œ)
         */
        function checkBrickCollision() {
            for (let i = 0; i < bricks.length; i++) {
                const b = bricks[i];

                if (b.status === 1) {
                    // AABBè¡çªåˆ¤å®š
                    if (
                        ball.x + ball.radius > b.x &&
                        ball.x - ball.radius < b.x + b.width &&
                        ball.y + ball.radius > b.y &&
                        ball.y - ball.radius < b.y + b.height
                    ) {
                        // è¡çªã‚’æ¤œå‡ºã—ãŸã‚‰ã‚²ãƒ¼ãƒ ã‚’ä¸€æ™‚åœæ­¢
                        gamePaused = true;
                        currentTargetBrick = b;

                        // ç‰¹æ®Šãƒ–ãƒ­ãƒƒã‚¯ã®å ´åˆã¯ã‚¯ã‚¤ã‚ºãªã—ã§å³åº§ã«ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—å‡¦ç†ã¸
                        if (b.type !== 'none') {
                            playSound('powerup'); // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—å–å¾—éŸ³
                            applyPowerUp(b.type);
                            
                            // ãƒ–ãƒ­ãƒƒã‚¯ç ´å£Š
                            currentTargetBrick.status = 0;
                            score += 20; 
                            bricksLeft--;
                            updateScore();
                            
                            // ãƒœãƒ¼ãƒ«ã®åå°„æ–¹å‘ã‚’æ±ºå®š
                            reflectBall(b);
                            applyVerticalBiasToBall();
                            
                            currentTargetBrick = null; 
                            gamePaused = false; // ã‚²ãƒ¼ãƒ å†é–‹
                            
                            if (bricksLeft === 0) {
                                endGame('ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼ãŠã‚ã§ã¨ã†ï¼');
                            }
                            return; 
                        }

                        // é€šå¸¸ãƒ–ãƒ­ãƒƒã‚¯ã®å ´åˆã¯ã‚¯ã‚¤ã‚ºã‚’è¡¨ç¤º
                        showQuiz(b.problem);

                        // ãƒœãƒ¼ãƒ«ã®åå°„æ–¹å‘ã‚’æ±ºå®šï¼ˆä¸€æ™‚åœæ­¢å‰ã«è¨˜éŒ²ï¼‰
                        reflectBall(b, true); 
                        
                        return; // ä¸€ã¤ã®è¡çªã§å‡¦ç†ã‚’çµ‚äº†
                    }
                }
            }
        }
        
        /**
         * ãƒœãƒ¼ãƒ«ã‚’åå°„ã•ã›ã€åå°„æ–¹å‘ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã«è¨˜éŒ²ã™ã‚‹
         */
        function reflectBall(brick, recordOnly = false) {
             // ç¸¦æ–¹å‘ã®åå°„ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ã®ä¸Šä¸‹ã«å½“ãŸã£ãŸå ´åˆï¼‰ã‚’å„ªå…ˆ
            if (ball.y < brick.y || ball.y > brick.y + brick.height) {
                brick.reflect = 'y';
                if (!recordOnly) ball.dy *= -1;
            }
            // æ¨ªæ–¹å‘ã®åå°„ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ã®å·¦å³ã«å½“ãŸã£ãŸå ´åˆï¼‰
            else if (ball.x < brick.x || ball.x > brick.x + brick.width) {
                brick.reflect = 'x';
                if (!recordOnly) ball.dx *= -1;
            } else {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç¸¦æ–¹å‘
                brick.reflect = 'y';
                if (!recordOnly) ball.dy *= -1;
            }
        }


        /**
         * ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
         */
        function showQuiz(problem) {
            quizProblemText.textContent = problem;
            quizAnswerInput.value = ''; 
            quizMessage.textContent = ''; 
            quizModalOverlay.classList.remove('hidden', 'opacity-0');
            quizModalOverlay.classList.add('flex', 'opacity-100');
            quizAnswerInput.focus();
        }

        /**
         * ã‚¯ã‚¤ã‚ºã®ç­”ãˆã‚’æ¤œè¨¼ã—ã€ã‚²ãƒ¼ãƒ ã‚’å†é–‹
         */
        function submitQuizAnswer() {
            if (!currentTargetBrick) return;

            const userAnswer = parseInt(quizAnswerInput.value, 10);
            const correctAnswer = currentTargetBrick.answer;

            if (userAnswer === correctAnswer) {
                // æ­£è§£
                playSound('correct'); // æ­£è§£éŸ³
                quizMessage.textContent = 'æ­£è§£ï¼ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç ´å£Šã—ã¾ã—ãŸï¼';
                quizMessage.classList.remove('text-red-400');
                quizMessage.classList.add('text-green-400');

                // å¿œç­”æ€§ã‚’é«˜ã‚ã‚‹ãŸã‚ã€0.2ç§’å¾Œã«ãƒ–ãƒ­ãƒƒã‚¯ç ´å£Šå‡¦ç†ã¨ã‚²ãƒ¼ãƒ å†é–‹
                setTimeout(() => {
                    // ãƒ–ãƒ­ãƒƒã‚¯ç ´å£Š
                    currentTargetBrick.status = 0;
                    score += 10;
                    bricksLeft--;
                    updateScore();

                    // ãƒœãƒ¼ãƒ«ã®åå°„
                    if (currentTargetBrick.reflect === 'y') {
                        ball.dy *= -1;
                    } else {
                        ball.dx *= -1;
                    }

                    // å‚ç›´æ–¹å‘ã¸ã®å‹•ãã‚’å¼·ã‚ã‚‹èª¿æ•´
                    applyVerticalBiasToBall();

                    // ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    quizModalOverlay.classList.remove('flex', 'opacity-100');
                    quizModalOverlay.classList.add('hidden', 'opacity-0');
                    currentTargetBrick = null; // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                    gamePaused = false; // ã‚²ãƒ¼ãƒ å†é–‹
                    
                    // ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢åˆ¤å®š
                    if (bricksLeft === 0) {
                        endGame('ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼ãŠã‚ã§ã¨ã†ï¼');
                    }
                }, 200); // 0.2ç§’å¾Œã«å‡¦ç†å®Ÿè¡Œ

            } else {
                // ä¸æ­£è§£
                playSound('incorrect'); // ä¸æ­£è§£éŸ³
                quizMessage.textContent = 'ä¸æ­£è§£ã§ã™ã€‚ãƒ–ãƒ­ãƒƒã‚¯ã¯å£Šã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚';
                quizMessage.classList.remove('text-green-400');
                quizMessage.classList.add('text-red-400');

                // å¿œç­”æ€§ã‚’é«˜ã‚ã‚‹ãŸã‚ã€0.2ç§’å¾Œã«ã‚²ãƒ¼ãƒ å†é–‹
                setTimeout(() => {
                    // ãƒœãƒ¼ãƒ«ã®åå°„ï¼ˆä¸æ­£è§£ã§ã‚‚ãƒœãƒ¼ãƒ«ã¯è·³ã­è¿”ã‚‹ï¼‰
                    if (currentTargetBrick.reflect === 'y') {
                        ball.dy *= -1;
                    } else {
                        ball.dx *= -1;
                    }

                    // å‚ç›´æ–¹å‘ã¸ã®å‹•ãã‚’å¼·ã‚ã‚‹èª¿æ•´
                    applyVerticalBiasToBall();

                    // ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    quizModalOverlay.classList.remove('flex', 'opacity-100');
                    quizModalOverlay.classList.add('hidden', 'opacity-0');
                    currentTargetBrick = null; // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                    gamePaused = false; // ã‚²ãƒ¼ãƒ å†é–‹
                }, 200); // 0.2ç§’å¾Œã«å‡¦ç†å®Ÿè¡Œ
            }
        }
        
        /**
         * ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—åŠ¹æœã‚’ç™ºå‹•
         */
        function applyPowerUp(type) {
            clearTimeout(currentPowerUpTimer);
            resetPowerUp(); 
            
            let statusText = '';
            
            if (type === 'paddle_boost') {
                paddle.width = originalPaddleWidth * 2;
                statusText = 'ğŸš€ ãƒ‘ãƒ‰ãƒ«æ‹¡å¤§ (10ç§’)';
            } else if (type === 'slow_ball') {
                ball.dx *= 0.5; 
                ball.dy *= 0.5; 
                statusText = 'ğŸ¢ ãƒœãƒ¼ãƒ«æ¸›é€Ÿ (10ç§’)';
            }
            
            powerUpStatus.textContent = statusText;

            currentPowerUpTimer = setTimeout(() => {
                resetPowerUp();
                powerUpStatus.textContent = '';
            }, POWERUP_DURATION);
        }

        /**
         * ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—åŠ¹æœã‚’ãƒªã‚»ãƒƒãƒˆ
         */
        function resetPowerUp() {
            paddle.width = originalPaddleWidth; 

            const currentSpeed = Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy);
            if (currentSpeed !== 0 && currentSpeed !== originalBallSpeed) {
                const ratio = originalBallSpeed / currentSpeed;
                ball.dx *= ratio;
                ball.dy *= ratio;
            }
            
            powerUpStatus.textContent = '';
            clearTimeout(currentPowerUpTimer);
            currentPowerUpTimer = null;
        }


        /**
         * ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°
         */
        function updateScore() {
            scoreDisplay.textContent = score;
        }

        /**
         * ã‚¹ã‚³ã‚¢ã«åŸºã¥ã„ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
         */
        function getScoreMessage(finalScore, isClear) {
            if (isClear) {
                if (finalScore >= 300) return 'ğŸ‰ å®Œç’§ï¼é©šç•°çš„ãªè¨ˆç®—åŠ›ã¨ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ï¼';
                return 'ğŸŒŸ ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼ç´ æ™´ã‚‰ã—ã„æˆç¸¾ã§ã™ï¼';
            }
            
            if (finalScore >= 300) {
                return 'ğŸ‰ é©šç•°çš„ï¼ç®—æ•°ã®ç¥ï¼ã‚ãªãŸã¯ãƒã‚¹ã‚¿ãƒ¼ã§ã™ï¼';
            } else if (finalScore >= 200) {
                return 'ğŸŒŸ ç´ æ™´ã‚‰ã—ã„ï¼ãƒ—ãƒ­ç´šã®è¨ˆç®—åŠ›ã¨ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ï¼';
            } else if (finalScore >= 150) {
                return 'ğŸ† ä¸Šç´šè€…ãƒ¬ãƒ™ãƒ«ï¼ã‚ã¨å°‘ã—ã§ãƒ—ãƒ­ã®é ˜åŸŸã§ã™ï¼';
            } else if (finalScore >= 100) {
                return 'ğŸ‘ ãªã‹ãªã‹ã‚„ã‚Šã¾ã™ã­ï¼å¹³å‡ã‚’ä¸Šå›ã‚‹å®ŸåŠ›ã§ã™ã€‚';
            } else {
                return 'ğŸ˜Š ã¾ãšã¾ãšã®ã‚¹ã‚¿ãƒ¼ãƒˆï¼æ¬¡ã¯äºŒæ¡ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ã€‚';
            }
        }

        /**
         * ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã¾ãŸã¯ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ã®å‡¦ç†
         */
        function endGame(title) {
            gameActive = false;
            gamePaused = true;
            resetPowerUp(); 
            
            gameEndTitle.textContent = title;
            finalScoreDisplay.textContent = score;
            
            const isClear = title.includes('ã‚¯ãƒªã‚¢');
            scoreMessage.textContent = getScoreMessage(score, isClear); 
            
            if (isClear) {
                playSound('correct');
                gameEndModal.classList.remove('border-red-500');
                gameEndModal.classList.add('border-green-500');
            } else {
                playSound('gameover');
                gameEndModal.classList.remove('border-green-500');
                gameEndModal.classList.add('border-red-500');
            }


            gameEndModalOverlay.classList.remove('hidden', 'opacity-0');
            gameEndModalOverlay.classList.add('flex', 'opacity-100');
        }

        /**
         * ã‚²ãƒ¼ãƒ ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
         * @param {boolean} fullReset ã‚¹ã‚³ã‚¢ã€ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã€UIã‚’å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã‹ã©ã†ã‹
         */
        function resetGame(fullReset = false) {
            const difficulty = document.querySelector('input[name="difficulty"]:checked').value;
            
            // é›£æ˜“åº¦ã«å¿œã˜ãŸãƒ–ãƒ­ãƒƒã‚¯ä½œæˆ
            createBricks(difficulty);

            // é›£æ˜“åº¦ã«å¿œã˜ãŸé€Ÿåº¦ã‚’å–å¾—
            const speed = speedLevels[difficulty] || speedLevels.medium; 

            // åˆæœŸé€Ÿåº¦ã‚’ä¿å­˜
            originalBallSpeed = speed;

            // ãƒœãƒ¼ãƒ«ã¨ãƒ‘ãƒ‰ãƒ«ã®ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
            paddle.x = (canvas.width - paddle.width) / 2;
            ball.x = canvas.width / 2;
            ball.y = canvas.height - 30;
            
            // ãƒœãƒ¼ãƒ«ã®åˆé€Ÿã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¨­å®š
            ball.dx = (Math.random() > 0.5 ? 1 : -1) * speed; 
            ball.dy = -speed;

            // åˆæœŸã®ãƒœãƒ¼ãƒ«ã®è§’åº¦ã«ã‚‚å‚ç›´æ–¹å‘ã®ãƒã‚¤ã‚¢ã‚¹ã‚’é©ç”¨
            applyVerticalBiasToBall();

            // ãƒ•ãƒ«ãƒªã‚»ãƒƒãƒˆã®å ´åˆã®ã¿ã€ã‚¹ã‚³ã‚¢ã¨UIã‚’ãƒªã‚»ãƒƒãƒˆ
            if (fullReset) {
                score = 0;
                updateScore();
                resetPowerUp(); 

                quizModalOverlay.classList.remove('flex', 'opacity-100'); 
                quizModalOverlay.classList.add('hidden', 'opacity-0');

                gameEndModalOverlay.classList.remove('flex', 'opacity-100');
                gameEndModalOverlay.classList.add('hidden', 'opacity-0');
                startButton.textContent = 'ã‚²ãƒ¼ãƒ é–‹å§‹';
                startButton.disabled = false;
                gamePaused = true;
                gameActive = true;
            }
        }


        /**
         * ãƒ¡ã‚¤ãƒ³ã®æç”»é–¢æ•°
         */
        function draw() {
            // èƒŒæ™¯ã‚’ã‚¯ãƒªã‚¢
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#161b22';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            drawBricks();
            drawPaddle();
            drawBall();

            if (gameActive && !gamePaused) {
                movePaddle();
                moveBall();
                requestAnimationFrame(draw);
            } else if (gameActive && gamePaused) {
                 requestAnimationFrame(draw);
            }
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---

        // ã‚­ãƒ¼å…¥åŠ›ã«ã‚ˆã‚‹ãƒ‘ãƒ‰ãƒ«åˆ¶å¾¡
        document.addEventListener('keydown', (e) => {
            if (gameActive && !gamePaused) {
                if (e.key === 'ArrowRight') {
                    paddle.x = Math.min(paddle.x + paddle.dx * 8, canvas.width - paddle.width);
                } else if (e.key === 'ArrowLeft') {
                    paddle.x = Math.max(paddle.x - paddle.dx * 8, 0);
                }
            }
        });
        
        // ã‚¿ãƒƒãƒæ“ä½œã«ã‚ˆã‚‹ãƒ‘ãƒ‰ãƒ«åˆ¶å¾¡ (ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ)
        let lastTouchX = null;
        canvas.addEventListener('touchstart', (e) => {
            // Tone.jsã®åˆæœŸåŒ– (ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€åˆã®æ“ä½œã§å®Ÿè¡Œ)
            if (Tone.context.state !== 'running') {
                Tone.start();
            }
            if (e.touches.length === 1) {
                lastTouchX = e.touches[0].clientX;
            }
        });
        canvas.addEventListener('touchmove', (e) => {
            if (gameActive && !gamePaused && e.touches.length === 1 && lastTouchX !== null) {
                const currentTouchX = e.touches[0].clientX;
                const deltaX = currentTouchX - lastTouchX;
                
                paddle.x += deltaX * 1.5; 
                
                if (paddle.x < 0) {
                    paddle.x = 0;
                } else if (paddle.x + paddle.width > canvas.width) {
                    paddle.x = canvas.width - paddle.width;
                }
                
                lastTouchX = currentTouchX;
            }
        });
        canvas.addEventListener('touchend', () => {
            lastTouchX = null;
        });


        // é›£æ˜“åº¦å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³)
        difficultySelection.addEventListener('change', (e) => {
             // Tone.jsã®åˆæœŸåŒ– (ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€åˆã®æ“ä½œã§å®Ÿè¡Œ)
            if (Tone.context.state !== 'running') {
                Tone.start();
            }
            // é›£æ˜“åº¦ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ã€ã‚²ãƒ¼ãƒ ã‚’å¼·åˆ¶çš„ã«åˆæœŸåŒ–ã—ã€é–‹å§‹å¾…ã¡çŠ¶æ…‹ã«æˆ»ã™
            resetGame(true); 
            
            // UIã‚’ã€Œã‚²ãƒ¼ãƒ é–‹å§‹ã€ã®çŠ¶æ…‹ã«æˆ»ã™
            startButton.textContent = 'ã‚²ãƒ¼ãƒ é–‹å§‹';
            startButton.disabled = false;
            
            draw(); // æ–°ã—ã„ãƒ–ãƒ­ãƒƒã‚¯é…ç½®ã‚’è¡¨ç¤º
        });


        // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
        startButton.addEventListener('click', () => {
            // Tone.jsã®åˆæœŸåŒ– (ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€åˆã®æ“ä½œã§å®Ÿè¡Œ)
            if (Tone.context.state !== 'running') {
                Tone.start();
            }
            if (!gameActive || bricksLeft === 0) {
                // åˆå›ã‚¹ã‚¿ãƒ¼ãƒˆã¾ãŸã¯ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢å¾Œã®ãƒªã‚»ãƒƒãƒˆ (ãƒ•ãƒ«ãƒªã‚»ãƒƒãƒˆ)
                resetGame(true);
                gameActive = true;
            }
            gamePaused = false;
            startButton.textContent = 'ãƒ—ãƒ¬ã‚¤ä¸­...';
            startButton.disabled = true;
            draw();
        });

        // ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³ (ã‚²ãƒ¼ãƒ é€”ä¸­ã§ã®ãƒªã‚»ãƒƒãƒˆ)
        retryButton.addEventListener('click', () => {
             // Tone.jsã®åˆæœŸåŒ– (ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€åˆã®æ“ä½œã§å®Ÿè¡Œ)
            if (Tone.context.state !== 'running') {
                Tone.start();
            }
            if (gameActive) {
                // ãƒ•ãƒ«ãƒªã‚»ãƒƒãƒˆ
                resetGame(true);
                startButton.textContent = 'ã‚²ãƒ¼ãƒ é–‹å§‹';
                startButton.disabled = false;
                draw();
            }
        });

        // ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ (ãƒãƒ¼ãƒˆæ©Ÿèƒ½)
        cheatSpeedResetButton.addEventListener('click', () => {
            if (!gameActive) {
                return;
            }
            
            const currentSpeed = Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy);
            if (currentSpeed !== 0 && currentSpeed !== originalBallSpeed) {
                const ratio = originalBallSpeed / currentSpeed;
                ball.dx *= ratio;
                ball.dy *= ratio;
                
                clearTimeout(currentPowerUpTimer);
                currentPowerUpTimer = null;
                powerUpStatus.textContent = 'ğŸš¨ ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ ğŸš¨';
                
                setTimeout(() => {
                    if (powerUpStatus.textContent === 'ğŸš¨ ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ ğŸš¨') {
                        powerUpStatus.textContent = '';
                    }
                }, 2000);
            }
        });

        // ã‚¯ã‚¤ã‚ºã®è§£ç­”ãƒœã‚¿ãƒ³
        submitAnswerButton.addEventListener('click', submitQuizAnswer);

        // ã‚¯ã‚¤ã‚ºå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§Enterã‚­ãƒ¼ã‚’æŠ¼ã—ãŸã¨ã
        quizAnswerInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                submitQuizAnswer();
            }
        });

        // ãƒªã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ (ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼/ã‚¯ãƒªã‚¢å¾Œ)
        restartButton.addEventListener('click', () => {
            resetGame(true); // ãƒ•ãƒ«ãƒªã‚»ãƒƒãƒˆ
            startButton.textContent = 'ã‚²ãƒ¼ãƒ é–‹å§‹';
            startButton.disabled = false;
        });

        // åˆæœŸæç”»
        resetGame(false); // åˆæœŸè¡¨ç¤ºã®ãŸã‚ã®ãƒ–ãƒ­ãƒƒã‚¯é…ç½®
        draw();

    </script>
</body>
</html>

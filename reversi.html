<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸–ç•Œéºç”£ã‚ªã‚»ãƒ­ Deluxe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { touch-action: manipulation; }
        .cell { aspect-ratio: 1 / 1; perspective: 1000px; position: relative; }
        
        .disc {
            width: 85%;
            height: 85%;
            border-radius: 50%;
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-style: preserve-3d;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .black { background: radial-gradient(circle at 30% 30%, #444, #000); }
        .white { background: radial-gradient(circle at 30% 30%, #fff, #ccc); border: 1px solid #aaa; }
        
        .placed-anim { animation: dropIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes dropIn {
            0% { transform: scale(2) translateY(-20px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }

        .flip-anim { animation: flipJump 0.6s ease-in-out; }
        @keyframes flipJump {
            0% { transform: rotateY(0deg) scale(1); }
            50% { transform: rotateY(90deg) scale(1.3); }
            100% { transform: rotateY(180deg) scale(1); }
        }

        .ripple {
            position: absolute;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: ripple-out 0.6s ease-out;
            pointer-events: none;
        }
        @keyframes ripple-out {
            from { width: 0; height: 0; opacity: 1; }
            to { width: 150%; height: 150%; opacity: 0; }
        }

        .last-move { z-index: 20; }
        .last-move::before {
            content: ''; position: absolute; inset: -2px;
            border: 3px solid #fbbf24; border-radius: 4px;
            animation: pulse-border 1.5s infinite;
        }
        @keyframes pulse-border {
            0%, 100% { opacity: 1; } 50% { opacity: 0.3; }
        }

        .valid-move::after {
            content: ''; width: 25%; height: 25%; background-color: rgba(255, 255, 255, 0.25);
            border-radius: 50%; position: absolute;
            animation: pulse-hint 2s infinite;
        }
        @keyframes pulse-hint {
            0%, 100% { transform: scale(1); opacity: 0.2; }
            50% { transform: scale(1.5); opacity: 0.5; }
        }

        .flash-correct { animation: flash-g 0.5s ease-out; }
        .flash-wrong { animation: flash-r 0.5s ease-out; }
        @keyframes flash-g { from { background-color: rgba(34, 197, 94, 0.4); } to { background-color: transparent; } }
        @keyframes flash-r { from { background-color: rgba(239, 68, 68, 0.4); } to { background-color: transparent; } }

        .modal-animate { animation: modalIn 0.3s ease-out; }
        @keyframes modalIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="bg-stone-100 min-h-screen font-sans text-slate-800 overflow-hidden transition-colors duration-500" id="body-overlay">

    <div id="app" class="max-w-md mx-auto h-screen flex flex-col p-2">
        
        <!-- Mode Selection (Title Screen) -->
        <div id="mode-selection" class="fixed inset-0 bg-stone-100 z-[100] flex flex-col items-center justify-center p-4 text-center">
            <div class="mb-8 animate-bounce">
                <span class="text-6xl">ğŸ›ï¸</span>
            </div>
            <h1 class="text-4xl font-black text-stone-800 mb-2 tracking-tighter">ä¸–ç•Œéºç”£ã‚ªã‚»ãƒ­</h1>
            <p class="text-stone-500 mb-10 font-medium">çŸ¥è­˜ãŒç›¤é¢ã‚’æ”¯é…ã™ã‚‹</p>
            
            <div class="space-y-4 w-full max-w-xs">
                <button onclick="startGame('pve')" class="group relative w-full bg-stone-800 text-white py-4 rounded-2xl font-bold shadow-xl transition-transform active:scale-95 overflow-hidden">
                    <span class="relative z-10">1äººã§ãƒ—ãƒ¬ã‚¤ (vs PC)</span>
                    <div class="absolute inset-0 bg-white/10 translate-y-full group-hover:translate-y-0 transition-transform"></div>
                </button>
                <button onclick="startGame('pvp')" class="w-full bg-white border-2 border-stone-800 text-stone-800 py-4 rounded-2xl font-bold shadow-lg transition-transform active:scale-95">
                    2äººã§å¯¾æˆ¦
                </button>
                
                <!-- Title Screen Review Button -->
                <button id="review-btn-title" onclick="showReview()" class="w-full bg-amber-100 text-amber-800 py-4 rounded-2xl font-black border-2 border-dashed border-amber-400 hidden animate-pulse transition-all active:scale-95">
                    ğŸ“– å‰å›ã®é–“é•ãˆãŸå•é¡Œã‚’å¾©ç¿’
                </button>
            </div>
        </div>

        <!-- Header -->
        <div class="flex justify-between items-center mb-3 px-2">
            <div class="flex items-center space-x-3">
                <h1 class="text-xl font-black text-stone-800 tracking-tight">DELUXE</h1>
                <button onclick="confirmRetry()" class="flex items-center space-x-1 bg-white border-2 border-stone-200 hover:border-red-400 hover:text-red-500 px-3 py-1 rounded-full text-xs font-black transition-all shadow-sm active:scale-90">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    <span>ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</span>
                </button>
            </div>
            <div id="turn-indicator" class="px-4 py-1 rounded-full shadow-inner font-black text-xs transition-all duration-300">é»’ã®ç•ª</div>
        </div>

        <!-- Scoreboard -->
        <div class="grid grid-cols-3 gap-2 items-center bg-white p-3 rounded-2xl shadow-md mb-3 border-b-4 border-stone-200">
            <div class="flex flex-col items-center">
                <div class="w-8 h-8 rounded-full black mb-1 shadow-lg ring-2 ring-stone-800 ring-offset-2"></div>
                <span class="text-2xl font-black leading-none" id="black-score">2</span>
            </div>
            <div class="text-center">
                <div id="status-message" class="text-[10px] font-black uppercase tracking-widest text-stone-400 h-4"></div>
                <div class="text-[8px] font-bold text-stone-300 mt-1">SCORE</div>
            </div>
            <div class="flex flex-col items-center">
                <div class="w-8 h-8 rounded-full white mb-1 shadow-md ring-2 ring-stone-200 ring-offset-2"></div>
                <span class="text-2xl font-black leading-none" id="white-score">2</span>
            </div>
        </div>

        <!-- Board -->
        <div class="flex-1 flex items-center justify-center min-h-0">
            <div id="board" class="grid grid-cols-8 gap-1 bg-emerald-800 p-1.5 rounded-xl shadow-2xl border-8 border-stone-800 w-full aspect-square max-w-[380px]"></div>
        </div>

        <!-- Footer Info -->
        <div class="mt-4 text-center text-[10px] font-bold text-stone-400 uppercase tracking-widest">
            World Heritage Othello Quiz Edition
        </div>

        <!-- Quiz Modal -->
        <div id="quiz-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[120] p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden modal-animate border-4 border-stone-800">
                <div id="quiz-header" class="bg-stone-800 text-white p-3 flex justify-between items-center">
                    <span id="quiz-level" class="bg-amber-400 px-3 py-1 rounded-full text-stone-900 font-black text-xs">LV.1</span>
                    <span class="text-xs font-bold animate-pulse">æ­£è§£ã™ã‚Œã°é…ç½®ã§ãã¾ã™</span>
                </div>
                <div class="p-6">
                    <p id="quiz-question" class="text-lg font-black mb-6 text-slate-800 leading-tight"></p>
                    <div id="quiz-options" class="grid grid-cols-1 gap-3"></div>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirm-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-[130] p-6 backdrop-blur-md">
            <div class="bg-white p-8 rounded-3xl max-w-xs w-full shadow-2xl text-center border-4 border-stone-800">
                <div class="text-4xl mb-4">âš ï¸</div>
                <p class="font-black text-xl mb-6 leading-tight">ä¸­æ–­ã—ã¦<br>ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹ï¼Ÿ</p>
                <div class="flex space-x-3">
                    <button onclick="closeConfirm()" class="flex-1 py-3 bg-stone-100 rounded-2xl font-black text-stone-500 active:scale-95">ã‚„ã‚ã‚‹</button>
                    <button onclick="location.reload()" class="flex-1 py-3 bg-red-500 rounded-2xl font-black text-white shadow-lg active:scale-95">æˆ»ã‚‹</button>
                </div>
            </div>
        </div>

        <!-- Review Modal -->
        <div id="review-modal" class="fixed inset-0 bg-stone-100 hidden flex-col z-[150] p-4 overflow-y-auto">
            <div class="max-w-md mx-auto w-full">
                <div class="flex justify-between items-center mb-6 border-b-4 border-stone-200 pb-4">
                    <h2 class="text-2xl font-black flex items-center">
                        <span class="mr-2">ğŸ“</span> ä»Šå›ã®å¾©ç¿’
                    </h2>
                    <button onclick="closeReview()" class="bg-stone-200 p-2 rounded-full active:scale-90 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="review-list" class="space-y-4 pb-24"></div>
                <div class="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-stone-100 to-transparent">
                    <button onclick="closeReview()" class="max-w-md mx-auto w-full bg-stone-800 text-white py-4 rounded-2xl font-black shadow-2xl active:scale-95 transition-transform">
                        ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹
                    </button>
                </div>
            </div>
        </div>

        <!-- Game Over Modal -->
        <div id="gameover-modal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[140] p-4 text-center backdrop-blur-md">
            <div class="bg-white p-8 rounded-[40px] max-w-xs w-full shadow-2xl border-t-8 border-amber-400">
                <h2 class="text-4xl font-black mb-2 text-stone-800 italic">FINISH!</h2>
                <div id="winner-text" class="text-xl font-black mb-6 text-amber-600 underline decoration-stone-800"></div>
                
                <div class="flex justify-center space-x-8 mb-8">
                    <div class="text-center">
                        <div class="w-10 h-10 black rounded-full mx-auto mb-1 ring-2 ring-offset-2 ring-stone-800"></div>
                        <span class="text-3xl font-black" id="final-black">0</span>
                    </div>
                    <div class="text-center">
                        <div class="w-10 h-10 white rounded-full mx-auto mb-1 ring-2 ring-offset-2 ring-stone-200"></div>
                        <span class="text-3xl font-black" id="final-white">0</span>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <button id="review-btn-end" onclick="showReview()" class="w-full bg-amber-400 text-stone-900 py-3 rounded-2xl font-black shadow-lg hover:bg-amber-300 active:scale-95 transition-all">
                        é–“é•ãˆãŸå•é¡Œã‚’å¾©ç¿’
                    </button>
                    <button onclick="location.reload()" class="w-full bg-stone-100 text-stone-400 py-3 rounded-2xl font-black hover:bg-stone-200 active:scale-95 transition-all">
                        ã‚¿ã‚¤ãƒˆãƒ«ã¸
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ 
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const filter = audioCtx.createBiquadFilter();
            
            osc.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;
            
            if (type === 'place') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(80, now + 0.15);
                gain.gain.setValueAtTime(0.5, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc.start(); osc.stop(now + 0.15);
            } else if (type === 'flip') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(400, now + 0.1);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(); osc.stop(now + 0.1);
            } else if (type === 'correct') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, now);
                osc.frequency.setValueAtTime(659.25, now + 0.1);
                osc.frequency.setValueAtTime(783.99, now + 0.2);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                osc.start(); osc.stop(now + 0.4);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth';
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(400, now);
                osc.frequency.setValueAtTime(120, now);
                osc.frequency.linearRampToValueAtTime(80, now + 0.3);
                gain.gain.setValueAtTime(0.4, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(); osc.stop(now + 0.3);
            }
        }

        const quizData = [
            { level: 1, q: "å§«è·¯åŸã®åˆ¥åã¯ï¼Ÿ", a: ["ç™½é·ºåŸ", "çƒåŸ", "é‡‘äº€åŸ", "ç™½å±±åŸ"], correct: 0 },
            { level: 1, q: "ãƒ¢ãƒ³ãƒ»ã‚µãƒ³ãƒ»ãƒŸã‚·ã‚§ãƒ«ã¯ä½•ï¼Ÿ", a: ["ä¿®é“é™¢", "è¦å¡", "ç‹å®®", "ç‰¢ç„"], correct: 0 },
            { level: 1, q: "ã‚°ãƒ¬ãƒ¼ãƒˆãƒ»ãƒãƒªã‚¢ãƒ»ãƒªãƒ¼ãƒ•ã¯ã©ã“ï¼Ÿ", a: ["è±ªå·", "ç±³å›½", "æ—¥æœ¬", "ãƒ•ã‚£ã‚¸ãƒ¼"], correct: 0 },
            { level: 1, q: "æœ€å¤§ã®ãƒ”ãƒ©ãƒŸãƒƒãƒ‰ã¯èª°ã®ï¼Ÿ", a: ["ã‚¯ãƒ•ç‹", "ã‚«ãƒ•ãƒ©ãƒ¼ç‹", "ãƒ¡ãƒ³ã‚«ã‚¦ãƒ©ãƒ¼ç‹", "ãƒ©ãƒ ã‚»ã‚¹"], correct: 0 },
            { level: 1, q: "ä¸‡é‡Œã®é•·åŸã®ç›®çš„ã¯ï¼Ÿ", a: ["å¤–æ•µä¾µå…¥é˜²æ­¢", "è²¿æ˜“è·¯", "çŒæ¼‘", "çš‡å¸ã®å¢“"], correct: 0 },
            { level: 1, q: "è‡ªç”±ã®å¥³ç¥ã¯ã©ã“ã‹ã‚‰è´ˆã‚‰ã‚ŒãŸï¼Ÿ", a: ["ãƒ•ãƒ©ãƒ³ã‚¹", "ã‚¤ã‚®ãƒªã‚¹", "ãƒ‰ã‚¤ãƒ„", "ã‚¤ã‚¿ãƒªã‚¢"], correct: 0 },
            { level: 1, q: "ä¸–ç•Œéºç”£ã‚’ç™»éŒ²ã™ã‚‹çµ„ç¹”ã¯ï¼Ÿ", a: ["ãƒ¦ãƒã‚¹ã‚³", "ãƒ¦ãƒ‹ã‚»ãƒ•", "WHO", "WTO"], correct: 0 },
            { level: 1, q: "å±‹ä¹…å³¶ã¨ã„ãˆã°ä½•ã®æœ¨ï¼Ÿ", a: ["ã‚¹ã‚®", "ãƒãƒ„", "ãƒ’ãƒã‚­", "ã‚±ãƒ¤ã‚­"], correct: 0 },
            { level: 1, q: "ã‚³ãƒ­ãƒƒã‚»ã‚ªãŒã‚ã‚‹å›½ã¯ï¼Ÿ", a: ["ã‚¤ã‚¿ãƒªã‚¢", "ã‚®ãƒªã‚·ãƒ£", "ãƒˆãƒ«ã‚³", "ã‚¨ã‚¸ãƒ—ãƒˆ"], correct: 0 },
            { level: 1, q: "ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«ãƒ»ãƒ¯ãƒƒãƒˆãŒã‚ã‚‹å›½ã¯ï¼Ÿ", a: ["ã‚«ãƒ³ãƒœã‚¸ã‚¢", "ãƒ™ãƒˆãƒŠãƒ ", "ã‚¿ã‚¤", "ãƒ©ã‚ªã‚¹"], correct: 0 },
            { level: 1, q: "å¯Œå£«å±±ã¯æ–‡åŒ–ãƒ»è‡ªç„¶ã©ã¡ã‚‰ã®éºç”£ï¼Ÿ", a: ["æ–‡åŒ–éºç”£", "è‡ªç„¶éºç”£", "è¤‡åˆéºç”£", "å±æ©Ÿéºç”£"], correct: 0 },
            { level: 1, q: "ãƒãƒãƒ¥ãƒ»ãƒ”ãƒãƒ¥ãŒã‚ã‚‹å›½ã¯ï¼Ÿ", a: ["ãƒšãƒ«ãƒ¼", "ãƒ–ãƒ©ã‚¸ãƒ«", "ãƒãƒª", "ãƒ¡ã‚­ã‚·ã‚³"], correct: 0 },
            { level: 2, q: "ãƒ™ãƒãƒã‚¢ã®ä¸»è¦ãªé‹æ²³ã¯ï¼Ÿ", a: ["ã‚«ãƒŠãƒ«ãƒ»ã‚°ãƒ©ãƒ³ãƒ‡", "ã‚µãƒ³ãƒãƒ«ã‚³", "ã‚¹ã‚¨ã‚º", "ãƒ‘ãƒŠãƒ"], correct: 0 },
            { level: 2, q: "ã‚µã‚°ãƒ©ãƒ€ãƒ»ãƒ•ã‚¡ãƒŸãƒªã‚¢ã®è¨­è¨ˆè€…ã¯ï¼Ÿ", a: ["ã‚¬ã‚¦ãƒ‡ã‚£", "ã‚³ãƒ«ãƒ“ãƒ¥ã‚¸ã‚¨", "ãƒ€ãƒ»ãƒ´ã‚£ãƒ³ãƒ", "ãƒŸã‚±ãƒ©ãƒ³ã‚¸ã‚§ãƒ­"], correct: 0 },
            { level: 2, q: "ã‚¬ãƒ©ãƒ‘ã‚´ã‚¹è«¸å³¶ã¯ã©ã“ã®å›½ï¼Ÿ", a: ["ã‚¨ã‚¯ã‚¢ãƒ‰ãƒ«", "ãƒšãƒ«ãƒ¼", "ãƒãƒª", "ã‚³ãƒ­ãƒ³ãƒ“ã‚¢"], correct: 0 },
            { level: 2, q: "ã‚¹ãƒˆãƒ¼ãƒ³ãƒ˜ãƒ³ã‚¸ã¯ä½•æ™‚ä»£ï¼Ÿ", a: ["æ–°çŸ³å™¨æ™‚ä»£", "ãƒ­ãƒ¼ãƒæ™‚ä»£", "ä¸­ä¸–", "ãƒ«ãƒã‚µãƒ³ã‚¹"], correct: 0 },
            { level: 2, q: "ã‚­ãƒªã‚¹ãƒˆåƒã®ã‚ã‚‹å±±ã¯ï¼Ÿ", a: ["ã‚³ãƒ«ã‚³ãƒãƒ¼ãƒ‰", "ãƒ¢ãƒ³ãƒ–ãƒ©ãƒ³", "å¯Œå£«å±±", "ã‚­ãƒªãƒãƒ³ã‚¸ãƒ£ãƒ­"], correct: 0 },
            { level: 2, q: "å³å³¶ç¥ç¤¾ã‚’æ•´ãˆãŸäººç‰©ã¯ï¼Ÿ", a: ["å¹³æ¸…ç››", "æºé ¼æœ", "è¶³åˆ©ç¾©æº€", "è±Šè‡£ç§€å‰"], correct: 0 },
            { level: 2, q: "ãƒšãƒˆãƒ©éºè·¡ã¯ä½•è‰²ã®éƒ½å¸‚ï¼Ÿ", a: ["ãƒãƒ©è‰²", "é»„é‡‘è‰²", "ç´”ç™½è‰²", "ç¢§è‰²"], correct: 0 },
            { level: 2, q: "ãƒã‚¤ã‚·ãƒ¥ãƒ´ã‚¡ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³åŸã¯ã©ã“ï¼Ÿ", a: ["ãƒ‰ã‚¤ãƒ„", "ã‚ªãƒ¼ã‚¹ãƒˆãƒªã‚¢", "ã‚¹ã‚¤ã‚¹", "ãƒ•ãƒ©ãƒ³ã‚¹"], correct: 0 },
            { level: 2, q: "æ—¥å…‰æ±ç…§å®®ã®æœ‰åãªå½«åˆ»ã¯ï¼Ÿ", a: ["ä¸‰çŒ¿", "ä¸‰é³¥", "ä¸‰çŠ¬", "ä¸‰é¾"], correct: 0 },
            { level: 2, q: "å±‹ä¹…å³¶ã®æœ€é«˜å³°ã®åå‰ã¯ï¼Ÿ", a: ["å®®ä¹‹æµ¦å²³", "æ°¸ç”°å²³", "æ —ç”Ÿå²³", "é»’å‘³å²³"], correct: 0 },
            { level: 2, q: "ã‚¨ã‚¢ãƒ¼ã‚ºãƒ»ãƒ­ãƒƒã‚¯ã®ç¾åœ°åã¯ï¼Ÿ", a: ["ã‚¦ãƒ«ãƒ«", "ã‚«ãƒãƒ¥ãƒ»ã‚¿", "ãƒ ãƒ«ã‚¬", "ãƒ”ãƒª"], correct: 0 },
            { level: 2, q: "ã‚¿ãƒ¼ã‚¸ãƒ»ãƒãƒãƒ«ã¯ä½•ã§ä½œã‚‰ã‚ŒãŸï¼Ÿ", a: ["ç™½å¤§ç†çŸ³", "èµ¤ãƒ¬ãƒ³ã‚¬", "é’éŠ…", "ç ‚å²©"], correct: 0 },
            { level: 3, q: "ã‚¿ãƒ¼ã‚¸ãƒ»ãƒãƒãƒ«ã‚’å»ºã¦ãŸçš‡å¸ã¯ï¼Ÿ", a: ["ã‚·ãƒ£ãƒ¼ãƒ»ã‚¸ãƒ£ãƒãƒ¼ãƒ³", "ã‚¢ã‚¯ãƒãƒ«", "ãƒãƒ¼ãƒ–ãƒ«", "ã‚¸ãƒ£ãƒãƒ¼ãƒ³ã‚®ãƒ¼ãƒ«"], correct: 0 },
            { level: 3, q: "ãƒ™ãƒ«ã‚µã‚¤ãƒ¦å®®æ®¿ã‚’åºƒã’ãŸç‹ã¯ï¼Ÿ", a: ["ãƒ«ã‚¤14ä¸–", "ãƒ«ã‚¤16ä¸–", "ãƒŠãƒãƒ¬ã‚ªãƒ³", "ãƒ«ã‚¤ãƒ»ãƒ•ã‚£ãƒªãƒƒãƒ—"], correct: 0 },
            { level: 3, q: "ã‚·ãƒ³ã‚°ãƒ´ã‚§ãƒˆãƒªãƒ«ã«ã‚ã‚‹ä¸–ç•Œæœ€å¤ã®è­°ä¼šã¯ï¼Ÿ", a: ["ã‚¢ãƒ«ã‚·ãƒ³ã‚°", "ãƒ€ã‚¤ãƒ«", "å›½ä¼š", "ã‚³ãƒ«ãƒ†ã‚¹"], correct: 0 },
            { level: 3, q: "ã‚«ãƒƒãƒ‘ãƒ‰ã‚­ã‚¢ã®åœ°ä¸‹æ–½è¨­ã¯èª°ãŒä½¿ã£ãŸï¼Ÿ", a: ["ã‚­ãƒªã‚¹ãƒˆæ•™å¾’", "ä»æ•™å¾’", "ã‚¤ã‚¹ãƒ©ãƒ æ•™å¾’", "ãƒ’ãƒ³ãƒ‰ã‚¥ãƒ¼æ•™å¾’"], correct: 0 },
            { level: 3, q: "ãƒãƒã‚§ãƒ³ãƒ»ã‚¤ãƒ„ã‚¡ã®ãƒ”ãƒ©ãƒŸãƒƒãƒ‰åã¯ï¼Ÿ", a: ["ã‚¨ãƒ«ãƒ»ã‚«ã‚¹ãƒ†ã‚£ãƒ¼ã‚¸ãƒ§", "ãƒ†ã‚ªãƒ†ã‚£ãƒ¯ã‚«ãƒ³", "ã‚¦ã‚·ãƒ¥ãƒãƒ«", "ãƒ‘ãƒ¬ãƒ³ã‚±"], correct: 0 },
            { level: 3, q: "å¯Œå²¡è£½ç³¸å ´ã®æŠ€è¡“å°å…¥å›½ã¯ï¼Ÿ", a: ["ãƒ•ãƒ©ãƒ³ã‚¹", "ã‚¤ã‚®ãƒªã‚¹", "ã‚¤ã‚¿ãƒªã‚¢", "ã‚¢ãƒ¡ãƒªã‚«"], correct: 0 },
            { level: 3, q: "ã‚¤ã‚°ã‚¢ã‚¹ã®æ»ãŒã‚ã‚‹å›½ã¯ï¼Ÿ", a: ["ã‚¢ãƒ«ã‚¼ãƒ³ãƒãƒ³ãƒ»ãƒ–ãƒ©ã‚¸ãƒ«", "ãƒšãƒ«ãƒ¼ãƒ»ãƒœãƒªãƒ“ã‚¢", "ãƒãƒªãƒ»ã‚¢ãƒ«ã‚¼ãƒ³ãƒãƒ³", "ãƒ™ãƒã‚ºã‚¨ãƒ©"], correct: 0 },
            { level: 3, q: "ç™½å·éƒ·ã®å»ºç¯‰æ§˜å¼ã¯ï¼Ÿ", a: ["åˆæŒé€ ã‚Š", "å…¥æ¯å±‹é€ ã‚Š", "å¯„æ£Ÿé€ ã‚Š", "åˆ‡å¦»é€ ã‚Š"], correct: 0 },
            { level: 3, q: "ã‚¢ãƒ«ãƒãƒ³ãƒ–ãƒ©å®®æ®¿ã¯ã©ã“ï¼Ÿ", a: ["ã‚¹ãƒšã‚¤ãƒ³", "ãƒ¢ãƒ­ãƒƒã‚³", "ãƒãƒ«ãƒˆã‚¬ãƒ«", "ã‚¤ã‚¿ãƒªã‚¢"], correct: 0 },
            { level: 3, q: "ãƒŠã‚¹ã‚«ã®åœ°ä¸ŠçµµãŒã‚ã‚‹å›½ã¯ï¼Ÿ", a: ["ãƒšãƒ«ãƒ¼", "ãƒ¡ã‚­ã‚·ã‚³", "ã‚³ãƒ­ãƒ³ãƒ“ã‚¢", "ãƒœãƒªãƒ“ã‚¢"], correct: 0 },
            { level: 3, q: "ãƒ¢ãƒ³ãƒ»ã‚µãƒ³ãƒ»ãƒŸã‚·ã‚§ãƒ«ã®æ¹¾ã®å¹²æº€å·®ã¯ï¼Ÿ", a: ["ç´„15m", "ç´„5m", "ç´„25m", "ç´„1m"], correct: 0 },
            { level: 3, q: "ãƒ«ãƒ»ã‚³ãƒ«ãƒ“ãƒ¥ã‚¸ã‚¨ãŒè¨­è¨ˆã—ãŸæ—¥æœ¬ã®å»ºç‰©ã¯ï¼Ÿ", a: ["å›½ç«‹è¥¿æ´‹ç¾è¡“é¤¨", "æ±äº¬å›½ç«‹åšç‰©é¤¨", "å›½ç«‹ç«¶æŠ€å ´", "éƒ½åº"], correct: 0 },
            { level: 4, q: "å¹³æ³‰ãŒè¡¨ã™ç†æƒ³ã®ä¸–ç•Œã¯ï¼Ÿ", a: ["æµ„åœŸ", "å¤©å›½", "æ¶…æ§ƒ", "æ¡ƒæºéƒ·"], correct: 0 },
            { level: 4, q: "ãƒ©ãƒªãƒ™ãƒ©ã®æ•™ä¼šã¯ã©ã†ä½œã£ãŸï¼Ÿ", a: ["å²©ã‚’ãã‚ŠæŠœã„ãŸ", "çŸ³ã‚’ç©ã‚“ã ", "ãƒ¬ãƒ³ã‚¬è£½", "æœ¨é€ "], correct: 0 },
            { level: 4, q: "ãƒ“ãƒƒã‚°ãƒ»ãƒ™ãƒ³ã®æ­£å¼åç§°ã¯ï¼Ÿ", a: ["ã‚¨ãƒªã‚¶ãƒ™ã‚¹ãƒ»ã‚¿ãƒ¯ãƒ¼", "ãƒ“ã‚¯ãƒˆãƒªã‚¢ãƒ»ã‚¿ãƒ¯ãƒ¼", "ã‚¸ãƒ§ãƒ¼ã‚¸ãƒ»ã‚¿ãƒ¯ãƒ¼", "ãƒ­ã‚¤ãƒ¤ãƒ«ãƒ»ã‚¿ãƒ¯ãƒ¼"], correct: 0 },
            { level: 4, q: "è»è‰¦å³¶ã®æ¡æ˜è³‡æºã¯ï¼Ÿ", a: ["çŸ³ç‚­", "é‡‘", "éŠ€", "éŠ…"], correct: 0 },
            { level: 4, q: "ãƒ­ãƒ™ãƒ³å³¶ã«åç›£ã•ã‚Œã¦ã„ãŸã®ã¯ï¼Ÿ", a: ["ãƒãƒ³ãƒ‡ãƒ©", "ã‚¬ãƒ³ãƒ‡ã‚£ãƒ¼", "ãƒã‚§ãƒ»ã‚²ãƒãƒ©", "ã‚¢ã‚¦ãƒ³ã‚µãƒ³ã‚¹ãƒ¼ãƒãƒ¼"], correct: 0 },
            { level: 4, q: "ã‚¤ãƒ¼ã‚¹ã‚¿ãƒ¼å³¶ã®ç¾åœ°åã¯ï¼Ÿ", a: ["ãƒ©ãƒ‘ãƒ»ãƒŒã‚¤", "ãƒ¢ã‚¢ã‚¤ãƒ»ã‚¢ã‚¤ãƒ©ãƒ³ãƒ‰", "ãƒ›ãƒ„ãƒ»ãƒãƒ„ã‚¢", "ã‚¢ãƒŠãƒ»ã‚±ãƒŠ"], correct: 0 },
            { level: 4, q: "ç†Šé‡å¤é“ãŒã‚ã‚‹å ´æ‰€ã¯ï¼Ÿ", a: ["ç´€ä¼Šå±±åœ°", "åŒ—ä¸Šå±±åœ°", "é£›é¨¨å±±è„ˆ", "é˜¿æ­¦éšˆé«˜åœ°"], correct: 0 },
            { level: 4, q: "ã‚¢ãƒ†ãƒã®ãƒ‘ãƒ«ãƒ†ãƒãƒ³ç¥æ®¿ã®æ§˜å¼ã¯ï¼Ÿ", a: ["ãƒ‰ãƒ¼ãƒªã‚¢å¼", "ã‚¤ã‚ªãƒ‹ã‚¢å¼", "ã‚³ãƒªãƒ³ãƒˆå¼", "ãƒˆã‚¹ã‚«ãƒŠå¼"], correct: 0 },
            { level: 4, q: "ã‚°ãƒ¬ãƒ¼ãƒˆãƒ»ã‚¸ãƒãƒ–ã‚¦ã‚§éºè·¡ã¯ä½•æ–‡æ˜ï¼Ÿ", a: ["ã‚·ãƒ§ãƒŠæ–‡æ˜", "ã‚ºãƒ¼ãƒ«ãƒ¼æ–‡æ˜", "ãƒãƒ³ãƒ„ãƒ¼æ–‡æ˜", "ã‚¢ã‚¯ã‚¹ãƒ æ–‡æ˜"], correct: 0 },
            { level: 4, q: "å°ç¬ åŸè«¸å³¶ãŒç™»éŒ²ã•ã‚ŒãŸç†ç”±ã¯ï¼Ÿ", a: ["ç‹¬è‡ªã®é€²åŒ–ï¼ˆé©å¿œæ”¾æ•£ï¼‰", "ç«å±±ã®æ´»å‹•", "æ¸¡ã‚Šé³¥ã®ä¸­ç¶™åœ°", "ã‚µãƒ³ã‚´ã®ç¾ã—ã•"], correct: 0 },
            { level: 4, q: "æ³•éš†å¯ºã«ã‚ã‚‹æ—¥æœ¬æœ€å¤ã®å¡”ã¯ï¼Ÿ", a: ["äº”é‡å¡”", "ä¸‰é‡å¡”", "å¤šå®å¡”", "å®ç¯‹å°å¡”"], correct: 0 },
            { level: 4, q: "ã‚«ã‚¶ãƒ³è–å ‚ãŒã‚ã‚‹ãƒ­ã‚·ã‚¢ã®éƒ½å¸‚ã¯ï¼Ÿ", a: ["ã‚µãƒ³ã‚¯ãƒˆãƒšãƒ†ãƒ«ãƒ–ãƒ«ã‚¯", "ãƒ¢ã‚¹ã‚¯ãƒ¯", "ãƒãƒ´ã‚´ãƒ­ãƒ‰", "ã‚«ã‚¶ãƒ³"], correct: 0 },
            { level: 5, q: "ä¸–ç•Œæœ€å¤§ã®æ´çªŸã‚½ãƒ³ãƒ‰ãƒ³æ´ã¯ã©ã“ï¼Ÿ", a: ["ãƒ™ãƒˆãƒŠãƒ ", "ãƒ©ã‚ªã‚¹", "ä¸­å›½", "ãƒ•ã‚£ãƒªãƒ”ãƒ³"], correct: 0 },
            { level: 5, q: "ã‚¸ã‚§ãƒ³ãƒæ—§å¸‚è¡—ã®æœ‰åãªå»ºç‰©ã¯ï¼Ÿ", a: ["æ³¥ã®ãƒ¢ã‚¹ã‚¯", "çŸ³ã®å¡”", "ãƒ¬ãƒ³ã‚¬ã®å®®æ®¿", "ç«¹ã®å¯º"], correct: 0 },
            { level: 5, q: "ãƒ‘ãƒ«ãƒŸãƒ©éºè·¡ã®å¥³ç‹ã¯ï¼Ÿ", a: ["ã‚¼ãƒãƒ“ã‚¢", "ã‚¯ãƒ¬ã‚ªãƒ‘ãƒˆãƒ©", "ãƒãƒ•ã‚§ãƒ«ãƒ†ã‚£ãƒ†ã‚£", "ã‚¨ãƒªã‚¶ãƒ™ã‚¹"], correct: 0 },
            { level: 5, q: "æœ€å¤§ã®å¢³å¢“ãƒ»ä»å¾³å¤©çš‡é™µã¯ä½•å½¢ï¼Ÿ", a: ["å‰æ–¹å¾Œå††å¢³", "å††å¢³", "æ–¹å¢³", "å…«è§’å¢³"], correct: 0 },
            { level: 5, q: "ãƒ–ãƒ«ãƒ¼ãƒ›ãƒ¼ãƒ«ãŒã‚ã‚‹ãƒãƒªã‚¢ãƒªãƒ¼ãƒ•ã¯ï¼Ÿ", a: ["ãƒ™ãƒªãƒ¼ã‚º", "ãƒãƒãƒ", "ã‚¸ãƒ£ãƒã‚¤ã‚«", "ã‚­ãƒ¥ãƒ¼ãƒ"], correct: 0 },
            { level: 5, q: "é‡˜ã‚’ä¸€æœ¬ã‚‚ä½¿ã‚ãªã„ã‚­ã‚¸å³¶ã®æ•™ä¼šã¯ï¼Ÿ", a: ["ãƒ—ãƒ¬ã‚ªãƒ–ãƒ©ã‚¸ã‚§ãƒ³ã‚¹ã‚«ãƒ¤", "ãƒ¯ã‚·ãƒªãƒ¼", "ã‚«ã‚¶ãƒ³", "æ•‘ä¸–ä¸»"], correct: 0 },
            { level: 5, q: "ã‚«ãƒ«ã‚«ã‚½ãƒ³ãƒŒã¯ä½•éƒ½å¸‚ï¼Ÿ", a: ["åŸå¡éƒ½å¸‚", "å®—æ•™éƒ½å¸‚", "æ¸¯æ¹¾éƒ½å¸‚", "å­¦è¡“éƒ½å¸‚"], correct: 0 },
            { level: 5, q: "ã‚¬ãƒ©ãƒ‘ã‚´ã‚¹ã®ç”±æ¥ã®ç”Ÿãç‰©ã¯ï¼Ÿ", a: ["ã‚¾ã‚¦ã‚¬ãƒ¡", "ã‚¤ã‚°ã‚¢ãƒŠ", "ãƒ•ã‚£ãƒ³ãƒ", "ãƒšãƒ³ã‚®ãƒ³"], correct: 0 },
            { level: 5, q: "ã‚«ãƒˆãƒãƒ³ã‚ºç›†åœ°ã®ä¸»ãªå®—æ•™ã¯ï¼Ÿ", a: ["ä»æ•™ã¨ãƒ’ãƒ³ãƒ‰ã‚¥ãƒ¼æ•™", "ã‚­ãƒªã‚¹ãƒˆæ•™", "ã‚¤ã‚¹ãƒ©ãƒ æ•™", "é“æ•™"], correct: 0 },
            { level: 5, q: "ã‚µãƒãƒ«ã‚«ãƒ³ãƒ‰ã¯ä½•ã®é’ã¨è¨€ã‚ã‚Œã‚‹ï¼Ÿ", a: ["ã‚µãƒãƒ«ã‚«ãƒ³ãƒ‰ãƒ»ãƒ–ãƒ«ãƒ¼", "ã‚¿ãƒ¼ã‚³ã‚¤ã‚ºãƒ»ãƒ–ãƒ«ãƒ¼", "ãƒ­ã‚¤ãƒ¤ãƒ«ãƒ»ãƒ–ãƒ«ãƒ¼", "ã‚¹ã‚«ã‚¤ãƒ»ãƒ–ãƒ«ãƒ¼"], correct: 0 },
            { level: 5, q: "å¤ä»£ã‚®ãƒªã‚·ãƒ£ã®ãƒ‡ãƒ«ãƒ•ã‚£ã«ã‚ã‚‹ç¥è¨—ã®ç¥ã¯ï¼Ÿ", a: ["ã‚¢ãƒãƒ­ãƒ³", "ã‚¼ã‚¦ã‚¹", "ãƒã‚»ã‚¤ãƒ‰ãƒ³", "ã‚¢ãƒ†ãƒŠ"], correct: 0 },
            { level: 5, q: "æ—¥æœ¬ã®ã€Œä½æ¸¡å³¶ã€ãŒ2024å¹´ã«ç™»éŒ²ã•ã‚ŒãŸç†ç”±ã¯ï¼Ÿ", a: ["é‡‘é‰±å±±éºç”£", "éŠ€å±±éºç”£", "éŠ…å±±éºç”£", "çŸ³ç‚­éºç”£"], correct: 0 }
        ];

        let board = [], turn = 1, pendingMove = null, gameMode = 'pvp', isProcessing = false;
        let lastMovePos = null, lastFlippedPositions = [];
        let wrongQuestions = []; // ã‚²ãƒ¼ãƒ ã”ã¨ã«ãƒªã‚»ãƒƒãƒˆã™ã‚‹ãŸã‚ç©ºé…åˆ—ã§åˆæœŸåŒ–
        let currentQuiz = null;

        const boardEl = document.getElementById('board');
        const turnIndicator = document.getElementById('turn-indicator');
        const blackScoreEl = document.getElementById('black-score');
        const whiteScoreEl = document.getElementById('white-score');
        const quizModal = document.getElementById('quiz-modal');
        const statusMsg = document.getElementById('status-message');

        window.onload = () => {
            updateReviewButtons();
        }

        function updateReviewButtons() {
            const hasWrong = wrongQuestions.length > 0;
            document.getElementById('review-btn-title').classList.toggle('hidden', !hasWrong);
            document.getElementById('review-btn-end').classList.toggle('hidden', !hasWrong);
        }

        function startGame(mode) {
            gameMode = mode;
            // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«å¾©ç¿’ãƒªã‚¹ãƒˆã‚’åˆ·æ–°
            wrongQuestions = [];
            updateReviewButtons();
            document.getElementById('mode-selection').style.display = 'none';
            initGame();
        }

        function initGame() {
            board = Array(8).fill(null).map(() => Array(8).fill(0));
            board[3][3] = 2; board[4][4] = 2; board[3][4] = 1; board[4][3] = 1;
            turn = 1; isProcessing = false; lastMovePos = null; lastFlippedPositions = [];
            render(); checkTurnPossible();
        }

        function confirmRetry() {
            document.getElementById('confirm-modal').style.display = 'flex';
        }
        function closeConfirm() {
            document.getElementById('confirm-modal').style.display = 'none';
        }

        function showReview() {
            const listEl = document.getElementById('review-list');
            listEl.innerHTML = '';
            
            if (wrongQuestions.length === 0) {
                listEl.innerHTML = '<p class="text-center text-stone-400 font-bold py-10">ä»Šå›ã®å¯¾å±€ã§é–“é•ãˆãŸå•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            } else {
                wrongQuestions.forEach((q, idx) => {
                    const card = document.createElement('div');
                    card.className = "bg-white p-6 rounded-3xl shadow-md border-2 border-amber-200";
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                             <p class="bg-amber-100 text-amber-800 px-3 py-0.5 rounded-full text-[10px] font-black">QUESTION ${idx + 1}</p>
                             <span class="text-[10px] font-bold text-stone-300 uppercase">Level ${q.level}</span>
                        </div>
                        <p class="text-base font-black mb-4 text-stone-800 leading-snug">${q.q}</p>
                        <div class="bg-emerald-50 p-3 rounded-2xl border-2 border-emerald-100">
                            <p class="text-[10px] text-emerald-600 font-black uppercase mb-1">Correct Answer</p>
                            <p class="text-base font-black text-emerald-800">${q.a[q.correct]}</p>
                        </div>
                    `;
                    listEl.appendChild(card);
                });
            }
            document.getElementById('review-modal').style.display = 'flex';
        }

        function closeReview() {
            document.getElementById('review-modal').style.display = 'none';
        }

        function createRipple(el) {
            const ripple = document.createElement('div');
            ripple.className = 'ripple';
            el.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        }

        function render() {
            boardEl.innerHTML = '';
            let b = 0, w = 0;
            const valid = getValidMoves(turn);
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const cell = document.createElement('div');
                    cell.className = `cell bg-emerald-700 hover:bg-emerald-600 transition-colors flex items-center justify-center rounded-sm ${lastMovePos?.r === r && lastMovePos?.c === c ? 'last-move' : ''}`;
                    if (board[r][c] !== 0) {
                        const disc = document.createElement('div');
                        const isFlipping = lastFlippedPositions.some(p => p.r === r && p.c === c);
                        const isNew = lastMovePos?.r === r && lastMovePos?.c === c;
                        
                        disc.className = `disc ${board[r][c] === 1 ? 'black' : 'white'} ${isNew ? 'placed-anim' : isFlipping ? 'flip-anim' : ''}`;
                        cell.appendChild(disc);
                        board[r][c] === 1 ? b++ : w++;

                        if (isFlipping) setTimeout(() => playSound('flip'), 100);
                    } else if (!isProcessing && (gameMode === 'pvp' || turn === 1)) {
                        const move = valid.find(m => m.r === r && m.c === c);
                        if (move) {
                            cell.classList.add('valid-move', 'cursor-pointer');
                            cell.onclick = (e) => {
                                createRipple(cell);
                                handleCellClick(r, c, move.flippable);
                            };
                        }
                    }
                    boardEl.appendChild(cell);
                }
            }
            blackScoreEl.textContent = b; whiteScoreEl.textContent = w;
            turnIndicator.textContent = turn === 1 ? "é»’ã®ç•ª" : "ç™½ã®ç•ª";
            turnIndicator.className = `px-4 py-1 rounded-full font-black text-xs shadow-md ${turn === 1 ? 'bg-stone-800 text-white ring-4 ring-stone-200' : 'bg-white border-2 border-stone-800 text-stone-800 ring-4 ring-stone-100'}`;
        }

        function getValidMoves(p) {
            const moves = [];
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    if (board[r][c] !== 0) continue;
                    const flippable = getFlippableDiscs(r, c, p);
                    if (flippable.length > 0) moves.push({ r, c, flippable });
                }
            }
            return moves;
        }

        function getFlippableDiscs(r, c, p) {
            const opp = p === 1 ? 2 : 1;
            const dirs = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
            let total = [];
            for (const [dr, dc] of dirs) {
                let cr = r + dr, cc = c + dc, path = [];
                while (cr >= 0 && cr < 8 && cc >= 0 && cc < 8 && board[cr][cc] === opp) {
                    path.push({ r: cr, c: cc }); cr += dr; cc += dc;
                }
                if (path.length > 0 && cr >= 0 && cr < 8 && cc >= 0 && cc < 8 && board[cr][cc] === p) total = total.concat(path);
            }
            return total;
        }

        function handleCellClick(r, c, flippable) {
            if (isProcessing) return;
            const lv = Math.min(5, flippable.length);
            pendingMove = { r, c, flippable };
            showQuiz(lv);
        }

        function showQuiz(lv) {
            isProcessing = true;
            const pool = quizData.filter(q => q.level === lv);
            const q = JSON.parse(JSON.stringify(pool[Math.floor(Math.random() * pool.length)]));
            currentQuiz = q;
            
            document.getElementById('quiz-level').textContent = `LEVEL ${lv}`;
            document.getElementById('quiz-question').textContent = q.q;
            const optsEl = document.getElementById('quiz-options');
            optsEl.innerHTML = '';
            quizModal.style.display = 'flex';
            
            // é¸æŠè‚¢ã®ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            const originalCorrectText = q.a[q.correct];
            const shuffledOptions = [...q.a].sort(() => Math.random() - 0.5);
            const newCorrectIndex = shuffledOptions.indexOf(originalCorrectText);

            if (gameMode === 'pve' && turn === 2) {
                // PCã¯ä¸€å®šç¢ºç‡ã§æ­£è§£ã™ã‚‹
                setTimeout(() => checkAnswer(Math.random() > (0.1 * lv) ? newCorrectIndex : -1, newCorrectIndex), 1200);
            } else {
                shuffledOptions.forEach((text, i) => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left p-4 rounded-2xl border-2 border-stone-100 hover:border-amber-400 hover:bg-amber-50 text-sm font-black transition-all active:scale-95";
                    btn.textContent = text; 
                    btn.onclick = () => checkAnswer(i, newCorrectIndex);
                    optsEl.appendChild(btn);
                });
            }
        }

        function triggerFlash(type) {
            const overlay = document.getElementById('body-overlay');
            const cls = type === 'correct' ? 'flash-correct' : 'flash-wrong';
            overlay.classList.add(cls);
            setTimeout(() => overlay.classList.remove(cls), 500);
        }

        function checkAnswer(sel, cor) {
            const ok = sel === cor;
            if (ok) {
                playSound('correct');
                triggerFlash('correct');
                lastMovePos = { r: pendingMove.r, c: pendingMove.c }; 
                lastFlippedPositions = [...pendingMove.flippable];
                board[pendingMove.r][pendingMove.c] = turn;
                pendingMove.flippable.forEach(p => board[p.r][p.c] = turn);
                showMessage(turn === 1 ? "GREAT! æ­£è§£ï¼" : "PC CORRECT!"); 
                playSound('place');
            } else {
                playSound('wrong');
                triggerFlash('wrong');
                lastMovePos = null; lastFlippedPositions = [];
                showMessage("MISS... ä¸æ­£è§£");
                
                // ä»Šå›ã®å¯¾å±€ãƒªã‚¹ãƒˆã«ä¿å­˜ï¼ˆé‡è¤‡ãªã—ï¼‰
                if (!wrongQuestions.some(wq => wq.q === currentQuiz.q)) {
                    wrongQuestions.push(currentQuiz);
                    updateReviewButtons();
                }
            }
            
            setTimeout(() => {
                quizModal.style.display = 'none'; 
                isProcessing = false;
                turn = turn === 1 ? 2 : 1; 
                render(); 
                checkTurnPossible();
            }, 800);
        }

        function checkTurnPossible() {
            if (isProcessing) return;
            const moves = getValidMoves(turn);
            if (moves.length === 0) {
                const other = turn === 1 ? 2 : 1;
                if (getValidMoves(other).length === 0) {
                    setTimeout(endGame, 1000);
                } else {
                    showMessage("PASS...");
                    setTimeout(() => { turn = other; render(); checkTurnPossible(); }, 1200);
                }
            } else if (gameMode === 'pve' && turn === 2) {
                setTimeout(() => {
                    const cpu = getValidMoves(2);
                    cpu.sort((a,b) => b.flippable.length - a.flippable.length);
                    handleCellClick(cpu[0].r, cpu[0].c, cpu[0].flippable);
                }, 800);
            }
        }

        function showMessage(t) { 
            statusMsg.textContent = t; 
            statusMsg.className = "text-[10px] font-black uppercase tracking-widest text-amber-500 h-4 animate-bounce";
            setTimeout(() => { 
                if(statusMsg.textContent===t) {
                    statusMsg.textContent=""; 
                    statusMsg.className = "text-[10px] font-black uppercase tracking-widest text-stone-400 h-4";
                }
            }, 2000); 
        }

        function endGame() {
            let b=0, w=0; board.forEach(r => r.forEach(c => { if(c===1)b++; if(c===2)w++; }));
            document.getElementById('final-black').textContent = b;
            document.getElementById('final-white').textContent = w;
            document.getElementById('winner-text').textContent = b > w ? "é»’ã®å‹åˆ©ï¼" : (w > b ? "ç™½ã®å‹åˆ©ï¼" : "å¼•ãåˆ†ã‘");
            document.getElementById('gameover-modal').style.display = 'flex';
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Coin River - Voice & Clarity</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Hiragino Kaku Gothic Pro', 'Meiryo', sans-serif;
            touch-action: none;
            display: flex;
            justify-content: center;
        }
        #game-container {
            position: relative;
            width: 100vw;
            max-width: 500px;
            height: 100vh;
            background: #000;
            overflow: hidden;
        }
        canvas {
            display: block;
        }
        #ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            color: white;
            pointer-events: none;
            text-shadow: 0 2px 6px rgba(0,0,0,1);
            display: flex;
            justify-content: space-between;
            z-index: 5;
        }
        .heart {
            color: #ff3366;
            text-shadow: 0 0 10px #ff3366;
            font-size: 20px;
            margin-right: 2px;
        }
        #combo-timer-bar {
            width: 100px;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            margin-top: 4px;
            overflow: hidden;
        }
        #combo-timer-fill {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #00ffcc, #ffffff);
        }
        #start-screen, #quiz-overlay, #clear-overlay, #result-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 24px;
            z-index: 100;
            color: white;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        #quiz-overlay, #clear-overlay, #result-overlay { display: none; }
        .quiz-btn {
            width: 100%;
            max-width: 300px;
            padding: 16px;
            margin: 8px;
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }
        .quiz-btn:hover { background: #334155; border-color: #00ffcc; transform: scale(1.02); }
        
        /* 説明用パネル */
        .info-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 20px;
            padding: 16px;
            width: 100%;
            max-width: 360px;
            margin-bottom: 24px;
        }
        .info-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            text-align: left;
        }
        .info-row:last-child { margin-bottom: 0; }
        .info-icon {
            font-size: 24px;
            width: 40px;
            text-align: center;
            margin-right: 12px;
        }
        .info-text b { color: #00ffcc; }

        #gold-rush-msg {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            font-weight: 900;
            color: gold;
            pointer-events: none;
            white-space: nowrap;
            display: none;
            z-index: 50;
            text-shadow: 0 0 30px rgba(255,215,0,1);
            animation: rushAnim 0.4s infinite alternate;
        }
        @keyframes rushAnim {
            from { transform: translate(-50%, -50%) scale(0.9); }
            to { transform: translate(-50%, -50%) scale(1.1); }
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="ui-layer">
        <div>
            <div id="lives-container" class="flex mb-1"></div>
            <div class="text-xs opacity-80 font-bold uppercase tracking-widest">Score</div>
            <div class="text-4xl font-black italic tracking-tighter" id="score">0</div>
            <div class="text-xs text-yellow-400 mt-2 font-bold uppercase">Remain: <span id="progress">30</span></div>
        </div>
        <div class="text-right">
            <div class="text-xs opacity-80 font-bold uppercase tracking-widest">Combo</div>
            <div class="text-4xl font-black italic text-cyan-300" id="combo">0</div>
            <div id="combo-timer-bar" class="ml-auto">
                <div id="combo-timer-fill"></div>
            </div>
        </div>
    </div>

    <div id="gold-rush-msg">FEVER!</div>
    
    <div id="start-screen">
        <h1 class="text-5xl font-black text-white mb-6 italic tracking-tighter">COIN <span class="text-cyan-400">RIVER</span></h1>
        
        <div class="info-card">
            <div class="info-row">
                <div class="info-icon">🪙</div>
                <div class="info-text text-sm"><b>コインを集める:</b> 横移動で回収。SPACEキーや長押しでスピードアップ！</div>
            </div>
            <div class="info-row">
                <div class="info-icon">⚡</div>
                <div class="info-text text-sm"><b>コンボを繋ぐ:</b> 連続回収でスコアと音程が上昇！</div>
            </div>
            <div class="info-row">
                <div class="info-icon">📜</div>
                <div class="info-text text-sm"><b>歴史クイズ:</b> 150コンボごとに発生。<br>正解でゲームクリアに近づきます。</div>
            </div>
        </div>

        <div class="w-full max-w-[320px] flex flex-col gap-2">
            <button id="start-basic-btn" class="quiz-btn !bg-cyan-600 border-none text-white text-xl py-4 shadow-lg shadow-cyan-900/50">
                基本モード
                <span class="block text-xs font-normal opacity-80 mt-1">全30問クリアで勝利</span>
            </button>
            <button id="start-advanced-btn" class="quiz-btn !bg-purple-700 border-none text-white text-xl py-4 shadow-lg shadow-purple-900/50">
                上級者モード
                <span class="block text-xs font-normal opacity-80 mt-1">全100問の耐久戦</span>
            </button>
        </div>
        <p class="text-[10px] mt-4 opacity-40 italic">Click to load audio</p>
    </div>

    <div id="quiz-overlay">
        <h2 class="text-xl font-bold mb-2 text-cyan-400">HISTORY QUIZ</h2>
        <div class="text-xs mb-2 opacity-70">あと <span id="quiz-remain-count">0</span> 問</div>
        <p id="quiz-question" class="text-lg mb-6 px-4"></p>
        <div id="quiz-options" class="flex flex-col w-full items-center"></div>
    </div>

    <div id="clear-overlay">
        <div id="result-icon" class="text-6xl mb-4">🏆</div>
        <h2 id="result-title" class="text-4xl font-black mb-2">COMPLETE!</h2>
        <p id="result-desc" class="text-xl mb-6"></p>
        <div class="bg-white/10 p-6 rounded-2xl mb-8 w-full max-w-[300px]">
            <p class="text-sm opacity-70 font-bold">TOTAL SCORE</p>
            <p class="text-5xl font-black text-cyan-400" id="final-score">0</p>
        </div>
        <button id="show-results-btn" class="quiz-btn !bg-cyan-600 border-none text-white font-bold">復習リスト</button>
        <button onclick="location.reload()" class="quiz-btn !bg-slate-700 border-none text-white font-bold">タイトル</button>
    </div>

    <div id="result-overlay">
        <h2 class="text-2xl font-black mb-6">復習リスト</h2>
        <div id="wrong-questions-list" class="w-full flex flex-col items-center"></div>
        <button onclick="location.reload()" class="quiz-btn !bg-yellow-600 border-none text-white font-bold my-8">リトライ</button>
    </div>
</div>

<script>
    // Audio Resources
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let titleAudioPlayed = false;

    // Title Voice function
    function playTitleVoice() {
        if (titleAudioPlayed) return;
        const audio = new Audio('title_voice.mp3');
        audio.play().catch(e => console.log("Audio play blocked", e));
        titleAudioPlayed = true;
    }

    // Trigger title voice on first user interaction with the page
    window.addEventListener('click', () => {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        playTitleVoice();
    }, { once: true });

    function playCoinSound(comboCount) {
        if (audioCtx.state === 'suspended') return;
        const baseFreq = 400;
        const freq = baseFreq + (comboCount % 50) * 15;
        const duration = 0.15;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        
        if (comboCount > 20) {
            const osc2 = audioCtx.createOscillator();
            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(freq * 2, audioCtx.currentTime);
            const gain2 = audioCtx.createGain();
            gain2.gain.setValueAtTime(0.08, audioCtx.currentTime);
            gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc2.connect(gain2);
            gain2.connect(audioCtx.destination);
            osc2.start();
            osc2.stop(audioCtx.currentTime + duration);
        }

        gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    }

    function playFeverStartSound() {
        const now = audioCtx.currentTime;
        [440, 554, 659, 880].forEach((f, i) => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(f, now + i * 0.1);
            gain.gain.setValueAtTime(0.15, now + i * 0.1);
            gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.1 + 0.5);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(now + i * 0.1);
            osc.stop(now + i * 0.1 + 0.5);
        });
    }

    function playErrorSound() {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.3);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.3);
    }

    // Quiz Data
    const allQuizData = [
        { q: "卑弥呼が中国の魏に使いを送った時期は？", a: ["3世紀前半", "4世紀後半", "1世紀", "5世紀"], c: 0 },
        { q: "聖徳太子が協力して政治を行った天皇は？", a: ["持統天皇", "推古天皇", "天武天皇", "斉明天皇"], c: 1 },
        { q: "大化の改新（645年）の中心人物は？", a: ["中大兄皇子", "聖徳太子", "藤原道長", "平清盛"], c: 0 },
        { q: "奈良の東大寺に大仏を造らせたのは？", a: ["天武天皇", "聖武天皇", "桓武天皇", "明治天皇"], c: 1 },
        { q: "『枕草子』を書いたのは？", a: ["紫式部", "清少納言", "和泉式部", "小野小町"], c: 1 },
        { q: "平清盛が任命された最高の役職は？", a: ["摂政", "関白", "太政大臣", "征夷大将軍"], c: 2 },
        { q: "源頼朝が鎌倉幕府を開いたのは何年？", a: ["1185年", "1192年", "1221年", "1333年"], c: 0 },
        { q: "元軍が襲来した「元寇」の時の執権は？", a: ["北条時宗", "北条泰時", "北条政子", "北条義時"], c: 0 },
        { q: "室町幕府の第3代将軍で金閣を建てたのは？", a: ["足利尊氏", "足利義満", "足利義政", "足利義昭"], c: 1 },
        { q: "キリスト教を日本に伝えたのは？", a: ["ザビエル", "ペリー", "マルコ・ポーロ", "マゼラン"], c: 0 },
        { q: "織田信長が今川義元を破った戦いは？", a: ["長篠の戦い", "桶狭間の戦い", "関ヶ原の戦い", "壇ノ浦の戦い"], c: 1 },
        { q: "豊臣秀吉が行った、農民から武器を取り上げた政策は？", a: ["太閤検地", "刀狩", "楽市楽座", "生類憐れみの令"], c: 1 },
        { q: "関ヶ原の戦いが起きたのは西暦何年？", a: ["1582年", "1590年", "1600年", "1603年"], c: 2 },
        { q: "江戸幕府の第3代将軍で参勤交代を制度化したのは？", a: ["徳川家康", "徳川秀忠", "徳川家光", "徳川吉宗"], c: 2 },
        { q: "目安箱を設置し享保の改革を行ったのは？", a: ["徳川吉宗", "徳川綱吉", "松平定信", "水野忠邦"], c: 0 },
        { q: "1853年、浦賀に来航したアメリカ艦隊の司令官は？", a: ["ハリス", "ペリー", "マッカーサー", "アイゼンハワー"], c: 1 },
        { q: "薩摩藩と長州藩の仲立ちをして薩長同盟を結ばせたのは？", a: ["西郷隆盛", "坂本龍馬", "桂小五郎", "高杉晋作"], c: 1 },
        { q: "1867年、徳川慶喜が政権を朝廷に返したことは？", a: ["王政復古", "大政奉還", "版籍奉還", "廃藩置県"], c: 1 },
        { q: "明治政府が1872年に出した、教育の義務化を定めたのは？", a: ["学制", "徴兵令", "地租改正", "富国強兵"], c: 0 },
        { q: "1889年に発布された、日本最初の近代憲法は？", a: ["日本国憲法", "大日本帝国憲法", "五箇条の御誓文", "十七条憲法"], c: 1 },
        { q: "日露戦争（1904年）の時に日本が勝利した有名な海戦は？", a: ["ミッドウェー海戦", "日本海海戦", "真珠湾攻撃", "レイテ沖海戦"], c: 1 },
        { q: "1923年、東京を中心とした大災害は？", a: ["関東大震災", "阪神淡路大震災", "室戸台風", "東日本大震災"], c: 0 },
        { q: "1931年、満州事変のきっかけとなった爆破事件は？", a: ["盧溝橋事件", "柳条湖事件", "二・二六事件", "五・一五事件"], c: 1 },
        { q: "1941年、日本がアメリカのハワイを攻撃して始まったのは？", a: ["日中戦争", "太平洋戦争", "第一次世界大戦", "冷戦"], c: 1 },
        { q: "1945年8月6日、原子爆弾が投下された最初の都市は？", a: ["長崎", "東京", "広島", "大阪"], c: 2 },
        { q: "戦後、GHQの最高司令官として日本に来たのは？", a: ["ルーズベルト", "マッカーサー", "トルーマン", "チャーチル"], c: 1 },
        { q: "1947年に施行された、現在の日本の憲法は？", a: ["大日本帝国憲法", "日本国憲法", "平和憲法", "明治憲法"], c: 1 },
        { q: "1964年、アジアで初めて開催されたスポーツの祭典は？", a: ["万博", "東京オリンピック", "アジア競技大会", "WBC"], c: 1 },
        { q: "足利義政が京都の東山に建てた建物は？", a: ["金閣", "銀閣", "安土城", "平等院鳳凰堂"], c: 1 },
        { q: "縄文時代、人々が食べていた貝の殻などを捨てた場所は？", a: ["竪穴住居", "貝塚", "高床倉庫", "古墳"], c: 1 },
        { q: "奈良時代に作られた、日本最古の歴史書は？", a: ["日本書紀", "古事記", "万葉集", "風土記"], c: 1 },
        { q: "奈良時代の政治の基本となった法律の仕組みは？", a: ["武家法", "律令", "分国法", "公家法"], c: 1 },
        { q: "奈良時代に税として人々が納めた絹や布を何という？", a: ["租", "庸", "調", "年貢"], c: 2 },
        { q: "平安時代の前半に政治の実権を握った一族は？", a: ["源氏", "平氏", "藤原氏", "蘇我氏"], c: 2 },
        { q: "藤原道長が政治の中心に立った時代は？", a: ["奈良時代", "平安時代", "鎌倉時代", "室町時代"], c: 1 },
        { q: "国風文化が栄えたのはどの時代？", a: ["奈良時代", "平安時代", "鎌倉時代", "江戸時代"], c: 1 },
        { q: "平安時代に使われるようになった日本独自の文字は？", a: ["漢字", "アルファベット", "ひらがな", "ローマ字"], c: 2 },
        { q: "『源氏物語』を書いた人物は？", a: ["清少納言", "紫式部", "藤原道長", "和泉式部"], c: 1 },
        { q: "武士が成長し始めたのは主にどの時代？", a: ["平安時代後半", "奈良時代", "江戸時代", "明治時代"], c: 0 },
        { q: "平氏が栄えた頃の天皇は？", a: ["後白河天皇", "桓武天皇", "推古天皇", "明治天皇"], c: 0 },
        { q: "源平の戦いで源氏が勝利した最後の戦いは？", a: ["桶狭間の戦い", "壇ノ浦の戦い", "関ヶ原の戦い", "川中島の戦い"], c: 1 },
        { q: "鎌倉幕府が置かれた場所は？", a: ["京都", "大阪", "鎌倉", "江戸"], c: 2 },
        { q: "鎌倉幕府で将軍を助けた役職は？", a: ["執権", "関白", "大老", "老中"], c: 0 },
        { q: "鎌倉時代に定められた武士のための法律は？", a: ["律令", "武家諸法度", "御成敗式目", "分国法"], c: 2 },
        { q: "元寇の際、日本を守るために築かれた防塁は？", a: ["石垣", "城壁", "石塁", "防波堤"], c: 2 },
        { q: "鎌倉幕府が滅びた原因の一つとなった戦いは？", a: ["応仁の乱", "承久の乱", "元寇", "島原の乱"], c: 1 },
        { q: "室町幕府を開いた人物は？", a: ["足利尊氏", "足利義満", "源頼朝", "徳川家康"], c: 0 },
        { q: "室町時代に起こった全国的な内乱は？", a: ["承久の乱", "応仁の乱", "島原の乱", "西南戦争"], c: 1 },
        { q: "室町時代の貿易で中国と行った貿易は？", a: ["南蛮貿易", "勘合貿易", "朱印船貿易", "自由貿易"], c: 1 },
        { q: "室町文化の代表的な芸能は？", a: ["歌舞伎", "能", "落語", "文楽"], c: 1 },
        { q: "戦国時代に各地の大名が定めた法律は？", a: ["武家諸法度", "分国法", "御成敗式目", "律令"], c: 1 },
        { q: "織田信長が行った商業を活発にする政策は？", a: ["刀狩", "楽市楽座", "参勤交代", "太閤検地"], c: 1 },
        { q: "安土城を築いた人物は？", a: ["豊臣秀吉", "織田信長", "徳川家康", "明智光秀"], c: 1 },
        { q: "全国統一を完成させた人物は？", a: ["織田信長", "徳川家康", "豊臣秀吉", "足利義昭"], c: 2 },
        { q: "江戸幕府を開いた人物は？", a: ["徳川家康", "徳川家光", "徳川吉宗", "徳川慶喜"], c: 0 },
        { q: "江戸時代に大名を統制するための法律は？", a: ["御成敗式目", "分国法", "武家諸法度", "律令"], c: 2 },
        { q: "江戸時代の身分制度で最も人数が多かったのは？", a: ["武士", "農民", "町人", "商人"], c: 1 },
        { q: "鎖国中、日本が貿易を許していたヨーロッパの国は？", a: ["イギリス", "スペイン", "オランダ", "フランス"], c: 2 },
        { q: "江戸時代の庶民文化として栄えたのは？", a: ["国風文化", "天平文化", "元禄文化", "北山文化"], c: 2 },
        { q: "ペリー来航によって結ばれた条約は？", a: ["日米修好通商条約", "日米和親条約", "下関条約", "ポーツマス条約"], c: 1 },
        { q: "幕府が滅び、天皇中心の政治に戻った出来事は？", a: ["王政復古", "大政奉還", "廃藩置県", "版籍奉還"], c: 0 },
        { q: "明治政府が行った藩を廃止する改革は？", a: ["廃藩置県", "四民平等", "徴兵令", "地租改正"], c: 0 },
        { q: "徴兵令によって国民に義務づけられたものは？", a: ["納税", "教育", "兵役", "労働"], c: 2 },
        { q: "日本が最初に開いた国会はいつ？", a: ["1889年", "1890年", "1904年", "1912年"], c: 1 },
        { q: "大正時代に広がった民主的な考え方は？", a: ["軍国主義", "大正デモクラシー", "尊王攘夷", "富国強兵"], c: 1 },
        { q: "第二次世界大戦後、日本が占領された期間に行われた改革は？", a: ["享保の改革", "農地改革", "大化の改新", "明治維新"], c: 1 },
        { q: "日本国憲法で保障されている基本的人権は？", a: ["制限される", "国が与える", "侵してはならない", "一部のみ認める"], c: 2 },
        { q: "戦後、日本が国際社会に復帰するきっかけとなった条約は？", a: ["日米安保条約", "サンフランシスコ平和条約", "ポーツマス条約", "日清修好条規"], c: 1 },
	{ q: "奈良時代に国ごとの地理や産物を記録させた書物は？", a: ["日本書紀", "古事記", "風土記", "万葉集"], c: 2 },
	{ q: "奈良時代に唐の制度を模して整えられた政治体制は？", a: ["幕藩体制", "律令体制", "摂関政治", "院政"], c: 1 },
	{ q: "平安京が建設された際、都の守り神として重視された方角は？", a: ["北", "南", "東", "西"], c: 0 },
	{ q: "藤原氏が天皇の外戚として権力を握った政治形態は？", a: ["院政", "摂関政治", "武家政治", "公武合体"], c: 1 },
	{ q: "国風文化の特徴として正しいものは？", a: ["唐風文化の重視", "武士文化の発達", "日本独自文化の発展", "西洋文化の流入"], c: 2 },
	{ q: "平安時代後期、天皇が上皇となって政治を行った政治形態は？", a: ["摂関政治", "院政", "律令政治", "幕府政治"], c: 1 },
	{ q: "保元の乱・平治の乱の後に台頭した武士の一族は？", a: ["藤原氏", "平氏", "橘氏", "大伴氏"], c: 1 },
	{ q: "鎌倉幕府成立後、将軍の権限を実質的に握った役職は？", a: ["管領", "執権", "六波羅探題", "守護"], c: 1 },
	{ q: "御成敗式目が定められた主な目的は？", a: ["公家社会の統制", "農民の保護", "武士社会の秩序維持", "天皇権力の強化"], c: 2 },
	{ q: "鎌倉時代に広まった、簡単な修行で救われると説いた仏教は？", a: ["天台宗", "真言宗", "浄土宗", "華厳宗"], c: 2 },
	{ q: "鎌倉新仏教を広めた人物と宗派の正しい組み合わせは？", a: ["親鸞―浄土宗", "法然―浄土宗", "日蓮―禅宗", "道元―浄土真宗"], c: 1 },
	{ q: "元寇の後、幕府の財政が苦しくなった理由は？", a: ["領土を失ったため", "恩賞を十分に与えられなかったため", "年貢が廃止されたため", "貿易が停止したため"], c: 1 },
	{ q: "鎌倉幕府滅亡の直接のきっかけとなった天皇は？", a: ["後鳥羽天皇", "後醍醐天皇", "白河天皇", "桓武天皇"], c: 1 },
	{ q: "建武の新政で後醍醐天皇が重視した身分は？", a: ["農民", "町人", "公家", "武士"], c: 2 },
	{ q: "室町幕府で将軍を補佐し、政治の実権を握った役職は？", a: ["執権", "管領", "老中", "大老"], c: 1 },
	{ q: "室町時代に中国（明）との貿易で使われた証明書は？", a: ["朱印状", "勘合", "通行手形", "割符"], c: 1 },
	{ q: "北山文化の象徴とされる建築物は？", a: ["銀閣", "金閣", "平等院鳳凰堂", "東大寺"], c: 1 },
	{ q: "東山文化に強い影響を与えた思想は？", a: ["儒教", "道教", "禅宗", "キリスト教"], c: 2 },
	{ q: "応仁の乱後、日本の社会が移行した時代は？", a: ["安土桃山時代", "戦国時代", "江戸時代", "鎌倉時代"], c: 1 },
	{ q: "戦国大名が家臣を直接支配するために行った政策は？", a: ["惣村の強化", "兵農分離", "下剋上", "分国法の制定"], c: 3 },
	{ q: "キリスト教が伝来した当初、布教を行った宣教師の国籍は？", a: ["スペイン", "イギリス", "ポルトガル", "オランダ"], c: 2 },
	{ q: "織田信長が比叡山延暦寺を焼き討ちした理由として正しいものは？", a: ["反乱を起こしたため", "経済活動を妨げたため", "敵対勢力と結んだから", "税を納めなかったため"], c: 2 },
	{ q: "太閤検地の主な目的は？", a: ["武士の統制", "農民の保護", "年貢徴収の安定", "商業の発展"], c: 2 },
	{ q: "兵農分離が進められた結果、農民に求められた役割は？", a: ["戦争への参加", "年貢の納入", "城の警備", "行政の担当"], c: 1 },
	{ q: "江戸幕府が朝廷を統制するために定めた法律は？", a: ["武家諸法度", "禁中並公家諸法度", "分国法", "御成敗式目"], c: 1 },
	{ q: "江戸幕府の政治体制を表す言葉として正しいものは？", a: ["律令国家", "中央集権国家", "幕藩体制", "立憲国家"], c: 2 },
	{ q: "江戸時代の村で年貢の責任を負った制度は？", a: ["五人組", "村請制", "株仲間", "座"], c: 1 },
	{ q: "江戸時代に起こった百姓一揆の主な目的は？", a: ["政権交代", "年貢の軽減", "独立国家の建設", "武士身分の獲得"], c: 1 },
	{ q: "化政文化が発展した中心地は？", a: ["京都", "大阪", "江戸", "長崎"], c: 2 },
	{ q: "松平定信が行った改革は？", a: ["享保の改革", "寛政の改革", "天保の改革", "大化の改新"], c: 1 },
	{ q: "天保の改革を主導した人物は？", a: ["徳川吉宗", "松平定信", "水野忠邦", "井伊直弼"], c: 2 },
	{ q: "日米修好通商条約で認められた日本に不利な権利は？", a: ["関税自主権", "領事裁判権", "参政権", "永住権"], c: 1 },
	{ q: "尊王攘夷運動の「尊王」が意味するものは？", a: ["幕府を尊ぶ", "武士を尊ぶ", "天皇を尊ぶ", "外国を尊ぶ"], c: 2 },
	{ q: "版籍奉還によって元大名が就いた身分は？", a: ["知藩事", "県令", "総督", "藩主"], c: 0 },
	{ q: "地租改正によって税の納め方はどう変わったか？", a: ["収穫量基準", "人頭税", "地価基準の金納", "労役"], c: 2 },
	{ q: "明治時代に欧米制度を取り入れるため派遣された使節団は？", a: ["遣唐使", "岩倉使節団", "朱印船", "勘合船"], c: 1 },
	{ q: "大日本帝国憲法で主権を持つとされたのは？", a: ["国民", "議会", "天皇", "内閣"], c: 2 },
	{ q: "日清戦争の結果、日本が得た植民地は？", a: ["朝鮮", "台湾", "満州", "樺太"], c: 1 },
	{ q: "第一次世界大戦後、日本が国際社会で影響力を強めた理由は？", a: ["軍事占領", "工業生産の拡大", "植民地放棄", "鎖国"], c: 1 },
	{ q: "普通選挙法が制定された際の制限として正しいものは？", a: ["女性も含む", "25歳以上の男子", "全成人", "納税額制限なし"], c: 1 }
    ];

    let quizPool = [];
    let correctCount = 0;
    let targetQuestionCount = 30; // Default
    let lives = 3;
    let wrongHistory = [];

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const comboEl = document.getElementById('combo');
    const progressEl = document.getElementById('progress');
    const comboTimerFill = document.getElementById('combo-timer-fill');
    const goldRushMsg = document.getElementById('gold-rush-msg');
    const startScreen = document.getElementById('start-screen');
    const livesContainer = document.getElementById('lives-container');

    let width, height, score = 0, combo = 0, comboTimer = 0;
    const COMBO_MAX_TIME = 100; 
    let particles = [], items = [];
    let feverMode = false, feverTimer = 0;
    const FEVER_MAX_TIME = 300; 
    let gamePaused = true;
    let isBoosting = false;

    // Background Scroll Settings
    let bgScrollPos = 0;
    const bgImg = new Image();
    bgImg.src = 'background.png';
    
    const playerImg = new Image();
    playerImg.src = 'player_bar.png';

    const player = { x: 0, y: 0, w: 90, h: 25, targetX: 0 };

    function resize() {
        const container = document.getElementById('game-container');
        width = container.clientWidth;
        height = container.clientHeight;
        canvas.width = width;
        canvas.height = height;
        player.y = height - 120;
        player.x = width / 2 - player.w / 2;
        player.targetX = player.x;
    }
    window.addEventListener('resize', resize);
    resize();

    function updateLivesDisplay() {
        livesContainer.innerHTML = '';
        for (let i = 0; i < 3; i++) {
            const span = document.createElement('span');
            span.className = 'heart';
            span.innerText = i < lives ? '❤' : '🖤';
            span.style.opacity = i < lives ? '1' : '0.3';
            livesContainer.appendChild(span);
        }
    }

    function startGame(mode) {
        if (mode === 'basic') {
            targetQuestionCount = 30;
        } else {
            targetQuestionCount = 100;
        }
        
        // Reset Logic
        quizPool = [...allQuizData];
        correctCount = 0;
        score = 0;
        combo = 0;
        lives = 3;
        items = [];
        particles = [];
        wrongHistory = [];
        feverMode = false;
        
        progressEl.innerText = targetQuestionCount;
        scoreEl.innerText = "0";
        comboEl.innerText = "0";

        startScreen.style.display = 'none';
        gamePaused = false;
        
        if(audioCtx.state === 'suspended') audioCtx.resume();
        playTitleVoice();
        updateLivesDisplay();
    }

    // Attach listeners to both buttons
    document.getElementById('start-basic-btn').onclick = (e) => {
        e.stopPropagation();
        startGame('basic');
    };

    document.getElementById('start-advanced-btn').onclick = (e) => {
        e.stopPropagation();
        startGame('advanced');
    };

    const updateTargetX = (clientX) => {
        const rect = canvas.getBoundingClientRect();
        player.targetX = (clientX - rect.left) - player.w / 2;
    };

    window.addEventListener('mousemove', (e) => updateTargetX(e.clientX));
    window.addEventListener('touchstart', (e) => { 
        e.preventDefault(); 
        updateTargetX(e.touches[0].clientX); 
        isBoosting = true; 
    }, {passive: false});
    window.addEventListener('touchmove', (e) => { 
        e.preventDefault(); 
        updateTargetX(e.touches[0].clientX); 
    }, {passive: false});
    window.addEventListener('touchend', () => isBoosting = false);
    window.addEventListener('keydown', (e) => { if(e.code === 'Space') { e.preventDefault(); isBoosting = true; } });
    window.addEventListener('keyup', (e) => { if(e.code === 'Space') isBoosting = false; });

    class Item {
        constructor(type) {
            this.type = type;
            this.x = Math.random() * (width - 40) + 20;
            this.y = -50;
            this.size = type === 'star' ? 18 : 10;
            this.speed = (Math.random() * 2 + 5) * (feverMode ? 2.5 : (isBoosting ? 2.0 : 1.0));
            this.rotation = Math.random() * Math.PI;
        }
        update() {
            this.y += this.speed;
            this.rotation += 0.05;
            if (feverMode) {
                const dx = (player.x + player.w / 2) - this.x;
                this.x += dx * 0.18;
            }
        }
        draw() {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.rotation);
            if (this.type === 'coin') {
                ctx.beginPath();
                ctx.arc(0, 0, this.size, 0, Math.PI * 2);
                ctx.fillStyle = '#ffd700';
                ctx.fill();
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
            } else {
                ctx.beginPath();
                for (let i = 0; i < 10; i++) {
                    const r = (i % 2 === 0) ? this.size : this.size/2;
                    const a = Math.PI * 2 / 10 * i;
                    ctx.lineTo(Math.cos(a) * r, Math.sin(a) * r);
                }
                ctx.closePath();
                ctx.fillStyle = '#ff33aa';
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#ff33aa';
                ctx.fill();
            }
            ctx.restore();
        }
    }

    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y;
            this.vx = (Math.random() - 0.5) * 12;
            this.vy = (Math.random() - 0.5) * 12;
            this.life = 1.0; this.color = color;
        }
        update() { this.x += this.vx; this.y += this.vy; this.life -= 0.05; }
        draw() { ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y, 4, 4); }
    }

    function showQuiz() {
        // If pool is empty, refill from original data to support 100 questions mode with limited data
        if (quizPool.length === 0) {
            quizPool = [...allQuizData];
        }

        gamePaused = true;
        isBoosting = false;
        
        const qIdx = Math.floor(Math.random() * quizPool.length);
        const quiz = quizPool[qIdx];
        
        document.getElementById('quiz-question').innerText = quiz.q;
        document.getElementById('quiz-remain-count').innerText = targetQuestionCount - correctCount;
        
        const opts = document.getElementById('quiz-options');
        opts.innerHTML = '';
        quiz.a.forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.className = 'quiz-btn';
            btn.innerText = opt;
            btn.onclick = () => {
                if (i === quiz.c) {
                    correctCount++;
                    progressEl.innerText = targetQuestionCount - correctCount;
                    playFeverStartSound();
                    triggerFever();
                    quizPool.splice(qIdx, 1);
                    if (correctCount >= targetQuestionCount) { endGame(true); return; }
                } else {
                    lives--;
                    updateLivesDisplay();
                    playErrorSound();
                    wrongHistory.push({ q: quiz.q, a: quiz.a[quiz.c] });
                    quizPool.splice(qIdx, 1);
                    if (lives <= 0) { endGame(false); return; }
                }
                gamePaused = false;
                document.getElementById('quiz-overlay').style.display = 'none';
            };
            opts.appendChild(btn);
        });
        document.getElementById('quiz-overlay').style.display = 'flex';
    }

    function triggerFever() {
        feverMode = true;
        feverTimer = FEVER_MAX_TIME;
        goldRushMsg.style.display = 'block';
        setTimeout(() => { goldRushMsg.style.display = 'none'; }, 2000);
    }

    function endGame(isClear) {
        gamePaused = true;
        const overlay = document.getElementById('clear-overlay');
        const title = document.getElementById('result-title');
        const desc = document.getElementById('result-desc');
        const icon = document.getElementById('result-icon');
        if (isClear) {
            title.innerText = "COMPLETE!"; title.style.color = "gold";
            desc.innerText = `${targetQuestionCount}問完全制覇！歴史の覇者です！`; icon.innerText = "👑";
        } else {
            title.innerText = "GAME OVER"; title.style.color = "red";
            desc.innerText = `${correctCount} / ${targetQuestionCount} 問突破。再挑戦しましょう！`; icon.innerText = "💀";
        }
        document.getElementById('final-score').innerText = score.toLocaleString();
        overlay.style.display = 'flex';
    }

    document.getElementById('show-results-btn').onclick = () => {
        document.getElementById('clear-overlay').style.display = 'none';
        const list = document.getElementById('wrong-questions-list');
        list.innerHTML = '';
        if(wrongHistory.length === 0) list.innerHTML = '<p class="opacity-50">全問正解！素晴らしい！</p>';
        else wrongHistory.forEach(item => {
            const div = document.createElement('div');
            div.className = 'bg-white/10 p-4 mb-3 rounded-xl text-left w-full max-w-[400px] border border-white/5';
            div.innerHTML = `<p class="text-sm font-bold">${item.q}</p><p class="text-xs text-cyan-400 mt-2">正解: ${item.a}</p>`;
            list.appendChild(div);
        });
        document.getElementById('result-overlay').style.display = 'flex';
    };

    function update() {
        if (gamePaused) {
            particles.forEach(p => p.update());
            return;
        }

        const baseSpeed = 4;
        const boostSpeed = isBoosting ? 10 : 0;
        const feverSpeed = feverMode ? 20 : 0;
        bgScrollPos += baseSpeed + boostSpeed + feverSpeed;

        const lerpFactor = isBoosting ? 0.35 : 0.12;
        player.x += (player.targetX - player.x) * lerpFactor;
        player.x = Math.max(0, Math.min(width - player.w, player.x));

        if (combo > 0) {
            comboTimer--;
            if (comboTimer <= 0) combo = 0;
        }
        comboTimerFill.style.width = (comboTimer / COMBO_MAX_TIME * 100) + '%';

        const spawnChance = feverMode ? 0.98 : (isBoosting ? 0.45 : 0.25);
        if (Math.random() < spawnChance) items.push(new Item(Math.random() < 0.96 ? 'coin' : 'star'));

        for (let i = items.length - 1; i >= 0; i--) {
            const it = items[i];
            it.update();
            const hit = it.x > player.x - 15 && it.x < player.x + player.w + 15 &&
                        it.y > player.y - 15 && it.y < player.y + player.h + 15;
            if (hit) {
                if (it.type === 'coin') {
                    combo++;
                    comboTimer = COMBO_MAX_TIME;
                    score += (10 + Math.floor(combo / 10)) * (feverMode ? 10 : 1);
                    playCoinSound(combo);
                    // Trigger quiz every 150 combos
                    if (combo > 0 && combo % 150 === 0 && correctCount < targetQuestionCount) showQuiz();
                } else {
                    score += 10000;
                    playFeverStartSound();
                }
                for(let j=0; j<6; j++) particles.push(new Particle(it.x, it.y, it.type === 'coin' ? '#ffd700' : '#ff33aa'));
                items.splice(i, 1);
                continue;
            }
            if (it.y > height + 100) items.splice(i, 1);
        }

        for (let i = particles.length - 1; i >= 0; i--) {
            particles[i].update();
            if (particles[i].life <= 0) particles.splice(i, 1);
        }

        if (feverMode) {
            feverTimer--;
            if (feverTimer <= 0) feverMode = false;
        }
        scoreEl.innerText = score.toLocaleString();
        comboEl.innerText = combo;
    }

    function draw() {
        ctx.clearRect(0, 0, width, height);
        ctx.globalAlpha = 1.0; 
        ctx.filter = 'none';
        
        if (bgImg.complete && bgImg.width > 0) {
            const aspect = bgImg.height / bgImg.width;
            const drawH = width * aspect;
            const offset = bgScrollPos % drawH;
            for (let y = offset - drawH; y < height; y += drawH) {
                ctx.drawImage(bgImg, 0, Math.ceil(y), width, Math.ceil(drawH) + 1);
            }
        } else {
            ctx.fillStyle = '#050510';
            ctx.fillRect(0, 0, width, height);
        }

        items.forEach(it => it.draw());

        ctx.save();
        if (playerImg.complete) {
            if (isBoosting) { 
                ctx.shadowBlur = 40; 
                ctx.shadowColor = 'rgba(255,255,255,0.8)'; 
                ctx.filter = 'brightness(1.4)'; 
            } else if (feverMode) { 
                ctx.shadowBlur = 40; 
                ctx.shadowColor = 'gold'; 
                ctx.filter = 'hue-rotate(45deg) brightness(1.2)';
            }
            const aspect = playerImg.height / playerImg.width;
            const drawH = player.w * aspect;
            ctx.drawImage(playerImg, player.x, player.y, player.w, drawH);
            player.h = drawH;
        } else {
            ctx.fillStyle = '#00fbff';
            ctx.fillRect(player.x, player.y, player.w, player.h);
        }
        ctx.restore();

        particles.forEach(p => p.draw());
        requestAnimationFrame(draw);
    }

    setInterval(update, 1000/60);
    draw();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Coin River - Voice & Clarity</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Hiragino Kaku Gothic Pro', 'Meiryo', sans-serif;
            touch-action: none;
            display: flex;
            justify-content: center;
        }
        #game-container {
            position: relative;
            width: 100vw;
            max-width: 500px;
            height: 100vh;
            background: #000;
            overflow: hidden;
        }
        canvas {
            display: block;
        }
        #ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            color: white;
            pointer-events: none;
            text-shadow: 0 2px 6px rgba(0,0,0,1);
            display: flex;
            justify-content: space-between;
            z-index: 5;
        }
        .heart {
            color: #ff3366;
            text-shadow: 0 0 10px #ff3366;
            font-size: 20px;
            margin-right: 2px;
        }
        #combo-timer-bar {
            width: 100px;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            margin-top: 4px;
            overflow: hidden;
        }
        #combo-timer-fill {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #00ffcc, #ffffff);
        }
        #start-screen, #quiz-overlay, #clear-overlay, #result-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 24px;
            z-index: 100;
            color: white;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        #quiz-overlay, #clear-overlay, #result-overlay { display: none; }
        .quiz-btn {
            width: 100%;
            max-width: 300px;
            padding: 16px;
            margin: 8px;
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }
        .quiz-btn:hover { background: #334155; border-color: #00ffcc; transform: scale(1.02); }
        
        /* èª¬æ˜ç”¨ãƒ‘ãƒãƒ« */
        .info-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 20px;
            padding: 16px;
            width: 100%;
            max-width: 360px;
            margin-bottom: 24px;
        }
        .info-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            text-align: left;
        }
        .info-row:last-child { margin-bottom: 0; }
        .info-icon {
            font-size: 24px;
            width: 40px;
            text-align: center;
            margin-right: 12px;
        }
        .info-text b { color: #00ffcc; }

        #gold-rush-msg {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            font-weight: 900;
            color: gold;
            pointer-events: none;
            white-space: nowrap;
            display: none;
            z-index: 50;
            text-shadow: 0 0 30px rgba(255,215,0,1);
            animation: rushAnim 0.4s infinite alternate;
        }
        @keyframes rushAnim {
            from { transform: translate(-50%, -50%) scale(0.9); }
            to { transform: translate(-50%, -50%) scale(1.1); }
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="ui-layer">
        <div>
            <div id="lives-container" class="flex mb-1"></div>
            <div class="text-xs opacity-80 font-bold uppercase tracking-widest">Score</div>
            <div class="text-4xl font-black italic tracking-tighter" id="score">0</div>
            <div class="text-xs text-yellow-400 mt-2 font-bold uppercase">Remain: <span id="progress">30</span></div>
        </div>
        <div class="text-right">
            <div class="text-xs opacity-80 font-bold uppercase tracking-widest">Combo</div>
            <div class="text-4xl font-black italic text-cyan-300" id="combo">0</div>
            <div id="combo-timer-bar" class="ml-auto">
                <div id="combo-timer-fill"></div>
            </div>
        </div>
    </div>

    <div id="gold-rush-msg">FEVER!</div>
    
    <div id="start-screen">
        <h1 class="text-5xl font-black text-white mb-8 italic tracking-tighter">COIN <span class="text-cyan-400">RIVER</span></h1>
        
        <div class="info-card">
            <div class="info-row">
                <div class="info-icon">ğŸª™</div>
                <div class="info-text text-sm"><b>ã‚³ã‚¤ãƒ³ã‚’é›†ã‚ã‚‹:</b> æ¨ªç§»å‹•ã§å›åã€‚SPACEã‚­ãƒ¼ã‚„é•·æŠ¼ã—ã§ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—ï¼</div>
            </div>
            <div class="info-row">
                <div class="info-icon">âš¡</div>
                <div class="info-text text-sm"><b>ã‚³ãƒ³ãƒœã‚’ç¹‹ã:</b> é€£ç¶šå›åã§ã‚¹ã‚³ã‚¢ã¨éŸ³ç¨‹ãŒä¸Šæ˜‡ï¼é€”åˆ‡ã‚Œã¦ã‚‚ç”»é¢ã¯æš—ããªã‚Šã¾ã›ã‚“ã€‚</div>
            </div>
            <div class="info-row">
                <div class="info-icon">ğŸ“œ</div>
                <div class="info-text text-sm"><b>æ­´å²ã‚¯ã‚¤ã‚º:</b> 150ã‚³ãƒ³ãƒœã”ã¨ã«ç™ºç”Ÿã€‚å…¨30å•æ­£è§£ã§ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼</div>
            </div>
            <div class="info-row">
                <div class="info-icon">ğŸ”¥</div>
                <div class="info-text text-sm"><b>FEVERçªå…¥:</b> ã‚¯ã‚¤ã‚ºæ­£è§£ã§ã‚³ã‚¤ãƒ³ãŒå¸ã„å¯„ã›ã‚‰ã‚Œã‚‹ãƒœãƒ¼ãƒŠã‚¹ã‚¿ã‚¤ãƒ ã¸ï¼</div>
            </div>
        </div>

        <button id="start-btn" class="quiz-btn !bg-cyan-600 border-none text-white font-bold text-2xl py-5 shadow-lg shadow-cyan-900/50">PLAY NOW</button>
        <p class="text-[10px] mt-4 opacity-40 italic">Click to load audio</p>
    </div>

    <div id="quiz-overlay">
        <h2 class="text-xl font-bold mb-2 text-cyan-400">HISTORY QUIZ</h2>
        <p id="quiz-question" class="text-lg mb-6 px-4"></p>
        <div id="quiz-options" class="flex flex-col w-full items-center"></div>
    </div>

    <div id="clear-overlay">
        <div id="result-icon" class="text-6xl mb-4">ğŸ†</div>
        <h2 id="result-title" class="text-4xl font-black mb-2">COMPLETE!</h2>
        <p id="result-desc" class="text-xl mb-6"></p>
        <div class="bg-white/10 p-6 rounded-2xl mb-8 w-full max-w-[300px]">
            <p class="text-sm opacity-70 font-bold">TOTAL SCORE</p>
            <p class="text-5xl font-black text-cyan-400" id="final-score">0</p>
        </div>
        <button id="show-results-btn" class="quiz-btn !bg-cyan-600 border-none text-white font-bold">å¾©ç¿’ãƒªã‚¹ãƒˆ</button>
        <button onclick="location.reload()" class="quiz-btn !bg-slate-700 border-none text-white font-bold">ã‚¿ã‚¤ãƒˆãƒ«</button>
    </div>

    <div id="result-overlay">
        <h2 class="text-2xl font-black mb-6">å¾©ç¿’ãƒªã‚¹ãƒˆ</h2>
        <div id="wrong-questions-list" class="w-full flex flex-col items-center"></div>
        <button onclick="location.reload()" class="quiz-btn !bg-yellow-600 border-none text-white font-bold my-8">ãƒªãƒˆãƒ©ã‚¤</button>
    </div>
</div>

<script>
    // Audio Resources
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let titleAudioPlayed = false;

    // Title Voice function
    function playTitleVoice() {
        if (titleAudioPlayed) return;
        const audio = new Audio('title_voice.mp3');
        audio.play().catch(e => console.log("Audio play blocked", e));
        titleAudioPlayed = true;
    }

    // Trigger title voice on first user interaction with the page
    window.addEventListener('click', () => {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        playTitleVoice();
    }, { once: true });

    function playCoinSound(comboCount) {
        if (audioCtx.state === 'suspended') return;
        const baseFreq = 400;
        const freq = baseFreq + (comboCount % 50) * 15;
        const duration = 0.15;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        
        if (comboCount > 20) {
            const osc2 = audioCtx.createOscillator();
            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(freq * 2, audioCtx.currentTime);
            const gain2 = audioCtx.createGain();
            gain2.gain.setValueAtTime(0.08, audioCtx.currentTime);
            gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc2.connect(gain2);
            gain2.connect(audioCtx.destination);
            osc2.start();
            osc2.stop(audioCtx.currentTime + duration);
        }

        gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    }

    function playFeverStartSound() {
        const now = audioCtx.currentTime;
        [440, 554, 659, 880].forEach((f, i) => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(f, now + i * 0.1);
            gain.gain.setValueAtTime(0.15, now + i * 0.1);
            gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.1 + 0.5);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(now + i * 0.1);
            osc.stop(now + i * 0.1 + 0.5);
        });
    }

    function playErrorSound() {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.3);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.3);
    }

    // Quiz Data
    const allQuizData = [
        { q: "å‘å¼¥å‘¼ãŒä¸­å›½ã®é­ã«ä½¿ã„ã‚’é€ã£ãŸæ™‚æœŸã¯ï¼Ÿ", a: ["3ä¸–ç´€å‰åŠ", "4ä¸–ç´€å¾ŒåŠ", "1ä¸–ç´€", "5ä¸–ç´€"], c: 0 },
        { q: "è–å¾³å¤ªå­ãŒå”åŠ›ã—ã¦æ”¿æ²»ã‚’è¡Œã£ãŸå¤©çš‡ã¯ï¼Ÿ", a: ["æŒçµ±å¤©çš‡", "æ¨å¤å¤©çš‡", "å¤©æ­¦å¤©çš‡", "æ–‰æ˜å¤©çš‡"], c: 1 },
        { q: "å¤§åŒ–ã®æ”¹æ–°ï¼ˆ645å¹´ï¼‰ã®ä¸­å¿ƒäººç‰©ã¯ï¼Ÿ", a: ["ä¸­å¤§å…„çš‡å­", "è–å¾³å¤ªå­", "è—¤åŸé“é•·", "å¹³æ¸…ç››"], c: 0 },
        { q: "å¥ˆè‰¯ã®æ±å¤§å¯ºã«å¤§ä»ã‚’é€ ã‚‰ã›ãŸã®ã¯ï¼Ÿ", a: ["å¤©æ­¦å¤©çš‡", "è–æ­¦å¤©çš‡", "æ¡“æ­¦å¤©çš‡", "æ˜æ²»å¤©çš‡"], c: 1 },
        { q: "ã€æ•è‰å­ã€ã‚’æ›¸ã„ãŸã®ã¯ï¼Ÿ", a: ["ç´«å¼éƒ¨", "æ¸…å°‘ç´è¨€", "å’Œæ³‰å¼éƒ¨", "å°é‡å°ç”º"], c: 1 },
        { q: "å¹³æ¸…ç››ãŒä»»å‘½ã•ã‚ŒãŸæœ€é«˜ã®å½¹è·ã¯ï¼Ÿ", a: ["æ‘‚æ”¿", "é–¢ç™½", "å¤ªæ”¿å¤§è‡£", "å¾å¤·å¤§å°†è»"], c: 2 },
        { q: "æºé ¼æœãŒéŒå€‰å¹•åºœã‚’é–‹ã„ãŸã®ã¯ä½•å¹´ï¼Ÿ", a: ["1185å¹´", "1192å¹´", "1221å¹´", "1333å¹´"], c: 0 },
        { q: "å…ƒè»ãŒè¥²æ¥ã—ãŸã€Œå…ƒå¯‡ã€ã®æ™‚ã®åŸ·æ¨©ã¯ï¼Ÿ", a: ["åŒ—æ¡æ™‚å®—", "åŒ—æ¡æ³°æ™‚", "åŒ—æ¡æ”¿å­", "åŒ—æ¡ç¾©æ™‚"], c: 0 },
        { q: "å®¤ç”ºå¹•åºœã®ç¬¬3ä»£å°†è»ã§é‡‘é–£ã‚’å»ºã¦ãŸã®ã¯ï¼Ÿ", a: ["è¶³åˆ©å°Šæ°", "è¶³åˆ©ç¾©æº€", "è¶³åˆ©ç¾©æ”¿", "è¶³åˆ©ç¾©æ˜­"], c: 1 },
        { q: "ã‚­ãƒªã‚¹ãƒˆæ•™ã‚’æ—¥æœ¬ã«ä¼ãˆãŸã®ã¯ï¼Ÿ", a: ["ã‚¶ãƒ“ã‚¨ãƒ«", "ãƒšãƒªãƒ¼", "ãƒãƒ«ã‚³ãƒ»ãƒãƒ¼ãƒ­", "ãƒã‚¼ãƒ©ãƒ³"], c: 0 },
        { q: "ç¹”ç”°ä¿¡é•·ãŒä»Šå·ç¾©å…ƒã‚’ç ´ã£ãŸæˆ¦ã„ã¯ï¼Ÿ", a: ["é•·ç¯ ã®æˆ¦ã„", "æ¡¶ç‹­é–“ã®æˆ¦ã„", "é–¢ãƒ¶åŸã®æˆ¦ã„", "å£‡ãƒæµ¦ã®æˆ¦ã„"], c: 1 },
        { q: "è±Šè‡£ç§€å‰ãŒè¡Œã£ãŸã€è¾²æ°‘ã‹ã‚‰æ­¦å™¨ã‚’å–ã‚Šä¸Šã’ãŸæ”¿ç­–ã¯ï¼Ÿ", a: ["å¤ªé–¤æ¤œåœ°", "åˆ€ç‹©", "æ¥½å¸‚æ¥½åº§", "ç”Ÿé¡æ†ã‚Œã¿ã®ä»¤"], c: 1 },
        { q: "é–¢ãƒ¶åŸã®æˆ¦ã„ãŒèµ·ããŸã®ã¯è¥¿æš¦ä½•å¹´ï¼Ÿ", a: ["1582å¹´", "1590å¹´", "1600å¹´", "1603å¹´"], c: 2 },
        { q: "æ±Ÿæˆ¸å¹•åºœã®ç¬¬3ä»£å°†è»ã§å‚å‹¤äº¤ä»£ã‚’åˆ¶åº¦åŒ–ã—ãŸã®ã¯ï¼Ÿ", a: ["å¾³å·å®¶åº·", "å¾³å·ç§€å¿ ", "å¾³å·å®¶å…‰", "å¾³å·å‰å®—"], c: 2 },
        { q: "ç›®å®‰ç®±ã‚’è¨­ç½®ã—äº«ä¿ã®æ”¹é©ã‚’è¡Œã£ãŸã®ã¯ï¼Ÿ", a: ["å¾³å·å‰å®—", "å¾³å·ç¶±å‰", "æ¾å¹³å®šä¿¡", "æ°´é‡å¿ é‚¦"], c: 0 },
        { q: "1853å¹´ã€æµ¦è³€ã«æ¥èˆªã—ãŸã‚¢ãƒ¡ãƒªã‚«è‰¦éšŠã®å¸ä»¤å®˜ã¯ï¼Ÿ", a: ["ãƒãƒªã‚¹", "ãƒšãƒªãƒ¼", "ãƒãƒƒã‚«ãƒ¼ã‚µãƒ¼", "ã‚¢ã‚¤ã‚¼ãƒ³ãƒãƒ¯ãƒ¼"], c: 1 },
        { q: "è–©æ‘©è—©ã¨é•·å·è—©ã®ä»²ç«‹ã¡ã‚’ã—ã¦è–©é•·åŒç›Ÿã‚’çµã°ã›ãŸã®ã¯ï¼Ÿ", a: ["è¥¿éƒ·éš†ç››", "å‚æœ¬é¾é¦¬", "æ¡‚å°äº”éƒ", "é«˜æ‰æ™‹ä½œ"], c: 1 },
        { q: "1867å¹´ã€å¾³å·æ…¶å–œãŒæ”¿æ¨©ã‚’æœå»·ã«è¿”ã—ãŸã“ã¨ã¯ï¼Ÿ", a: ["ç‹æ”¿å¾©å¤", "å¤§æ”¿å¥‰é‚„", "ç‰ˆç±å¥‰é‚„", "å»ƒè—©ç½®çœŒ"], c: 1 },
        { q: "æ˜æ²»æ”¿åºœãŒ1872å¹´ã«å‡ºã—ãŸã€æ•™è‚²ã®ç¾©å‹™åŒ–ã‚’å®šã‚ãŸã®ã¯ï¼Ÿ", a: ["å­¦åˆ¶", "å¾´å…µä»¤", "åœ°ç§Ÿæ”¹æ­£", "å¯Œå›½å¼·å…µ"], c: 0 },
        { q: "1889å¹´ã«ç™ºå¸ƒã•ã‚ŒãŸã€æ—¥æœ¬æœ€åˆã®è¿‘ä»£æ†²æ³•ã¯ï¼Ÿ", a: ["æ—¥æœ¬å›½æ†²æ³•", "å¤§æ—¥æœ¬å¸å›½æ†²æ³•", "äº”ç®‡æ¡ã®å¾¡èª“æ–‡", "åä¸ƒæ¡æ†²æ³•"], c: 1 },
        { q: "æ—¥éœ²æˆ¦äº‰ï¼ˆ1904å¹´ï¼‰ã®æ™‚ã«æ—¥æœ¬ãŒå‹åˆ©ã—ãŸæœ‰åãªæµ·æˆ¦ã¯ï¼Ÿ", a: ["ãƒŸãƒƒãƒ‰ã‚¦ã‚§ãƒ¼æµ·æˆ¦", "æ—¥æœ¬æµ·æµ·æˆ¦", "çœŸç æ¹¾æ”»æ’ƒ", "ãƒ¬ã‚¤ãƒ†æ²–æµ·æˆ¦"], c: 1 },
        { q: "1923å¹´ã€æ±äº¬ã‚’ä¸­å¿ƒã¨ã—ãŸå¤§ç½å®³ã¯ï¼Ÿ", a: ["é–¢æ±å¤§éœ‡ç½", "é˜ªç¥æ·¡è·¯å¤§éœ‡ç½", "å®¤æˆ¸å°é¢¨", "æ±æ—¥æœ¬å¤§éœ‡ç½"], c: 0 },
        { q: "1931å¹´ã€æº€å·äº‹å¤‰ã®ãã£ã‹ã‘ã¨ãªã£ãŸçˆ†ç ´äº‹ä»¶ã¯ï¼Ÿ", a: ["ç›§æºæ©‹äº‹ä»¶", "æŸ³æ¡æ¹–äº‹ä»¶", "äºŒãƒ»äºŒå…­äº‹ä»¶", "äº”ãƒ»ä¸€äº”äº‹ä»¶"], c: 1 },
        { q: "1941å¹´ã€æ—¥æœ¬ãŒã‚¢ãƒ¡ãƒªã‚«ã®ãƒãƒ¯ã‚¤ã‚’æ”»æ’ƒã—ã¦å§‹ã¾ã£ãŸã®ã¯ï¼Ÿ", a: ["æ—¥ä¸­æˆ¦äº‰", "å¤ªå¹³æ´‹æˆ¦äº‰", "ç¬¬ä¸€æ¬¡ä¸–ç•Œå¤§æˆ¦", "å†·æˆ¦"], c: 1 },
        { q: "1945å¹´8æœˆ6æ—¥ã€åŸå­çˆ†å¼¾ãŒæŠ•ä¸‹ã•ã‚ŒãŸæœ€åˆã®éƒ½å¸‚ã¯ï¼Ÿ", a: ["é•·å´", "æ±äº¬", "åºƒå³¶", "å¤§é˜ª"], c: 2 },
        { q: "æˆ¦å¾Œã€GHQã®æœ€é«˜å¸ä»¤å®˜ã¨ã—ã¦æ—¥æœ¬ã«æ¥ãŸã®ã¯ï¼Ÿ", a: ["ãƒ«ãƒ¼ã‚ºãƒ™ãƒ«ãƒˆ", "ãƒãƒƒã‚«ãƒ¼ã‚µãƒ¼", "ãƒˆãƒ«ãƒ¼ãƒãƒ³", "ãƒãƒ£ãƒ¼ãƒãƒ«"], c: 1 },
        { q: "1947å¹´ã«æ–½è¡Œã•ã‚ŒãŸã€ç¾åœ¨ã®æ—¥æœ¬ã®æ†²æ³•ã¯ï¼Ÿ", a: ["å¤§æ—¥æœ¬å¸å›½æ†²æ³•", "æ—¥æœ¬å›½æ†²æ³•", "å¹³å’Œæ†²æ³•", "æ˜æ²»æ†²æ³•"], c: 1 },
        { q: "1964å¹´ã€ã‚¢ã‚¸ã‚¢ã§åˆã‚ã¦é–‹å‚¬ã•ã‚ŒãŸã‚¹ãƒãƒ¼ãƒ„ã®ç¥­å…¸ã¯ï¼Ÿ", a: ["ä¸‡åš", "æ±äº¬ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯", "ã‚¢ã‚¸ã‚¢ç«¶æŠ€å¤§ä¼š", "WBC"], c: 1 },
        { q: "è¶³åˆ©ç¾©æ”¿ãŒäº¬éƒ½ã®æ±å±±ã«å»ºã¦ãŸå»ºç‰©ã¯ï¼Ÿ", a: ["é‡‘é–£", "éŠ€é–£", "å®‰åœŸåŸ", "å¹³ç­‰é™¢é³³å‡°å ‚"], c: 1 },
        { q: "ç¸„æ–‡æ™‚ä»£ã€äººã€…ãŒé£Ÿã¹ã¦ã„ãŸè²ã®æ®»ãªã©ã‚’æ¨ã¦ãŸå ´æ‰€ã¯ï¼Ÿ", a: ["ç«ªç©´ä½å±…", "è²å¡š", "é«˜åºŠå€‰åº«", "å¤å¢³"], c: 1 },
        { q: "å¥ˆè‰¯æ™‚ä»£ã«ä½œã‚‰ã‚ŒãŸã€æ—¥æœ¬æœ€å¤ã®æ­´å²æ›¸ã¯ï¼Ÿ", a: ["æ—¥æœ¬æ›¸ç´€", "å¤äº‹è¨˜", "ä¸‡è‘‰é›†", "é¢¨åœŸè¨˜"], c: 1 },
        { q: "å¥ˆè‰¯æ™‚ä»£ã®æ”¿æ²»ã®åŸºæœ¬ã¨ãªã£ãŸæ³•å¾‹ã®ä»•çµ„ã¿ã¯ï¼Ÿ", a: ["æ­¦å®¶æ³•", "å¾‹ä»¤", "åˆ†å›½æ³•", "å…¬å®¶æ³•"], c: 1 },
        { q: "å¥ˆè‰¯æ™‚ä»£ã«ç¨ã¨ã—ã¦äººã€…ãŒç´ã‚ãŸçµ¹ã‚„å¸ƒã‚’ä½•ã¨ã„ã†ï¼Ÿ", a: ["ç§Ÿ", "åº¸", "èª¿", "å¹´è²¢"], c: 2 },
        { q: "å¹³å®‰æ™‚ä»£ã®å‰åŠã«æ”¿æ²»ã®å®Ÿæ¨©ã‚’æ¡ã£ãŸä¸€æ—ã¯ï¼Ÿ", a: ["æºæ°", "å¹³æ°", "è—¤åŸæ°", "è˜‡æˆ‘æ°"], c: 2 },
        { q: "è—¤åŸé“é•·ãŒæ”¿æ²»ã®ä¸­å¿ƒã«ç«‹ã£ãŸæ™‚ä»£ã¯ï¼Ÿ", a: ["å¥ˆè‰¯æ™‚ä»£", "å¹³å®‰æ™‚ä»£", "éŒå€‰æ™‚ä»£", "å®¤ç”ºæ™‚ä»£"], c: 1 },
        { q: "å›½é¢¨æ–‡åŒ–ãŒæ „ãˆãŸã®ã¯ã©ã®æ™‚ä»£ï¼Ÿ", a: ["å¥ˆè‰¯æ™‚ä»£", "å¹³å®‰æ™‚ä»£", "éŒå€‰æ™‚ä»£", "æ±Ÿæˆ¸æ™‚ä»£"], c: 1 },
        { q: "å¹³å®‰æ™‚ä»£ã«ä½¿ã‚ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸæ—¥æœ¬ç‹¬è‡ªã®æ–‡å­—ã¯ï¼Ÿ", a: ["æ¼¢å­—", "ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ", "ã²ã‚‰ãŒãª", "ãƒ­ãƒ¼ãƒå­—"], c: 2 },
        { q: "ã€æºæ°ç‰©èªã€ã‚’æ›¸ã„ãŸäººç‰©ã¯ï¼Ÿ", a: ["æ¸…å°‘ç´è¨€", "ç´«å¼éƒ¨", "è—¤åŸé“é•·", "å’Œæ³‰å¼éƒ¨"], c: 1 },
        { q: "æ­¦å£«ãŒæˆé•·ã—å§‹ã‚ãŸã®ã¯ä¸»ã«ã©ã®æ™‚ä»£ï¼Ÿ", a: ["å¹³å®‰æ™‚ä»£å¾ŒåŠ", "å¥ˆè‰¯æ™‚ä»£", "æ±Ÿæˆ¸æ™‚ä»£", "æ˜æ²»æ™‚ä»£"], c: 0 },
        { q: "å¹³æ°ãŒæ „ãˆãŸé ƒã®å¤©çš‡ã¯ï¼Ÿ", a: ["å¾Œç™½æ²³å¤©çš‡", "æ¡“æ­¦å¤©çš‡", "æ¨å¤å¤©çš‡", "æ˜æ²»å¤©çš‡"], c: 0 },
        { q: "æºå¹³ã®æˆ¦ã„ã§æºæ°ãŒå‹åˆ©ã—ãŸæœ€å¾Œã®æˆ¦ã„ã¯ï¼Ÿ", a: ["æ¡¶ç‹­é–“ã®æˆ¦ã„", "å£‡ãƒæµ¦ã®æˆ¦ã„", "é–¢ãƒ¶åŸã®æˆ¦ã„", "å·ä¸­å³¶ã®æˆ¦ã„"], c: 1 },
        { q: "éŒå€‰å¹•åºœãŒç½®ã‹ã‚ŒãŸå ´æ‰€ã¯ï¼Ÿ", a: ["äº¬éƒ½", "å¤§é˜ª", "éŒå€‰", "æ±Ÿæˆ¸"], c: 2 },
        { q: "éŒå€‰å¹•åºœã§å°†è»ã‚’åŠ©ã‘ãŸå½¹è·ã¯ï¼Ÿ", a: ["åŸ·æ¨©", "é–¢ç™½", "å¤§è€", "è€ä¸­"], c: 0 },
        { q: "éŒå€‰æ™‚ä»£ã«å®šã‚ã‚‰ã‚ŒãŸæ­¦å£«ã®ãŸã‚ã®æ³•å¾‹ã¯ï¼Ÿ", a: ["å¾‹ä»¤", "æ­¦å®¶è«¸æ³•åº¦", "å¾¡æˆæ•—å¼ç›®", "åˆ†å›½æ³•"], c: 2 },
        { q: "å…ƒå¯‡ã®éš›ã€æ—¥æœ¬ã‚’å®ˆã‚‹ãŸã‚ã«ç¯‰ã‹ã‚ŒãŸé˜²å¡ã¯ï¼Ÿ", a: ["çŸ³å£", "åŸå£", "çŸ³å¡", "é˜²æ³¢å ¤"], c: 2 },
        { q: "éŒå€‰å¹•åºœãŒæ»…ã³ãŸåŸå› ã®ä¸€ã¤ã¨ãªã£ãŸæˆ¦ã„ã¯ï¼Ÿ", a: ["å¿œä»ã®ä¹±", "æ‰¿ä¹…ã®ä¹±", "å…ƒå¯‡", "å³¶åŸã®ä¹±"], c: 1 },
        { q: "å®¤ç”ºå¹•åºœã‚’é–‹ã„ãŸäººç‰©ã¯ï¼Ÿ", a: ["è¶³åˆ©å°Šæ°", "è¶³åˆ©ç¾©æº€", "æºé ¼æœ", "å¾³å·å®¶åº·"], c: 0 },
        { q: "å®¤ç”ºæ™‚ä»£ã«èµ·ã“ã£ãŸå…¨å›½çš„ãªå†…ä¹±ã¯ï¼Ÿ", a: ["æ‰¿ä¹…ã®ä¹±", "å¿œä»ã®ä¹±", "å³¶åŸã®ä¹±", "è¥¿å—æˆ¦äº‰"], c: 1 },
        { q: "å®¤ç”ºæ™‚ä»£ã®è²¿æ˜“ã§ä¸­å›½ã¨è¡Œã£ãŸè²¿æ˜“ã¯ï¼Ÿ", a: ["å—è›®è²¿æ˜“", "å‹˜åˆè²¿æ˜“", "æœ±å°èˆ¹è²¿æ˜“", "è‡ªç”±è²¿æ˜“"], c: 1 },
        { q: "å®¤ç”ºæ–‡åŒ–ã®ä»£è¡¨çš„ãªèŠ¸èƒ½ã¯ï¼Ÿ", a: ["æ­Œèˆä¼", "èƒ½", "è½èª", "æ–‡æ¥½"], c: 1 },
        { q: "æˆ¦å›½æ™‚ä»£ã«å„åœ°ã®å¤§åãŒå®šã‚ãŸæ³•å¾‹ã¯ï¼Ÿ", a: ["æ­¦å®¶è«¸æ³•åº¦", "åˆ†å›½æ³•", "å¾¡æˆæ•—å¼ç›®", "å¾‹ä»¤"], c: 1 },
        { q: "ç¹”ç”°ä¿¡é•·ãŒè¡Œã£ãŸå•†æ¥­ã‚’æ´»ç™ºã«ã™ã‚‹æ”¿ç­–ã¯ï¼Ÿ", a: ["åˆ€ç‹©", "æ¥½å¸‚æ¥½åº§", "å‚å‹¤äº¤ä»£", "å¤ªé–¤æ¤œåœ°"], c: 1 },
        { q: "å®‰åœŸåŸã‚’ç¯‰ã„ãŸäººç‰©ã¯ï¼Ÿ", a: ["è±Šè‡£ç§€å‰", "ç¹”ç”°ä¿¡é•·", "å¾³å·å®¶åº·", "æ˜æ™ºå…‰ç§€"], c: 1 },
        { q: "å…¨å›½çµ±ä¸€ã‚’å®Œæˆã•ã›ãŸäººç‰©ã¯ï¼Ÿ", a: ["ç¹”ç”°ä¿¡é•·", "å¾³å·å®¶åº·", "è±Šè‡£ç§€å‰", "è¶³åˆ©ç¾©æ˜­"], c: 2 },
        { q: "æ±Ÿæˆ¸å¹•åºœã‚’é–‹ã„ãŸäººç‰©ã¯ï¼Ÿ", a: ["å¾³å·å®¶åº·", "å¾³å·å®¶å…‰", "å¾³å·å‰å®—", "å¾³å·æ…¶å–œ"], c: 0 },
        { q: "æ±Ÿæˆ¸æ™‚ä»£ã«å¤§åã‚’çµ±åˆ¶ã™ã‚‹ãŸã‚ã®æ³•å¾‹ã¯ï¼Ÿ", a: ["å¾¡æˆæ•—å¼ç›®", "åˆ†å›½æ³•", "æ­¦å®¶è«¸æ³•åº¦", "å¾‹ä»¤"], c: 2 },
        { q: "æ±Ÿæˆ¸æ™‚ä»£ã®èº«åˆ†åˆ¶åº¦ã§æœ€ã‚‚äººæ•°ãŒå¤šã‹ã£ãŸã®ã¯ï¼Ÿ", a: ["æ­¦å£«", "è¾²æ°‘", "ç”ºäºº", "å•†äºº"], c: 1 },
        { q: "é–å›½ä¸­ã€æ—¥æœ¬ãŒè²¿æ˜“ã‚’è¨±ã—ã¦ã„ãŸãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã®å›½ã¯ï¼Ÿ", a: ["ã‚¤ã‚®ãƒªã‚¹", "ã‚¹ãƒšã‚¤ãƒ³", "ã‚ªãƒ©ãƒ³ãƒ€", "ãƒ•ãƒ©ãƒ³ã‚¹"], c: 2 },
        { q: "æ±Ÿæˆ¸æ™‚ä»£ã®åº¶æ°‘æ–‡åŒ–ã¨ã—ã¦æ „ãˆãŸã®ã¯ï¼Ÿ", a: ["å›½é¢¨æ–‡åŒ–", "å¤©å¹³æ–‡åŒ–", "å…ƒç¦„æ–‡åŒ–", "åŒ—å±±æ–‡åŒ–"], c: 2 },
        { q: "ãƒšãƒªãƒ¼æ¥èˆªã«ã‚ˆã£ã¦çµã°ã‚ŒãŸæ¡ç´„ã¯ï¼Ÿ", a: ["æ—¥ç±³ä¿®å¥½é€šå•†æ¡ç´„", "æ—¥ç±³å’Œè¦ªæ¡ç´„", "ä¸‹é–¢æ¡ç´„", "ãƒãƒ¼ãƒ„ãƒã‚¹æ¡ç´„"], c: 1 },
        { q: "å¹•åºœãŒæ»…ã³ã€å¤©çš‡ä¸­å¿ƒã®æ”¿æ²»ã«æˆ»ã£ãŸå‡ºæ¥äº‹ã¯ï¼Ÿ", a: ["ç‹æ”¿å¾©å¤", "å¤§æ”¿å¥‰é‚„", "å»ƒè—©ç½®çœŒ", "ç‰ˆç±å¥‰é‚„"], c: 0 },
        { q: "æ˜æ²»æ”¿åºœãŒè¡Œã£ãŸè—©ã‚’å»ƒæ­¢ã™ã‚‹æ”¹é©ã¯ï¼Ÿ", a: ["å»ƒè—©ç½®çœŒ", "å››æ°‘å¹³ç­‰", "å¾´å…µä»¤", "åœ°ç§Ÿæ”¹æ­£"], c: 0 },
        { q: "å¾´å…µä»¤ã«ã‚ˆã£ã¦å›½æ°‘ã«ç¾©å‹™ã¥ã‘ã‚‰ã‚ŒãŸã‚‚ã®ã¯ï¼Ÿ", a: ["ç´ç¨", "æ•™è‚²", "å…µå½¹", "åŠ´åƒ"], c: 2 },
        { q: "æ—¥æœ¬ãŒæœ€åˆã«é–‹ã„ãŸå›½ä¼šã¯ã„ã¤ï¼Ÿ", a: ["1889å¹´", "1890å¹´", "1904å¹´", "1912å¹´"], c: 1 },
        { q: "å¤§æ­£æ™‚ä»£ã«åºƒãŒã£ãŸæ°‘ä¸»çš„ãªè€ƒãˆæ–¹ã¯ï¼Ÿ", a: ["è»å›½ä¸»ç¾©", "å¤§æ­£ãƒ‡ãƒ¢ã‚¯ãƒ©ã‚·ãƒ¼", "å°Šç‹æ”˜å¤·", "å¯Œå›½å¼·å…µ"], c: 1 },
        { q: "ç¬¬äºŒæ¬¡ä¸–ç•Œå¤§æˆ¦å¾Œã€æ—¥æœ¬ãŒå é ˜ã•ã‚ŒãŸæœŸé–“ã«è¡Œã‚ã‚ŒãŸæ”¹é©ã¯ï¼Ÿ", a: ["äº«ä¿ã®æ”¹é©", "è¾²åœ°æ”¹é©", "å¤§åŒ–ã®æ”¹æ–°", "æ˜æ²»ç¶­æ–°"], c: 1 },
        { q: "æ—¥æœ¬å›½æ†²æ³•ã§ä¿éšœã•ã‚Œã¦ã„ã‚‹åŸºæœ¬çš„äººæ¨©ã¯ï¼Ÿ", a: ["åˆ¶é™ã•ã‚Œã‚‹", "å›½ãŒä¸ãˆã‚‹", "ä¾µã—ã¦ã¯ãªã‚‰ãªã„", "ä¸€éƒ¨ã®ã¿èªã‚ã‚‹"], c: 2 },
        { q: "æˆ¦å¾Œã€æ—¥æœ¬ãŒå›½éš›ç¤¾ä¼šã«å¾©å¸°ã™ã‚‹ãã£ã‹ã‘ã¨ãªã£ãŸæ¡ç´„ã¯ï¼Ÿ", a: ["æ—¥ç±³å®‰ä¿æ¡ç´„", "ã‚µãƒ³ãƒ•ãƒ©ãƒ³ã‚·ã‚¹ã‚³å¹³å’Œæ¡ç´„", "ãƒãƒ¼ãƒ„ãƒã‚¹æ¡ç´„", "æ—¥æ¸…ä¿®å¥½æ¡è¦"], c: 1 }
    ];

    let quizPool = [...allQuizData];
    let correctCount = 0;
    let lives = 3;
    const TOTAL_QUESTIONS = 30;
    let wrongHistory = [];

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const comboEl = document.getElementById('combo');
    const progressEl = document.getElementById('progress');
    const comboTimerFill = document.getElementById('combo-timer-fill');
    const goldRushMsg = document.getElementById('gold-rush-msg');
    const startScreen = document.getElementById('start-screen');
    const livesContainer = document.getElementById('lives-container');

    let width, height, score = 0, combo = 0, comboTimer = 0;
    const COMBO_MAX_TIME = 100; 
    let particles = [], items = [];
    let feverMode = false, feverTimer = 0;
    const FEVER_MAX_TIME = 300; 
    let gamePaused = true;
    let isBoosting = false;

    // Background Scroll Settings
    let bgScrollPos = 0;
    const bgImg = new Image();
    bgImg.src = 'background.png';
    
    const playerImg = new Image();
    playerImg.src = 'player_bar.png';

    const player = { x: 0, y: 0, w: 90, h: 25, targetX: 0 };

    function resize() {
        const container = document.getElementById('game-container');
        width = container.clientWidth;
        height = container.clientHeight;
        canvas.width = width;
        canvas.height = height;
        player.y = height - 120;
        player.x = width / 2 - player.w / 2;
        player.targetX = player.x;
    }
    window.addEventListener('resize', resize);
    resize();

    function updateLivesDisplay() {
        livesContainer.innerHTML = '';
        for (let i = 0; i < 3; i++) {
            const span = document.createElement('span');
            span.className = 'heart';
            span.innerText = i < lives ? 'â¤' : 'ğŸ–¤';
            span.style.opacity = i < lives ? '1' : '0.3';
            livesContainer.appendChild(span);
        }
    }

    document.getElementById('start-btn').onclick = (e) => {
        e.stopPropagation(); // Prevent duplicate voice trigger
        startScreen.style.display = 'none';
        gamePaused = false;
        if(audioCtx.state === 'suspended') audioCtx.resume();
        playTitleVoice();
        updateLivesDisplay();
    };

    const updateTargetX = (clientX) => {
        const rect = canvas.getBoundingClientRect();
        player.targetX = (clientX - rect.left) - player.w / 2;
    };

    window.addEventListener('mousemove', (e) => updateTargetX(e.clientX));
    window.addEventListener('touchstart', (e) => { 
        e.preventDefault(); 
        updateTargetX(e.touches[0].clientX); 
        isBoosting = true; 
    }, {passive: false});
    window.addEventListener('touchmove', (e) => { 
        e.preventDefault(); 
        updateTargetX(e.touches[0].clientX); 
    }, {passive: false});
    window.addEventListener('touchend', () => isBoosting = false);
    window.addEventListener('keydown', (e) => { if(e.code === 'Space') { e.preventDefault(); isBoosting = true; } });
    window.addEventListener('keyup', (e) => { if(e.code === 'Space') isBoosting = false; });

    class Item {
        constructor(type) {
            this.type = type;
            this.x = Math.random() * (width - 40) + 20;
            this.y = -50;
            this.size = type === 'star' ? 18 : 10;
            this.speed = (Math.random() * 2 + 5) * (feverMode ? 2.5 : (isBoosting ? 2.0 : 1.0));
            this.rotation = Math.random() * Math.PI;
        }
        update() {
            this.y += this.speed;
            this.rotation += 0.05;
            if (feverMode) {
                const dx = (player.x + player.w / 2) - this.x;
                this.x += dx * 0.18;
            }
        }
        draw() {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.rotation);
            if (this.type === 'coin') {
                ctx.beginPath();
                ctx.arc(0, 0, this.size, 0, Math.PI * 2);
                ctx.fillStyle = '#ffd700';
                ctx.fill();
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
            } else {
                ctx.beginPath();
                for (let i = 0; i < 10; i++) {
                    const r = (i % 2 === 0) ? this.size : this.size/2;
                    const a = Math.PI * 2 / 10 * i;
                    ctx.lineTo(Math.cos(a) * r, Math.sin(a) * r);
                }
                ctx.closePath();
                ctx.fillStyle = '#ff33aa';
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#ff33aa';
                ctx.fill();
            }
            ctx.restore();
        }
    }

    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y;
            this.vx = (Math.random() - 0.5) * 12;
            this.vy = (Math.random() - 0.5) * 12;
            this.life = 1.0; this.color = color;
        }
        update() { this.x += this.vx; this.y += this.vy; this.life -= 0.05; }
        draw() { ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y, 4, 4); }
    }

    function showQuiz() {
        if (quizPool.length === 0) return;
        gamePaused = true;
        isBoosting = false;
        const qIdx = Math.floor(Math.random() * quizPool.length);
        const quiz = quizPool[qIdx];
        document.getElementById('quiz-question').innerText = quiz.q;
        const opts = document.getElementById('quiz-options');
        opts.innerHTML = '';
        quiz.a.forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.className = 'quiz-btn';
            btn.innerText = opt;
            btn.onclick = () => {
                if (i === quiz.c) {
                    correctCount++;
                    progressEl.innerText = TOTAL_QUESTIONS - correctCount;
                    playFeverStartSound();
                    triggerFever();
                    quizPool.splice(qIdx, 1);
                    if (correctCount >= TOTAL_QUESTIONS) { endGame(true); return; }
                } else {
                    lives--;
                    updateLivesDisplay();
                    playErrorSound();
                    wrongHistory.push({ q: quiz.q, a: quiz.a[quiz.c] });
                    quizPool.splice(qIdx, 1);
                    if (lives <= 0) { endGame(false); return; }
                }
                gamePaused = false;
                document.getElementById('quiz-overlay').style.display = 'none';
            };
            opts.appendChild(btn);
        });
        document.getElementById('quiz-overlay').style.display = 'flex';
    }

    function triggerFever() {
        feverMode = true;
        feverTimer = FEVER_MAX_TIME;
        goldRushMsg.style.display = 'block';
        setTimeout(() => { goldRushMsg.style.display = 'none'; }, 2000);
    }

    function endGame(isClear) {
        gamePaused = true;
        const overlay = document.getElementById('clear-overlay');
        const title = document.getElementById('result-title');
        const desc = document.getElementById('result-desc');
        const icon = document.getElementById('result-icon');
        if (isClear) {
            title.innerText = "COMPLETE!"; title.style.color = "gold";
            desc.innerText = "æ­´å²ã®è¦‡è€…ã¨ãªã‚Šã¾ã—ãŸï¼"; icon.innerText = "ğŸ‘‘";
        } else {
            title.innerText = "GAME OVER"; title.style.color = "red";
            desc.innerText = `${correctCount}å•çªç ´ã€‚å†æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ï¼`; icon.innerText = "ğŸ’€";
        }
        document.getElementById('final-score').innerText = score.toLocaleString();
        overlay.style.display = 'flex';
    }

    document.getElementById('show-results-btn').onclick = () => {
        document.getElementById('clear-overlay').style.display = 'none';
        const list = document.getElementById('wrong-questions-list');
        list.innerHTML = '';
        if(wrongHistory.length === 0) list.innerHTML = '<p class="opacity-50">å…¨å•æ­£è§£ï¼ç´ æ™´ã‚‰ã—ã„ï¼</p>';
        else wrongHistory.forEach(item => {
            const div = document.createElement('div');
            div.className = 'bg-white/10 p-4 mb-3 rounded-xl text-left w-full max-w-[400px] border border-white/5';
            div.innerHTML = `<p class="text-sm font-bold">${item.q}</p><p class="text-xs text-cyan-400 mt-2">æ­£è§£: ${item.a}</p>`;
            list.appendChild(div);
        });
        document.getElementById('result-overlay').style.display = 'flex';
    };

    function update() {
        if (gamePaused) {
            particles.forEach(p => p.update());
            return;
        }

        const baseSpeed = 4;
        const boostSpeed = isBoosting ? 10 : 0;
        const feverSpeed = feverMode ? 20 : 0;
        bgScrollPos += baseSpeed + boostSpeed + feverSpeed;

        const lerpFactor = isBoosting ? 0.35 : 0.12;
        player.x += (player.targetX - player.x) * lerpFactor;
        player.x = Math.max(0, Math.min(width - player.w, player.x));

        if (combo > 0) {
            comboTimer--;
            if (comboTimer <= 0) combo = 0;
        }
        comboTimerFill.style.width = (comboTimer / COMBO_MAX_TIME * 100) + '%';

        const spawnChance = feverMode ? 0.98 : (isBoosting ? 0.45 : 0.25);
        if (Math.random() < spawnChance) items.push(new Item(Math.random() < 0.96 ? 'coin' : 'star'));

        for (let i = items.length - 1; i >= 0; i--) {
            const it = items[i];
            it.update();
            const hit = it.x > player.x - 15 && it.x < player.x + player.w + 15 &&
                        it.y > player.y - 15 && it.y < player.y + player.h + 15;
            if (hit) {
                if (it.type === 'coin') {
                    combo++;
                    comboTimer = COMBO_MAX_TIME;
                    score += (10 + Math.floor(combo / 10)) * (feverMode ? 10 : 1);
                    playCoinSound(combo);
                    if (combo > 0 && combo % 150 === 0 && correctCount < TOTAL_QUESTIONS) showQuiz();
                } else {
                    score += 10000;
                    playFeverStartSound();
                }
                for(let j=0; j<6; j++) particles.push(new Particle(it.x, it.y, it.type === 'coin' ? '#ffd700' : '#ff33aa'));
                items.splice(i, 1);
                continue;
            }
            if (it.y > height + 100) items.splice(i, 1);
        }

        for (let i = particles.length - 1; i >= 0; i--) {
            particles[i].update();
            if (particles[i].life <= 0) particles.splice(i, 1);
        }

        if (feverMode) {
            feverTimer--;
            if (feverTimer <= 0) feverMode = false;
        }
        scoreEl.innerText = score.toLocaleString();
        comboEl.innerText = combo;
    }

    function draw() {
        ctx.clearRect(0, 0, width, height);
        ctx.globalAlpha = 1.0; 
        ctx.filter = 'none';
        
        if (bgImg.complete && bgImg.width > 0) {
            const aspect = bgImg.height / bgImg.width;
            const drawH = width * aspect;
            const offset = bgScrollPos % drawH;
            for (let y = offset - drawH; y < height; y += drawH) {
                ctx.drawImage(bgImg, 0, Math.ceil(y), width, Math.ceil(drawH) + 1);
            }
        } else {
            ctx.fillStyle = '#050510';
            ctx.fillRect(0, 0, width, height);
        }

        items.forEach(it => it.draw());

        ctx.save();
        if (playerImg.complete) {
            if (isBoosting) { 
                ctx.shadowBlur = 40; 
                ctx.shadowColor = 'rgba(255,255,255,0.8)'; 
                ctx.filter = 'brightness(1.4)'; 
            } else if (feverMode) { 
                ctx.shadowBlur = 40; 
                ctx.shadowColor = 'gold'; 
                ctx.filter = 'hue-rotate(45deg) brightness(1.2)';
            }
            const aspect = playerImg.height / playerImg.width;
            const drawH = player.w * aspect;
            ctx.drawImage(playerImg, player.x, player.y, player.w, drawH);
            player.h = drawH;
        } else {
            ctx.fillStyle = '#00fbff';
            ctx.fillRect(player.x, player.y, player.w, player.h);
        }
        ctx.restore();

        particles.forEach(p => p.draw());
        requestAnimationFrame(draw);
    }

    setInterval(update, 1000/60);
    draw();
</script>

</body>
</html>


<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢ç©ãƒã‚¹ã‚¿ãƒ¼ãƒ»ãƒ–ãƒ­ãƒƒã‚¯å´©ã— EX</title>
    <style>
        /* ------------------------------------------------------------
           CSS: ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
        ------------------------------------------------------------ */
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;800&display=swap');

        body {
            margin: 0;
            padding: 0;
            background-color: #020205;
            color: white;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            user-select: none;
        }

        #game-wrapper {
            position: relative;
            width: 800px;
            height: 600px;
            transform-origin: center center;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.2);
        }

        canvas {
            display: block;
            border-radius: 12px;
            background: radial-gradient(circle at 50% 80%, #1a1a3a 0%, #000000 100%);
            border: 4px solid #00ffff;
            box-shadow: 0 0 20px #00ffff, inset 0 0 50px rgba(0,0,0,0.5);
            cursor: none; /* ã‚²ãƒ¼ãƒ ä¸­ã¯ã‚«ãƒ¼ã‚½ãƒ«ã‚’æ¶ˆã™ */
        }

        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 20; text-align: center;
            border-radius: 12px;
            backdrop-filter: blur(5px);
            cursor: default;
        }

        .hidden { display: none !important; }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */
        #slideshow-container {
            width: 85%; height: 45%;
            background: linear-gradient(135deg, #222, #111);
            border: 2px solid #ff00ff;
            box-shadow: 0 0 15px #ff00ff;
            margin-bottom: 20px;
            display: flex; justify-content: center; align-items: center;
            position: relative; border-radius: 15px; overflow: hidden;
        }

        .slide-content { padding: 20px; width: 100%; box-sizing: border-box; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .slide-content h2 { color: #ff00ff; font-size: 1.8rem; margin-bottom: 0.5rem; text-shadow: 0 0 10px #ff00ff; }
        .slide-content p { font-size: 1.1rem; line-height: 1.6; }
        .icon-display { font-size: 3rem; margin-top: 10px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.5)); }

        .slide-nav { position: absolute; bottom: 10px; width: 100%; display: flex; justify-content: center; gap: 15px; }
        .dot { width: 12px; height: 12px; background: #555; border-radius: 50%; cursor: pointer; transition: 0.3s; }
        .dot.active { background: #00ffff; box-shadow: 0 0 10px #00ffff; transform: scale(1.2); }

        .level-select-container { display: flex; gap: 20px; margin-top: 10px; }
        .neon-btn {
            background: transparent; color: #fff; padding: 15px 30px;
            font-size: 1.2rem; font-weight: 800; cursor: pointer;
            transition: all 0.2s; border-radius: 50px;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            text-transform: uppercase; position: relative; overflow: hidden;
        }
        .btn-easy { border: 3px solid #00ff00; color: #00ff00; text-shadow: 0 0 10px #00ff00; box-shadow: 0 0 10px #00ff00; }
        .btn-easy:hover { background: #00ff00; color: #000; transform: scale(1.1); }
        .btn-normal { border: 3px solid #00ffff; color: #00ffff; text-shadow: 0 0 10px #00ffff; box-shadow: 0 0 10px #00ffff; }
        .btn-normal:hover { background: #00ffff; color: #000; transform: scale(1.1); }
        .btn-hard { border: 3px solid #ff0055; color: #ff0055; text-shadow: 0 0 10px #ff0055; box-shadow: 0 0 10px #ff0055; }
        .btn-hard:hover { background: #ff0055; color: #fff; transform: scale(1.1); }

        /* ã‚¯ã‚¤ã‚ºç”»é¢ */
        #quiz-modal {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            border: 4px solid #ffcc00; padding: 30px; border-radius: 20px; width: 75%;
            box-shadow: 0 0 50px rgba(255, 204, 0, 0.6); position: relative; cursor: auto;
        }
        #quiz-question { font-size: 2rem; margin-bottom: 25px; color: #ffffff; text-shadow: 0 2px 4px black; white-space: pre-line; }
        .input-group { display: flex; justify-content: center; align-items: center; gap: 10px; }
        #quiz-input {
            font-size: 2rem; padding: 10px; width: 180px; text-align: center;
            border: 3px solid #fff; background: rgba(0,0,0,0.5); color: white; border-radius: 10px; outline: none;
        }
        #quiz-input:focus { border-color: #00ff00; }
        .unit-label { font-size: 2rem; font-weight: bold; color: #aaa; }

        /* UIæƒ…å ± */
        #ui-layer {
            position: absolute; top: 15px; left: 20px; right: 20px;
            display: flex; justify-content: space-between; pointer-events: none; z-index: 5;
        }
        .info-box {
            font-size: 1.5rem; font-weight: 800; color: #fff; text-shadow: 0 0 10px #00ffff;
            background: rgba(0,0,0,0.4); padding: 5px 20px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.2);
        }
        .level-badge { font-size: 1rem; color: #aaa; margin-left: 10px; }

        /* ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ»å¾©ç¿’ */
        #review-list {
            width: 90%; max-height: 250px; overflow-y: auto;
            background: rgba(255,255,255,0.1); border: 1px solid #ff0055;
            margin: 20px 0; padding: 15px; text-align: left; border-radius: 10px;
        }
        .review-item { border-bottom: 1px solid rgba(255,255,255,0.2); padding: 10px; font-size: 1rem; color: #ddd; }
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 5px; }
    </style>
</head>
<body>

<div id="game-wrapper">
    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <div id="ui-layer">
        <div class="info-box">SCORE: <span id="score-display">0</span><span id="level-display" class="level-badge"></span></div>
        <div class="info-box">LIFE: <span id="life-display">â¤ï¸â¤ï¸â¤ï¸</span></div>
    </div>

    <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
    <div id="start-screen" class="overlay">
        <h1 style="color: #00ffff; text-shadow: 0 0 30px #00ffff; font-size: 3.5rem; margin: 0 0 10px 0; letter-spacing: 5px;">
            é¢ç©ãƒã‚¹ã‚¿ãƒ¼<br><span style="font-size:2rem; color:white;">BLOCK BREAKER EX</span>
        </h1>
        
        <div id="slideshow-container">
            <div id="slide-1" class="slide-content">
                <h2>ğŸ® æ“ä½œæ–¹æ³•</h2>
                <p><b>ãƒã‚¦ã‚¹</b> ã¾ãŸã¯ <b>â† â†’ ã‚­ãƒ¼</b> ã§ãƒ‘ãƒ‰ãƒ«ç§»å‹•<br>
                æ»‘ã‚‰ã‹ãªæ“ä½œæ„Ÿã§ãƒœãƒ¼ãƒ«ã‚’ã‚­ãƒ£ãƒƒãƒï¼<br>
                ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ãƒ¬ãƒ¼ã‚¶ãƒ¼ç™ºå°„ï¼ˆã‚¢ã‚¤ãƒ†ãƒ æ™‚ï¼‰</p>
                <div class="icon-display">ğŸ–±ï¸ âŒ¨ï¸ ğŸ“</div>
            </div>
            <div id="slide-2" class="slide-content hidden">
                <h2>ğŸ§  é¢ç©ã‚¯ã‚¤ã‚º</h2>
                <p>ãƒ–ãƒ­ãƒƒã‚¯ã«å½“ãŸã‚‹ã¨<b>ç®—æ•°ã‚¯ã‚¤ã‚º</b>ãŒå‡ºé¡Œï¼<br>æ­£è§£ã§ç ´å£Šï¼†ã‚¹ã‚³ã‚¢ã‚¢ãƒƒãƒ—ã€‚<br>ãƒ†ãƒ³ãƒã‚ˆãç­”ãˆã¦ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’ç›®æŒ‡ãã†ã€‚</p>
                <div class="icon-display">ğŸ“ ğŸ¤” ğŸ’¥</div>
            </div>
            <div id="slide-3" class="slide-content hidden">
                <h2>ğŸ’ ã‚¢ã‚¤ãƒ†ãƒ </h2>
                <p>ç‰¹æ®Šãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰ã‚¢ã‚¤ãƒ†ãƒ å‡ºç¾ï¼<br>
                <span style="color:cyan">â– ãƒ¯ã‚¤ãƒ‰</span> <span style="color:orange">â– å¤‰å½¢</span> <span style="color:lime">â– ã‚¹ãƒ­ãƒ¼</span> <span style="color:red">â– ãƒ¬ãƒ¼ã‚¶ãƒ¼</span></p>
                <div class="icon-display">ğŸ âœ¨ ğŸš€</div>
            </div>
            
            <div class="slide-nav">
                <div class="dot active" onclick="showSlide(0)"></div>
                <div class="dot" onclick="showSlide(1)"></div>
                <div class="dot" onclick="showSlide(2)"></div>
            </div>
        </div>

        <p style="margin:0; font-size:1rem;">é›£æ˜“åº¦ã‚’é¸ã‚“ã§ã‚¹ã‚¿ãƒ¼ãƒˆ (éŸ³ãŒå‡ºã¾ã™)</p>
        <div class="level-select-container">
            <button class="neon-btn btn-easy" onclick="startGame('EASY')">åˆç´š<br><span style="font-size:0.8rem">çƒ:é…ã‚</span></button>
            <button class="neon-btn btn-normal" onclick="startGame('NORMAL')">ä¸­ç´š<br><span style="font-size:0.8rem">çƒ:æ™®é€š</span></button>
            <button class="neon-btn btn-hard" onclick="startGame('HARD')">ä¸Šç´š<br><span style="font-size:0.8rem">çƒ:é«˜é€Ÿ</span></button>
        </div>
    </div>

    <!-- ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="quiz-overlay" class="overlay hidden">
        <div id="quiz-modal">
            <h2 style="margin-top:0; color:#ffcc00; text-shadow:0 0 10px orange;">é¢ç©ã‚’æ±‚ã‚ã‚ˆï¼</h2>
            <div id="quiz-question">Question Here</div>
            <div class="input-group">
                <input type="number" id="quiz-input" step="0.01" placeholder="ç­”ãˆ" autocomplete="off">
                <span class="unit-label">cmÂ²</span>
            </div>
            <button class="neon-btn" style="padding: 10px 30px; font-size: 1.2rem; margin-top: 20px; border-width:2px; color:white; border-color:white;" onclick="checkAnswer()">æ±ºå®š (Enter)</button>
            <div id="quiz-feedback" style="margin-top:15px; font-size:1.5rem; font-weight:bold; min-height:40px;"></div>
        </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ -->
    <div id="gameover-screen" class="overlay hidden">
        <h1 style="color: #ff0055; font-size: 4rem; text-shadow: 0 0 30px red; margin-bottom:10px;">GAME OVER</h1>
        <h2 style="font-size:2rem;">æœ€çµ‚ã‚¹ã‚³ã‚¢: <span id="final-score" style="color:#00ffff;">0</span></h2>
        
        <div style="width: 90%; text-align: left; margin-top:10px;">
            <h3 style="color:#ffcc00;">ğŸ“ å¾©ç¿’ãƒãƒ¼ãƒˆï¼ˆé–“é•ãˆãŸå•é¡Œï¼‰</h3>
        </div>
        <div id="review-list"></div>

        <button class="neon-btn btn-normal" onclick="location.reload()" style="margin-top:20px;">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
    </div>
</div>

<script>
/**
 * é¢ç©ãƒã‚¹ã‚¿ãƒ¼ãƒ»ãƒ–ãƒ­ãƒƒã‚¯å´©ã— EX - ãƒªãƒƒãƒãƒ‘ãƒ‰ãƒ«ç‰ˆ
 */

// --- ç”»é¢ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å‡¦ç† ---
function resizeGame() {
    const wrapper = document.getElementById('game-wrapper');
    const scaleX = window.innerWidth / 800;
    const scaleY = window.innerHeight / 600;
    const scale = Math.min(scaleX, scaleY) * 0.95;
    wrapper.style.transform = `scale(${scale})`;
}
window.addEventListener('resize', resizeGame);
resizeGame();

// --- ã‚µã‚¦ãƒ³ãƒ‰ç®¡ç†ã‚¯ãƒ©ã‚¹ ---
class SoundManager {
    constructor() {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.masterGain = this.ctx.createGain();
        this.masterGain.gain.value = 0.3;
        this.masterGain.connect(this.ctx.destination);
    }
    resume() { if (this.ctx.state === 'suspended') this.ctx.resume(); }
    playTone(freq, type, duration, vol=1) {
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.masterGain);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    }
    playHit() { this.playTone(400 + Math.random()*200, 'sine', 0.1, 0.5); }
    playPaddle() { this.playTone(300, 'square', 0.1, 0.4); }
    playCorrect() { 
        this.playTone(880, 'sine', 0.15, 0.5); 
        setTimeout(()=>this.playTone(1760, 'sine', 0.3, 0.5), 100);
    }
    playWrong() { this.playTone(150, 'sawtooth', 0.4, 0.8); }
    playDestroy() {
        this.playTone(100, 'sawtooth', 0.2, 0.8);
        this.playTone(80, 'square', 0.3, 0.6);
    }
    playLaser() {
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.frequency.setValueAtTime(800, this.ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.2);
        gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.2);
        osc.connect(gain);
        gain.connect(this.masterGain);
        osc.start();
        osc.stop(this.ctx.currentTime + 0.2);
    }
}
const sound = new SoundManager();

// --- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« ---
class Particle {
    constructor(x, y, color) {
        this.x = x; y = y; this.color = color;
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 4 + 1;
        this.dx = Math.cos(angle) * speed;
        this.dy = Math.sin(angle) * speed;
        this.life = 1.0;
        this.decay = 0.03;
    }
    update() {
        this.x += this.dx; this.y += this.dy; this.life -= this.decay;
    }
    draw(ctx) {
        ctx.globalAlpha = this.life;
        ctx.fillStyle = this.color;
        ctx.fillRect(this.x, this.y, 5, 5);
        ctx.globalAlpha = 1.0;
    }
}
let particles = [];

// --- ã‚²ãƒ¼ãƒ å®šæ•°ãƒ»å¤‰æ•° ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const STATE = { START: 0, PLAYING: 1, QUIZ: 2, WAITING: 3, GAMEOVER: 4 };
let gameState = STATE.START;
let score = 0;
let lives = 3;
let wrongAnswers = [];

// ãƒ¬ãƒ™ãƒ«è¨­å®š
const LEVELS = {
    EASY: { speed: 4, multiplier: 1, name: 'åˆç´š' },
    NORMAL: { speed: 7, multiplier: 2, name: 'ä¸­ç´š' },
    HARD: { speed: 10, multiplier: 4, name: 'ä¸Šç´š' }
};
let currentLevel = LEVELS.NORMAL;

// å…¥åŠ›çŠ¶æ…‹
let rightPressed = false;
let leftPressed = false;
let mouseX = null; // ãƒã‚¦ã‚¹ä½ç½®è¿½è·¡ç”¨
let lastInputType = 'mouse'; // 'mouse' or 'keyboard'

// ãƒ‘ãƒ‰ãƒ« (ç‰©ç†æ¼”ç®—å¯¾å¿œ)
const paddle = {
    x: canvas.width / 2 - 60,
    y: canvas.height - 40,
    width: 120,
    height: 20, // å°‘ã—åšã¿ã‚’æŒãŸã›ã‚‹
    
    // ç‰©ç†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
    vx: 0,           // é€Ÿåº¦
    ax: 0,           // åŠ é€Ÿåº¦
    maxSpeed: 12,    // æœ€å¤§é€Ÿåº¦
    friction: 0.85,  // æ‘©æ“¦ï¼ˆæ…£æ€§ï¼‰ 0ã«è¿‘ã„ã»ã©ã™ãæ­¢ã¾ã‚‹
    accel: 1.5,      // ã‚­ãƒ¼å…¥åŠ›æ™‚ã®åŠ é€Ÿåº¦
    
    isLaserActive: false
};

// ãƒœãƒ¼ãƒ«
const ball = {
    x: canvas.width / 2,
    y: canvas.height - 60,
    dx: 0, dy: 0,
    radius: 8,
    speed: 6,
    shape: 'circle',
    color: '#ffffff',
    active: false,
    trail: [] 
};

// ãƒ–ãƒ­ãƒƒã‚¯
const blockConfig = { rows: 6, cols: 10, width: 70, height: 25, padding: 8, offsetTop: 50, offsetLeft: 15 };
let blocks = [];
let items = [];
let lasers = [];
const ITEM_TYPES = ['WIDE', 'SHAPE', 'SLOW', 'LASER'];

// ã‚¯ã‚¤ã‚º
let currentQuiz = null;
let targetBlockIndex = -1;

// --- åˆæœŸåŒ– ---
function initBlocks() {
    blocks = [];
    const totalW = blockConfig.cols * (blockConfig.width + blockConfig.padding);
    const startX = (canvas.width - totalW) / 2 + blockConfig.padding/2;

    for (let c = 0; c < blockConfig.cols; c++) {
        for (let r = 0; r < blockConfig.rows; r++) {
            const isSpecial = Math.random() < 0.08;
            const hue = (c / blockConfig.cols) * 360; 
            blocks.push({
                x: startX + c * (blockConfig.width + blockConfig.padding),
                y: blockConfig.offsetTop + r * (blockConfig.height + blockConfig.padding),
                width: blockConfig.width,
                height: blockConfig.height,
                status: 1,
                isSpecial: isSpecial,
                color: isSpecial ? '#ffffff' : `hsl(${hue}, 80%, 60%)`,
                stroke: isSpecial ? '#ff00ff' : `hsl(${hue}, 80%, 40%)`
            });
        }
    }
}

// ã‚¹ãƒ©ã‚¤ãƒ‰ã‚·ãƒ§ãƒ¼
let currentSlide = 0;
function showSlide(index) {
    const slides = document.querySelectorAll('.slide-content');
    const dots = document.querySelectorAll('.dot');
    slides.forEach(s => s.classList.add('hidden'));
    dots.forEach(d => d.classList.remove('active'));
    slides[index].classList.remove('hidden');
    dots[index].classList.add('active');
    currentSlide = index;
}

// ã‚²ãƒ¼ãƒ é–‹å§‹
function startGame(levelKey) {
    sound.resume();
    currentLevel = LEVELS[levelKey];
    ball.speed = currentLevel.speed;
    
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('level-display').textContent = `[${currentLevel.name}]`;
    
    gameState = STATE.PLAYING;
    score = 0;
    lives = 3;
    wrongAnswers = [];
    items = [];
    lasers = [];
    paddle.isLaserActive = false;
    paddle.width = 120;
    
    initBlocks();
    resetBall();
    gameLoop();
    
    canvas.addEventListener('mousemove', mouseMoveHandler);
    document.addEventListener('keydown', keyDownHandler);
    document.addEventListener('keyup', keyUpHandler);
    
    document.getElementById('life-display').textContent = 'â¤ï¸'.repeat(lives);
    document.getElementById('score-display').textContent = score;
}

function resetBall() {
    ball.active = false;
    ball.x = paddle.x + paddle.width / 2;
    ball.y = paddle.y - ball.radius - 5;
    ball.dx = 0; ball.dy = 0;
    ball.trail = [];
    
    setTimeout(() => {
        if(gameState === STATE.PLAYING) {
            ball.active = true;
            ball.speed = currentLevel.speed;
            const angle = -Math.PI/2 + (Math.random() * 0.5 - 0.25);
            ball.dx = ball.speed * Math.cos(angle);
            ball.dy = ball.speed * Math.sin(angle);
        }
    }, 800);
}

// --- å…¥åŠ›åˆ¶å¾¡ & ãƒ‘ãƒ‰ãƒ«ç‰©ç†æ¼”ç®— ---
function mouseMoveHandler(e) {
    if (gameState !== STATE.PLAYING && gameState !== STATE.WAITING) return;
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    mouseX = (e.clientX - rect.left) * scaleX;
    lastInputType = 'mouse';
}

function keyDownHandler(e) {
    if (e.code === 'ArrowRight') { rightPressed = true; lastInputType = 'keyboard'; }
    else if (e.code === 'ArrowLeft') { leftPressed = true; lastInputType = 'keyboard'; }
    else if (e.code === 'Space' && paddle.isLaserActive && gameState === STATE.PLAYING) shootLaser();
    else if (e.code === 'Enter' && gameState === STATE.QUIZ) checkAnswer();
}

function keyUpHandler(e) {
    if (e.code === 'ArrowRight') rightPressed = false;
    else if (e.code === 'ArrowLeft') leftPressed = false;
}

function updatePaddle() {
    // ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦æŒ™å‹•ã‚’å¤‰ãˆã‚‹
    if (lastInputType === 'keyboard') {
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œï¼šåŠ é€Ÿåº¦ã‚’åŠ ç®—
        if (rightPressed) paddle.vx += paddle.accel;
        if (leftPressed) paddle.vx -= paddle.accel;
        
        // æ‘©æ“¦ã§æ¸›é€Ÿ
        paddle.vx *= paddle.friction;
        
    } else if (lastInputType === 'mouse' && mouseX !== null) {
        // ãƒã‚¦ã‚¹æ“ä½œï¼šç›®æ¨™ä½ç½®ã«å‘ã‹ã£ã¦è£œé–“ç§»å‹•ï¼ˆæ»‘ã‚‰ã‹ã•æ¼”å‡ºï¼‰
        const targetX = mouseX - paddle.width / 2;
        // ç¾åœ¨ä½ç½®ã¨ç›®æ¨™ä½ç½®ã®å·®åˆ†
        const diff = targetX - paddle.x;
        // ãƒã‚¦ã‚¹ã®å¸ã„ä»˜ãæ„Ÿï¼ˆ0.2ãã‚‰ã„ãŒé©åº¦ã«é…å»¶ã—ã¦æ°—æŒã¡ã„ã„ï¼‰
        paddle.vx = diff * 0.3; 
    }

    // æœ€é«˜é€Ÿåº¦åˆ¶é™ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œæ™‚ã®ã¿æ„å‘³ãŒã‚ã‚‹ã€ãƒã‚¦ã‚¹ã¯è¿½å¾“å„ªå…ˆï¼‰
    if (lastInputType === 'keyboard') {
        if (paddle.vx > paddle.maxSpeed) paddle.vx = paddle.maxSpeed;
        if (paddle.vx < -paddle.maxSpeed) paddle.vx = -paddle.maxSpeed;
    }

    // é€Ÿåº¦ã‚’ä½ç½®ã«åŠ ç®—
    paddle.x += paddle.vx;

    // ç”»é¢å¤–ã‚¯ãƒ©ãƒ³ãƒ—
    if (paddle.x < 0) {
        paddle.x = 0;
        paddle.vx = 0; // å£ã«å½“ãŸã£ãŸã‚‰é€Ÿåº¦0
    }
    if (paddle.x + paddle.width > canvas.width) {
        paddle.x = canvas.width - paddle.width;
        paddle.vx = 0;
    }

    // ãƒœãƒ¼ãƒ«ç™ºå°„å‰ã¯è¿½å¾“
    if (!ball.active && gameState === STATE.PLAYING) {
        ball.x = paddle.x + paddle.width / 2;
        ball.y = paddle.y - ball.radius - 5;
    }
}

function shootLaser() {
    lasers.push({ x: paddle.x + paddle.width / 2, y: paddle.y, dy: -10, active: true });
    sound.playLaser();
    paddle.isLaserActive = false; 
}

// --- ã‚¯ã‚¤ã‚ºç”Ÿæˆ ---
function generateQuiz() {
    const types = ['square', 'rect', 'tri', 'para', 'trap', 'rhombus', 'circle'];
    const type = types[Math.floor(Math.random() * types.length)];
    let q = { question: '', answer: 0, formula: '' };
    const rnd = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    switch(type) {
        case 'square':
            const s = rnd(3, 15);
            q.question = `æ­£æ–¹å½¢\nä¸€è¾º ${s} cm`; q.answer = s * s; q.formula = `${s}Ã—${s}`; break;
        case 'rect':
            const w = rnd(3, 15), h = rnd(3, 15);
            q.question = `é•·æ–¹å½¢\nç¸¦ ${h}cm, æ¨ª ${w}cm`; q.answer = w * h; q.formula = `${h}Ã—${w}`; break;
        case 'tri':
            const tb = rnd(4, 16), th = rnd(4, 16);
            q.question = `ä¸‰è§’å½¢\nåº•è¾º ${tb}cm, é«˜ã• ${th}cm`; q.answer = (tb * th) / 2; q.formula = `${tb}Ã—${th}Ã·2`; break;
        case 'para':
            const pb = rnd(4, 15), ph = rnd(4, 15);
            q.question = `å¹³è¡Œå››è¾ºå½¢\nåº•è¾º ${pb}cm, é«˜ã• ${ph}cm`; q.answer = pb * ph; q.formula = `${pb}Ã—${ph}`; break;
        case 'trap':
            const u = rnd(2, 10), l = rnd(u+2, 16), trh = rnd(4, 12);
            q.question = `å°å½¢\nä¸Šåº•${u}cm, ä¸‹åº•${l}cm, é«˜ã•${trh}cm`; q.answer = (u + l) * trh / 2; q.formula = `(${u}+${l})Ã—${trh}Ã·2`; break;
        case 'rhombus':
            const d1 = rnd(6, 16), d2 = rnd(6, 16);
            q.question = `ã²ã—å½¢\nå¯¾è§’ç·š ${d1}cm, ${d2}cm`; q.answer = (d1 * d2) / 2; q.formula = `${d1}Ã—${d2}Ã·2`; break;
        case 'circle':
            const r = rnd(2, 9);
            q.question = `å††\nåŠå¾„ ${r}cm (å††å‘¨ç‡3.14)`; q.answer = Math.round(r * r * 3.14 * 100) / 100; q.formula = `${r}Ã—${r}Ã—3.14`; break;
    }
    return q;
}

function triggerQuiz(blockIndex) {
    gameState = STATE.QUIZ;
    targetBlockIndex = blockIndex;
    currentQuiz = generateQuiz();
    sound.playHit();
    
    // ã‚«ãƒ¼ã‚½ãƒ«ã‚’è¡¨ç¤ºã«æˆ»ã™
    canvas.style.cursor = 'default';

    const modal = document.getElementById('quiz-overlay');
    document.getElementById('quiz-question').innerText = currentQuiz.question;
    const input = document.getElementById('quiz-input');
    input.value = '';
    document.getElementById('quiz-feedback').textContent = '';
    modal.classList.remove('hidden');
    setTimeout(() => input.focus(), 50);
}

function checkAnswer() {
    const input = document.getElementById('quiz-input');
    const feedback = document.getElementById('quiz-feedback');
    const userVal = parseFloat(input.value);
    const isCorrect = Math.abs(userVal - currentQuiz.answer) < 0.01;

    if (isCorrect) {
        sound.playCorrect();
        feedback.style.color = '#00ff00';
        feedback.textContent = `æ­£è§£! ${currentQuiz.answer} cmÂ²`;
        score += 100 * currentLevel.multiplier;
        
        setTimeout(() => {
            document.getElementById('quiz-overlay').classList.add('hidden');
            canvas.style.cursor = 'none'; // ã‚«ãƒ¼ã‚½ãƒ«éè¡¨ç¤º
            destroyBlock(targetBlockIndex);
            resumeGame(true);
        }, 1000);
    } else {
        sound.playWrong();
        feedback.style.color = '#ff0000';
        feedback.textContent = `ç­”ãˆã¯ ${currentQuiz.answer} cmÂ² ã ï¼`;
        
        wrongAnswers.push({q: currentQuiz.question.replace('\n', ' '), u: isNaN(userVal)?'ç„¡å›ç­”':userVal, a: currentQuiz.answer, f: currentQuiz.formula});

        setTimeout(() => {
            document.getElementById('quiz-overlay').classList.add('hidden');
            canvas.style.cursor = 'none'; // ã‚«ãƒ¼ã‚½ãƒ«éè¡¨ç¤º
            resumeGame(false);
        }, 1000);
    }
}

function resumeGame(destroyed) {
    gameState = STATE.PLAYING;
    ball.dy = Math.abs(ball.dy); 
    if (ball.dy < 2) ball.dy = 3; 
    
    if (!destroyed) {
        const b = blocks[targetBlockIndex];
        if (ball.y > b.y) {
            ball.y = b.y + b.height + ball.radius + 2;
        }
    }
    normalizeBallVelocity();
}

function destroyBlock(index) {
    const b = blocks[index];
    if(b.status === 0) return;
    b.status = 0;
    score += 50 * currentLevel.multiplier;
    sound.playDestroy();
    
    for(let k=0; k<15; k++) {
        particles.push(new Particle(b.x + b.width/2, b.y + b.height/2, b.color));
    }
    if (b.isSpecial) dropItem(b.x + b.width/2, b.y + b.height);
    if(blocks.every(bl => bl.status === 0)) gameOver(true);
}

// --- ã‚¢ã‚¤ãƒ†ãƒ  ---
function dropItem(x, y) {
    const type = ITEM_TYPES[Math.floor(Math.random() * ITEM_TYPES.length)];
    items.push({ x, y, type, dy: 3, active: true });
}

function activateItem(type) {
    score += 50 * currentLevel.multiplier;
    sound.playCorrect();
    const msg = document.createElement('div');
    msg.style.cssText = 'position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); color:white; font-size:3rem; font-weight:bold; text-shadow:0 0 20px cyan; z-index:100; pointer-events:none;';
    msg.innerText = type;
    document.body.appendChild(msg);
    msg.animate([{opacity:1, transform:'translate(-50%,-50%) scale(1)'}, {opacity:0, transform:'translate(-50%,-100%) scale(2)'}], {duration: 800, fill: 'forwards'});
    setTimeout(()=>msg.remove(), 800);

    switch(type) {
        case 'WIDE': paddle.width = 200; setTimeout(() => paddle.width = 120, 10000); break;
        case 'SHAPE': ball.shape = Math.random()>0.5 ? 'square' : 'triangle'; setTimeout(() => ball.shape = 'circle', 10000); break;
        case 'SLOW': 
            const originalSpeed = ball.speed; ball.speed = originalSpeed * 0.6; normalizeBallVelocity();
            setTimeout(() => { ball.speed = originalSpeed; normalizeBallVelocity(); }, 8000); break;
        case 'LASER': paddle.isLaserActive = true; break;
    }
}

function normalizeBallVelocity() {
    const currentSpeed = Math.sqrt(ball.dx*ball.dx + ball.dy*ball.dy);
    if(currentSpeed === 0) return;
    ball.dx = (ball.dx / currentSpeed) * ball.speed;
    ball.dy = (ball.dy / currentSpeed) * ball.speed;
}

// --- æç”»é–¢æ•°ï¼šãƒ‘ãƒ‰ãƒ«ï¼ˆç”»åƒã‚’ã‚³ãƒ¼ãƒ‰ã§å†ç¾ï¼‰ ---
function drawCyberPaddle() {
    const x = paddle.x;
    const y = paddle.y;
    const w = paddle.width;
    const h = paddle.height;
    
    ctx.save();
    
    // ãƒã‚ªãƒ³ç™ºå…‰åŠ¹æœ
    ctx.shadowBlur = 15;
    ctx.shadowColor = paddle.isLaserActive ? '#ff0055' : '#00ffff';
    
    // ãƒ¡ã‚¤ãƒ³ãƒœãƒ‡ã‚£ï¼ˆãƒ€ãƒ¼ã‚¯ãªé’ç´«è‰²ï¼‰
    const grad = ctx.createLinearGradient(x, y, x, y + h);
    grad.addColorStop(0, '#3a3a5e');
    grad.addColorStop(1, '#1a1a2e');
    
    ctx.fillStyle = grad;
    ctx.beginPath();
    // è§’ä¸¸
    ctx.roundRect(x, y, w, h, 4);
    ctx.fill();
    
    // ãƒã‚¤ãƒ©ã‚¤ãƒˆæ ç·š
    ctx.strokeStyle = paddle.isLaserActive ? '#ff0055' : '#00ffff';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    ctx.shadowBlur = 0; // ç™ºå…‰ã‚ªãƒ•

    // ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯é¢¨ã®å¹¾ä½•å­¦ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚·ã‚¢ãƒ³ã®ãƒ©ã‚¤ãƒ³ï¼‰
    // ãƒ–ãƒ­ãƒƒã‚¯åˆ†å‰²ç·š
    ctx.strokeStyle = paddle.isLaserActive ? 'rgba(255, 0, 85, 0.5)' : 'rgba(0, 255, 255, 0.5)';
    ctx.lineWidth = 1;
    const segments = 5;
    const segW = w / segments;
    
    ctx.beginPath();
    for(let i=1; i<segments; i++) {
        ctx.moveTo(x + i*segW, y);
        ctx.lineTo(x + i*segW, y + h);
    }
    ctx.stroke();

    // å›è·¯å›³ã£ã½ã„ãƒ©ã‚¤ãƒ³è£…é£¾
    ctx.beginPath();
    ctx.strokeStyle = paddle.isLaserActive ? '#ff99aa' : '#ccffff';
    ctx.lineWidth = 1;
    
    // å·¦å´ã®è£…é£¾
    ctx.moveTo(x + 5, y + h/2);
    ctx.lineTo(x + 15, y + h/2);
    ctx.lineTo(x + 20, y + 5);
    
    // å³å´ã®è£…é£¾
    ctx.moveTo(x + w - 5, y + h/2);
    ctx.lineTo(x + w - 15, y + h/2);
    ctx.lineTo(x + w - 20, y + h - 5);
    
    // ä¸­å¤®ã®ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ
    ctx.rect(x + w/2 - 10, y + 5, 20, h - 10);
    
    ctx.stroke();
    
    // ç™ºå…‰ã™ã‚‹ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ
    ctx.fillStyle = paddle.isLaserActive ? '#ff0055' : '#00ffff';
    ctx.beginPath();
    ctx.rect(x + w/2 - 5, y + 8, 10, h - 16);
    ctx.fill();

    ctx.restore();
}

// --- æ›´æ–°ãƒ«ãƒ¼ãƒ— ---
function update() {
    if (gameState !== STATE.PLAYING) return;

    updatePaddle();

    for (let i = particles.length - 1; i >= 0; i--) {
        particles[i].update();
        if (particles[i].life <= 0) particles.splice(i, 1);
    }

    if (ball.active) {
        ball.trail.push({x: ball.x, y: ball.y, alpha: 0.5});
        if(ball.trail.length > 5) ball.trail.shift();

        ball.x += ball.dx; ball.y += ball.dy;

        // å£åå°„
        if (ball.x + ball.radius > canvas.width || ball.x - ball.radius < 0) {
            ball.dx = -ball.dx; sound.playHit();
        }
        if (ball.y - ball.radius < 0) {
            ball.dy = -ball.dy; sound.playHit();
        }
        
        // è½ä¸‹
        if (ball.y - ball.radius > canvas.height) {
            lives--;
            document.getElementById('life-display').textContent = 'â¤ï¸'.repeat(lives);
            sound.playWrong();
            if (lives <= 0) gameOver(false);
            else resetBall();
        }

        // ãƒ‘ãƒ‰ãƒ«åå°„
        if (
            ball.y + ball.radius >= paddle.y &&
            ball.y - ball.radius <= paddle.y + paddle.height &&
            ball.x >= paddle.x &&
            ball.x <= paddle.x + paddle.width
        ) {
            let collidePoint = ball.x - (paddle.x + paddle.width / 2);
            collidePoint = collidePoint / (paddle.width / 2);
            let angle = collidePoint * (Math.PI / 2.5);
            
            ball.dx = ball.speed * Math.sin(angle);
            ball.dy = -ball.speed * Math.cos(angle);
            
            // æ‘©æ“¦çš„ãªæ¨ªç§»å‹•ã®å½±éŸ¿ã‚’åŠ ãˆã‚‹ï¼ˆã‚«ãƒƒãƒˆã‚¤ãƒ³åŠ¹æœï¼‰
            ball.dx += paddle.vx * 0.2; 
            
            sound.playPaddle();
            
            if (Math.abs(ball.dy) < ball.speed * 0.2) {
                 ball.dy = -ball.speed * 0.3;
                 normalizeBallVelocity();
            }
        }

        // ãƒ–ãƒ­ãƒƒã‚¯è¡çª
        for (let i = 0; i < blocks.length; i++) {
            let b = blocks[i];
            if (b.status === 1) {
                if (
                    ball.x + ball.radius > b.x && 
                    ball.x - ball.radius < b.x + b.width &&
                    ball.y + ball.radius > b.y && 
                    ball.y - ball.radius < b.y + b.height
                ) {
                    triggerQuiz(i);
                    break;
                }
            }
        }
    }

    // ã‚¢ã‚¤ãƒ†ãƒ  & ãƒ¬ãƒ¼ã‚¶ãƒ¼
    items.forEach((item) => {
        if(item.active) {
            item.y += item.dy;
            if(item.y > canvas.height) item.active = false;
            if(item.y + 10 >= paddle.y && item.x >= paddle.x && item.x <= paddle.x + paddle.width) {
                activateItem(item.type);
                item.active = false;
            }
        }
    });
    lasers.forEach((laser) => {
        if(laser.active) {
            laser.y += laser.dy;
            if(laser.y < 0) laser.active = false;
            for(let i=0; i<blocks.length; i++) {
                let b = blocks[i];
                if(b.status === 1 && laser.x > b.x && laser.x < b.x + b.width && laser.y > b.y && laser.y < b.y + b.height) {
                    destroyBlock(i); laser.active = false; break;
                }
            }
        }
    });

    document.getElementById('score-display').textContent = score;
}

// --- æç”»ãƒ«ãƒ¼ãƒ— ---
function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    blocks.forEach(b => {
        if (b.status === 1) {
            ctx.shadowBlur = 10; ctx.shadowColor = b.color; ctx.fillStyle = b.color;
            ctx.beginPath(); ctx.roundRect(b.x, b.y, b.width, b.height, 5); ctx.fill();
            ctx.lineWidth = 2; ctx.strokeStyle = '#fff'; ctx.stroke();
            if(b.isSpecial) { ctx.fillStyle = "#000"; ctx.font = "bold 16px Arial"; ctx.fillText("?", b.x + b.width/2 - 5, b.y + 18); }
            ctx.shadowBlur = 0;
        }
    });

    particles.forEach(p => p.draw(ctx));

    // æ–°ã—ã„ãƒ‘ãƒ‰ãƒ«æç”»
    drawCyberPaddle();

    // ãƒœãƒ¼ãƒ«æç”»
    ball.trail.forEach(t => {
        ctx.globalAlpha = t.alpha * 0.3;
        ctx.beginPath(); ctx.arc(t.x, t.y, ball.radius, 0, Math.PI*2);
        ctx.fillStyle = ball.color; ctx.fill();
        t.alpha -= 0.1;
    });
    ctx.globalAlpha = 1;
    ball.trail = ball.trail.filter(t => t.alpha > 0);

    ctx.beginPath();
    if (ball.shape === 'square') ctx.rect(ball.x - ball.radius, ball.y - ball.radius, ball.radius*2, ball.radius*2);
    else if (ball.shape === 'triangle') {
        ctx.moveTo(ball.x, ball.y - ball.radius);
        ctx.lineTo(ball.x + ball.radius, ball.y + ball.radius);
        ctx.lineTo(ball.x - ball.radius, ball.y + ball.radius);
    } else ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
    ctx.fillStyle = ball.color; ctx.fill();

    items.forEach(item => {
        if(item.active) {
            ctx.beginPath(); ctx.arc(item.x, item.y, 12, 0, Math.PI*2); ctx.fillStyle = '#fff'; ctx.fill();
            ctx.beginPath(); ctx.arc(item.x, item.y, 10, 0, Math.PI*2);
            ctx.fillStyle = item.type === 'LASER' ? 'red' : item.type === 'WIDE' ? 'cyan' : item.type === 'SLOW' ? 'lime' : 'orange';
            ctx.fill(); ctx.fillStyle = 'black'; ctx.font = 'bold 10px Arial'; ctx.fillText(item.type[0], item.x-4, item.y+4);
        }
    });
    lasers.forEach(l => {
        if(l.active) {
            ctx.save(); ctx.shadowBlur = 10; ctx.shadowColor = 'red'; ctx.fillStyle = '#ff0055';
            ctx.fillRect(l.x - 3, l.y, 6, 20); ctx.restore();
        }
    });
}

function gameLoop() {
    if(gameState !== STATE.GAMEOVER) {
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }
}

function gameOver(isClear) {
    gameState = STATE.GAMEOVER;
    canvas.style.cursor = 'default'; // ã‚«ãƒ¼ã‚½ãƒ«æˆ»ã™
    if(lives > 0) score += lives * 1000 * currentLevel.multiplier;
    document.getElementById('final-score').textContent = score;
    document.getElementById('gameover-screen').classList.remove('hidden');
    const list = document.getElementById('review-list');
    list.innerHTML = '';
    if (wrongAnswers.length === 0) list.innerHTML = '<p style="text-align:center; color:#00ff00;">å…¨å•æ­£è§£ï¼ç´ æ™´ã‚‰ã—ã„ï¼ï¼</p>';
    else {
        wrongAnswers.forEach(w => {
            const d = document.createElement('div'); d.className = 'review-item';
            d.innerHTML = `<div>Q: ${w.q}</div><div style="color:#ff6666">ã‚ãªãŸ: ${w.u} cmÂ² / æ­£è§£: ${w.a} cmÂ²</div><div style="font-size:0.8rem; color:cyan;">å¼: ${w.f}</div>`;
            list.appendChild(d);
        });
    }
}
</script>
</body>
</html>
